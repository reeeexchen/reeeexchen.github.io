<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="日常记录">
<meta property="og:type" content="website">
<meta property="og:title" content="REEEEX">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="REEEEX">
<meta property="og:description" content="日常记录">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="REEEEX">
<meta name="twitter:description" content="日常记录">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>REEEEX</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">REEEEX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">KEEP GOING</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/23/MicWechat Note-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/23/MicWechat Note-9/" itemprop="url">Wechat Mini | Note-9</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T00:00:00+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-9"><a href="#微信小程序开发-Note-9" class="headerlink" title="微信小程序开发 Note-9"></a>微信小程序开发 Note-9</h3><hr>
<h4 id="关注接口"><a href="#关注接口" class="headerlink" title="关注接口"></a>关注接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersLikeVideosMapper usersLikeVideosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersFansMapper usersFansMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUserFanRelation</span><span class="params">(String userId, String fanId)</span> </span>&#123;</span><br><span class="line">		UsersFans usersFan = <span class="keyword">new</span> UsersFans();</span><br><span class="line">		usersFan.setId(sid.nextShort());</span><br><span class="line">		usersFan.setUserId(userId);</span><br><span class="line">		usersFan.setFanId(fanId);</span><br><span class="line">		usersFansMapper.insert(usersFan);</span><br><span class="line"></span><br><span class="line">		userMapper.addFansCount(userId);</span><br><span class="line">		userMapper.addFollersCount(fanId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUserFanRelation</span><span class="params">(String userId, String fanId)</span> </span>&#123;</span><br><span class="line">		Example example = <span class="keyword">new</span> Example(UsersFans.class);</span><br><span class="line">		Example.Criteria criteria = example.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"userId"</span>,userId);</span><br><span class="line">		criteria.andEqualTo(<span class="string">"fanId"</span>,fanId);</span><br><span class="line">		usersFansMapper.deleteByExample(example);</span><br><span class="line"></span><br><span class="line">		userMapper.reduceFansCount(userId);</span><br><span class="line">		userMapper.reduceFollersCount(fanId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"FOLLOW USER"</span>, notes = <span class="string">"FOLLOW USER API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/beyourfans"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">beyourfans</span><span class="params">(String userId,String fanId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId) || StringUtils.isBlank(fanId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		userService.saveUserFanRelation(userId,fanId);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(<span class="string">"关注成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UNFOLLOW USER"</span>, notes = <span class="string">"UNFOLLOW USER API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/dontbeyourfans"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">dontbeyourfans</span><span class="params">(String userId,String fanId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId) || StringUtils.isBlank(fanId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		userService.deleteUserFanRelation(userId,fanId);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(<span class="string">"取消关注成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="关注联调"><a href="#关注联调" class="headerlink" title="关注联调"></a>关注联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mine.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    isMe:<span class="literal">true</span>,</span><br><span class="line">    isFollow:<span class="literal">false</span>,</span><br><span class="line">    publisherId:<span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// var user = app.userInfo;</span></span><br><span class="line">    <span class="comment">// 修改原有的全局对象为本地缓存</span></span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> userId = user.id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> publisherId = params.publisherId;</span><br><span class="line">    <span class="keyword">if</span> (publisherId != <span class="literal">null</span> &amp;&amp; publisherId != <span class="string">""</span> &amp;&amp; publisherId != <span class="literal">undefined</span>)&#123;</span><br><span class="line">      <span class="comment">// 进入发布者的页面</span></span><br><span class="line">      userId = publisherId;</span><br><span class="line">      me.setData(&#123;</span><br><span class="line">        isMe:<span class="literal">false</span>,</span><br><span class="line">        publisherId: publisherId</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 关注事件</span></span><br><span class="line">  followMe:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> publisherId = me.data.publisherId;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> userId = user.id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> followType = e.currentTarget.dataset.followtype;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span>(followType == <span class="string">'1'</span>)&#123;</span><br><span class="line">      <span class="comment">// 关注</span></span><br><span class="line">      url = <span class="string">'/user/beyourfans?userId='</span> + publisherId + <span class="string">"&amp;fanId="</span> + userId;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// 取消关注</span></span><br><span class="line">      url = <span class="string">'/user/dontbeyourfans?userId='</span> + publisherId + <span class="string">"&amp;fanId="</span> + userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'提交中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: app.serverUrl + url,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="string">'userId'</span>: user.id,</span><br><span class="line">        <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">      &#125;,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (followType == <span class="string">'1'</span>) &#123;</span><br><span class="line">          <span class="comment">// 关注</span></span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            isFollow:<span class="literal">true</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 取消关注</span></span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            isFollow: <span class="literal">false</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="关注功能完善"><a href="#关注功能完善" class="headerlink" title="关注功能完善"></a>关注功能完善</h4><p>关注与已关注的实时刷新；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (followType == <span class="string">'1'</span>) &#123;</span><br><span class="line">    <span class="comment">// 关注</span></span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        isFollow:<span class="literal">true</span>,</span><br><span class="line">        fansCounts: ++me.data.fansCounts</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 取消关注</span></span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        isFollow: <span class="literal">false</span>,</span><br><span class="line">        fansCounts: --me.data.fansCounts</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户头像的事件触发修改；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;isMe&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;faceUrl&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"face"</span> <span class="attr">bindtap</span>=<span class="string">'changeFace'</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;!isMe&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;faceUrl&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"face"</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">'nickname'</span>&gt;</span>&#123;&#123;nickname&#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="作品-收藏-关注-tab动态切换"><a href="#作品-收藏-关注-tab动态切换" class="headerlink" title="作品 收藏 关注 tab动态切换"></a>作品 收藏 关注 tab动态切换</h4><p>通过三个不同的List和不同的Flag的值，进行不同List的获取；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">    isMe: <span class="literal">true</span>,</span><br><span class="line">    isFollow: <span class="literal">false</span>,</span><br><span class="line">    publisherId: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    videoSelClass: <span class="string">"video-info"</span>,</span><br><span class="line">    isSelectedWork: <span class="string">"video-info-selected"</span>,</span><br><span class="line">    isSelectedLike: <span class="string">""</span>,</span><br><span class="line">    isSelectedFollow: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    myVideoList: [],</span><br><span class="line">    myVideoPage: <span class="number">1</span>,</span><br><span class="line">    myVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    likeVideoList: [],</span><br><span class="line">    likeVideoPage: <span class="number">1</span>,</span><br><span class="line">    likeVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    followVideoList: [],</span><br><span class="line">    followVideoPage: <span class="number">1</span>,</span><br><span class="line">    followVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    myWorkFlag: <span class="literal">false</span>,</span><br><span class="line">    myLikesFlag: <span class="literal">true</span>,</span><br><span class="line">    myFollowFlag: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 选择作品tab</span></span><br><span class="line">  doSelectWork: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      isSelectedWork: <span class="string">"video-info-selected"</span>,</span><br><span class="line">      isSelectedLike: <span class="string">""</span>,</span><br><span class="line">      isSelectedFollow: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">      myWorkFlag: <span class="literal">false</span>,</span><br><span class="line">      myLikesFlag: <span class="literal">true</span>,</span><br><span class="line">      myFollowFlag: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      myVideoList: [],</span><br><span class="line">      myVideoPage: <span class="number">1</span>,</span><br><span class="line">      myVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      likeVideoList: [],</span><br><span class="line">      likeVideoPage: <span class="number">1</span>,</span><br><span class="line">      likeVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      followVideoList: [],</span><br><span class="line">      followVideoPage: <span class="number">1</span>,</span><br><span class="line">      followVideoTotal: <span class="number">1</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.getMyVideoList(<span class="number">1</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 选择收藏tab</span></span><br><span class="line">  doSelectLike: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 选择关注tab</span></span><br><span class="line">  doSelectFollow: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">  &#125;,</span><br><span class="line">  getMyVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询视频信息</span></span><br><span class="line">    wx.showLoading();</span><br><span class="line">    <span class="comment">// 调用后端</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll/?page='</span> + page + <span class="string">'&amp;pageSize=6'</span>,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        userId: me.data.userId</span><br><span class="line">      &#125;,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span> <span class="comment">// 默认值</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="keyword">var</span> myVideoList = res.data.data.rows;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.myVideoList;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          myVideoPage: page,</span><br><span class="line">          myVideoList: newVideoList.concat(myVideoList),</span><br><span class="line">          myVideoTotal: res.data.data.total,</span><br><span class="line">          serverUrl: app.serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 我的作品视频列表</span></span><br><span class="line">  getMyVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询视频信息</span></span><br><span class="line">    wx.showLoading();</span><br><span class="line">    <span class="comment">// 调用后端</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll/?page='</span> + page + <span class="string">'&amp;pageSize=6'</span>,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        userId: me.data.userId</span><br><span class="line">      &#125;,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span> <span class="comment">// 默认值</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="keyword">var</span> myVideoList = res.data.data.rows;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.myVideoList;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          myVideoPage: page,</span><br><span class="line">          myVideoList: newVideoList.concat(myVideoList),</span><br><span class="line">          myVideoTotal: res.data.data.total,</span><br><span class="line">          serverUrl: app.serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="微信API菜单操作"><a href="#微信API菜单操作" class="headerlink" title="微信API菜单操作"></a>微信API菜单操作</h4><h5 id="wx-showActionSheet-OBJECT-显示操作菜单"><a href="#wx-showActionSheet-OBJECT-显示操作菜单" class="headerlink" title="wx.showActionSheet(OBJECT) 显示操作菜单"></a>wx.showActionSheet(OBJECT) 显示操作菜单</h5><p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>itemList</td>
<td>String Array</td>
<td>是</td>
<td>按钮的文字数组，数组长度最大为6个</td>
</tr>
<tr>
<td>itemColor</td>
<td>HexColor</td>
<td>否</td>
<td>按钮的文字颜色，默认为”#000000”</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功的回调函数，详见返回参数说明</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">shareMe:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.showActionSheet(&#123;</span><br><span class="line">        itemList: [<span class="string">'下载到本地'</span>, <span class="string">'举报用户'</span>, <span class="string">'分享到朋友圈'</span>,<span class="string">'分享到QQ空间'</span>,<span class="string">'分享到微博'</span>],</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(res.tapIndex);</span><br><span class="line">            <span class="keyword">if</span>(res.tapIndex == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">// 下载</span></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(res.tapIndex == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="comment">// 举报用户</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 未开放</span></span><br><span class="line">                wx.showToast(&#123;</span><br><span class="line">                    title: <span class="string">'功能暂未开发'</span>,</span><br><span class="line">                    icon:<span class="string">'loading'</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="保存举报信息接口"><a href="#保存举报信息接口" class="headerlink" title="保存举报信息接口"></a>保存举报信息接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Service</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportUser</span><span class="params">(UsersReport usersReport)</span> </span>&#123;</span><br><span class="line">    usersReport.setId(sid.nextShort());</span><br><span class="line">    usersReport.setCreateDate(<span class="keyword">new</span> Date());</span><br><span class="line">    usersReportMapper.insert(usersReport);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"REPORT USER"</span>, notes = <span class="string">"REPORT USER API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/reportUser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">reportUser</span><span class="params">(@RequestBody UsersReport usersReport)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存举报信息</span></span><br><span class="line">    userService.reportUser(usersReport);</span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"举报成功，相关人员会及时处理"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="举报联调"><a href="#举报联调" class="headerlink" title="举报联调"></a>举报联调</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (res.tapIndex == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 举报用户</span></span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(me.data.videoInfo);</span><br><span class="line">    <span class="keyword">var</span> realUrl = <span class="string">'../videoinfo/videoinfo#videoInfo@'</span> + videoInfo;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">''</span>) &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            url: <span class="string">'../userLogin/login?redirectUrl='</span> + realUrl,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> publishUserId = me.data.videoInfo.userId;</span><br><span class="line">        <span class="keyword">var</span> videoId = me.data.videoInfo.id;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            url: <span class="string">'../report/report?videoId='</span> + videoId + <span class="string">"&amp;publishUserId="</span> + publishUserId</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="分享好友或微信群"><a href="#分享好友或微信群" class="headerlink" title="分享好友或微信群"></a>分享好友或微信群</h4><h5 id="onShareAppMessage-Object"><a href="#onShareAppMessage-Object" class="headerlink" title="onShareAppMessage(Object)"></a>onShareAppMessage(Object)</h5><p>监听用户点击页面内转发按钮（<code>&lt;button&gt;</code> 组件 <code>open-type=&quot;share&quot;</code>）或右上角菜单“转发”按钮的行为，并自定义转发内容。</p>
<p><strong>注意：只有定义了此事件处理函数，右上角菜单才会显示“转发”按钮</strong></p>
<p><strong>Object 参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>from</td>
<td>String</td>
<td>转发事件来源。 <code>button</code>：页面内转发按钮； <code>menu</code>：右上角转发菜单</td>
</tr>
<tr>
<td>target</td>
<td>Object</td>
<td>如果 <code>from</code> 值是 <code>button</code>，则 <code>target</code> 是触发这次转发事件的 <code>button</code>，否则为 <code>undefined</code></td>
</tr>
<tr>
<td>webViewUrl</td>
<td>String</td>
<td>页面中包含<code>&lt;web-view&gt;</code>组件时，返回当前<code>&lt;web-view&gt;</code>的url</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分享</span></span><br><span class="line">onShareAppMessage: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoInfo = me.data.videoInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        title: <span class="string">'短视频内容分享'</span>,</span><br><span class="line">        path: <span class="string">'pages/videoinfo/videoinfo?videoInfo='</span> + <span class="built_in">JSON</span>.stringify(videoInfo)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="下载视频到本地"><a href="#下载视频到本地" class="headerlink" title="下载视频到本地"></a>下载视频到本地</h4><h5 id="wx-downloadFile-OBJECT"><a href="#wx-downloadFile-OBJECT" class="headerlink" title="wx.downloadFile(OBJECT)"></a>wx.downloadFile(OBJECT)</h5><p>下载文件资源到本地，客户端直接发起一个 HTTP GET 请求，返回文件的本地临时路径；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>必填</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>String</td>
<td>是</td>
<td>下载资源的 url</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>否</td>
<td>HTTP 请求 Header，header 中不能设置 Referer</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>下载成功后以 tempFilePath 的形式传给页面，res = {tempFilePath: ‘文件的临时路径’}</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<p>注：文件的临时路径，在小程序本次启动期间可以正常使用，如需持久保存，需在主动调用 wx.saveFile，才能在小程序下次启动时访问得到；</p>
<p>注：请在 header 中指定合理的 Content-Type 字段，以保证客户端正确处理文件类型；</p>
<h5 id="wx-saveVideoToPhotosAlbum-OBJECT"><a href="#wx-saveVideoToPhotosAlbum-OBJECT" class="headerlink" title="wx.saveVideoToPhotosAlbum(OBJECT)"></a>wx.saveVideoToPhotosAlbum(OBJECT)</h5><p>保存视频到系统相册</p>
<p>需要<a href="https://developers.weixin.qq.com/miniprogram/dev/api/authorize-index.html" target="_blank" rel="noopener">用户授权</a> scope.writePhotosAlbum</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>filePath</td>
<td>String</td>
<td>是</td>
<td>视频文件路径，可以是临时文件路径也可以是永久文件路径</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (res.tapIndex == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 下载</span></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'下载中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.downloadFile(&#123;</span><br><span class="line">        url: app.serverUrl + me.data.videoInfo.videoPath,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 只要服务器有响应数据，就会把响应内容写入文件并进入 success 回调，业务需要自行判断是否下载到了想要的内容</span></span><br><span class="line">            <span class="keyword">if</span> (res.statusCode === <span class="number">200</span>) &#123;</span><br><span class="line">                wx.saveVideoToPhotosAlbum(&#123;</span><br><span class="line">                    filePath: res.tempFilePath,</span><br><span class="line">                    success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(res.errMsg)</span><br><span class="line">                        wx.hideLoading();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/MicWechat Note-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/22/MicWechat Note-8/" itemprop="url">Wechat Mini | Note-8</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T00:00:00+08:00">
                2018-08-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-8"><a href="#微信小程序开发-Note-8" class="headerlink" title="微信小程序开发 Note-8"></a>微信小程序开发 Note-8</h3><hr>
<h4 id="搜索功能整合-amp-首页联调"><a href="#搜索功能整合-amp-首页联调" class="headerlink" title="搜索功能整合 &amp; 首页联调"></a>搜索功能整合 &amp; 首页联调</h4><p>通过修改index.js中对于<code>getAllVideoList</code>，加入对应的参数，搜索内容和分页记录；</p>
<p>以达到搜索返回视频列表的目标；（上拉刷新和下拉刷新不进行刷新）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 共用方法</span></span><br><span class="line">getAllVideoList: <span class="function"><span class="keyword">function</span> (<span class="params">page, isSaveRecord</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'视频加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> searchContent = me.data.searchContent;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page + <span class="string">"&amp;isSaveRecord="</span> + isSaveRecord,</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      data:&#123;</span><br><span class="line">        videoDesc:searchContent</span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        wx.hideNavigationBarLoading();</span><br><span class="line">        wx.stopPullDownRefresh();</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="comment">// 判断当前页page是否为第一页，第一页则清空videoList</span></span><br><span class="line">        <span class="keyword">if</span> (page === <span class="number">1</span>) &#123;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            videoList: []</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> videoList = res.data.data.rows;</span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.videoList;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          videoList: newVideoList.concat(videoList),</span><br><span class="line">          page: page,</span><br><span class="line">          totalPage: res.data.data.total,</span><br><span class="line">          serverUrl: serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="热搜查询联调-amp-视频对象播放与暂停"><a href="#热搜查询联调-amp-视频对象播放与暂停" class="headerlink" title="热搜查询联调 &amp; 视频对象播放与暂停"></a>热搜查询联调 &amp; 视频对象播放与暂停</h4><p><strong>Q:对视频对象进行mute设置时，跳转到搜索页面和主页时，视频依然播放音乐；</strong></p>
<p>A:在JS中进行相应的修改；</p>
<p>步骤：    在生命周期的onLoad（），获取videoContext，onShow（）对视频进行播放，</p>
<p>​        在跳转时，onHide（）进行视频暂停；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    cover:<span class="string">"cover"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  videoCtx:&#123;&#125;,</span><br><span class="line">  onLoad:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx = wx.createVideoContext(<span class="string">"myVideo"</span>, me);</span><br><span class="line">  &#125;,</span><br><span class="line">  onShow:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx.play();</span><br><span class="line">  &#125;,</span><br><span class="line">  onHide:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx.pause();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 搜索</span></span><br><span class="line">  showSearch:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.navigateTo(&#123;</span><br><span class="line">      url: <span class="string">'../searchVideo/searchVideo'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="上传视频功能复用-amp-测试"><a href="#上传视频功能复用-amp-测试" class="headerlink" title="上传视频功能复用 &amp; 测试"></a>上传视频功能复用 &amp; 测试</h4><p>在pages同级目录下，创建一个utils，videoUtil.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// videoUtil.js</span></span><br><span class="line"><span class="comment">// 视频上传-跳转至BGM选择页面</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadVideo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">  wx.chooseVideo(&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// videoUtil.js 导出</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  uploadVideo: uploadVideo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> videoUtil = <span class="built_in">require</span>(<span class="string">'../../utils/videoUtil.js'</span>) <span class="comment">// 引用</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 上传视频</span></span><br><span class="line">  upload:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    videoUtil.uploadVideo();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页进入视频展示页"><a href="#首页进入视频展示页" class="headerlink" title="首页进入视频展示页"></a>首页进入视频展示页</h4><p>从首页中的对象，获取到JSON数据，然后通过转换的形式，转换成字符串，传到videoinfo，在videoinfo中，再转换回JSON对象，进行数据的获取和赋值；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// 具体的视频信息-跳转</span></span><br><span class="line">showVideoInfo: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoList = me.data.videoList;</span><br><span class="line">    <span class="keyword">var</span> arrindex = e.target.dataset.arrindex;</span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(videoList[arrindex]);</span><br><span class="line">    wx.redirectTo(&#123;</span><br><span class="line">      url: <span class="string">'../videoinfo/videoinfo?videoInfo='</span> + videoInfo</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// videoinfo.js</span></span><br><span class="line">onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx = wx.createVideoContext(<span class="string">"myVideo"</span>, me);</span><br><span class="line">    <span class="comment">// 获取上一页面传入的参数</span></span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.parse(params.videoInfo);</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">      videoId: videoInfo.id,</span><br><span class="line">      src: app.serverUrl + videoInfo.videoPath,</span><br><span class="line">      videoInfo: videoInfo</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="页面重定向"><a href="#页面重定向" class="headerlink" title="页面重定向"></a>页面重定向</h4><p>对于没有登录的用户，可以搜索，但是不能进行个人信息页面的跳转和视频的上传；</p>
<p>所以需要对于没有登录的用户，进行页面的拦截和重定向；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">showMine: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">""</span>) &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../mine/mine'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在从视频详细页面跳转到登录页面之后，我们希望登录后，再次跳转回到之前的视频详细页面；</p>
<p>那么我们需要将原视频详细页面的信息传到登录页面，再进行页面的重定向跳转；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// videoInfo.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 上传视频</span></span><br><span class="line">  upload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="comment">// 重定向数据定义</span></span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(me.data.videoInfo);</span><br><span class="line">    <span class="keyword">var</span> realUrl = <span class="string">'../videoinfo/videoinfo#videoInfo@'</span> + videoInfo;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">""</span>) &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../userLogin/login?redirectUrl='</span> + realUrl,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      videoUtil.uploadVideo();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.js</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 视频页面重定向跳转到登录页面，做参数的处理（接收与反传）</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> redirectUrl = params.redirectUrl;</span><br><span class="line">    redirectUrl = redirectUrl.replace(<span class="regexp">/#/g</span>, <span class="string">"?"</span>);</span><br><span class="line">    redirectUrl = redirectUrl.replace(<span class="regexp">/@/g</span>, <span class="string">"="</span>);</span><br><span class="line">    me.redirectUrl = redirectUrl;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 登录</span></span><br><span class="line">  doLogin: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (username.length == <span class="number">0</span> || password.length == <span class="number">0</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// BackEnd</span></span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        ...</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">          ...</span><br><span class="line">            <span class="comment">// app.userInfo = res.data.data;</span></span><br><span class="line">            <span class="comment">// fixme 修改原有全局对象为本地缓存</span></span><br><span class="line">            app.setGlobalUserInfo(res.data.data);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 页面跳转</span></span><br><span class="line">            <span class="keyword">var</span> redirectUrl = me.redirectUrl;</span><br><span class="line">            <span class="keyword">if</span> (redirectUrl != <span class="literal">null</span> &amp;&amp; redirectUrl != <span class="literal">undefined</span> &amp;&amp; redirectUrl != <span class="string">""</span>) &#123;</span><br><span class="line">              wx.redirectTo(&#123;</span><br><span class="line">                url: redirectUrl,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              wx.redirectTo(&#123;</span><br><span class="line">                url: <span class="string">'../mine/mine'</span>,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == <span class="number">500</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="拦截器配置与注册"><a href="#拦截器配置与注册" class="headerlink" title="拦截器配置与注册"></a>拦截器配置与注册</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟拦截器配置（对所有请求进行拦截）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 拦截请求判断，预处理（Controller之前）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"请求拦截"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 返回false：请求被拦截，返回</span></span><br><span class="line">		<span class="comment">// 返回true:请求允许,继续执行</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求Controller之后，渲染视图之前</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求和视图渲染之后</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拦截器注册</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MiniInterceptor <span class="title">miniInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MiniInterceptor();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册中心</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对UserController进行拦截注册</span></span><br><span class="line">        registry.addInterceptor(miniInterceptor()).addPathPatterns(<span class="string">"/user/**"</span>);</span><br><span class="line">        <span class="keyword">super</span>.addInterceptors(registry);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="完善登录拦截-amp-限制单台手机登录"><a href="#完善登录拦截-amp-限制单台手机登录" class="headerlink" title="完善登录拦截 &amp; 限制单台手机登录"></a>完善登录拦截 &amp; 限制单台手机登录</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RedisOperator redis;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_REDIS_SESSION = <span class="string">"user-redis-session"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 拦截请求判断，预处理（Controller之前）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String userId = request.getHeader(<span class="string">"userId"</span>);</span><br><span class="line">		String userToken = request.getHeader(<span class="string">"userToken"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(userId) &amp;&amp; StringUtils.isNotBlank(userToken)) &#123;</span><br><span class="line">			String uniqueToken = redis.get(USER_REDIS_SESSION + <span class="string">":"</span> + userId);</span><br><span class="line">			<span class="comment">// Token超时限制的判断 重新登录</span></span><br><span class="line">			<span class="keyword">if</span> (StringUtils.isEmpty(uniqueToken) &amp;&amp; StringUtils.isBlank(uniqueToken)) &#123;</span><br><span class="line">				System.out.println(<span class="string">"请登录"</span>);</span><br><span class="line">				returnErrorResponse(response, IMoocJSONResult.errorTokenMsg(<span class="string">"请登录"</span>));</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 限制一台手机登录</span></span><br><span class="line">				<span class="keyword">if</span> (!uniqueToken.equals(userToken)) &#123;</span><br><span class="line">					System.out.println(<span class="string">"帐号异点登录"</span>);</span><br><span class="line">					returnErrorResponse(response, IMoocJSONResult.errorTokenMsg(<span class="string">"帐号异点登录"</span>));</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			returnErrorResponse(response, IMoocJSONResult.errorTokenMsg(<span class="string">"请登录"</span>));</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 公用返回JSON格式</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnErrorResponse</span><span class="params">(HttpServletResponse response, IMoocJSONResult result)</span> <span class="keyword">throws</span> IOException, UnsupportedEncodingException </span>&#123;</span><br><span class="line">		OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">			response.setContentType(<span class="string">"text/json"</span>);</span><br><span class="line">			out = response.getOutputStream();</span><br><span class="line">			out.write(JsonUtils.objectToJson(result).getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			out.flush();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">				out.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="拦截器联调"><a href="#拦截器联调" class="headerlink" title="拦截器联调"></a>拦截器联调</h4><p>对于拦截器方法中，需要获取用户的USERID以及USERTOKEN，所以在用户请求时，在header中加入相应数据，以实现拦截器的功能；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      ...</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="string">'userId'</span>: user.id,</span><br><span class="line">        <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.data.status == <span class="number">502</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: res.data.msg,</span><br><span class="line">            icon: <span class="string">'none'</span>,</span><br><span class="line">            duration: <span class="number">2000</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">              wx.redirectTo(&#123;</span><br><span class="line">                url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="点赞接口"><a href="#点赞接口" class="headerlink" title="点赞接口"></a>点赞接口</h4><p>非常简单的接口，不加以展示；</p>
<p>首先对Mapper进行方法的编写，然后修改对于的XML的语句；</p>
<p>在VideoServiceImpl进行对于方法的实现即可<code>userLikeVideo</code> &amp; <code>userUnLikeVideo</code>；</p>
<p>以及Controller的修改；</p>
<h4 id="点赞联调"><a href="#点赞联调" class="headerlink" title="点赞联调"></a>点赞联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> videoUtil = <span class="built_in">require</span>(<span class="string">'../../utils/videoUtil.js'</span>)</span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    cover: <span class="string">"cover"</span>,</span><br><span class="line">    videoId: <span class="string">""</span>,</span><br><span class="line">    src: <span class="string">""</span>,</span><br><span class="line">    videoInfo: &#123;&#125;,</span><br><span class="line">    userLikeVideo: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 点赞与取消点赞</span></span><br><span class="line">  likeVideoOrNot: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoInfo = me.data.videoInfo;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="comment">// 判断登录</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">""</span>) &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 点赞与取消点赞的request</span></span><br><span class="line">      <span class="keyword">var</span> userLikeVideo = me.data.userLikeVideo;</span><br><span class="line">      <span class="keyword">var</span> url = <span class="string">'/video/userLike?userId='</span> + user.id + <span class="string">"&amp;videoId="</span> + videoInfo.id + <span class="string">"&amp;videoCreaterId="</span> + videoInfo.userId;</span><br><span class="line">      <span class="keyword">if</span> (userLikeVideo) &#123;</span><br><span class="line">        <span class="comment">// 取消点赞</span></span><br><span class="line">        url = <span class="string">'/video/userUnLike?userId='</span> + user.id + <span class="string">"&amp;videoId="</span> + videoInfo.id + <span class="string">"&amp;videoCreaterId="</span> + videoInfo.userId;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// request</span></span><br><span class="line">      <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">      wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'提交中'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        url: serverUrl + url,</span><br><span class="line">        method: <span class="string">'POST'</span>,</span><br><span class="line">        header: &#123;</span><br><span class="line">          <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">          <span class="string">'userId'</span>: user.id,</span><br><span class="line">          <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">        &#125;,</span><br><span class="line">        success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">          wx.hideLoading();</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            userLikeVideo: !userLikeVideo</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视频展示页"><a href="#视频展示页" class="headerlink" title="视频展示页"></a>视频展示页</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> videoUtil = <span class="built_in">require</span>(<span class="string">'../../utils/videoUtil.js'</span>)</span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    cover: <span class="string">"cover"</span>,</span><br><span class="line">    videoId: <span class="string">""</span>,</span><br><span class="line">    src: <span class="string">""</span>,</span><br><span class="line">    videoInfo: &#123;&#125;,</span><br><span class="line">    userLikeVideo: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取视频发布者信息，点赞关系</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> loginUserId = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span> &amp;&amp; user != <span class="literal">undefined</span> &amp;&amp; user != <span class="string">""</span>) &#123;</span><br><span class="line">      loginUserId = user.id;</span><br><span class="line">    &#125;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/user/queryPublisher?loginUserId='</span> + loginUserId + <span class="string">"&amp;videoId="</span> + videoInfo.id + <span class="string">"&amp;publishUserId="</span> + videoInfo.userId,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="keyword">var</span> publisher = res.data.data.publisher;</span><br><span class="line">        <span class="keyword">var</span> userLikeVideo = res.data.data.userLikeVideo;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          serverUrl: serverUrl,</span><br><span class="line">          publisher: publisher,</span><br><span class="line">          userLikeVideo: userLikeVideo</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"QUERY VIDEO PUBLISHER INFORMATION"</span>, notes = <span class="string">"QUERY VIDEO PUBLISHER INFORMATION API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/queryPublisher"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">queryPublisher</span><span class="params">(String loginUserId,String videoId,String publishUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(publishUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查询发布者用户个人信息</span></span><br><span class="line">    Users userInfo = userService.queryUserInfo(publishUserId);</span><br><span class="line">    UsersVO publisher = <span class="keyword">new</span> UsersVO();</span><br><span class="line">    BeanUtils.copyProperties(userInfo, publisher);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查询登录用户与点赞关系</span></span><br><span class="line">    <span class="keyword">boolean</span> userLikeVideo = userService.isUserLikeVideo(loginUserId,videoId);</span><br><span class="line">    PublisherVideo bean = <span class="keyword">new</span> PublisherVideo();</span><br><span class="line">    bean.setPublisher(publisher);</span><br><span class="line">    bean.setUserLikeVideo(userLikeVideo);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.ok(bean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/21/MicWechat Note-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/21/MicWechat Note-7/" itemprop="url">Wechat Mini | Note-7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-21T00:00:00+08:00">
                2018-08-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-7"><a href="#微信小程序开发-Note-7" class="headerlink" title="微信小程序开发 Note-7"></a>微信小程序开发 Note-7</h3><hr>
<h4 id="小程序首页视频列表"><a href="#小程序首页视频列表" class="headerlink" title="小程序首页视频列表"></a>小程序首页视频列表</h4><p>首页是底色加封面图，并不是可播放的视频；</p>
<h4 id="自定义mapper"><a href="#自定义mapper" class="headerlink" title="自定义mapper"></a>自定义mapper</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAllVideos"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    select v.*,u.face_image as face_image,u.nickname as nickname from videos v</span><br><span class="line">    left join users u on u.id = v.user_id</span><br><span class="line">    where</span><br><span class="line">    1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" videoDesc != null and videoDesc != '' "</span>&gt;</span></span><br><span class="line">        and v.video_desc like '%$&#123;videoDesc&#125;%'</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" userId != null and userId != '' "</span>&gt;</span></span><br><span class="line">        and v.user_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    and v.status = 1</span><br><span class="line">    order by v.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="视频列表分页查询接口"><a href="#视频列表分页查询接口" class="headerlink" title="视频列表分页查询接口"></a>视频列表分页查询接口</h4><p>Pagehelper原理：</p>
<p>从数据库中select数据，在查询之前做一层拦截；</p>
<p>拦截后的select语句，将会由Ph做一个拼接，拼接成复合分页要求的select（limit）语句；</p>
<p>拼接出来的新select语句将替代原select，获取数据；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询第几页，每页显示几条数据</span></span><br><span class="line">PageHelper.startPage(page,pageSize);</span><br><span class="line">List&lt;User&gt; list = userMapper.find();</span><br><span class="line">PageInfo page = <span class="keyword">new</span> PageInfo&lt;list&gt;;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapperCustom videosMapperCustom;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> PagedResult <span class="title">getAllVideos</span><span class="params">(Integer page, Integer pageSize)</span> </span>&#123;</span><br><span class="line">		PageHelper.startPage(page,pageSize);</span><br><span class="line">		List&lt;VideosVO&gt; list = videosMapperCustom.queryAllVideos();</span><br><span class="line"></span><br><span class="line">		PageInfo&lt;VideosVO&gt; pageList = <span class="keyword">new</span> PageInfo&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">		PagedResult pagedResult = <span class="keyword">new</span> PagedResult();</span><br><span class="line">		pagedResult.setPage(page);</span><br><span class="line">		pagedResult.setTotal(pageList.getPages());</span><br><span class="line">		pagedResult.setRows(list);</span><br><span class="line">		pagedResult.setRecords(pageList.getTotal());</span><br><span class="line">		<span class="keyword">return</span> pagedResult;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/showAll"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">showAll</span><span class="params">(Integer page)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(page == <span class="keyword">null</span>)&#123;</span><br><span class="line">			page = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		PagedResult pagedResult = videoService.getAllVideos(page,PAGE_SIZE);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(pagedResult);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页分页联调"><a href="#首页分页联调" class="headerlink" title="首页分页联调"></a>首页分页联调</h4><h5 id="wx-getSystemInfoSync-获取系统信息同步接口"><a href="#wx-getSystemInfoSync-获取系统信息同步接口" class="headerlink" title="wx.getSystemInfoSync() - 获取系统信息同步接口"></a>wx.getSystemInfoSync() - 获取系统信息同步接口</h5><p>同步返回参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>screenWidth</td>
<td>屏幕宽度</td>
</tr>
<tr>
<td>screenHeight</td>
<td>屏幕高度</td>
</tr>
<tr>
<td>windowWidth</td>
<td>可使用窗口宽度</td>
</tr>
<tr>
<td>windowHeight</td>
<td>可使用窗口高度</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    <span class="comment">// 总页数</span></span><br><span class="line">    totalPage: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 当前页数</span></span><br><span class="line">    page: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 视频列表</span></span><br><span class="line">    videoList: [],</span><br><span class="line">    screenWidth: <span class="number">350</span>,</span><br><span class="line">    serverUrl: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> screenWidth = wx.getSystemInfoSync().screenWidth;</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">      screenWidth: screenWidth</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前的分页数</span></span><br><span class="line">    <span class="keyword">var</span> page = me.data.page;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="comment">// 判断当前页page是否为第一页，第一页则清空videoList</span></span><br><span class="line">        <span class="keyword">if</span>(page === <span class="number">1</span>)&#123;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            videoList: []</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> videoList = res.data.data.rows;</span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.videoList;</span><br><span class="line"></span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          videoList: newVideoList.concat(videoList),</span><br><span class="line">          page:page,</span><br><span class="line">          totalPage: res.data.data.total,</span><br><span class="line">          serverUrl:serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页——上拉分页"><a href="#首页——上拉分页" class="headerlink" title="首页——上拉分页"></a>首页——上拉分页</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"><span class="comment">// 并且修改共用方法</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    <span class="comment">// 总页数</span></span><br><span class="line">    totalPage: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 当前页数</span></span><br><span class="line">    page: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 视频列表</span></span><br><span class="line">    videoList: [],</span><br><span class="line">    screenWidth: <span class="number">350</span>,</span><br><span class="line">    serverUrl: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 共用方法</span></span><br><span class="line">  getAllVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page,</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="comment">// 判断当前页page是否为第一页，第一页则清空videoList</span></span><br><span class="line">        <span class="keyword">if</span> (page === <span class="number">1</span>) &#123;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            videoList: []</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> videoList = res.data.data.rows;</span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.videoList;</span><br><span class="line"></span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          videoList: newVideoList.concat(videoList),</span><br><span class="line">          page: page,</span><br><span class="line">          totalPage: res.data.data.total,</span><br><span class="line">          serverUrl: serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 上拉刷新</span></span><br><span class="line">  onReachBottom: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> currentPage = me.data.page;</span><br><span class="line">    <span class="keyword">var</span> totalPage = me.data.totalPage;</span><br><span class="line">    <span class="comment">// 如果是最后一页，无须查询</span></span><br><span class="line">    <span class="keyword">if</span> (currentPage === totalPage) &#123;</span><br><span class="line">      wx.showToast(&#123;</span><br><span class="line">        title: <span class="string">'没有更多视频，请积极投稿'</span>,</span><br><span class="line">        icon: <span class="string">'none'</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续翻页</span></span><br><span class="line">    <span class="keyword">var</span> page = currentPage + <span class="number">1</span>;</span><br><span class="line">    me.getAllVideoList(page);</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 具体的视频信息</span></span><br><span class="line">  showVideoInfo: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页——下拉刷新"><a href="#首页——下拉刷新" class="headerlink" title="首页——下拉刷新"></a>首页——下拉刷新</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 共用方法</span></span><br><span class="line">  getAllVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page,</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 隐藏刷新</span></span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        wx.hideNavigationBarLoading();</span><br><span class="line">        wx.stopPullDownRefresh();</span><br><span class="line">        ...</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 下拉刷新(需要在index.json启动事件)</span></span><br><span class="line">  onPullDownRefresh:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.showNavigationBarLoading();</span><br><span class="line">    <span class="keyword">this</span>.getAllVideoList(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视频组件与API"><a href="#视频组件与API" class="headerlink" title="视频组件与API"></a>视频组件与API</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/video.html" target="_blank" rel="noopener">video 视频</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>src</td>
<td>String</td>
<td></td>
<td>要播放视频的资源地址，支持云文件ID（2.2.3）</td>
</tr>
<tr>
<td>initial-time</td>
<td>Number</td>
<td></td>
<td>指定视频初始播放位置</td>
</tr>
<tr>
<td>duration</td>
<td>Number</td>
<td></td>
<td>指定视频时长</td>
</tr>
<tr>
<td>controls</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示默认播放控件（播放/暂停按钮、播放进度、时间）</td>
</tr>
<tr>
<td>danmu-list</td>
<td>Object Array</td>
<td></td>
<td>弹幕列表</td>
</tr>
<tr>
<td>danmu-btn</td>
<td>Boolean</td>
<td>false</td>
<td>是否显示弹幕按钮，只在初始化时有效，不能动态变更</td>
</tr>
<tr>
<td>enable-danmu</td>
<td>Boolean</td>
<td>false</td>
<td>是否展示弹幕，只在初始化时有效，不能动态变更</td>
</tr>
<tr>
<td>autoplay</td>
<td>Boolean</td>
<td>false</td>
<td>是否自动播放</td>
</tr>
<tr>
<td>loop</td>
<td>Boolean</td>
<td>false</td>
<td>是否循环播放</td>
</tr>
<tr>
<td>muted</td>
<td>Boolean</td>
<td>false</td>
<td>是否静音播放</td>
</tr>
<tr>
<td>page-gesture</td>
<td>Boolean</td>
<td>false</td>
<td>在非全屏模式下，是否开启亮度与音量调节手势</td>
</tr>
<tr>
<td>direction</td>
<td>Number</td>
<td></td>
<td>设置全屏时视频的方向，不指定则根据宽高比自动判断。有效值为 0（正常竖向）, 90（屏幕逆时针90度）, -90（屏幕顺时针90度）</td>
</tr>
<tr>
<td>show-progress</td>
<td>Boolean</td>
<td>true</td>
<td>若不设置，宽度大于240时才会显示</td>
</tr>
<tr>
<td>show-fullscreen-btn</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示全屏按钮</td>
</tr>
<tr>
<td>show-play-btn</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示视频底部控制栏的播放按钮</td>
</tr>
<tr>
<td>show-center-play-btn</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示视频中间的播放按钮</td>
</tr>
<tr>
<td>enable-progress-gesture</td>
<td>Boolean</td>
<td>true</td>
<td>是否开启控制进度的手势</td>
</tr>
</tbody>
</table>
<h5 id="wx-createVideoContext-videoId-this"><a href="#wx-createVideoContext-videoId-this" class="headerlink" title="wx.createVideoContext(videoId, this)"></a>wx.createVideoContext(videoId, this)</h5><p>创建并返回 video 上下文 <code>videoContext</code> 对象。在自定义组件下，第二个参数传入组件实例this，以操作组件内 <code>&lt;video/&gt;</code>组件</p>
<h5 id="videoContext"><a href="#videoContext" class="headerlink" title="videoContext"></a>videoContext</h5><p><code>videoContext</code> 通过 videoId 跟一个 video 组件绑定，通过它可以操作一个 video 组件</p>
<hr>
<h4 id="开源搜索视频组件"><a href="#开源搜索视频组件" class="headerlink" title="开源搜索视频组件"></a>开源搜索视频组件</h4><h5 id="wsSearchView"><a href="#wsSearchView" class="headerlink" title="wsSearchView"></a><a href="https://github.com/mindawei/wsSearchView" target="_blank" rel="noopener">wsSearchView</a></h5><p>该搜索框组件基于开源项目<a href="https://github.com/icindy/wxSearch" target="_blank" rel="noopener">wxSearch</a> 进行了改进，主要有以下几个修改点：</p>
<ul>
<li>增加了注释，修改了一些bug，项目可以跑起来。</li>
<li>为了解决搜索框和输入法界面重叠的问题，将搜索组件作为一个独立的页面。</li>
<li>修改了界面样式，更加美观。</li>
<li>减少了暴露接口，复杂性更低。</li>
</ul>
<h4 id="搜索插件缓存"><a href="#搜索插件缓存" class="headerlink" title="搜索插件缓存"></a>搜索插件缓存</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params">inputValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (inputValue &amp;&amp; inputValue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 添加历史记录</span></span><br><span class="line">    wxSearchAddHisKey(inputValue);</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    <span class="keyword">var</span> temData = __that.data.wxSearchData;</span><br><span class="line">    temData.value = inputValue;</span><br><span class="line">    __that.setData(&#123;</span><br><span class="line">      wxSearchData: temData</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 回调搜索</span></span><br><span class="line">    __searchFunction(inputValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加本地缓存</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wxSearchAddHisKey</span>(<span class="params">inputValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!inputValue || inputValue.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> value = wx.getStorageSync(<span class="string">'wxSearchHisKeys'</span>);</span><br><span class="line">  <span class="keyword">if</span> (value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value.indexOf(inputValue) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      value.unshift(inputValue);</span><br><span class="line">    &#125;</span><br><span class="line">    wx.setStorage(&#123;</span><br><span class="line">      key: <span class="string">"wxSearchHisKeys"</span>,</span><br><span class="line">      data: value,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        getHisKeys(__that);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    value = [];</span><br><span class="line">    value.push(inputValue);</span><br><span class="line">    wx.setStorage(&#123;</span><br><span class="line">      key: <span class="string">"wxSearchHisKeys"</span>,</span><br><span class="line">      data: value,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        getHisKeys(__that);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="修改全局用户对象（使用缓存）"><a href="#修改全局用户对象（使用缓存）" class="headerlink" title="修改全局用户对象（使用缓存）"></a>修改全局用户对象（使用缓存）</h4><p>为了使用户每次打开小程序不需要重复的登录，根据官方文档的同步&amp;异步方法的说明；</p>
<p>需要通过设置全局的用户对象，使用本地缓存的方式，解决这样的问题；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line">App(&#123;</span><br><span class="line">  serverUrl: <span class="string">"ip"</span>,</span><br><span class="line">  userInfo: <span class="literal">null</span>,</span><br><span class="line">  setGlobalUserInfo:<span class="function"><span class="keyword">function</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">    wx.setStorageSync(<span class="string">"userInfo"</span>, user);</span><br><span class="line">  &#125;,</span><br><span class="line">  getGlobalUserInfo: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> wx.getStorageSync(<span class="string">"userInfo"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.userInfo = res.data.data;</span></span><br><span class="line"><span class="comment">// fixme 修改原有全局对象为本地缓存</span></span><br><span class="line">app.setGlobalUserInfo(res.data.data);</span><br><span class="line"><span class="comment">// fixme 修改原有全局对象为本地缓存</span></span><br><span class="line"><span class="keyword">var</span> userInfo = app.getGlobalUserInfo();</span><br><span class="line"><span class="comment">// 注销后，清空缓存</span></span><br><span class="line">          wx.removeStorageSync(<span class="string">"userInfo"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="查询接口完善-amp-热搜词保存"><a href="#查询接口完善-amp-热搜词保存" class="headerlink" title="查询接口完善 &amp; 热搜词保存"></a>查询接口完善 &amp; 热搜词保存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="keyword">package</span> com.imooc.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageInfo;</span><br><span class="line"><span class="keyword">import</span> com.imooc.mapper.SearchRecordsMapper;</span><br><span class="line"><span class="keyword">import</span> com.imooc.mapper.VideosMapper;</span><br><span class="line"><span class="keyword">import</span> com.imooc.mapper.VideosMapperCustom;</span><br><span class="line"><span class="keyword">import</span> com.imooc.pojo.SearchRecords;</span><br><span class="line"><span class="keyword">import</span> com.imooc.pojo.Videos;</span><br><span class="line"><span class="keyword">import</span> com.imooc.pojo.vo.VideosVO;</span><br><span class="line"><span class="keyword">import</span> com.imooc.service.VideoService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.utils.PagedResult;</span><br><span class="line"><span class="keyword">import</span> org.n3r.idworker.Sid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapperCustom videosMapperCustom;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SearchRecordsMapper searchRecordsMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> PagedResult <span class="title">getAllVideos</span><span class="params">(Videos video, Integer isSaveRecord, Integer page, Integer pageSize)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 保存热搜词记录</span></span><br><span class="line">		String desc = video.getVideoDesc();</span><br><span class="line">		<span class="keyword">if</span>(isSaveRecord != <span class="keyword">null</span> &amp;&amp; isSaveRecord == <span class="number">1</span>)&#123;</span><br><span class="line">			SearchRecords record = <span class="keyword">new</span> SearchRecords();</span><br><span class="line">			record.setId(sid.nextShort());</span><br><span class="line">			record.setContent(desc);</span><br><span class="line">			searchRecordsMapper.insert(record);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 视频分页查询</span></span><br><span class="line">		PageHelper.startPage(page, pageSize);</span><br><span class="line">		List&lt;VideosVO&gt; list = videosMapperCustom.queryAllVideos(desc);</span><br><span class="line"></span><br><span class="line">		PageInfo&lt;VideosVO&gt; pageList = <span class="keyword">new</span> PageInfo&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">		PagedResult pagedResult = <span class="keyword">new</span> PagedResult();</span><br><span class="line">		pagedResult.setPage(page);</span><br><span class="line">		pagedResult.setTotal(pageList.getPages());</span><br><span class="line">		pagedResult.setRows(list);</span><br><span class="line">		pagedResult.setRecords(pageList.getTotal());</span><br><span class="line">		<span class="keyword">return</span> pagedResult;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// VideosMapperCustom.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAllVideos"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    select v.*,u.face_image as face_image,u.nickname as nickname from videos v</span><br><span class="line">    left join users u on u.id = v.user_id</span><br><span class="line">    where</span><br><span class="line">    1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" videoDesc != null and videoDesc != '' "</span>&gt;</span></span><br><span class="line">        and v.video_desc like '%$&#123;videoDesc&#125;%'</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    and v.status = 1</span><br><span class="line">    order by v.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="热搜词查询接口"><a href="#热搜词查询接口" class="headerlink" title="热搜词查询接口"></a>热搜词查询接口</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// SearchRecordsMapper.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getHotwords"</span> <span class="attr">resultType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    SELECT content</span><br><span class="line">    FROM search_records</span><br><span class="line">    GROUP BY content</span><br><span class="line">    ORDER BY count(content) DESC</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SearchRecordsMapper searchRecordsMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHotwords</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> searchRecordsMapper.getHotwords();;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideoService videoService;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/hot"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">hot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(videoService.getHotwords());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="热搜词联调"><a href="#热搜词联调" class="headerlink" title="热搜词联调"></a>热搜词联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...  </span><br><span class="line"><span class="comment">// 2 搜索栏初始化（热搜词）</span></span><br><span class="line">onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 查询热搜词</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl+<span class="string">'/video/hot'</span>,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res);</span><br><span class="line">        <span class="keyword">var</span> hotList = res.data.data;</span><br><span class="line">        <span class="comment">// 搜索栏初始化</span></span><br><span class="line">        WxSearch.init(</span><br><span class="line">          that, <span class="comment">// 本页面一个引用</span></span><br><span class="line">          <span class="comment">// ['慕课网', "小程序", 'SpringBoot', 'linux'], 热点搜索推荐，[]表示不使用</span></span><br><span class="line">          hotList,</span><br><span class="line">          hotList, <span class="comment">// 搜索匹配，[]表示不使用</span></span><br><span class="line">          that.mySearchFunction, <span class="comment">// 提供一个搜索回调函数</span></span><br><span class="line">          that.myGobackFunction <span class="comment">//提供一个返回回调函数</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/20/MicWechat Note-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/20/MicWechat Note-6/" itemprop="url">Wechat Mini | Note-6</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-20T00:00:00+08:00">
                2018-08-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-6"><a href="#微信小程序开发-Note-6" class="headerlink" title="微信小程序开发 Note-6"></a>微信小程序开发 Note-6</h3><p>@ 2018年8月17日 22:51:33</p>
<h4 id="上传短视频业务流程"><a href="#上传短视频业务流程" class="headerlink" title="上传短视频业务流程"></a>上传短视频业务流程</h4><p>用户选择视频（10s限制或即时拍摄）；</p>
<p>BGM选择页面；</p>
<p>选择/不选择，并且输入描述（可为空）；</p>
<p>上传（Controller）；</p>
<p>保存视频截图（封面）；</p>
<p>用户是否选择BGM；</p>
<p>​    -否——直接保存视频；</p>
<p>​    -是——合并视频和BGM成新视频，并保存；</p>
<h4 id="用户选择视频"><a href="#用户选择视频" class="headerlink" title="用户选择视频"></a>用户选择视频</h4><h6 id="wx-chooseVideo-OBJECT"><a href="#wx-chooseVideo-OBJECT" class="headerlink" title="wx.chooseVideo(OBJECT)"></a>wx.chooseVideo(OBJECT)</h6><p>拍摄视频或从手机相册中选视频，返回视频的临时文件路径。</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>sourceType</td>
<td>StringArray</td>
<td>否</td>
<td>album 从相册选视频，camera 使用相机拍摄，默认为：[‘album’, ‘camera’]</td>
</tr>
<tr>
<td>compressed</td>
<td>Boolead</td>
<td>否</td>
<td>是否压缩所选的视频源文件，默认值为true，需要压缩</td>
</tr>
<tr>
<td>maxDuration</td>
<td>Number</td>
<td>否</td>
<td>拍摄视频最长拍摄时间，单位秒。最长支持 60 秒</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功，返回视频文件的临时文件路径，详见返回参数说明</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 视频上传</span></span><br><span class="line">  uploadVideo: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    wx.chooseVideo(&#123;</span><br><span class="line">      sourceType: [<span class="string">'album'</span>],</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res);</span><br><span class="line">        <span class="keyword">var</span> duration = res.duration;</span><br><span class="line">        <span class="keyword">var</span> tempheight = res.height;</span><br><span class="line">        <span class="keyword">var</span> tempwidth = res.width;</span><br><span class="line">        <span class="keyword">var</span> tempVideoUrl = res.tempFilePath;</span><br><span class="line">        <span class="keyword">var</span> tempCoverUrl = res.thumbTempFilePath;</span><br><span class="line">        <span class="keyword">if</span> (duration &gt; <span class="number">11</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'视频长度不能超过10秒'</span>,</span><br><span class="line">            icon: <span class="string">"none"</span>,</span><br><span class="line">            duration: <span class="number">2500</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (duration &lt; <span class="number">3</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'视频长度过短，请上传超过3秒以上的视频'</span>,</span><br><span class="line">            icon: <span class="string">"none"</span>,</span><br><span class="line">            duration: <span class="number">2500</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// TODO 打开BGM选择页面</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="后台BGM列表接口"><a href="#后台BGM列表接口" class="headerlink" title="后台BGM列表接口"></a>后台BGM列表接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BgmServiceImpl</span> <span class="keyword">implements</span> <span class="title">BgmService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> BgmMapper bgmMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Bgm&gt; <span class="title">queryBgmList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> bgmMapper.selectAll();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"BGM API"</span>, tags = &#123;<span class="string">"BGM CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/bgm"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BgmController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> BgmService bgmService;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"GET BGM LIST"</span>, notes = <span class="string">"GET BGM LIST API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(bgmService.queryBgmList());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="BGM页面联调-amp-获取背景音乐列表"><a href="#BGM页面联调-amp-获取背景音乐列表" class="headerlink" title="BGM页面联调 &amp; 获取背景音乐列表"></a>BGM页面联调 &amp; 获取背景音乐列表</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    bgmList: [],</span><br><span class="line">    serverUrl: <span class="string">""</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'加载背景音乐中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/bgm/list'</span>,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> bgmList = res.data.data;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            bgmList: bgmList,</span><br><span class="line">            serverUrl: serverUrl</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">'upload'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">radio-group</span> <span class="attr">name</span>=<span class="string">"bgmId"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;bgmList&#125;&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'container'</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">audio</span> <span class="attr">name</span>=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> <span class="attr">author</span>=<span class="string">"&#123;&#123;item.author&#125;&#125;"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;serverUrl&#125;&#125;&#123;&#123;item.path&#125;&#125;"</span> <span class="attr">style</span>=<span class="string">"width:300px"</span> <span class="attr">id</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">controls</span> <span class="attr">loop</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">radio</span> <span class="attr">style</span>=<span class="string">'margin-top:20px;'</span> <span class="attr">value</span>=<span class="string">''</span>&gt;</span><span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">radio-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="开发上传短视频接口-amp-Swagger测试上传"><a href="#开发上传短视频接口-amp-Swagger测试上传" class="headerlink" title="开发上传短视频接口 &amp; Swagger测试上传"></a>开发上传短视频接口 &amp; Swagger测试上传</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UPLOAD VIDEO"</span>, notes = <span class="string">"UPLOAD VIDEO API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"bgmId"</span>, value = <span class="string">"背景音乐ID"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoSeconds"</span>, value = <span class="string">"视频长度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"double"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoWidth"</span>, value = <span class="string">"视频宽度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"int"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoHeight"</span>, value = <span class="string">"视频高度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"int"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"desc"</span>, value = <span class="string">"视频描述"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/upload"</span>,headers = <span class="string">"content-type=multipart/form-data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">upload</span><span class="params">(String userId, String bgmId,</span></span></span><br><span class="line"><span class="function"><span class="params">								  <span class="keyword">double</span> videoSeconds, <span class="keyword">int</span> videoWidth, <span class="keyword">int</span> videoHeight, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">								  @ApiParam(value = <span class="string">"短视频"</span>,required = <span class="keyword">true</span>)</span> MultipartFile file) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 文件保存的命名空间</span></span><br><span class="line">		String fileSpace = <span class="string">"D:/xxx"</span>;</span><br><span class="line">		<span class="comment">// 保存到数据库中的相对路径</span></span><br><span class="line">		String uploadPathDB = <span class="string">"/"</span> + userId + <span class="string">"/video"</span>;</span><br><span class="line"></span><br><span class="line">		FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">				String fileName = file.getOriginalFilename();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(fileName)) &#123;</span><br><span class="line">					<span class="comment">// 文件上传的最终保存绝对路径</span></span><br><span class="line">					String finalVideoPath = fileSpace + uploadPathDB + <span class="string">"/"</span> + fileName;</span><br><span class="line">					<span class="comment">// 设置数据库保存的路径</span></span><br><span class="line">					uploadPathDB += (<span class="string">"/"</span> + fileName);</span><br><span class="line"></span><br><span class="line">					File outFile = <span class="keyword">new</span> File(finalVideoPath);</span><br><span class="line">					<span class="keyword">if</span> (outFile.getParentFile() != <span class="keyword">null</span> || !outFile.getParentFile().isDirectory()) &#123;</span><br><span class="line">						<span class="comment">// 创建父文件夹</span></span><br><span class="line">						outFile.getParentFile().mkdirs();</span><br><span class="line">					&#125;</span><br><span class="line">					fileOutputStream = <span class="keyword">new</span> FileOutputStream(outFile);</span><br><span class="line">					inputStream = file.getInputStream();</span><br><span class="line">					IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fileOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">				fileOutputStream.flush();</span><br><span class="line">				fileOutputStream.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视频临时参数传入下一个页面"><a href="#视频临时参数传入下一个页面" class="headerlink" title="视频临时参数传入下一个页面"></a>视频临时参数传入下一个页面</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开BGM选择页面</span></span><br><span class="line">wx.navigateTo(&#123;</span><br><span class="line">    url: <span class="string">'../chooseBgm/chooseBgm?duration='</span> + duration </span><br><span class="line">    + <span class="string">"&amp;tempHeight="</span> + tempHeight</span><br><span class="line">    + <span class="string">"&amp;tempWidth="</span> + tempWidth</span><br><span class="line">    + <span class="string">"&amp;tempVideoUrl="</span> + tempVideoUrl</span><br><span class="line">    + <span class="string">"&amp;tempCoverUrl="</span> + tempCoverUrl</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    videoParams:&#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(params);</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">      videoParams:params</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在BGM选择页面，选择BGM后，上传视频</span></span><br><span class="line">  upload:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> bgmId = e.detail.value.bgmId;</span><br><span class="line">    <span class="keyword">var</span> desc = e.detail.value.desc;</span><br><span class="line">    <span class="built_in">console</span>.log(bgmId + <span class="string">"---"</span> + desc);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="小程序上传短视频联调"><a href="#小程序上传短视频联调" class="headerlink" title="小程序上传短视频联调"></a>小程序上传短视频联调</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controler</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UPLOAD VIDEO"</span>, notes = <span class="string">"UPLOAD VIDEO API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"bgmId"</span>, value = <span class="string">"背景音乐ID"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoSeconds"</span>, value = <span class="string">"视频长度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoWidth"</span>, value = <span class="string">"视频宽度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoHeight"</span>, value = <span class="string">"视频高度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"desc"</span>, value = <span class="string">"视频描述"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/upload"</span>,headers = <span class="string">"content-type=multipart/form-data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">upload</span><span class="params">(String userId, String bgmId,</span></span></span><br><span class="line"><span class="function"><span class="params">								  <span class="keyword">double</span> videoSeconds, <span class="keyword">int</span> videoWidth, <span class="keyword">int</span> videoHeight, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">								  @ApiParam(value = <span class="string">"短视频"</span>,required = <span class="keyword">true</span>)</span> MultipartFile file) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 文件保存的命名空间</span></span><br><span class="line">		String fileSpace = <span class="string">"D:/videos_dev_face"</span>;</span><br><span class="line">		<span class="comment">// 保存到数据库中的相对路径</span></span><br><span class="line">		String uploadPathDB = <span class="string">"/"</span> + userId + <span class="string">"/video"</span>;</span><br><span class="line"></span><br><span class="line">		FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">				String fileName = file.getOriginalFilename();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(fileName)) &#123;</span><br><span class="line">					<span class="comment">// 文件上传的最终保存绝对路径</span></span><br><span class="line">					String finalVideoPath = fileSpace + uploadPathDB + <span class="string">"/"</span> + fileName;</span><br><span class="line">					<span class="comment">// 设置数据库保存的路径</span></span><br><span class="line">					uploadPathDB += (<span class="string">"/"</span> + fileName);</span><br><span class="line"></span><br><span class="line">					File outFile = <span class="keyword">new</span> File(finalVideoPath);</span><br><span class="line">					<span class="keyword">if</span> (outFile.getParentFile() != <span class="keyword">null</span> || !outFile.getParentFile().isDirectory()) &#123;</span><br><span class="line">						<span class="comment">// 创建父文件夹</span></span><br><span class="line">						outFile.getParentFile().mkdirs();</span><br><span class="line">					&#125;</span><br><span class="line">					fileOutputStream = <span class="keyword">new</span> FileOutputStream(outFile);</span><br><span class="line">					inputStream = file.getInputStream();</span><br><span class="line">					IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fileOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">				fileOutputStream.flush();</span><br><span class="line">				fileOutputStream.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    bgmList: [],</span><br><span class="line">    serverUrl: <span class="string">""</span>,</span><br><span class="line">    videoParams: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在BGM选择页面，选择BGM后，上传视频</span></span><br><span class="line">  upload: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> bgmId = e.detail.value.bgmId;</span><br><span class="line">    <span class="keyword">var</span> desc = e.detail.value.desc;</span><br><span class="line">    <span class="built_in">console</span>.log(bgmId + <span class="string">"---"</span> + desc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> duration = me.data.videoParams.duration;</span><br><span class="line">    <span class="keyword">var</span> tmpHeight = me.data.videoParams.tmpHeight;</span><br><span class="line">    <span class="keyword">var</span> tmpWidth = me.data.videoParams.tmpWidth;</span><br><span class="line">    <span class="keyword">var</span> tmpVideoUrl = me.data.videoParams.tmpVideoUrl;</span><br><span class="line">    <span class="keyword">var</span> tmpCoverUrl = me.data.videoParams.tmpCoverUrl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(tmpHeight + <span class="string">","</span> + tmpWidth);</span><br><span class="line">    <span class="built_in">console</span>.log(tmpVideoUrl);</span><br><span class="line">    <span class="built_in">console</span>.log(tmpCoverUrl);</span><br><span class="line"></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频上传中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 上传短视频</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.uploadFile(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">"/video/upload"</span>,</span><br><span class="line">      formData: &#123;</span><br><span class="line">        userId: app.userInfo.id,</span><br><span class="line">        bgmId: bgmId,</span><br><span class="line">        videoSeconds: duration,</span><br><span class="line">        videoWidth: tmpHeight,</span><br><span class="line">        videoHeight: tmpWidth,</span><br><span class="line">        desc: desc</span><br><span class="line">      &#125;,</span><br><span class="line">      filePath: tmpVideoUrl,</span><br><span class="line">      name: <span class="string">'file'</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// var data = JSON.parse(res.data);</span></span><br><span class="line">        <span class="built_in">console</span>.log(res);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.status == <span class="number">200</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'视频上传成功'</span>,</span><br><span class="line">            icon: <span class="string">'success'</span>,</span><br><span class="line">            duration: <span class="number">3000</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="FFMPEG"><a href="#FFMPEG" class="headerlink" title="FFMPEG"></a>FFMPEG</h4><p>视音频处理工具；跨平台的视音频处理解决方案；</p>
<p>播放器（暴风）；转码工具（格式工厂）；直播、视频加码、滤镜、水印、特效；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 output.avi</span><br></pre></td></tr></table></figure>
<h4 id="JAVA-amp-FFMPEG"><a href="#JAVA-amp-FFMPEG" class="headerlink" title="JAVA &amp; FFMPEG"></a>JAVA &amp; FFMPEG</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FFMPEGTest</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String ffmpegEXE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FFMPEGTest</span><span class="params">(String ffmpegEXE)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ffmpegEXE = ffmpegEXE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">convertor</span><span class="params">(String videoInputPath, String videoOutputPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">// cmd执行命令</span></span><br><span class="line">		List&lt;String&gt; command = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		command.add(ffmpegEXE);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(videoInputPath);</span><br><span class="line">		command.add(videoOutputPath);</span><br><span class="line">		<span class="comment">// 建立进程cmd</span></span><br><span class="line">		ProcessBuilder builder = <span class="keyword">new</span> ProcessBuilder(command);</span><br><span class="line">		Process process = builder.start();</span><br><span class="line">		<span class="comment">// 关闭流，避免资源浪费</span></span><br><span class="line">		InputStream errorStream = process.getErrorStream();</span><br><span class="line">		InputStreamReader inputStreamReader = <span class="keyword">new</span> InputStreamReader(errorStream);</span><br><span class="line">		BufferedReader br = <span class="keyword">new</span> BufferedReader(inputStreamReader);</span><br><span class="line">		String line = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(br != <span class="keyword">null</span>)&#123;</span><br><span class="line">			br.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(inputStreamReader != <span class="keyword">null</span>)&#123;</span><br><span class="line">			inputStreamReader.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(errorStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">			errorStream.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 执行.exe的路径</span></span><br><span class="line">		FFMPEGTest ffmpeg = <span class="keyword">new</span> FFMPEGTest(<span class="string">"D:\\FFMEPG\\bin\\ffmpeg.exe"</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ffmpeg.convertor(<span class="string">"D:\\test.mp4"</span>, <span class="string">"D:\\done.avi"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FFMPEG操作视频-amp-BGM"><a href="#FFMPEG操作视频-amp-BGM" class="headerlink" title="FFMPEG操作视频 &amp; BGM"></a>FFMPEG操作视频 &amp; BGM</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg.exe -i test.mp4 -i bgm.mp3 -t <span class="number">10</span> -y done.mp4</span><br></pre></td></tr></table></figure>
<h4 id="JAVA合并音视频"><a href="#JAVA合并音视频" class="headerlink" title="JAVA合并音视频"></a>JAVA合并音视频</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在JAVA &amp; FFMPEG的基础上，进行修改即可</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeVideoMp3</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String ffmpegEXE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MergeVideoMp3</span><span class="params">(String ffmpegEXE)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ffmpegEXE = ffmpegEXE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">convertor</span><span class="params">(String videoInputPath, String mp3InputPath, <span class="keyword">double</span> seconds, String videoOutputPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">// cmd执行命令 ffmpeg.exe -i test.mp4 -i bgm.mp3 -t 10 -y done.mp4</span></span><br><span class="line">		List&lt;String&gt; command = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		command.add(ffmpegEXE);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(videoInputPath);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(mp3InputPath);</span><br><span class="line">		command.add(<span class="string">"-t"</span>);</span><br><span class="line">		command.add(String.valueOf(seconds));</span><br><span class="line">		command.add(<span class="string">"-y"</span>);</span><br><span class="line">		command.add(videoOutputPath);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 执行.exe的路径</span></span><br><span class="line">		MergeVideoMp3 ffmpeg = <span class="keyword">new</span> MergeVideoMp3(<span class="string">"D:\\FFMEPG\\bin\\ffmpeg.exe"</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ffmpeg.convertor(<span class="string">"D:\\test.mp4"</span>, <span class="string">"D:\\bgm.mp3"</span>, <span class="number">10</span>, <span class="string">"D:\\done.mp4"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="保存视频信息-amp-数据库"><a href="#保存视频信息-amp-数据库" class="headerlink" title="保存视频信息 &amp; 数据库"></a>保存视频信息 &amp; 数据库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">saveVideo</span><span class="params">(Videos video)</span> </span>&#123;</span><br><span class="line">        video.setId(sid.nextShort());</span><br><span class="line">        videosMapper.insertSelective(video);</span><br><span class="line">        <span class="keyword">return</span> video.getId();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="comment">// 具体代码与头像上传和保存到数据库基本类似；</span></span><br><span class="line"><span class="comment">// 代码过长，不进行发表；</span></span><br><span class="line"><span class="comment">// 详情看github；</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="上传封面图-amp-数据库"><a href="#上传封面图-amp-数据库" class="headerlink" title="上传封面图 &amp; 数据库"></a>上传封面图 &amp; 数据库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateVideo</span><span class="params">(String videoId, String coverPath)</span> </span>&#123;</span><br><span class="line">		Videos video = <span class="keyword">new</span> Videos();</span><br><span class="line">		video.setId(videoId);</span><br><span class="line">		video.setCoverPath(coverPath);</span><br><span class="line">		videosMapper.updateByPrimaryKeySelective(video);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="comment">// 具体代码与头像上传和保存到数据库基本类似；</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideoService videoService;</span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UPLOAD COVER PIC"</span>, notes = <span class="string">"UPLOAD COVER PIC API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoId"</span>, value = <span class="string">"视频ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/uploadCover"</span>, headers = <span class="string">"content-type=multipart/form-data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">uploadCover</span><span class="params">(String userId, String videoId, @ApiParam(value = <span class="string">"封面"</span>, required = <span class="keyword">true</span>)</span> MultipartFile file) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		...</span><br><span class="line">		videoService.updateVideo(videoId,uploadPathDB);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="小程序上传视频业务流程联调"><a href="#小程序上传视频业务流程联调" class="headerlink" title="小程序上传视频业务流程联调"></a>小程序上传视频业务流程联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 封面图上传 补充</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    bgmList: [],</span><br><span class="line">    serverUrl: <span class="string">""</span>,</span><br><span class="line">    videoParams: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在BGM选择页面，选择BGM后，上传视频</span></span><br><span class="line">  upload: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频上传中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 上传短视频</span></span><br><span class="line">      ...</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> videoId = data.data;</span><br><span class="line">          <span class="comment">// 封面图上传</span></span><br><span class="line">          wx.showLoading(&#123;</span><br><span class="line">            title: <span class="string">'封面图上传中'</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          wx.uploadFile(&#123;</span><br><span class="line">            url: serverUrl + <span class="string">"/video/uploadCover"</span>,</span><br><span class="line">            formData: &#123;</span><br><span class="line">              userId: app.userInfo.id,</span><br><span class="line">              videoId: videoId</span><br><span class="line">            &#125;,</span><br><span class="line">            filePath: tmpCoverUrl,</span><br><span class="line">            name: <span class="string">'file'</span>,</span><br><span class="line">            header: &#123;</span><br><span class="line">              <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res.data);</span><br><span class="line">              wx.hideLoading();</span><br><span class="line">              <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">                wx.showToast(&#123;</span><br><span class="line">                  title: <span class="string">'上传成功'</span>,</span><br><span class="line">                  icon: <span class="string">"success"</span></span><br><span class="line">                &#125;);</span><br><span class="line">                wx.navigateBack(&#123;</span><br><span class="line">                  delta: <span class="number">1</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                wx.showToast(&#123;</span><br><span class="line">                  title: <span class="string">'上传失败'</span>,</span><br><span class="line">                  icon: <span class="string">"none"</span></span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'上传失败'</span>,</span><br><span class="line">            icon: <span class="string">"none"</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="联调手机端-amp-坑"><a href="#联调手机端-amp-坑" class="headerlink" title="联调手机端 &amp; 坑"></a>联调手机端 &amp; 坑</h4><p>在使用手机端测试时，res所返回的数据与PC端返回的数据不同；</p>
<p>手机端所返回的数据中，不包含封面图的数据信息；</p>
<p>所以，才用FFMPEG生成截图的方式，生成封面图；</p>
<h4 id="使用FFMPEG生成截图"><a href="#使用FFMPEG生成截图" class="headerlink" title="使用FFMPEG生成截图"></a>使用FFMPEG生成截图</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FetchVideoCover</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 视频路径</span></span><br><span class="line">	<span class="keyword">private</span> String ffmpegEXE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCover</span><span class="params">(String videoInputPath, String coverOutputPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//		ffmpeg.exe -ss 00:00:01 -i spring.mp4 -vframes 1 bb.jpg</span></span><br><span class="line">		List&lt;String&gt; command = <span class="keyword">new</span> java.util.ArrayList&lt;String&gt;();</span><br><span class="line">		command.add(ffmpegEXE);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 指定截取第1秒</span></span><br><span class="line">		command.add(<span class="string">"-ss"</span>);</span><br><span class="line">		command.add(<span class="string">"00:00:01"</span>);</span><br><span class="line"></span><br><span class="line">		command.add(<span class="string">"-y"</span>);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(videoInputPath);</span><br><span class="line"></span><br><span class="line">		command.add(<span class="string">"-vframes"</span>);</span><br><span class="line">		command.add(<span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">		command.add(coverOutputPath);</span><br><span class="line"></span><br><span class="line">		ProcessBuilder builder = <span class="keyword">new</span> ProcessBuilder(command);</span><br><span class="line">		Process process = builder.start();</span><br><span class="line"></span><br><span class="line">		InputStream errorStream = process.getErrorStream();</span><br><span class="line">		InputStreamReader inputStreamReader = <span class="keyword">new</span> InputStreamReader(errorStream);</span><br><span class="line">		BufferedReader br = <span class="keyword">new</span> BufferedReader(inputStreamReader);</span><br><span class="line"></span><br><span class="line">		String line = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">			br.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (inputStreamReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">			inputStreamReader.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (errorStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">			errorStream.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上传视频流程-amp-整合视频截图功能"><a href="#上传视频流程-amp-整合视频截图功能" class="headerlink" title="上传视频流程 &amp; 整合视频截图功能"></a>上传视频流程 &amp; 整合视频截图功能</h4><h4 id="上传流程联调"><a href="#上传流程联调" class="headerlink" title="上传流程联调"></a>上传流程联调</h4><p>在上传视频的同时，制作封面图，并且将封面图的CoverPath存储到数据库即可；</p>
<p>就解决了PC和手机传回数据不同的问题，不再需要二次request的过程；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 产生视频封面</span></span><br><span class="line">FetchVideoCover videoInfo = <span class="keyword">new</span> FetchVideoCover(FFMPEG_EXE);</span><br><span class="line">videoInfo.getCover(finalVideoPath, FILE_SPACE + coverPathDB);</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月19日 19:47:47</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/19/MicWechat Note-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/MicWechat Note-5/" itemprop="url">Wechat Mini | Note-5</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T00:00:00+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-5"><a href="#微信小程序开发-Note-5" class="headerlink" title="微信小程序开发 Note-5"></a>微信小程序开发 Note-5</h3><p>@ 2018年8月17日 15:15:32</p>
<h4 id="注销接口"><a href="#注销接口" class="headerlink" title="注销接口"></a>注销接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"LOGIN &amp; REGISTER API"</span>, tags = &#123;<span class="string">"LOGIN &amp; REGISTER CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistLoginController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"LOGOUT"</span>, notes = <span class="string">"LOGOUT API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">logout</span><span class="params">(String userId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		redis.del(USER_REDIS_SESSION + <span class="string">":"</span> + userId);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"注销成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="注销联调"><a href="#注销联调" class="headerlink" title="注销联调"></a>注销联调</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 注销</span></span><br><span class="line">  logout: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user = app.userInfo;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'注销中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/logout?userId='</span> + user.id,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'注销成功'</span>,</span><br><span class="line">            icon: <span class="string">'success'</span>,</span><br><span class="line">            duration: <span class="number">2000</span></span><br><span class="line">          &#125;);</span><br><span class="line">          app.userInfo = <span class="literal">null</span>;</span><br><span class="line">          <span class="comment">// 页面跳转Login</span></span><br><span class="line">          wx.redirectTo(&#123;</span><br><span class="line">            url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户头像接口"><a href="#用户头像接口" class="headerlink" title="用户头像接口"></a>用户头像接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;	</span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"USER UPLOAD FACE IMG"</span>, notes = <span class="string">"USER UPLOAD FACE IMG API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/uploadFace"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">uploadFace</span><span class="params">(String userId, @RequestParam(<span class="string">"file"</span>)</span> MultipartFile[] files) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 文件保存的命名空间</span></span><br><span class="line">		String fileSpace = <span class="string">"D:/videos_dev_face"</span>;</span><br><span class="line">		<span class="comment">// 保存到数据库中的相对路径</span></span><br><span class="line">		String uploadPathDB = <span class="string">"/"</span> + userId + <span class="string">"/face"</span>;</span><br><span class="line"></span><br><span class="line">		FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (files != <span class="keyword">null</span> &amp;&amp; files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				String fileName = files[<span class="number">0</span>].getOriginalFilename();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(fileName)) &#123;</span><br><span class="line">					<span class="comment">// 文件上传的最终保存绝对路径</span></span><br><span class="line">					String finalFacePath = fileSpace + uploadPathDB + <span class="string">"/"</span> + fileName;</span><br><span class="line">					<span class="comment">// 设置数据库保存的路径</span></span><br><span class="line">					uploadPathDB += (<span class="string">"/"</span> + fileName);</span><br><span class="line"></span><br><span class="line">					File outFile = <span class="keyword">new</span> File(finalFacePath);</span><br><span class="line">					<span class="keyword">if</span> (outFile.getParentFile() != <span class="keyword">null</span> || !outFile.getParentFile().isDirectory()) &#123;</span><br><span class="line">						<span class="comment">// 创建父文件夹</span></span><br><span class="line">						outFile.getParentFile().mkdirs();</span><br><span class="line">					&#125;</span><br><span class="line">					fileOutputStream = <span class="keyword">new</span> FileOutputStream(outFile);</span><br><span class="line">					inputStream = files[<span class="number">0</span>].getInputStream();</span><br><span class="line">					IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(fileOutputStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">				fileOutputStream.flush();</span><br><span class="line">				fileOutputStream.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户头像联调"><a href="#用户头像联调" class="headerlink" title="用户头像联调"></a>用户头像联调</h4><h5 id="wx-chooseImage-OBJECT"><a href="#wx-chooseImage-OBJECT" class="headerlink" title="wx.chooseImage(OBJECT)"></a>wx.chooseImage(OBJECT)</h5><p>从本地相册选择图片或使用相机拍照；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>count</td>
<td>Number</td>
<td>否</td>
<td>最多可以选择的图片张数，默认9</td>
</tr>
<tr>
<td>sizeType</td>
<td>StringArray</td>
<td>否</td>
<td>original 原图，compressed 压缩图，默认二者都有</td>
</tr>
<tr>
<td>sourceType</td>
<td>StringArray</td>
<td>否</td>
<td>album 从相册选图，camera 使用相机，默认二者都有</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>是</td>
<td>成功则返回图片的本地文件路径列表 tempFilePaths</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<h5 id="wx-uploadFile-OBJECT"><a href="#wx-uploadFile-OBJECT" class="headerlink" title="wx.uploadFile(OBJECT)"></a>wx.uploadFile(OBJECT)</h5><p>将本地资源上传到开发者服务器，客户端发起一个 HTTPS POST 请求，其中 <code>content-type</code> 为 <code>multipart/form-data</code> ；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>String</td>
<td>是</td>
<td>开发者服务器 url</td>
</tr>
<tr>
<td>filePath</td>
<td>String</td>
<td>是</td>
<td>要上传文件资源的路径</td>
</tr>
<tr>
<td>name</td>
<td>String</td>
<td>是</td>
<td>文件对应的 key , 开发者在服务器端通过这个 key 可以获取到文件二进制内容</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>否</td>
<td>HTTP 请求 Header, header 中不能设置 Referer</td>
</tr>
<tr>
<td>formData</td>
<td>Object</td>
<td>否</td>
<td>HTTP 请求中其他额外的 form data</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 头像上传</span></span><br><span class="line">  changeFace: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    wx.chooseImage(&#123;</span><br><span class="line">      count: <span class="number">1</span>,</span><br><span class="line">      sizeType: [<span class="string">'compressed'</span>],</span><br><span class="line">      sourceType: [<span class="string">'album'</span>],</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> tempFilePaths = res.tempFilePaths;</span><br><span class="line">        <span class="built_in">console</span>.log(tempFilePaths);</span><br><span class="line"></span><br><span class="line">        wx.showLoading(&#123;</span><br><span class="line">          title: <span class="string">'上传中...'</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上传</span></span><br><span class="line">        <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">        wx.uploadFile(&#123;</span><br><span class="line">          url: serverUrl + <span class="string">"/user/uploadFace?userId="</span> + app.userInfo.id,</span><br><span class="line">          filePath: tempFilePaths[<span class="number">0</span>],</span><br><span class="line">          name: <span class="string">'file'</span>,</span><br><span class="line">          header: &#123;</span><br><span class="line">            <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> data = res.data</span><br><span class="line">            <span class="built_in">console</span>.log(data);</span><br><span class="line">            wx.hideLoading();</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: <span class="string">'头像上传成功'</span>,</span><br><span class="line">              icon:<span class="string">'success'</span>,</span><br><span class="line">              duration:<span class="number">3000</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户头像更新到数据库"><a href="#用户头像更新到数据库" class="headerlink" title="用户头像更新到数据库"></a>用户头像更新到数据库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUserInfo</span><span class="params">(Users user)</span> </span>&#123;</span><br><span class="line">		Example userExample = <span class="keyword">new</span> Example(Users.class);</span><br><span class="line">		Example.Criteria criteria = userExample.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"id"</span>,user.getId());</span><br><span class="line">		userMapper.updateByExampleSelective(user,userExample);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"USER UPLOAD FACE IMG"</span>, notes = <span class="string">"USER UPLOAD FACE IMG API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/uploadFace"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">uploadFace</span><span class="params">(String userId, @RequestParam(<span class="string">"file"</span>)</span> MultipartFile[] files) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isBlank(userId))&#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">// 上传成功,更新数据库头像信息</span></span><br><span class="line">		Users user = <span class="keyword">new</span> Users();</span><br><span class="line">		user.setId(userId);</span><br><span class="line">		user.setFaceImage(uploadPathDB);</span><br><span class="line">		userService.updateUserInfo(user);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="SpringBoot静态资源配置，显示图片"><a href="#SpringBoot静态资源配置，显示图片" class="headerlink" title="SpringBoot静态资源配置，显示图片"></a>SpringBoot静态资源配置，显示图片</h4><p>通过虚拟目录的功能，创建一个配置类，继承<code>WebMvcConfigurerAdapter</code>，重写方法<code>addResourceHandlers</code>；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">      registry.addResourceHandler(<span class="string">"/**"</span>)</span><br><span class="line">      .addResourceLocations(<span class="string">"file:D:/xxx/"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动项目后，即可通过访问<a href="http://localhost:8081/123/face/imooc.jpg的方式，获取到静态资源文件；" target="_blank" rel="noopener">http://localhost:8081/123/face/imooc.jpg的方式，获取到静态资源文件；</a></p>
<p>@问题，配置后，<a href="http://localhost:8081/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8081/swagger-ui.html</a> 无法访问，报404；</p>
<p>需要重新配置；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">		registry.addResourceHandler(<span class="string">"/**"</span>)</span><br><span class="line">				.addResourceLocations(<span class="string">"classpath:/META-INF/resources/"</span>)</span><br><span class="line">				.addResourceLocations(<span class="string">"file:D:/xxx/"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="小程序展示头像以及手机端调试"><a href="#小程序展示头像以及手机端调试" class="headerlink" title="小程序展示头像以及手机端调试"></a>小程序展示头像以及手机端调试</h4><p>现在完成页面访问静态资源文件的功能，既可以完成小程序中展示头像的功能；</p>
<p>在上传完成文件后，并且更新数据库信息，需要给小程序返回相对路径的地址；</p>
<p>@success返回的data并不是JSON格式，而是String类型；</p>
<p>需要将data转换成JSON格式，在小程序前端实现格式化；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res.data);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 获取返回的头像相对路径</span></span><br><span class="line">    <span class="keyword">var</span> imageUrl = data.data;</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        faceUrl: serverUrl + imageUrl</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用预览模式，并且打开调试模式，即可完成效果；</p>
<hr>
<h4 id="查询用户信息接口"><a href="#查询用户信息接口" class="headerlink" title="查询用户信息接口"></a>查询用户信息接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Users <span class="title">queryUserInfo</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">		Example userExample = <span class="keyword">new</span> Example(Users.class);</span><br><span class="line">		Example.Criteria criteria = userExample.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"id"</span>,userId);</span><br><span class="line">		Users user = userMapper.selectOneByExample(userExample);</span><br><span class="line">		<span class="keyword">return</span> user;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"QUERY USER INFORMATION"</span>, notes = <span class="string">"QUERY USER INFORMATION API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/query"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">query</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Users userInfo = userService.queryUserInfo(userId);</span><br><span class="line">		UsersVO usersVO = <span class="keyword">new</span> UsersVO();</span><br><span class="line">		BeanUtils.copyProperties(userInfo, usersVO);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(usersVO);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户信息展示联调"><a href="#用户信息展示联调" class="headerlink" title="用户信息展示联调"></a>用户信息展示联调</h4><p>实现了后台的API后，对小程序进行数据的读取和设置；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> user = app.userInfo;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/user/query?userId='</span> + user.id,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> userInfo = res.data.data;</span><br><span class="line">          <span class="keyword">var</span> faceUrl = <span class="string">"../resource/images/noneface.png"</span>;</span><br><span class="line">          <span class="comment">// 头像判空</span></span><br><span class="line">          <span class="keyword">if</span> (userInfo.faceImage != <span class="literal">null</span> &amp;&amp; userInfo.faceImage != <span class="string">""</span> &amp;&amp; userInfo.faceImage != <span class="literal">undefined</span>) &#123;</span><br><span class="line">            faceUrl = serverUrl + userInfo.faceImage;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 个人信息设置</span></span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            faceUrl: faceUrl,</span><br><span class="line">            fansCounts: userInfo.fansCounts,</span><br><span class="line">            followCounts: userInfo.followCounts,</span><br><span class="line">            receiveLikeCounts: userInfo.receiveLikeCounts,</span><br><span class="line">            nickname: userInfo.nickname</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月17日 22:34:27</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/18/MicWechat Note-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/18/MicWechat Note-4/" itemprop="url">Wechat Mini | Note-4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-18T00:00:00+08:00">
                2018-08-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-4"><a href="#微信小程序开发-Note-4" class="headerlink" title="微信小程序开发 Note-4"></a>微信小程序开发 Note-4</h3><p>@ 2018年8月16日 16:23:30</p>
<hr>
<h4 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h4><p>背景音乐表（bgm）</p>
<p>评论表（comments）</p>
<p>搜索记录（search_records）</p>
<p>用户表（users）</p>
<p>关注（粉丝）表（users_fans）</p>
<p>用户点赞视频表（users_like_videos）</p>
<p>用户举报表（users_report）</p>
<p>视频表（videos）</p>
<hr>
<h4 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h4><p>先进行前端小程序页面的设计，修改工程目录结构，保留必备文件即可；</p>
<p>映入静态资源文件 resource；</p>
<p>将后台项目工程，采用分层的目录结构，方便工程的后期维护和管理；</p>
<hr>
<h4 id="Mybatis逆向生成工具"><a href="#Mybatis逆向生成工具" class="headerlink" title="Mybatis逆向生成工具"></a>Mybatis逆向生成工具</h4><p>这个工具，是生成表的实体对象，实体mapper，以及实体.xml文件的工具；</p>
<p>我觉得这个工具生成的文件和使用的方式，过于相似SSM的开发过程，<code>不推荐使用，由于课程的技术，无法修改</code>；</p>
<p>使用了SpringBoot开发框架的话，应该推荐使用JpaRepository的方式实现与数据持续层的访问；</p>
<p>在搭建分层工程结构的时候，遇到以下问题：</p>
<p>Q:JAR包冲突</p>
<p>A:删除对应JAR包、升级对应JAR包；</p>
<p>Q:由于是分层搭建工程，出现<code>Caused by: java.lang.IllegalStateException: Found multiple @SpringBootConfiguration annotated classes [Generic bean: class [...]; scope=; abstract=false; lazyInit=false; autowireMode=0; dependencyCheck=0; autowireCandidate=true; primary=false; factoryBeanName=null; factoryMethodName=null; initMethodName=null; destroyMethodName=null;</code>这样的错误</p>
<p>A:由于是分层工程，并且是父子关系的pom继承关系，存在@SpringBootTest的class路径的自动查询出现问题，需要在每个子工程的@SpringBootTest中指明明确的class路径；</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideosDevServiceApplicationTests</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修改为</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = VideosDevServiceApplication.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideosDevServiceApplicationTests</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户注册接口"><a href="#用户注册接口" class="headerlink" title="用户注册接口"></a>用户注册接口</h4><p>第一，我为上面说这是一个类似SSM框架不推荐的话，掌嘴；</p>
<p>第二，使用插件（idworker）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegisterLoginController</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterLoginController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/regist"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">regist</span><span class="params">(@RequestBody Users user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1.判断用户名和密码不为空</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(user.getUsername()) || StringUtils.isBlank(user.getPassword())) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户名和密码不能为空"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 2.判断用户是否存在</span></span><br><span class="line">		<span class="keyword">boolean</span> usernameIsExist = userService.queryUsernameIsExist(user.getUsername());</span><br><span class="line">		<span class="keyword">if</span>(!usernameIsExist)&#123;</span><br><span class="line">			user.setNickname(user.getUsername());</span><br><span class="line">			user.setPassword(MD5Utils.getMD5Str(user.getPassword()));</span><br><span class="line">			user.setFansCounts(<span class="number">0</span>);</span><br><span class="line">			user.setReceiveLikeCounts(<span class="number">0</span>);</span><br><span class="line">			user.setFollowCounts(<span class="number">0</span>);</span><br><span class="line">			userService.saveUser(user);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户名已存在"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 3.保存用户,注册信息</span></span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserServiceImpl</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper usersMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">queryUsernameIsExist</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">		Users user = <span class="keyword">new</span> Users();</span><br><span class="line">		user.setUsername(username);</span><br><span class="line">		Users result = usersMapper.selectOne(user);</span><br><span class="line">		<span class="keyword">return</span> result != <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(Users user)</span> </span>&#123;</span><br><span class="line">		user.setId(sid.nextShort());</span><br><span class="line">		usersMapper.insert(user);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Swagger2使用与restful接口测试"><a href="#Swagger2使用与restful接口测试" class="headerlink" title="Swagger2使用与restful接口测试"></a>Swagger2使用与restful接口测试</h4><p>可以生成文档形式的api，并提供给不同的团队；</p>
<p>便于自我测试，也便于查阅；</p>
<p>无须过多冗余的word文档；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * swagger2的配置文件，扫描的包等</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Docket <span class="title">createResApi</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select()</span><br><span class="line">				.apis(RequestHandlerSelectors.basePackage(<span class="string">"top.rex.videos.controller"</span>))</span><br><span class="line">				.paths(PathSelectors.any()).build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建API文档的信息</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder().title(<span class="string">"Swagger API Document"</span>)</span><br><span class="line">				.contact(<span class="keyword">new</span> Contact(<span class="string">"REX"</span>, <span class="string">"https://reeeexchen.github.io/"</span>, <span class="string">"dy708484@163.com"</span>))</span><br><span class="line">				.description(<span class="string">"This Is About The Description"</span>)</span><br><span class="line">				.version(<span class="string">"1.0.0"</span>).build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于Controller的API注释</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"User Login &amp; Register"</span>,tags = &#123;<span class="string">"Login &amp; Register Controller"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterLoginController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"Register"</span>,notes = <span class="string">"Register"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/regist"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">regist</span><span class="params">(@RequestBody Users user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对于Users实体的API注释</span></span><br><span class="line"><span class="meta">@ApiModel</span>(value=<span class="string">"Users Entity"</span>, description=<span class="string">"This Is Users Obj"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Users</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@ApiModelProperty</span>(hidden=<span class="keyword">true</span>)</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"Username"</span>, name=<span class="string">"username"</span>, example=<span class="string">"imoocuser"</span>, required=<span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value=<span class="string">"Password"</span>, name=<span class="string">"password"</span>, example=<span class="string">"123456"</span>, required=<span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@太心累了，用Mybatis配置扫描包的操作，分层工程结构下的包路径，总是出错，无从下手；</p>
<p>@2018年8月17日 13:36:47</p>
<p>从昨晚开始，启动之后做测试，一直报出一个错误</p>
<p><code>[java.lang.IncompatibleClassChangeError: Implementing class]</code></p>
<p>我这个错误有点特殊，跟网上能找到的不一样，弄了4个小时之后，终于解决；</p>
<p>主要的问题依然是jar包；由于之前尝试运行一个含有druid的项目，一直也是类似的错误；</p>
<p>这次对机器上的JAVA进行了升级；</p>
<p><strong>JRE和JDK从1.8.0_111升级到了1.8.0_181（JAVA1.8最新版本），问题解决；</strong></p>
<hr>
<h4 id="用户注册联调"><a href="#用户注册联调" class="headerlink" title="用户注册联调"></a>用户注册联调</h4><h5 id="配置流程"><a href="#配置流程" class="headerlink" title="配置流程"></a>配置流程</h5><p>服务器域名请在 <code>小程序后台-设置-开发设置-服务器域名</code> 中进行配置，配置时需要注意：</p>
<ul>
<li>域名只支持 <code>https</code> (<code>request</code>、<code>uploadFile</code>、<code>downloadFile</code>) 和 <code>wss</code> (<code>connectSocket</code>) 协议；</li>
<li>域名不能使用 IP 地址或 localhost</li>
<li>域名必须经过 ICP 备案；</li>
<li><strong>出于安全考虑，<code>api.weixin.qq.com</code> 不能被配置为服务器域名，相关API也不能在小程序内调用。</strong>开发者应将 appsecret 保存到后台服务器中，通过服务器使用 appsecret 获取 accesstoken，并调用相关 API。</li>
<li>对于每个接口，分别可以配置最多 20 个域名</li>
</ul>
<p><strong>注意将微信开发工具中的，不进行证书校验打开</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  doRegist:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> formObject = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> username = formObject.username;</span><br><span class="line">    <span class="keyword">var</span> password = formObject.password;</span><br><span class="line">    <span class="comment">// 简单的前端验证</span></span><br><span class="line">    <span class="keyword">if</span>(username.length == <span class="number">0</span> || password.length == <span class="number">0</span>)&#123;</span><br><span class="line">      wx.showToast(&#123;</span><br><span class="line">        title: <span class="string">'用户名或密码不能为空'</span>,</span><br><span class="line">        icon:<span class="string">'none'</span>,</span><br><span class="line">        duration:<span class="number">3000</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">       wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'提交中'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        url: serverUrl + <span class="string">'/regist'</span>,</span><br><span class="line">        method:<span class="string">"POST"</span>,</span><br><span class="line">        data:&#123;</span><br><span class="line">          username:username,</span><br><span class="line">          password:password</span><br><span class="line">        &#125;,</span><br><span class="line">        header:&#123;</span><br><span class="line">          <span class="string">'content-type'</span>:<span class="string">'application/json'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(res.data);</span><br><span class="line">          wx.hideLoading();</span><br><span class="line">          <span class="keyword">var</span> status = res.data.status;</span><br><span class="line">          <span class="keyword">if</span>(status == <span class="number">200</span>)&#123;</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: <span class="string">'用户注册成功'</span>,</span><br><span class="line">              icon: <span class="string">'success'</span>,</span><br><span class="line">              duration: <span class="number">3000</span></span><br><span class="line">            &#125;),</span><br><span class="line">            app.userInfo = res.data.data;</span><br><span class="line">          &#125;<span class="keyword">else</span> <span class="keyword">if</span>(status == <span class="number">500</span>)&#123;</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: res.data.msg,</span><br><span class="line">              icon: <span class="string">'none'</span>,</span><br><span class="line">              duration: <span class="number">3000</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Users <span class="title">queryUserForLogin</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">		Example userExample = <span class="keyword">new</span> Example(Users.class);</span><br><span class="line">		Example.Criteria criteria = userExample.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"username"</span>,username);</span><br><span class="line">		criteria.andEqualTo(<span class="string">"password"</span>,password);</span><br><span class="line">		Users result = userMapper.selectOneByExample(userExample);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"LOGIN &amp; REGISTER API"</span>, tags = &#123;<span class="string">"LOGIN &amp; REGISTER CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistLoginController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"LOGIN"</span>, notes = <span class="string">"LOGIN API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">login</span><span class="params">(@RequestBody Users user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String username = user.getUsername();</span><br><span class="line">		String password = user.getPassword();</span><br><span class="line">		<span class="comment">// 1.判断用户名和密码不为空</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(username) || StringUtils.isBlank(password)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户名和密码不能为空"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 2.判断用户是否存在</span></span><br><span class="line">		Users userResult = userService.queryUserForLogin(username,MD5Utils.getMD5Str(password));</span><br><span class="line">		<span class="comment">// 3.返回用户信息</span></span><br><span class="line">		<span class="keyword">if</span>(userResult != <span class="keyword">null</span>)&#123;</span><br><span class="line">			userResult.setPassword(<span class="string">""</span>);</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.ok(userResult);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户名或密码错误，请重试"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 登录</span></span><br><span class="line">  doLogin: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> formObject = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> username = formObject.username;</span><br><span class="line">    <span class="keyword">var</span> password = formObject.password;</span><br><span class="line">    <span class="comment">// 简单的前端验证</span></span><br><span class="line">    <span class="keyword">if</span> (username.length == <span class="number">0</span> || password.length == <span class="number">0</span>) &#123;</span><br><span class="line">      wx.showToast(&#123;</span><br><span class="line">        title: <span class="string">'用户名或密码不能为空'</span>,</span><br><span class="line">        icon: <span class="string">'none'</span>,</span><br><span class="line">        duration: <span class="number">3000</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">      wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'登录中'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// BackEnd</span></span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        url: serverUrl + <span class="string">'/login'</span>,</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">          username: username,</span><br><span class="line">          password: password</span><br><span class="line">        &#125;,</span><br><span class="line">        header: &#123;</span><br><span class="line">          <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(res.data);</span><br><span class="line">          wx.hideLoading();</span><br><span class="line">          <span class="keyword">var</span> status = res.data.status;</span><br><span class="line">          <span class="keyword">if</span> (status == <span class="number">200</span>) &#123;</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: <span class="string">'登录成功'</span>,</span><br><span class="line">              icon: <span class="string">'success'</span>,</span><br><span class="line">              duration: <span class="number">2000</span></span><br><span class="line">            &#125;);</span><br><span class="line">            app.userInfo = res.data.data;</span><br><span class="line">            <span class="comment">// TODO 页面跳转</span></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == <span class="number">500</span>) &#123;</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: res.data.msg,</span><br><span class="line">              icon: <span class="string">'none'</span>,</span><br><span class="line">              duration: <span class="number">3000</span></span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="有状态会话与无状态会话基本概念"><a href="#有状态会话与无状态会话基本概念" class="headerlink" title="有状态会话与无状态会话基本概念"></a>有状态会话与无状态会话基本概念</h4><p>有状态session：每个用户访问都会产生一个session；</p>
<p>无状态session：app的用户访问服务时，不产生session；</p>
<p>redis-session：以通过无状态session，用redis的方式维护一个持续的会话状态；用户访问服务时，将用户的信息以JSON的形式保存到redis的缓存中；</p>
<h5 id="redis-session好处"><a href="#redis-session好处" class="headerlink" title="redis-session好处"></a>redis-session好处</h5><p>用户信息存储到redis缓存中，形成无状态会话；</p>
<p>便于扩展，当单体应用该扩展成集群会更方便；</p>
<p>便于权限认证；</p>
<hr>
<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>之前已经在我的阿里云服务器中搭建过redis-server，在此不再记录，详细参考网上的搭建教程；</p>
<p><strong>基本命令</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli.exe -h xxx.xxx.xxx.xxx -p <span class="number">6379</span> -a xxx</span><br><span class="line">ping</span><br><span class="line">set key value</span><br><span class="line">get key</span><br></pre></td></tr></table></figure>
<h4 id="开发用户redis-session"><a href="#开发用户redis-session" class="headerlink" title="开发用户redis-session"></a>开发用户redis-session</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">public</span> RedisOperator redis;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_REDIS_SESSION = <span class="string">"user-redis-session"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"LOGIN &amp; REGISTER API"</span>, tags = &#123;<span class="string">"LOGIN &amp; REGISTER CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistLoginController</span> <span class="keyword">extends</span> <span class="title">BasicController</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置用户登录与注册的redis-session-token</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userModel</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersVO <span class="title">setUserRedisSessionToken</span><span class="params">(Users userModel)</span></span>&#123;</span><br><span class="line">		<span class="comment">// REDIS SESSION</span></span><br><span class="line">		String uniqueToken = UUID.randomUUID().toString();</span><br><span class="line">		redis.set(USER_REDIS_SESSION + <span class="string">":"</span> + userModel.getId(),uniqueToken,<span class="number">1000</span> * <span class="number">60</span> * <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">		UsersVO usersVO = <span class="keyword">new</span> UsersVO();</span><br><span class="line">		BeanUtils.copyProperties(userModel,usersVO);</span><br><span class="line">		usersVO.setUserToken(uniqueToken);</span><br><span class="line">		<span class="keyword">return</span> usersVO;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月17日 15:15:10</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/17/MicWechat Note-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/17/MicWechat Note-3/" itemprop="url">Wechat Mini | Note-3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-17T00:00:00+08:00">
                2018-08-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-3"><a href="#微信小程序开发-Note-3" class="headerlink" title="微信小程序开发 Note-3"></a>微信小程序开发 Note-3</h3><p>@ 2018年8月16日 11:23:54</p>
<hr>
<h4 id="button"><a href="#button" class="headerlink" title="button"></a>button</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html" target="_blank" rel="noopener">button 按钮</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
<th>生效时机</th>
<th>最低版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>size</td>
<td>String</td>
<td>default</td>
<td>按钮的大小</td>
<td></td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>String</td>
<td>default</td>
<td>按钮的样式类型</td>
<td></td>
<td></td>
</tr>
<tr>
<td>plain</td>
<td>Boolean</td>
<td>false</td>
<td>按钮是否镂空，背景色透明</td>
<td></td>
<td></td>
</tr>
<tr>
<td>disabled</td>
<td>Boolean</td>
<td>false</td>
<td>是否禁用</td>
<td></td>
<td></td>
</tr>
<tr>
<td>loading</td>
<td>Boolean</td>
<td>false</td>
<td>名称前是否带 loading 图标</td>
<td></td>
<td></td>
</tr>
<tr>
<td>form-type</td>
<td>String</td>
<td></td>
<td>用于 <code>&lt;form/&gt;</code> 组件，点击分别会触发 <code>&lt;form/&gt;</code> 组件的 submit/reset 事件</td>
<td></td>
<td></td>
</tr>
<tr>
<td>hover-class</td>
<td>String</td>
<td>button-hover</td>
<td>指定按钮按下去的样式类。当 <code>hover-class=&quot;none&quot;</code> 时，没有点击态效果</td>
<td></td>
<td></td>
</tr>
<tr>
<td>hover-stop-propagation</td>
<td>Boolean</td>
<td>false</td>
<td>指定是否阻止本节点的祖先节点出现点击态</td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<h4 id="checkbox-amp-label"><a href="#checkbox-amp-label" class="headerlink" title="checkbox &amp; label"></a>checkbox &amp; label</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/checkbox.html" target="_blank" rel="noopener">checkbox 多选框</a></p>
<p>checkbox-group    多项选择器，内部由多个checkbox组成；</p>
<p>check双标签自带label ；</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>String</td>
<td></td>
<td><code>&lt;checkbox/&gt;</code>标识，选中时触发<code>&lt;checkbox-group/&gt;</code>的 change 事件，并携带 <code>&lt;checkbox/&gt;</code> 的 value</td>
</tr>
<tr>
<td>disabled</td>
<td>Boolean</td>
<td>false</td>
<td>是否禁用</td>
</tr>
<tr>
<td>checked</td>
<td>Boolean</td>
<td>false</td>
<td>当前是否选中，可用来设置默认选中</td>
</tr>
<tr>
<td>color</td>
<td>Color</td>
<td></td>
<td>checkbox的颜色，同css的color</td>
</tr>
</tbody>
</table>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/label.html" target="_blank" rel="noopener">label 标签</a></p>
<p>用来改进表单组件的可用性，使用<code>for</code>属性找到对应的<code>id</code>，或者将控件放在该标签下，当点击时，就会触发对应的控件；</p>
<p>目前可以绑定的控件有：<code>&lt;button/&gt;</code>, <code>&lt;checkbox/&gt;</code>, <code>&lt;radio/&gt;</code>, <code>&lt;switch/&gt;</code>；</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>for</td>
<td>String</td>
<td>绑定控件的 id</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">id</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;item.value&#125;&#125;"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">checked</span>=<span class="string">"&#123;&#123;item.checked&#125;&#125;"</span> <span class="attr">color</span>=<span class="string">"&#123;&#123;item.color&#125;&#125;"</span> <span class="attr">disabled</span>=<span class="string">"&#123;&#123;item.disabled&#125;&#125;"</span>&gt;</span></span><br><span class="line">      &#123;&#123;item.name&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"1001"</span>&gt;</span>测试点击<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    array: [&#123;</span><br><span class="line">        id:<span class="string">"1001"</span>,</span><br><span class="line">        name: <span class="string">"中国"</span>,</span><br><span class="line">        value: <span class="string">"CHINA"</span>,</span><br><span class="line">        checked: <span class="literal">true</span>,</span><br><span class="line">        color: <span class="string">"red"</span>,</span><br><span class="line">        disabled: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1002"</span>,</span><br><span class="line">        name: <span class="string">"美国"</span>,</span><br><span class="line">        value: <span class="string">"USA"</span>,</span><br><span class="line">        checked: <span class="literal">false</span>,</span><br><span class="line">        color: <span class="string">"blue"</span>,</span><br><span class="line">        disabled: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1003"</span>,</span><br><span class="line">        name: <span class="string">"俄罗斯"</span>,</span><br><span class="line">        value: <span class="string">"RUS"</span>,</span><br><span class="line">        checked: <span class="literal">true</span>,</span><br><span class="line">        color: <span class="string">"pink"</span>,</span><br><span class="line">        disabled: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="submit-amp-reset"><a href="#submit-amp-reset" class="headerlink" title="submit &amp; reset"></a>submit &amp; reset</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/form.html" target="_blank" rel="noopener">form 表单</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>report-submit</td>
<td>Boolean</td>
<td>是否返回 formId 用于发送<a href="https://developers.weixin.qq.com/miniprogram/dev/api/notice.html" target="_blank" rel="noopener">模板消息</a></td>
</tr>
<tr>
<td>bindsubmit</td>
<td>EventHandle</td>
<td>携带 form 中的数据触发 submit 事件，event.detail = {value : {‘name’: ‘value’} , formId: ‘’}</td>
</tr>
<tr>
<td>bindreset</td>
<td>EventHandle</td>
<td>表单重置时会触发 reset 事件</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="input"><a href="#input" class="headerlink" title="input"></a>input</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/input.html" target="_blank" rel="noopener">input 输入框</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>String</td>
<td></td>
<td>输入框的初始内容</td>
</tr>
<tr>
<td>type</td>
<td>String</td>
<td>text</td>
<td>input 的类型</td>
</tr>
<tr>
<td>password</td>
<td>Boolean</td>
<td>false</td>
<td>是否是密码类型</td>
</tr>
<tr>
<td>placeholder</td>
<td>String</td>
<td></td>
<td>输入框为空时占位符</td>
</tr>
<tr>
<td>placeholder-style</td>
<td>String</td>
<td></td>
<td>指定 placeholder 的样式</td>
</tr>
<tr>
<td>placeholder-class</td>
<td>String</td>
<td>“input-placeholder”</td>
<td>指定 placeholder 的样式类</td>
</tr>
<tr>
<td>cursor-spacing</td>
<td>Number</td>
<td>0</td>
<td>指定光标与键盘的距离，单位 px 。取 input 距离底部的距离和 cursor-spacing 指定的距离的最小值作为光标与键盘的距离</td>
</tr>
<tr>
<td>focus</td>
<td>Boolean</td>
<td>false</td>
<td>获取焦点</td>
</tr>
<tr>
<td>confirm-type</td>
<td>String</td>
<td>“done”</td>
<td>设置键盘右下角按钮的文字，仅在type=’text’时生效</td>
</tr>
<tr>
<td>confirm-hold</td>
<td>Boolean</td>
<td>false</td>
<td>点击键盘右下角按钮时是否保持键盘不收起</td>
</tr>
<tr>
<td>selection-start</td>
<td>Number</td>
<td>-1</td>
<td>光标起始位置，自动聚集时有效，需与selection-end搭配使用</td>
</tr>
<tr>
<td>selection-end</td>
<td>Number</td>
<td>-1</td>
<td>光标结束位置，自动聚集时有效，需与selection-start搭配使用</td>
</tr>
<tr>
<td>adjust-position</td>
<td>Boolean</td>
<td>true</td>
<td>键盘弹起时，是否自动上推页面</td>
</tr>
<tr>
<td>bindinput</td>
<td>EventHandle</td>
<td></td>
<td>键盘输入时触发，event.detail = {value, cursor, keyCode}，keyCode 为键值，处理函数可以直接 return 一个字符串，将替换输入框的内容。</td>
</tr>
<tr>
<td>bindfocus</td>
<td>EventHandle</td>
<td></td>
<td>输入框聚焦时触发，event.detail = { value, height }，height 为键盘高度</td>
</tr>
<tr>
<td>bindblur</td>
<td>EventHandle</td>
<td></td>
<td>输入框失去焦点时触发，event.detail = {value: value}</td>
</tr>
<tr>
<td>bindconfirm</td>
<td>EventHandle</td>
<td></td>
<td>点击完成按钮时触发，event.detail = {value: value}</td>
</tr>
</tbody>
</table>
<p><strong>type 有效值：</strong></p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>text</td>
<td>文本输入键盘</td>
</tr>
<tr>
<td>number</td>
<td>数字输入键盘</td>
</tr>
<tr>
<td>idcard</td>
<td>身份证输入键盘</td>
</tr>
<tr>
<td>digit</td>
<td>带小数点的数字键盘</td>
</tr>
</tbody>
</table>
<p><strong>confirm-type 有效值：</strong></p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>send</td>
<td>右下角按钮为“发送”</td>
</tr>
<tr>
<td>search</td>
<td>右下角按钮为“搜索”</td>
</tr>
<tr>
<td>next</td>
<td>右下角按钮为“下一个”</td>
</tr>
<tr>
<td>go</td>
<td>右下角按钮为“前往”</td>
</tr>
<tr>
<td>done</td>
<td>右下角按钮为“完成”</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"学习小程序"</span> <span class="attr">maxlength</span>=<span class="string">'10'</span> <span class="attr">cursor-spacing</span>=<span class="string">'10'</span> <span class="attr">confirm-type</span>=<span class="string">"next"</span> <span class="attr">confirm-hold</span>=<span class="string">"true"</span> <span class="attr">bindinput</span>=<span class="string">'inputEvent'</span> <span class="attr">bindfocus</span>=<span class="string">'focusEvent'</span> <span class="attr">bindblur</span>=<span class="string">'blurEvent'</span> <span class="attr">bindconfirm</span>=<span class="string">'confirmEvent'</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"number"</span> <span class="attr">type</span>=<span class="string">'number'</span> <span class="attr">focus</span>=<span class="string">'true'</span> <span class="attr">selection-start</span>=<span class="string">"2"</span> <span class="attr">selection-end</span>=<span class="string">"4"</span> <span class="attr">adjust-position</span>=<span class="string">"false"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"idcard"</span> <span class="attr">type</span>=<span class="string">'idcard'</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"digit"</span> <span class="attr">type</span>=<span class="string">'digit'</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">密码框：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">password</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">placeholder：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">placeholder</span>=<span class="string">"请输入你的用户名"</span> <span class="attr">placeholder-style</span>=<span class="string">"color:green"</span> <span class="attr">placeholder-class</span>=<span class="string">"placeholder"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  inputEvent: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"inputEvent"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"imooc"</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  focusEvent: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"focusEvent"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  blurEvent: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"blurEvent"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  confirmEvent: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"confirmEvent"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="picker"><a href="#picker" class="headerlink" title="picker"></a>picker</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/picker.html" target="_blank" rel="noopener">picker 选择器</a></p>
<p>从底部弹起的滚动选择器，现支持五种选择器，通过mode来区分，分别是普通选择器，多列选择器，时间选择器，日期选择器，省市区选择器，默认是普通选择器；</p>
<h5 id="普通选择器：mode-selector"><a href="#普通选择器：mode-selector" class="headerlink" title="普通选择器：mode = selector"></a>普通选择器：mode = selector</h5><table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>range</td>
<td>Array / Object Array</td>
<td>[]</td>
<td>mode为 selector 或 multiSelector 时，range 有效</td>
</tr>
<tr>
<td>range-key</td>
<td>String</td>
<td></td>
<td>当 range 是一个 Object Array 时，通过 range-key 来指定 Object 中 key 的值作为选择器显示内容</td>
</tr>
<tr>
<td>bindcancel</td>
<td>EventHandle</td>
<td></td>
<td>取消选择或点遮罩层收起 picker 时触发</td>
</tr>
<tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value: value}</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"selector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span>&gt;</span></span><br><span class="line">  请选择数组</span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"selector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;arrayObj&#125;&#125;"</span> <span class="attr">range-key</span>=<span class="string">"name"</span></span></span><br><span class="line"><span class="tag"><span class="attr">bindcancel</span>=<span class="string">"cancelme"</span> <span class="attr">bindchange</span>=<span class="string">"changeme"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;showme&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data:&#123;</span><br><span class="line">    array:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">0</span>],</span><br><span class="line">    arrayObj:[</span><br><span class="line">      &#123;<span class="attr">id</span>:<span class="string">"1001"</span>,<span class="attr">name</span>:<span class="string">"jack"</span>&#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">"1002"</span>, <span class="attr">name</span>: <span class="string">"tom"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">"1003"</span>, <span class="attr">name</span>: <span class="string">"mary"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">"1004"</span>, <span class="attr">name</span>: <span class="string">"bob"</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="string">"1005"</span>, <span class="attr">name</span>: <span class="string">"peter"</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    showme:<span class="string">"请选择人名"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  changeme:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = e.detail.value;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"value is = "</span> + index);</span><br><span class="line">    <span class="keyword">var</span> id = <span class="keyword">this</span>.data.arrayObj[index].id;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="keyword">this</span>.data.arrayObj[index].name;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      showme:id + name</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  cancelme: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"CANCEL"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="多列选择器：mode-multiSelector"><a href="#多列选择器：mode-multiSelector" class="headerlink" title="多列选择器：mode = multiSelector"></a>多列选择器：mode = multiSelector</h5><table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>range</td>
<td>二维Array / 二维Object Array</td>
<td>[]</td>
<td>mode为 selector 或 multiSelector 时，range 有效。二维数组，长度表示多少列，数组的每项表示每列的数据，如<code>[[&quot;a&quot;,&quot;b&quot;], [&quot;c&quot;,&quot;d&quot;]]</code></td>
</tr>
<tr>
<td>range-key</td>
<td>String</td>
<td></td>
<td>当 range 是一个 二维Object Array 时，通过 range-key 来指定 Object 中 key 的值作为选择器显示内容</td>
</tr>
<tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>value 改变时触发 change 事件，event.detail = {value: value}</td>
</tr>
<tr>
<td>bindcolumnchange</td>
<td>EventHandle</td>
<td></td>
<td>某一列的值改变时触发 columnchange 事件，event.detail = {column: column, value: value}，column 的值表示改变了第几列（下标从0开始），value 的值表示变更值的下标</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'margin-top:150rpx;'</span>&gt;</span>多列选择器<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"multiSelector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;arrayMulti&#125;&#125;"</span>&gt;</span></span><br><span class="line">  请选择数组</span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"multiSelector"</span> <span class="attr">range</span>=<span class="string">"&#123;&#123;arrayObjMulti&#125;&#125;"</span> <span class="attr">range-key</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag"><span class="attr">bindchange</span>=<span class="string">"changemeMulti"</span> <span class="attr">bindcolumnchange</span>=<span class="string">"columnchange"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;showme&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data:&#123;</span><br><span class="line">    arrayMulti:[</span><br><span class="line">      [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>],</span><br><span class="line">      [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>]</span><br><span class="line">    ],</span><br><span class="line">    arrayObjMulti:[</span><br><span class="line">      [</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1001"</span>, <span class="attr">name</span>: <span class="string">"jack"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1002"</span>, <span class="attr">name</span>: <span class="string">"tom"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1003"</span>, <span class="attr">name</span>: <span class="string">"mary"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1004"</span>, <span class="attr">name</span>: <span class="string">"bob"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1005"</span>, <span class="attr">name</span>: <span class="string">"peter"</span> &#125;</span><br><span class="line">      ], [</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1001"</span>, <span class="attr">name</span>: <span class="string">"jack"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1002"</span>, <span class="attr">name</span>: <span class="string">"tom"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1003"</span>, <span class="attr">name</span>: <span class="string">"mary"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1004"</span>, <span class="attr">name</span>: <span class="string">"bob"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">id</span>: <span class="string">"1005"</span>, <span class="attr">name</span>: <span class="string">"peter"</span> &#125;</span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  columnchange:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.detail);</span><br><span class="line">  &#125;,</span><br><span class="line">  changemeMulti:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> indexs = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> arrayObjMulti = <span class="keyword">this</span>.data.arrayObjMulti;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; indexs.length;i++)&#123;</span><br><span class="line">      <span class="keyword">var</span> indexTmp = indexs[i];</span><br><span class="line">      <span class="keyword">var</span> id = arrayObjMulti[i][indexTmp].id;</span><br><span class="line">      <span class="keyword">var</span> name = arrayObjMulti[i][indexTmp].name;</span><br><span class="line">      <span class="built_in">console</span>.log(id + <span class="string">" "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="时间选择器：mode-time"><a href="#时间选择器：mode-time" class="headerlink" title="时间选择器：mode = time"></a>时间选择器：mode = time</h5><table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>String</td>
<td></td>
<td>表示选中的时间，格式为”hh:mm”</td>
</tr>
<tr>
<td>start</td>
<td>String</td>
<td></td>
<td>表示有效时间范围的开始，字符串格式为”hh:mm”</td>
</tr>
<tr>
<td>end</td>
<td>String</td>
<td></td>
<td>表示有效时间范围的结束，字符串格式为”hh:mm”</td>
</tr>
</tbody>
</table>
<h5 id="日期选择器：mode-date"><a href="#日期选择器：mode-date" class="headerlink" title="日期选择器：mode = date"></a>日期选择器：mode = date</h5><table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>String</td>
<td>0</td>
<td>表示选中的日期，格式为”YYYY-MM-DD”</td>
</tr>
<tr>
<td>start</td>
<td>String</td>
<td></td>
<td>表示有效日期范围的开始，字符串格式为”YYYY-MM-DD”</td>
</tr>
<tr>
<td>end</td>
<td>String</td>
<td></td>
<td>表示有效日期范围的结束，字符串格式为”YYYY-MM-DD”</td>
</tr>
<tr>
<td>fields</td>
<td>String</td>
<td>day</td>
<td>有效值 year,month,day，表示选择器的粒度</td>
</tr>
</tbody>
</table>
<p><strong>fields 有效值：</strong></p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>year</td>
<td>选择器粒度为年</td>
</tr>
<tr>
<td>month</td>
<td>选择器粒度为月份</td>
</tr>
<tr>
<td>day</td>
<td>选择器粒度为天</td>
</tr>
</tbody>
</table>
<h5 id="省市区选择器：mode-region"><a href="#省市区选择器：mode-region" class="headerlink" title="省市区选择器：mode = region"></a>省市区选择器：mode = region</h5><table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>Array</td>
<td>[]</td>
<td>表示选中的省市区，默认选中每一列的第一个值</td>
</tr>
<tr>
<td>custom-item</td>
<td>String</td>
<td></td>
<td>可为每一列的顶部添加一个自定义的项</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'margin-top:100rpx;'</span>&gt;</span>时间选择器<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"time"</span> <span class="attr">start</span>=<span class="string">"08:00"</span> <span class="attr">end</span>=<span class="string">"22:00"</span> <span class="attr">bindchange</span>=<span class="string">'changeTime'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>当前选择：&#123;&#123;timeLabel&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'margin-top:100rpx;'</span>&gt;</span>日期选择器<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"date"</span> <span class="attr">start</span>=<span class="string">"2018-03-01"</span> <span class="attr">end</span>=<span class="string">"2018-09-01"</span> <span class="attr">bindchange</span>=<span class="string">'changeDate'</span> <span class="attr">fields</span>=<span class="string">"month"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>当前选择：&#123;&#123;dateLabel&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'margin-top:100rpx;'</span>&gt;</span>城市选择器<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">mode</span>=<span class="string">"region"</span> <span class="attr">bindchange</span>=<span class="string">'changeCity'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>当前选择：&#123;&#123;cityLabel&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data:&#123;</span><br><span class="line">    timeLabel:<span class="string">"null"</span>,</span><br><span class="line">    dateLabel:<span class="string">"null"</span>,</span><br><span class="line">    cityLabel:<span class="string">"null"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  changeTime:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      timeLabel: e.detail.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  changeDate: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      dateLabel: e.detail.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  changeCity: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      cityLabel: e.detail.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="pricker-view"><a href="#pricker-view" class="headerlink" title="pricker-view"></a>pricker-view</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/picker-view.html" target="_blank" rel="noopener">picker-view 嵌入页面的滚动选择器</a></p>
<p>picker-view-column：仅可放置于<picker-view>中，其孩子节点的高度会自动设置成与picker-view的选中框的高度一致；</picker-view></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">picker-view</span> <span class="attr">style</span>=<span class="string">'width:100;height:250rpx;'</span> <span class="attr">bindchange</span>=<span class="string">"changeme"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;year&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;month&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;day&#125;&#125;"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">picker-view-column</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>"Current Value Is : "&#123;&#123;myvalue&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    year: [<span class="number">1990</span>, <span class="number">1995</span>, <span class="number">2000</span>, <span class="number">2005</span>, <span class="number">2010</span>, <span class="number">2015</span>, <span class="number">2020</span>],</span><br><span class="line">    month: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>],</span><br><span class="line">    day: [<span class="number">1</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">30</span>],</span><br><span class="line">    myvalue: <span class="string">"null"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  changeme: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> indexs = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> year = <span class="keyword">this</span>.data.year[indexs[<span class="number">0</span>]];</span><br><span class="line">    <span class="keyword">var</span> month = <span class="keyword">this</span>.data.month[indexs[<span class="number">1</span>]];</span><br><span class="line">    <span class="keyword">var</span> day = <span class="keyword">this</span>.data.day[indexs[<span class="number">2</span>]];</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      myvalue: year + <span class="string">" Y "</span> + month + <span class="string">" M "</span> + day + <span class="string">" D "</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="radio"><a href="#radio" class="headerlink" title="radio"></a>radio</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/radio.html" target="_blank" rel="noopener">radio 单选项</a></p>
<p>radio-group单项选择器，内部由多个<code>&lt;radio/&gt;</code>组成；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">radio-group</span> <span class="attr">class</span>=<span class="string">"radio-group"</span> <span class="attr">bindchange</span>=<span class="string">"radioChange"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"radio"</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;items&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">radio</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;item.checked&#125;&#125;"</span>/&gt;</span>&#123;&#123;item.value&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">radio-group</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    items: [</span><br><span class="line">      &#123;<span class="attr">name</span>: <span class="string">'USA'</span>, <span class="attr">value</span>: <span class="string">'美国'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">name</span>: <span class="string">'CHN'</span>, <span class="attr">value</span>: <span class="string">'中国'</span>, <span class="attr">checked</span>: <span class="string">'true'</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">name</span>: <span class="string">'BRA'</span>, <span class="attr">value</span>: <span class="string">'巴西'</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  radioChange: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'radio发生change事件，携带value值为：'</span>, e.detail.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="slider"><a href="#slider" class="headerlink" title="slider"></a>slider</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/slider.html" target="_blank" rel="noopener">slider 滑动选择器</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>min</td>
<td>Number</td>
<td>0</td>
<td>最小值</td>
</tr>
<tr>
<td>max</td>
<td>Number</td>
<td>100</td>
<td>最大值</td>
</tr>
<tr>
<td>step</td>
<td>Number</td>
<td>1</td>
<td>步长，取值必须大于 0，并且可被(max - min)整除</td>
</tr>
<tr>
<td>color</td>
<td>Color</td>
<td>#e9e9e9</td>
<td>背景条的颜色（请使用 backgroundColor）</td>
</tr>
<tr>
<td>selected-color</td>
<td>Color</td>
<td>#1aad19</td>
<td>已选择的颜色（请使用 activeColor）</td>
</tr>
<tr>
<td>activeColor</td>
<td>Color</td>
<td>#1aad19</td>
<td>已选择的颜色</td>
</tr>
<tr>
<td>backgroundColor</td>
<td>Color</td>
<td>#e9e9e9</td>
<td>背景条的颜色</td>
</tr>
<tr>
<td>block-size</td>
<td>Number</td>
<td>28</td>
<td>滑块的大小，取值范围为 12 - 28</td>
</tr>
<tr>
<td>block-color</td>
<td>Color</td>
<td>#ffffff</td>
<td>滑块的颜色</td>
</tr>
<tr>
<td>show-value</td>
<td>Boolean</td>
<td>false</td>
<td>是否显示当前 value</td>
</tr>
<tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>完成一次拖动后触发的事件，event.detail = {value: value}</td>
</tr>
<tr>
<td>bindchanging</td>
<td>EventHandle</td>
<td></td>
<td>拖动过程中触发的事件，event.detail = {value: value}</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slider</span> <span class="attr">min</span>=<span class="string">'1'</span> <span class="attr">max</span>=<span class="string">'100'</span><span class="attr">show-value</span>=<span class="string">"true"</span> <span class="attr">block-color</span>=<span class="string">'green'</span> <span class="attr">bindchanging</span>=<span class="string">'changing'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">slider</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'background-color:green;width:100%;height:&#123;&#123;myheight&#125;&#125;;'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    myheight:<span class="string">"500rpx"</span> ,</span><br><span class="line">    staticHeight:<span class="number">500</span></span><br><span class="line">  &#125;,</span><br><span class="line">  changing:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> val = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> newHeight = <span class="keyword">this</span>.data.staticHeight * (val / <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      myheight:newHeight + <span class="string">"rpx"</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="swich"><a href="#swich" class="headerlink" title="swich"></a>swich</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/switch.html" target="_blank" rel="noopener">switch 开关选择器</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>checked</td>
<td>Boolean</td>
<td>false</td>
<td>是否选中</td>
</tr>
<tr>
<td>type</td>
<td>String</td>
<td>switch</td>
<td>样式，有效值：switch, checkbox</td>
</tr>
<tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>checked 改变时触发 change 事件，event.detail={ value:checked}</td>
</tr>
<tr>
<td>color</td>
<td>Color</td>
<td></td>
<td>switch 的颜色，同 css 的 color</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"body-view"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">switch</span> <span class="attr">checked</span> <span class="attr">bindchange</span>=<span class="string">"switchChange"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">switch</span> <span class="attr">checked</span> <span class="attr">bindchange</span>=<span class="string">"switchChange"</span> <span class="attr">type</span>=<span class="string">'checkbox'</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">switch</span> <span class="attr">checked</span> <span class="attr">bindchange</span>=<span class="string">"switchChange"</span> <span class="attr">color</span>=<span class="string">'red'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  switchChange: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'switch 发生 change 事件，携带值为'</span>, e.detail.value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="nav-amp-value"><a href="#nav-amp-value" class="headerlink" title="nav &amp; value"></a>nav &amp; value</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/navigator.html" target="_blank" rel="noopener">navigator 页面链接</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>target</td>
<td>String</td>
<td></td>
<td>在哪个目标上发生跳转，默认当前小程序</td>
</tr>
<tr>
<td>url</td>
<td>String</td>
<td></td>
<td>当前小程序内的跳转链接</td>
</tr>
<tr>
<td>open-type</td>
<td>String</td>
<td>navigate</td>
<td>跳转方式</td>
</tr>
<tr>
<td>delta</td>
<td>Number</td>
<td></td>
<td>当 open-type 为 ‘navigateBack’ 时有效，表示回退的层数</td>
</tr>
<tr>
<td>hover-stop-propagation</td>
<td>Boolean</td>
<td>false</td>
<td>指定是否阻止本节点的祖先节点出现点击态</td>
</tr>
</tbody>
</table>
<p><strong>open-type 有效值：</strong></p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>navigate</td>
<td>对应 <code>wx.navigateTo</code> 或 <code>wx.navigateToMiniProgram</code> 的功能</td>
</tr>
<tr>
<td>redirect</td>
<td>对应 <code>wx.redirectTo</code> 的功能</td>
</tr>
<tr>
<td>switchTab</td>
<td>对应 <code>wx.switchTab</code> 的功能</td>
</tr>
<tr>
<td>reLaunch</td>
<td>对应 <code>wx.reLaunch</code> 的功能</td>
</tr>
<tr>
<td>navigateBack</td>
<td>对应 <code>wx.navigateBack</code> 的功能</td>
</tr>
<tr>
<td>exit</td>
<td>退出小程序，target=”miniProgram”时生效</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// page1</span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>This is Page 1<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">url</span>=<span class="string">'../page2/page2?id=1001&amp;name=imooc'</span>&gt;</span>跳转第2页<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">url</span>=<span class="string">'../page3/page3'</span>&gt;</span>跳转第3页<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// page2</span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>This is Page 2<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">url</span>=<span class="string">'../page3/page3'</span>&gt;</span>跳转第3页<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">open-type</span>=<span class="string">'navigateBack'</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// page3</span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>This is Page 3<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">navigator</span> <span class="attr">open-type</span>=<span class="string">'navigateBack'</span> <span class="attr">delta</span>=<span class="string">'2'</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page2</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  onLoad:<span class="function"><span class="keyword">function</span>(<span class="params">params</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(params);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="image-amp-video"><a href="#image-amp-video" class="headerlink" title="image &amp; video"></a>image &amp; video</h4><p>image组件默认宽度300px、高度225px；</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>src</td>
<td>String</td>
<td></td>
<td>图片资源地址</td>
</tr>
<tr>
<td><strong>mode</strong></td>
<td>String</td>
<td>‘scaleToFill’</td>
<td>图片裁剪、缩放的模式</td>
</tr>
<tr>
<td>lazy-load</td>
<td>Boolean</td>
<td>false</td>
<td>图片懒加载。只针对page与scroll-view下的image有效</td>
</tr>
<tr>
<td>bindload</td>
<td>HandleEvent</td>
<td></td>
<td>当图片载入完毕时，发布到 AppService 的事件名，事件对象event.detail = {height:’图片高度px’, width:’图片宽度px’}</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h4><p>小程序不能直接访问后台接口；</p>
<p>通过内网穿透实现暴露到公网；</p>
<p>工具：ngrok（获取安全Token）；</p>
<p>在ngrok目录下执行cmd，完成安装；</p>
<p>执行命令 ngrok http 8080 暴露内网端口到公网中；复制所给的Forwarding网址，即可完成对内网的穿透；</p>
<hr>
<h4 id="wx-request"><a href="#wx-request" class="headerlink" title="wx.request"></a>wx.request</h4><p>通过wx.request(OBJECT)实现小程序和后台API的通信；</p>
<p>类似与HTML中的AJAX通信；</p>
<h4 id="Bug-amp-Tip"><a href="#Bug-amp-Tip" class="headerlink" title="Bug &amp; Tip"></a>Bug &amp; Tip</h4><p><code>tip</code>: content-type 默认为 ‘application/json’;</p>
<p><code>bug</code>: 开发者工具 <code>0.10.102800</code> 版本，<code>header</code> 的 <code>content-type</code> 设置异常；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>String</td>
<td>是</td>
<td></td>
<td>开发者服务器接口地址</td>
</tr>
<tr>
<td>data</td>
<td>Object/String/ArrayBuffer</td>
<td>否</td>
<td></td>
<td>请求的参数</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>否</td>
<td></td>
<td>设置请求的 header，header 中不能设置 Referer。</td>
</tr>
<tr>
<td>method</td>
<td>String</td>
<td>否</td>
<td>GET</td>
<td>（需大写）有效值：OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, CONNECT</td>
</tr>
<tr>
<td>dataType</td>
<td>String</td>
<td>否</td>
<td>json</td>
<td>如果设为json，会尝试对返回的数据做一次 JSON.parse</td>
</tr>
<tr>
<td>responseType</td>
<td>String</td>
<td>否</td>
<td>text</td>
<td>设置响应的数据类型。合法值：text、arraybuffer</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td></td>
<td>收到开发者服务成功返回的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td></td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td></td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<p><strong>success返回参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td>Object/String/ArrayBuffer</td>
<td>开发者服务器返回的数据</td>
</tr>
<tr>
<td>statusCode</td>
<td>Number</td>
<td>开发者服务器返回的 HTTP 状态码</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>开发者服务器返回的 HTTP Response Header</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  clickme:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: <span class="string">'...'</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        id:<span class="number">1001</span>,</span><br><span class="line">        name:<span class="string">"rex"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><h4 id="综合练习"><a href="#综合练习" class="headerlink" title="综合练习"></a>综合练习</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">'submitevent'</span> <span class="attr">style</span>=<span class="string">"font-size: 16px;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">placeholder</span>=<span class="string">'输入用户名'</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">password</span>=<span class="string">'true'</span> <span class="attr">placeholder</span>=<span class="string">'输入密码'</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">checkbox-group</span> <span class="attr">name</span>=<span class="string">"skill"</span> <span class="attr">style</span>=<span class="string">"margin-top:30rpx"</span>&gt;</span>选择技能</span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;skills&#125;&#125;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">id</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123;item.value&#125;&#125;"</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">checkbox-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">picker</span> <span class="attr">name</span>=<span class="string">"birthday"</span> <span class="attr">mode</span>=<span class="string">"date"</span> <span class="attr">start</span>=<span class="string">"1990-01-01"</span> <span class="attr">end</span>=<span class="string">"2018-01-01"</span> <span class="attr">bindchange</span>=<span class="string">'changeDate'</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span>出生日期为：&#123;&#123;dateLabel&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">picker</span> <span class="attr">name</span>=<span class="string">"city"</span> <span class="attr">mode</span>=<span class="string">"region"</span> <span class="attr">bindchange</span>=<span class="string">'changeCity'</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span>所在地区为：&#123;&#123;cityLabel&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">radio-group</span> <span class="attr">name</span>=<span class="string">"sex"</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">radio</span> <span class="attr">value</span>=<span class="string">'男'</span> <span class="attr">checked</span>=<span class="string">'true'</span>&gt;</span>男性<span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">radio</span> <span class="attr">value</span>=<span class="string">'女'</span>&gt;</span>女性<span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">radio-group</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx'</span>&gt;</span></span><br><span class="line">  请选择年龄：</span><br><span class="line">  <span class="tag">&lt;<span class="name">slider</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">'18'</span> <span class="attr">min</span>=<span class="string">'18'</span> <span class="attr">max</span>=<span class="string">'65'</span> <span class="attr">show-value</span>=<span class="string">'true'</span>&gt;</span><span class="tag">&lt;/<span class="name">slider</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">switch</span> <span class="attr">name</span>=<span class="string">"isOK"</span> <span class="attr">checked</span>=<span class="string">'false'</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx'</span>&gt;</span></span><br><span class="line">    个人资料进行保密</span><br><span class="line">  <span class="tag">&lt;/<span class="name">switch</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"remark"</span> <span class="attr">placeholder</span>=<span class="string">'备注信息'</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx;border:1px;border-style:solid;width:90%;height:150rpx;'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">'margin-top:30rpx'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">'mini'</span> <span class="attr">form-type</span>=<span class="string">'submit'</span> <span class="attr">type</span>=<span class="string">'primary'</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">size</span>=<span class="string">'mini'</span> <span class="attr">form-type</span>=<span class="string">'reset'</span> <span class="attr">type</span>=<span class="string">'warn'</span><span class="attr">style</span>=<span class="string">'margin-left:30rpx'</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    skills: [&#123;</span><br><span class="line">        id: <span class="string">"1001"</span>,</span><br><span class="line">        name: <span class="string">"JAVA"</span>,</span><br><span class="line">        value: <span class="string">"java"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1002"</span>,</span><br><span class="line">        name: <span class="string">"HTML"</span>,</span><br><span class="line">        value: <span class="string">"html"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1003"</span>,</span><br><span class="line">        name: <span class="string">"SQL"</span>,</span><br><span class="line">        value: <span class="string">"sql"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1004"</span>,</span><br><span class="line">        name: <span class="string">"DATA"</span>,</span><br><span class="line">        value: <span class="string">"data"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1005"</span>,</span><br><span class="line">        name: <span class="string">"IOS"</span>,</span><br><span class="line">        value: <span class="string">"ios"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        id: <span class="string">"1006"</span>,</span><br><span class="line">        name: <span class="string">"ANDROID"</span>,</span><br><span class="line">        value: <span class="string">"android"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    dateLabel: <span class="string">"null"</span>,</span><br><span class="line">    cityLabel: <span class="string">"null"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  changeDate: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      dateLabel: e.detail.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  changeCity: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      cityLabel: e.detail.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  submitevent:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.detail.value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月16日 16:21:10</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/16/MicWechat Note-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/16/MicWechat Note-2/" itemprop="url">Wechat Mini | Note-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T00:00:00+08:00">
                2018-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-2"><a href="#微信小程序开发-Note-2" class="headerlink" title="微信小程序开发 Note-2"></a>微信小程序开发 Note-2</h3><p>@ 2018年8月15日 20:54:19</p>
<hr>
<h4 id="小程序的flex布局"><a href="#小程序的flex布局" class="headerlink" title="小程序的flex布局"></a>小程序的flex布局</h4><p>小程序建议使用flex布局进行排版（响应式、自适应）；</p>
<p>flex是一个盒装弹性布局（盒子中依然含有多个大小不一的盒子）；</p>
<p>flex是一个容器，所有子元素都是他的成员；</p>
<p>定义布局：<code>display:flex</code></p>
<p>flex容器的属性 <code>flex-direction:排列方向</code>，<code>flex-wrap：换行规则</code> ，<code>justify-content：对齐方式</code>；</p>
<hr>
<h4 id="flex-direction"><a href="#flex-direction" class="headerlink" title="flex-direction"></a>flex-direction</h4><p>row：从左到右            row-reverse：从右到左</p>
<p>column：从上到下        column-reverse：从下到上</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: row;</span><br><span class="line">  <span class="attribute">flex-direction</span>: row-reverse;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">flex-direction</span>: row-lolumn-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="flex-wrap"><a href="#flex-wrap" class="headerlink" title="flex-wrap"></a>flex-wrap</h4><p>nowrap：默认不换行（根据所设置的长度进行压缩</p>
<p>wrap：换行（顶满则换行）        wrap-reverse：倒序换行（从下开始换行）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: nowrap;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: wrap-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="justify-content"><a href="#justify-content" class="headerlink" title="justify-content"></a>justify-content</h4><p>决定内容的对齐方式；</p>
<p>flex-start：左对齐；        flex-end：右对齐；        center：居中对齐；</p>
<p>space-between：从左往右，平均分配，用空格分隔成员 ；</p>
<p>space-around：从左往右，平均分配，用空格包围成员；</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: flex-start;</span><br><span class="line">  <span class="attribute">justify-content</span>: flex-end;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">  <span class="attribute">justify-content</span>: space-around;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="flex成员元素的样式设置"><a href="#flex成员元素的样式设置" class="headerlink" title="flex成员元素的样式设置"></a>flex成员元素的样式设置</h4><p>order：成员之间的显示顺序；</p>
<p>flex：成员所占屏幕的比例（会导致width和height失效，并且将一行按比例分配给每个成员）；</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.a</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: red;</span><br><span class="line">  <span class="attribute">order</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="小程序的组件介绍"><a href="#小程序的组件介绍" class="headerlink" title="小程序的组件介绍"></a>小程序的组件介绍</h4><p>组件是视图层的基本组成单元，多个组件构成一张试图页面；</p>
<p>组件包含&lt;开始标签&gt;&lt;/结束标签&gt;；</p>
<p>每个组件都包含一些共有属性；</p>
<h5 id="属性类型"><a href="#属性类型" class="headerlink" title="属性类型"></a>属性类型</h5><p><code>Boolean</code> <code>Number</code> <code>String</code> <code>Array</code> <code>Object</code> <code>EventHandler 事件处理函数名</code> <code>Any 任意属性</code></p>
<p>共同属性类型</p>
<p><code>id(String)</code> <code>class(String)</code> <code>style(String)</code> <code>hidden(Boolean)</code> <code>data-*(Any)</code> <code>bind*/catch*(EventHandler)</code></p>
<hr>
<h4 id="视图组件-view"><a href="#视图组件-view" class="headerlink" title="视图组件 view"></a>视图组件 view</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/view.html" target="_blank" rel="noopener">视图容器 view</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>hover-class</td>
<td>String</td>
<td>none</td>
<td>指定按下去的样式类。当 <code>hover-class=&quot;none&quot;</code> 时，没有点击态效果</td>
</tr>
<tr>
<td>hover-stop-propagation</td>
<td>Boolean</td>
<td>false</td>
<td>指定是否阻止本节点的祖先节点出现点击态</td>
</tr>
<tr>
<td>hover-start-time</td>
<td>Number</td>
<td>50</td>
<td>按住后多久出现点击态，单位毫秒</td>
</tr>
<tr>
<td>hover-stay-time</td>
<td>Number</td>
<td>400</td>
<td>手指松开后点击态保留时间，单位毫秒</td>
</tr>
</tbody>
</table>
<h4 id="scroll-view-可滚动视图"><a href="#scroll-view-可滚动视图" class="headerlink" title="scroll-view 可滚动视图"></a>scroll-view 可滚动视图</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/scroll-view.html" target="_blank" rel="noopener">scroll-view 可滚动视图区域</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>scroll-x</td>
<td>Boolean</td>
<td>false</td>
<td>允许横向滚动</td>
</tr>
<tr>
<td>scroll-y</td>
<td>Boolean</td>
<td>false</td>
<td>允许纵向滚动</td>
</tr>
<tr>
<td>upper-threshold</td>
<td>Number</td>
<td>50</td>
<td>距顶部/左边多远时（px）,触发 scrolltoupper 事件</td>
</tr>
<tr>
<td>lower-threshold</td>
<td>Number</td>
<td>50</td>
<td>距底部/右边多远时（px）,触发 scrolltolower 事件</td>
</tr>
<tr>
<td>bindscrolltoupper</td>
<td>EventHandle</td>
<td></td>
<td>滚动到顶部/左边,会触发 scrolltoupper 事件</td>
</tr>
<tr>
<td>bindscrolltolower</td>
<td>EventHandle</td>
<td></td>
<td>滚动到底部/右边,会触发 scrolltolower 事件</td>
</tr>
<tr>
<td>scroll-top</td>
<td>Number</td>
<td></td>
<td>设置竖向滚动条的默认位置</td>
</tr>
<tr>
<td>enable-back-to-top</td>
<td>Boolean</td>
<td>false</td>
<td>iOS点击顶部状态栏/安卓双击标题栏时,滚动条返回顶部,只支持竖向</td>
</tr>
<tr>
<td>scroll-with-animation</td>
<td>Boolean</td>
<td>false</td>
<td>在设置滚动条位置时使用动画过渡</td>
</tr>
<tr>
<td>bindscroll</td>
<td>EventHandle</td>
<td></td>
<td>滚动时触发，event.detail = {scrollLeft, scrollTop, scrollHeight, scrollWidth, deltaX, deltaY}</td>
</tr>
<tr>
<td>scroll-into-view</td>
<td>String</td>
<td></td>
<td>值应为某子元素id（id不能以数字开头）.设置哪个方向可滚动，则在哪个方向滚动到该元素</td>
</tr>
<tr>
<td>scroll-left</td>
<td>Number</td>
<td></td>
<td>设置横向滚动条位置</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">!scroll.wxml--</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-y</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">'height:300rpx'</span> <span class="attr">bindscrolltoupper</span>=<span class="string">"scrolltoupper"</span>     <span class="attr">bindscrolltolower</span>=<span class="string">"scrolltolower"</span> <span class="attr">upper-threshold</span>=<span class="string">"0"</span> <span class="attr">lower-threshold</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag"><span class="attr">enable-back-to-top</span>=<span class="string">"true"</span> <span class="attr">scroll-with-animation</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag"><span class="attr">bindscroll</span>=<span class="string">"bindscroll"</span> <span class="attr">scroll-into-view</span>=<span class="string">"e"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"a"</span><span class="attr">class</span>=<span class="string">'a size'</span>&gt;</span>a<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"b"</span><span class="attr">class</span>=<span class="string">'b size'</span>&gt;</span>b<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"c"</span><span class="attr">class</span>=<span class="string">'c size'</span>&gt;</span>c<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"d"</span><span class="attr">class</span>=<span class="string">'d size'</span>&gt;</span>d<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"e"</span><span class="attr">class</span>=<span class="string">'e size'</span>&gt;</span>e<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">scroll-x</span>=<span class="string">"true"</span> <span class="attr">style</span>=<span class="string">'margin-top:250rpx'</span> <span class="attr">scroll-left</span>=<span class="string">"150"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"a"</span><span class="attr">class</span>=<span class="string">'a size'</span>&gt;</span>a<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"b"</span><span class="attr">class</span>=<span class="string">'b size'</span>&gt;</span>b<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"c"</span><span class="attr">class</span>=<span class="string">'c size'</span>&gt;</span>c<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"d"</span><span class="attr">class</span>=<span class="string">'d size'</span>&gt;</span>d<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"e"</span><span class="attr">class</span>=<span class="string">'e size'</span>&gt;</span>e<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//scroll.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data:&#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  scrolltolower:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"滚动到底部"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  scrolltoupper:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"滚动到顶部"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  bindscroll:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"滚动"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**index.wxss**/</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex; <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.size</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">250</span>rpx; <span class="attribute">height</span>: <span class="number">350</span>rpx; <span class="attribute">display</span>: inline-block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.a</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: red; <span class="attribute">order</span>: <span class="number">1</span>; <span class="attribute">flex</span>: <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.b</span> <span class="selector-tag">c</span> <span class="selector-tag">d</span> <span class="selector-tag">e</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="swiper-轮播图"><a href="#swiper-轮播图" class="headerlink" title="swiper 轮播图"></a>swiper 轮播图</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/swiper.html" target="_blank" rel="noopener">swiper 滑块视图容器</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>indicator-dots</td>
<td>Boolean</td>
<td>false</td>
<td>是否显示面板指示点</td>
</tr>
<tr>
<td>autoplay</td>
<td>Boolean</td>
<td>false</td>
<td>是否自动切换</td>
</tr>
<tr>
<td>interval</td>
<td>Number</td>
<td>5000</td>
<td>自动切换时间间隔</td>
</tr>
<tr>
<td>duration</td>
<td>Number</td>
<td>500</td>
<td>滑动动画时长</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="movable-area-movable-view"><a href="#movable-area-movable-view" class="headerlink" title="movable-area/movable-view"></a>movable-area/movable-view</h4><p>movable-view 需要在movable-area成员之间；</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>direction</td>
<td>String</td>
<td>none</td>
<td>movable-view的移动方向，属性值有all、vertical、horizontal、none</td>
</tr>
<tr>
<td>inertia</td>
<td>Boolean</td>
<td>false</td>
<td>movable-view是否带有惯性</td>
</tr>
<tr>
<td>out-of-bounds</td>
<td>Boolean</td>
<td>false</td>
<td>超过可移动区域后，movable-view是否还可以移动</td>
</tr>
<tr>
<td>x/y</td>
<td>Number / String</td>
<td></td>
<td>定义x/y轴方向的偏移，如果x/y的值不在可移动范围内，会自动移动到可移动范围；改变x/y的值会触发动画</td>
</tr>
<tr>
<td>damping</td>
<td>Number</td>
<td>20</td>
<td>阻尼系数，用于控制x或y改变时的动画和过界回弹的动画，值越大移动越快</td>
</tr>
<tr>
<td>friction</td>
<td>Number</td>
<td>2</td>
<td>摩擦系数，用于控制惯性滑动的动画，值越大摩擦力越大，滑动越快停止；必须大于0，否则会被设置成默认值</td>
</tr>
<tr>
<td>scale</td>
<td>Boolean</td>
<td>false</td>
<td>是否支持双指缩放，默认缩放手势生效区域是在movable-view内</td>
</tr>
<tr>
<td>scale-min/max</td>
<td>Number</td>
<td>0.5</td>
<td>定义缩放倍数最小/大值</td>
</tr>
<tr>
<td>bindchange</td>
<td>EventHandle</td>
<td></td>
<td>拖动过程中触发的事件，event.detail = {x: x, y: y, source: source}，其中source表示产生移动的原因，值可为touch（拖动）、touch-out-of-bounds（超出移动范围）、out-of-bounds（超出移动范围后的回弹）、friction（惯性）和空字符串（setData）</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">movable-area</span> <span class="attr">class</span>=<span class="string">"father-size"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">movable-view</span> <span class="attr">class</span>=<span class="string">'e size'</span> <span class="attr">direction</span>=<span class="string">'all'</span> <span class="attr">inertia</span>=<span class="string">'true'</span> <span class="attr">out-of-bounds</span>=<span class="string">'true'</span> <span class="attr">x</span>=<span class="string">'50'</span> <span class="attr">y</span>=<span class="string">'100'</span> <span class="attr">damping</span>=<span class="string">'100'</span> <span class="attr">friction</span>=<span class="string">'60'</span> <span class="attr">bindchange</span>=<span class="string">'doChange'</span> <span class="attr">scale</span>=<span class="string">'true'</span> <span class="attr">bindscale</span>=<span class="string">'doScale'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">movable-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">movable-area</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  doChange:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Moving"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  doScale:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Scaling"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="icon"><a href="#icon" class="headerlink" title="icon"></a>icon</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/icon.html" target="_blank" rel="noopener">icon 图标</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>type</td>
<td>String</td>
<td></td>
<td>icon的类型，有效值：success, success_no_circle, info, warn, waiting, cancel, download, search, clear</td>
</tr>
<tr>
<td>size</td>
<td>Number</td>
<td>23</td>
<td>icon的大小，单位px</td>
</tr>
<tr>
<td>color</td>
<td>Color</td>
<td></td>
<td>icon的颜色，同css的color</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'success'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'success'</span> <span class="attr">size</span>=<span class="string">'66'</span> <span class="attr">color</span>=<span class="string">'blue'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'success_no_circle'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'info'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'warn'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'waiting'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'cancel'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'download'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'search'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span> <span class="attr">type</span>=<span class="string">'clear'</span> <span class="attr">size</span>=<span class="string">'66'</span>&gt;</span><span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="text"><a href="#text" class="headerlink" title="text"></a>text</h4><table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>selectable</td>
<td>Boolean</td>
<td>false</td>
<td>文本是否可选</td>
</tr>
<tr>
<td>space</td>
<td>String</td>
<td>false</td>
<td>显示连续空格</td>
</tr>
<tr>
<td>decode</td>
<td>Boolean</td>
<td>false</td>
<td>是否解码</td>
</tr>
</tbody>
</table>
<h5 id="space-有效值："><a href="#space-有效值：" class="headerlink" title="space 有效值："></a><strong>space 有效值：</strong></h5><table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ensp</td>
<td>中文字符空格一半大小</td>
</tr>
<tr>
<td>emsp</td>
<td>中文字符空格大小</td>
</tr>
<tr>
<td>nbsp</td>
<td>根据字体设置的空格大小</td>
</tr>
</tbody>
</table>
<h5 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>decode可以解析的有 <code>&amp;nbsp;</code> <code>&amp;lt;</code> <code>&amp;gt;</code> <code>&amp;amp;</code> <code>&amp;apos;</code> <code>&amp;ensp;</code> <code>&amp;emsp;</code></li>
<li>各个操作系统的空格标准并不一致。</li>
<li><code>&lt;text/&gt;</code> 组件内只支持 <code>&lt;text/&gt;</code> 嵌套。</li>
<li>除了文本节点以外的其他节点都无法长按选中。</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>this a view text<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">selectable</span>=<span class="string">'true'</span>&gt;</span>this is a text<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">space</span>=<span class="string">'ensp'</span>&gt;</span>this is a spac             e text<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">decode</span>=<span class="string">'true'</span>&gt;</span>&amp;nbsp; &amp;lt; &amp;gt; &amp;amp; &amp;apos; &amp;ensp; &amp;emsp;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="rich-text（富文本）"><a href="#rich-text（富文本）" class="headerlink" title="rich-text（富文本）"></a>rich-text（富文本）</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/rich-text.html" target="_blank" rel="noopener">rich-text 富文本</a></p>
<p>nodes 属性推荐使用 Array 类型，由于组件会将 String 类型转换为 Array 类型，因而性能会有所下降；</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
<th>类型</th>
<th>必填</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>标签名</td>
<td>String</td>
<td>是</td>
<td>支持部分受信任的HTML节点</td>
</tr>
<tr>
<td>attrs</td>
<td>属性</td>
<td>Object</td>
<td>否</td>
<td>支持部分受信任的属性，遵循Pascal命名法</td>
</tr>
<tr>
<td>children</td>
<td>子节点列表</td>
<td>Array</td>
<td>否</td>
<td>结构和nodes一致</td>
</tr>
</tbody>
</table>
<h5 id="Bug-amp-Tip"><a href="#Bug-amp-Tip" class="headerlink" title="Bug &amp; Tip"></a>Bug &amp; Tip</h5><p>nodes 不推荐使用 String 类型，性能会有所下降；</p>
<p><code>rich-text</code> 组件内屏蔽所有节点的事件；</p>
<p>attrs 属性不支持 id ，支持 class ；</p>
<p>name 属性大小写不敏感；</p>
<p>如果使用了不受信任的HTML节点，该节点及其所有子节点将会被移除；</p>
<p>img 标签仅支持网络图片；</p>
<p>如果在自定义组件中使用 <code>rich-text</code> 组件，那么仅自定义组件的 wxss 样式对 <code>rich-text</code> 中的 class 生效；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- String --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rich-text</span> <span class="attr">nodes</span>=<span class="string">'&#123;&#123;mycontent&#125;&#125;'</span>&gt;</span><span class="tag">&lt;/<span class="name">rich-text</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Array --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rich-text</span> <span class="attr">nodes</span>=<span class="string">'&#123;&#123;mycontent2&#125;&#125;'</span>&gt;</span><span class="tag">&lt;/<span class="name">rich-text</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    mycontent: <span class="string">'&lt;img class="course-banner" src="//img3.mukewang.com/szimg/5a9ca4e80001786305400300.jpg"&gt;'</span>,</span><br><span class="line">      </span><br><span class="line">    mycontent2: [&#123;</span><br><span class="line">      name: <span class="string">"img"</span>,</span><br><span class="line">      attrs: &#123;</span><br><span class="line">        class: "course-banner",</span><br><span class="line">        src: <span class="string">"//img3.mukewang.com/szimg/5a9ca4e80001786305400300.jpg"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="progress"><a href="#progress" class="headerlink" title="progress"></a>progress</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/progress.html" target="_blank" rel="noopener">progress 进度条</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>percent</td>
<td>Float</td>
<td>无</td>
<td>百分比0~100</td>
</tr>
<tr>
<td>show-info</td>
<td>Boolean</td>
<td>false</td>
<td>在进度条右侧显示百分比</td>
</tr>
<tr>
<td>stroke-width</td>
<td>Number</td>
<td>6</td>
<td>进度条线的宽度，单位px</td>
</tr>
<tr>
<td>color</td>
<td>Color</td>
<td>#09BB07</td>
<td>进度条颜色 （请使用 activeColor）</td>
</tr>
<tr>
<td>activeColor</td>
<td>Color</td>
<td></td>
<td>已选择的进度条的颜色</td>
</tr>
<tr>
<td>backgroundColor</td>
<td>Color</td>
<td></td>
<td>未选择的进度条的颜色</td>
</tr>
<tr>
<td>active</td>
<td>Boolean</td>
<td>false</td>
<td>进度条从左往右的动画</td>
</tr>
<tr>
<td>active-mode</td>
<td>String</td>
<td>backwards</td>
<td>backwards: 动画从头播；forwards：动画从上次结束点接着播</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">progress</span> <span class="attr">percent</span>=<span class="string">"&#123;&#123;percentdata&#125;&#125;"</span> <span class="attr">show-info</span>=<span class="string">'true'</span> <span class="attr">stroke-width</span>=<span class="string">"20"</span> <span class="attr">color</span>=<span class="string">"orange"</span> <span class="attr">backgroundColor</span>=<span class="string">'white'</span> <span class="attr">active</span>=<span class="string">'true'</span><span class="attr">active-mode</span>=<span class="string">'forwards'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">bindtap</span>=<span class="string">'addPercent'</span>&gt;</span>addPercent<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    percentdata: <span class="number">15</span></span><br><span class="line">  &#125;,</span><br><span class="line">  addPercent: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newPercent = <span class="keyword">this</span>.data.percentdata + <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      percentdata: newPercent</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月16日 11:22:28</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/15/Spring Cloud Note-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/15/Spring Cloud Note-9/" itemprop="url">Spring Cloud | Note-9</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-15T00:00:00+08:00">
                2018-08-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Cloud微服务-Note-9"><a href="#Spring-Cloud微服务-Note-9" class="headerlink" title="Spring Cloud微服务 | Note(9)"></a>Spring Cloud微服务 | Note(9)</h3><p>@ 2018年8月15日 10:19:40</p>
<h4 id="微服务——熔断机制"><a href="#微服务——熔断机制" class="headerlink" title="微服务——熔断机制"></a>微服务——熔断机制</h4><p>当服务过载，流量激增，超过负荷时，掐断服务，保护服务的机制；</p>
<h5 id="什么是服务的熔断机制"><a href="#什么是服务的熔断机制" class="headerlink" title="什么是服务的熔断机制"></a>什么是服务的熔断机制</h5><p>对于系统的防护机制，不会导致服务的不响应，返回默认值，依然保持服务的响应；</p>
<p>对该服务的调用执行熔断，对于后续的请求，不再继续调用该目标服务，而是直接返回默认值，从而快速释放资源；保护系统；</p>
<hr>
<h5 id="熔断的原理（服务熔断）"><a href="#熔断的原理（服务熔断）" class="headerlink" title="熔断的原理（服务熔断）"></a>熔断的原理（服务熔断）</h5><p>断路器：受保护的服务封装在断路器中，当故障达到阈值时，切断服务的响应，由断路器返回响应；</p>
<p>断路器模式：防止应用程序执行可能失败的操作，使应用程序检测故障是否解决；</p>
<p>Microsof Azure 断路器状态：关闭，打开，半打开；</p>
<p>Hystrix：服务正常，服务异常（Fallback）；</p>
<hr>
<h5 id="熔断的意义"><a href="#熔断的意义" class="headerlink" title="熔断的意义"></a>熔断的意义</h5><p>好处：保护系统，系统稳定，减少性能损耗，及时响应（简单的响应），阀值可定制；</p>
<p>功能：异常处理，日志记录，测试失败的操作，手动复位，并发，加速断路，重试失败请求；</p>
<hr>
<h5 id="熔断与降级的区别"><a href="#熔断与降级的区别" class="headerlink" title="熔断与降级的区别"></a>熔断与降级的区别</h5><p>相似：目的一致（可用性，可靠性，保护系统），表现类似（服务暂时不可达），粒度一致（服务级别，DAO）</p>
<p>区别：</p>
<p>​    ·触发条件不同——熔断由服务引起，降级由整体负荷引起；</p>
<p>​    ·管理目标层次不同——熔断管理整个框架级，每个服务都需要，降级管理业务层次；</p>
<hr>
<h5 id="如何集成Hystrix"><a href="#如何集成Hystrix" class="headerlink" title="如何集成Hystrix"></a>如何集成Hystrix</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 依赖</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">	compile(<span class="string">'org.springframework.cloud:spring-cloud-starter-netflix-hystrix'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启用</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixApplication</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(HystrixApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务过载时实现</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CityClient cityClient;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/cities"</span>)</span><br><span class="line">	<span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"defaultCities"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">listCity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 通过Feign客户端来查找</span></span><br><span class="line">		String body = cityClient.listCity();</span><br><span class="line">		<span class="keyword">return</span> body;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">defaultCities</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"服务暂不可用(City Server Is Down)"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="实现微服务的熔断机制"><a href="#实现微服务的熔断机制" class="headerlink" title="实现微服务的熔断机制"></a>实现微服务的熔断机制</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 具体服务中实现熔断</span></span><br><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"micro-weather-eureka-client-zuul"</span>,fallback = DataClientFallback.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataClient</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bean</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataClientFallback</span> <span class="keyword">implements</span> <span class="title">DataClient</span></span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;City&gt; <span class="title">listCity</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 默认响应信息</span></span><br><span class="line">        ...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> WeatherResponse <span class="title">getDataByCityId</span><span class="params">(String cityId)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 默认响应信息</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// application.properties</span></span><br><span class="line">spring.application.name=micro-weather-eureka-client-feign-gateway-hystrix</span><br><span class="line">feign.hystrix.enabled=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="微服务——自动扩展"><a href="#微服务——自动扩展" class="headerlink" title="微服务——自动扩展"></a>微服务——自动扩展</h4><h5 id="什么是自动扩展"><a href="#什么是自动扩展" class="headerlink" title="什么是自动扩展"></a>什么是自动扩展</h5><p>垂直扩展（双核主机 –&gt; 四核主机）硬件升级，瓶颈在于硬件水平的技术；</p>
<p>水平扩展（1台主机 –&gt; x台主机）能力扩展，分布式系统解决计算能力；</p>
<p>自我注册和自我发现是自动扩展的前提条件；</p>
<p>服务注册表（服务注册中心），客户端，微服务实例；</p>
<p>客户端查询服务注册表，查询可用的服务；服务实例启动后，自我注册到服务注册表中，待客户端使用；</p>
<p>按需扩展：微服务实例分为使用中和保留，当需要更多实例时，再启动保留的服务实例，按照请求的需要扩展；</p>
<hr>
<h5 id="自动扩展的意义"><a href="#自动扩展的意义" class="headerlink" title="自动扩展的意义"></a>自动扩展的意义</h5><p>解决应用程序为了支持长时间的运行，需要提前预留硬件、软件的功能，解决闲置资源的浪费问题；</p>
<p>按需扩展；</p>
<p>每个微服务实例需要独立的部署空间；</p>
<h6 id="好处："><a href="#好处：" class="headerlink" title="好处："></a>好处：</h6><p>提供高可用性和容错能力：快速自动扩展使用新的服务实例，以满足服务的需要；</p>
<p>增加可伸缩性：水平扩展能力的增加，允许根据流量自动选择服务的规模；</p>
<p>具有最佳使用率，节约成本：按需扩展；</p>
<p>优先考虑服务或服务组：通过优先级分配资源；</p>
<hr>
<h4 id="自动扩展的常见模式"><a href="#自动扩展的常见模式" class="headerlink" title="自动扩展的常见模式"></a>自动扩展的常见模式</h4><h5 id="应用程序级别"><a href="#应用程序级别" class="headerlink" title="应用程序级别"></a>应用程序级别</h5><p>扩展通过复制微服务实例实现，虚拟机或主机运行微服务；</p>
<p>更换服务实例；</p>
<h5 id="基础架构级别"><a href="#基础架构级别" class="headerlink" title="基础架构级别"></a>基础架构级别</h5><p>根据需求及时创建或消除；</p>
<p>保留的服务实例，被创建为具有预订意义的，服务实例虚拟机镜像，当有服务A的需求时，虚拟机将服务移动到激活的状态；</p>
<p>更换服务虚拟机，适用范围更广；</p>
<p>缺点：基于整个虚拟机扩展，体积更大，占用更多的系统资源；</p>
<p>解决：采用轻量级容器docker，减少资源的占用；</p>
<h5 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h5><p>监控程序：实时监控CPU的使用率，当使用率大于阀值时，启动新的服务实例；</p>
<h5 id="特定时间段"><a href="#特定时间段" class="headerlink" title="特定时间段"></a>特定时间段</h5><p>根据特定时间段、季节性、业务高峰的服务需求，启动新的服务实例，减轻服务器的负载；</p>
<h5 id="消息长度"><a href="#消息长度" class="headerlink" title="消息长度"></a>消息长度</h5><p>监控程序监控每个服务实例的消息队列的长度，当队列长度大于设置的长度时，说明需要处理的消息超过服务可提供的能力，则新增服务实例；</p>
<h5 id="业务参数"><a href="#业务参数" class="headerlink" title="业务参数"></a>业务参数</h5><p>添加实例基于某些业务参数，解决业务事件时，通过先新增服务实例的方法，预防即将到来的大量业务交易请求；</p>
<h5 id="根据预测"><a href="#根据预测" class="headerlink" title="根据预测"></a>根据预测</h5><p>新型的自动扩展方式；</p>
<p>有多种信息事务模式的组合；</p>
<p>有助于解决硬编码和时间窗口；</p>
<p>根据历史信息，当前趋势进行预测（更精确，更有效的解决突发情况）；</p>
<hr>
<h4 id="如何实现微服务的自动扩展"><a href="#如何实现微服务的自动扩展" class="headerlink" title="如何实现微服务的自动扩展"></a>如何实现微服务的自动扩展</h4><h5 id="思考的问题"><a href="#思考的问题" class="headerlink" title="思考的问题"></a>思考的问题</h5><p>如何管理数千个容器？</p>
<p>如何监控容器？</p>
<p>在部署工件时，如何应用规则和约束？</p>
<p>如何利用容器获得资源效率？</p>
<p>如何确保至少有一定数量的最小实例正在运行？</p>
<p>如何确保依赖服务正常运行？</p>
<p>如何进行滚动升级和优雅的迁移？</p>
<p>如何回滚错误的部署？</p>
<h5 id="所需功能"><a href="#所需功能" class="headerlink" title="所需功能"></a>所需功能</h5><p>依赖两个关键功能：</p>
<p>1-一个容器抽象层，在许多物理或虚拟机上提供统一的抽象；</p>
<p>2-容器编排和初始化系统在集群抽象之上智能管理部署</p>
<hr>
<h4 id="容器编排"><a href="#容器编排" class="headerlink" title="容器编排"></a>容器编排</h4><p>为开发以及架构团队，提供一个抽象层，来处理大规模集装箱式的部署；</p>
<p>共同功能：具备发现、资源管理、监控和部署等；</p>
<p>职责：集群管理（将虚拟机和物理机器的集群管理为一台大型机器 ）</p>
<p>自动部署（能处理有大量及其的应用程序和容器的自动部署，支持多版本的应用程序容器，并且支持跨越大量集群机器的滚动升级和故障回滚）</p>
<p>可伸缩性（支持服务实例的自动和手动伸缩，以性能优化为主要目标）</p>
<p>运行状况的健康（管理集群、节点和应用程序的健康）</p>
<p>基础架构抽象（开发人员不需要担心集群和容量等问题）</p>
<p>资源优化（以有效的方式在可用机器上分配容器工作负载，从而减低成本，通过简单到复杂的算法有效提高利用率）</p>
<p>资源分配（基于应用程序开发人员设置的资源可用性和约束来分配服务器）</p>
<p>服务可用性（确保服务在集群中正常运行，机器故障的情况下，容器编排会自动通过在集群中的其他机器上重新启动这些服务来处理故障）</p>
<p>敏捷性（敏捷性工具能够快速分配工作负载到可用资源，或在资源需求发生变化时跨机器移动工作量）</p>
<p>隔离（提供资源隔离，即使应用程序不是容器化，也可以实现资源隔离）</p>
<hr>
<h4 id="资源分配常用算法"><a href="#资源分配常用算法" class="headerlink" title="资源分配常用算法"></a>资源分配常用算法</h4><p>传播（Spread）工作负载平均分配到多台主机中；</p>
<p>装箱（Bin Packing）优先试图填满机器的最大负载，常用于按需付费的云服务；</p>
<p>随机（Random）工作负载随机分配到多台主机中；</p>
<h4 id="常用的容器编排技术"><a href="#常用的容器编排技术" class="headerlink" title="常用的容器编排技术"></a>常用的容器编排技术</h4><p>Docker Swarm</p>
<p>Kubernetes</p>
<p>Apache Mesos</p>
<hr>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>@ 2018年8月15日 14:57:54</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/15/MicWechat Note-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/15/MicWechat Note-1/" itemprop="url">Wechat Mini | Note-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-15T00:00:00+08:00">
                2018-08-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-1"><a href="#微信小程序开发-Note-1" class="headerlink" title="微信小程序开发 Note-1"></a>微信小程序开发 Note-1</h3><p>@ 2018年8月15日 15:46:28</p>
<hr>
<h4 id="微信小程序是什么"><a href="#微信小程序是什么" class="headerlink" title="微信小程序是什么"></a>微信小程序是什么</h4><p>是一种全新的连接用户和服务的方式，可以在微信内便捷的获取和传播，同时具有出色的使用体验；</p>
<p>手机端APP的另一种全新的展现形式；</p>
<p>不是HTML5应用；</p>
<p>无须下载过多占用手机内存的app，即开即用；</p>
<p>必备技术栈：HTML，JS，CSS；</p>
<p>不是所有app都适用于小程序；</p>
<p>基于腾讯庞大的社交群体，为原生APP导流；</p>
<p>创业公司优先推出小程序，开发成本低；</p>
<p>当作简单的工具使用，需要在APP上频繁的CRUD不适用；</p>
<hr>
<h4 id="小程序注册流程"><a href="#小程序注册流程" class="headerlink" title="小程序注册流程"></a>小程序注册流程</h4><p>邮箱，小程序基本设置，开发者设置；</p>
<h4 id="小程序开发"><a href="#小程序开发" class="headerlink" title="小程序开发"></a>小程序开发</h4><h5 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h5><p>下载微信开发工具后，建立快速开发基本模版即可开启第一个小程序项目；</p>
<p>app.js 只有唯一一个；</p>
<p>pages是页面目录；</p>
<p>wxml-html，js-js，wxss-css；</p>
<h5 id="官方demo"><a href="#官方demo" class="headerlink" title="官方demo"></a>官方demo</h5><p><a href="https://developers.weixin.qq.com/miniprogram/dev/demo.html?t=1477656485442" target="_blank" rel="noopener">体验小程序</a></p>
<p>包含了小程序的官方组件以及接口；</p>
<hr>
<h5 id="小程序工程的构成"><a href="#小程序工程的构成" class="headerlink" title="小程序工程的构成"></a>小程序工程的构成</h5><p>基本文件（app.js,app.json,app.wxss）</p>
<p>​    ·app.js 外部全局主要的JS文件，当作一个JS文件的父类</p>
<p>​    ·app.json 全局的配置文件</p>
<p>​    ·app.wxss 全局的页面样式文件</p>
<p>页面文件（Page目录下）</p>
<p>​    `index(index.js，index.wxml，index.wxss，index.json)</p>
<p>​    xxx.js         私有的JS，相当于的子类</p>
<p>​    xxx.json     以json对象形式存在的配置</p>
<p>​    xxx.wxml     页面文件</p>
<p>​    xxx.wxss     私有的页面样式文件</p>
<hr>
<h5 id="第一个小程序demo"><a href="#第一个小程序demo" class="headerlink" title="第一个小程序demo"></a>第一个小程序demo</h5><p>删除部分不需要的文件；</p>
<p>只保留app.js中的部分内容；</p>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">app.json 配置项列表-window</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line">App(&#123;</span><br><span class="line">  onLaunch: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"pages"</span>: [</span><br><span class="line">    <span class="string">"pages/imooc/imooc"</span>,</span><br><span class="line">    <span class="string">"pages/index/index"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"window"</span>: &#123;</span><br><span class="line">    <span class="string">"backgroundTextStyle"</span>: <span class="string">"light"</span>,</span><br><span class="line">    <span class="string">"navigationBarBackgroundColor"</span>: <span class="string">"#fff"</span>,</span><br><span class="line">    <span class="string">"navigationBarTitleText"</span>: <span class="string">"WeChat"</span>,</span><br><span class="line">    <span class="string">"navigationBarTextStyle"</span>: <span class="string">"black"</span></span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="string">"tabBar"</span>: &#123;</span><br><span class="line">    <span class="string">"list"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"pagePath"</span>: <span class="string">"pages/index/index"</span>,</span><br><span class="line">        <span class="string">"text"</span>: <span class="string">"首页"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">在pages，用于描述当前小程序所有页面路径，这是为了让微信客户端知道当前你的小程序页面定义在哪个目；</span><br><span class="line">在pages，设置的第一行，为打开小程序所显示的主页；</span><br><span class="line"></span><br><span class="line">在<span class="built_in">window</span>字段：定义小程序所有页面的顶部背景颜色，文字颜色定义等；</span><br><span class="line"></span><br><span class="line">在tabBar中，暂时为导航栏；</span><br><span class="line">在networkTimeout字段，各类网络请求的超时时间；</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="数据绑定以及CSS文件"><a href="#数据绑定以及CSS文件" class="headerlink" title="数据绑定以及CSS文件"></a>数据绑定以及CSS文件</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">"txt-css"</span>&gt;</span>&#123;&#123;mydata&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">&#123;&#123;xxx&#125;&#125; 数据绑定的用法；</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="comment">//获取应用实例</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    mydata: <span class="string">'Data Bind'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//index.wxss</span><br><span class="line"><span class="selector-class">.txt-css</span>&#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">150</span>rpx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>rpx（responsive pixel）: 可以根据屏幕宽度进行自适应。规定屏幕宽为750rpx。如在 iPhone6 上，屏幕宽度为375px，共有750个物理像素，则750rpx = 375px = 750物理像素，1rpx = 0.5px = 1物理像素。</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//外部css文件导入 以及 内联样式</span><br><span class="line">@<span class="keyword">import</span> <span class="string">"out.wxss"</span>;</span><br><span class="line"><span class="selector-class">.txt-css</span>&#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">150</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line">// out.wxss</span><br><span class="line"><span class="selector-class">.txt-left</span>&#123;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">350</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;!<span class="selector-tag">--index</span><span class="selector-class">.wxml--</span>&gt;</span><br><span class="line">&lt;view class="container"&gt;</span><br><span class="line">  &lt;text class="txt-css txt-left" style="color:&#123;&#123;color&#125;&#125;;"&gt;&#123;&#123;mydata&#125;&#125;&lt;/text&gt;</span><br><span class="line">&lt;/view&gt;</span><br><span class="line"></span><br><span class="line">//index.js</span><br><span class="line">//获取应用实例</span><br><span class="line"><span class="selector-tag">Page</span>(&#123;</span><br><span class="line">  <span class="attribute">data</span>: &#123;</span><br><span class="line">    mydata: <span class="string">'Data Bind'</span>,</span><br><span class="line">    color:  <span class="string">"red"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="selector-tag">onLoad</span><span class="selector-pseudo">:function()</span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="小程序页面加载"><a href="#小程序页面加载" class="headerlink" title="小程序页面加载"></a>小程序页面加载</h5><p>默认加载pages中的第一个目录；</p>
<p>其他目录需要通过触发才能加载；</p>
<hr>
<h5 id="小程序APP的生命周期"><a href="#小程序APP的生命周期" class="headerlink" title="小程序APP的生命周期"></a>小程序APP的生命周期</h5><p>onLaunch：初始化事件，只被执行一次；</p>
<p>onShow：随着onLaunch触发，打开到小程序前台触发的事件；</p>
<p>onHide：小程序随着前台到后台的转变，隐藏到后台的触发事件；</p>
<p>onError：抛出异常时触发的事件；</p>
<p>其他：开发人员定义的事件；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line">App(&#123;</span><br><span class="line">  onLaunch: <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"触发onLaunch"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  onShow: <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"触发onShow"</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  onHide: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something when hide.</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onError: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(msg)</span><br><span class="line">  &#125;,</span><br><span class="line">  globalData: <span class="string">'I am global data'</span>,</span><br><span class="line">  courseName: <span class="string">'小程序'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局的 getApp() 函数可以用来获取到小程序实例</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    mydata: <span class="string">'imooc Bind'</span>,</span><br><span class="line">    color: <span class="string">"green"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> appInstance = getApp()</span><br><span class="line">    <span class="built_in">console</span>.log(appInstance.courseName)</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      mydata: appInstance.courseName</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="手机端的远程调试"><a href="#手机端的远程调试" class="headerlink" title="手机端的远程调试"></a>手机端的远程调试</h4><p>进行手机上的远程调试（debug）时，需要在创建工程时，填上AppID；</p>
<p>使用手机扫描小程序开发根据提供的预览和远程调试的功能；</p>
<hr>
<h4 id="私有页面的生命周期以及导航"><a href="#私有页面的生命周期以及导航" class="headerlink" title="私有页面的生命周期以及导航"></a>私有页面的生命周期以及导航</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/page.html#pageprototyperoute" target="_blank" rel="noopener">注册页面，生命周期回调函数</a></p>
<p>onLoad(Object query)    页面加载时触发</p>
<p>onShow()            页面显示/切入前台时触发</p>
<p>onReady()            页面初次渲染完成时触发</p>
<p>onHide()                页面隐藏/切入后台时触发</p>
<p>onUnload()            页面卸载时触发</p>
<p>关于onHide和onUnload，联系到两个API wx.redirectTo(OBJECT) 和 wx.navigateTo(OBJECT)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在页面中写入一个clickMe的点击事件；</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  clickMe:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.navigateTo(&#123;</span><br><span class="line">      url: <span class="string">'../index/index'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">	wx.redirectTo(&#123;</span><br><span class="line">      url: <span class="string">'../index/index'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 注意事项1 url的路径问题，明确相对路径和绝对路径；</span></span><br><span class="line"><span class="comment">// 当跳转当另一页面，点击返回时，只触发了onShow事件，没有触发onLaunch和onReady事件；</span></span><br><span class="line"><span class="comment">// redirectTo事件，触发onUnload事件；</span></span><br><span class="line"><span class="comment">// 注意事项2 减少使用navigateTo，防止onHide消耗过多的资源；</span></span><br></pre></td></tr></table></figure>
<p><img src="https://developers.weixin.qq.com/miniprogram/dev/image/mina-lifecycle.png?t=18081511" alt=""></p>
<hr>
<h4 id="小程序的事件触发"><a href="#小程序的事件触发" class="headerlink" title="小程序的事件触发"></a>小程序的事件触发</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html" target="_blank" rel="noopener">事件</a></p>
<p>通过行为进行的人机交互的方式；</p>
<p>类似html中<code>onClick</code>和<code>onChange</code>事件等；</p>
<p>如<code>bindtap</code>，当用户点击该组件的时候会在该页面对应的Page中找到相应的事件处理函数。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- event.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">id</span>=<span class="string">"tapTest"</span> <span class="attr">bindtap</span>=<span class="string">"clickMe"</span>&gt;</span> Click me! <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  clickMe: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Click Me Was Clicked"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="事件分类"><a href="#事件分类" class="headerlink" title="事件分类"></a>事件分类</h5><p>事件分为<code>冒泡事件</code>和<code>非冒泡事件</code></p>
<p>​    ·冒泡事件：当一个组件上的事件被触发后，该事件会向父节点传递；</p>
<p>​    ·非冒泡事件：当一个组件上的事件被触发后，该事件不会向父节点传递；</p>
<hr>
<h4 id="小程序的模块化"><a href="#小程序的模块化" class="headerlink" title="小程序的模块化"></a>小程序的模块化</h4><p>抽离通用方法作为通用函数；</p>
<p>构建<code>utils-common</code>类；</p>
<p>可以将一些公共的代码抽离成为一个单独的 js 文件，作为一个模块。模块只有通过 <code>module.exports</code> 或者 <code>exports</code> 才能对外暴露接口；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hello '</span> + name + <span class="string">'!'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayGoodbye</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Goodbye <span class="subst">$&#123;name&#125;</span> !`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 区别单引号''和反引号``</span></span><br><span class="line"><span class="built_in">module</span>.exports.sayHello = sayHello</span><br><span class="line">exports.sayGoodbye = sayGoodbye</span><br></pre></td></tr></table></figure>
<p>在需要使用这些模块的文件中，使用 <code>require(path)</code> 将公共代码引入 ；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> common = <span class="built_in">require</span>(<span class="string">'common.js'</span>)</span><br><span class="line">Page(&#123;</span><br><span class="line">  helloMINA: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    common.sayHello(<span class="string">'MINA'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  goodbyeMINA: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    common.sayGoodbye(<span class="string">'MINA'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视图层——数据绑定"><a href="#视图层——数据绑定" class="headerlink" title="视图层——数据绑定"></a>视图层——数据绑定</h4><p>HTML中，JQuery dom操作 $选择器；</p>
<p>WX中，通过数据绑定 类似于vue/react，通过Mustache表达式；</p>
<p>作用范围：内容，组件属性（双引号内），控制属性（双引号内），关键字（双引号内）；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--pages/dataBind/dataBind.wxml--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'container'</span> <span class="attr">id</span>=<span class="string">"myid-&#123;&#123;testid&#125;&#125;"</span>&gt;</span></span><br><span class="line">&#123;&#123;msg&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;true&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;false&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;flag&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checkbox</span> <span class="attr">checked</span>=<span class="string">"&#123;&#123;unflag&#125;&#125;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">checkbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/dataBind/dataBind.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    msg:<span class="string">"这是一个msg"</span>,</span><br><span class="line">    testid:<span class="number">1001</span>,</span><br><span class="line">    flag:<span class="literal">true</span>,</span><br><span class="line">    unflag:<span class="literal">false</span>,</span><br><span class="line">    a:<span class="number">1</span>,</span><br><span class="line">    b:<span class="number">2</span>,</span><br><span class="line">    c:<span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 三元运算 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">hidden</span>=<span class="string">"&#123;&#123;flag ? true : false&#125;&#125;"</span>&gt;</span> Hidden <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 算数运算 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span> &#123;&#123;a + b&#125;&#125; + &#123;&#123;c&#125;&#125; + d <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">view中的内容为 3 + 3 + d</span><br><span class="line"><span class="comment">&lt;!-- 字符串运算 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;msg + hello + "test"&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">view中内容为 这是一个msghellotest</span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;a+b + hello&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">view中内容为 3hello</span><br></pre></td></tr></table></figure>
<h4 id="视图层——列表渲染"><a href="#视图层——列表渲染" class="headerlink" title="视图层——列表渲染"></a>视图层——列表渲染</h4><p>wx:key</p>
<p>如果列表中项目的位置会动态改变或者有新的项目添加到列表中，并且希望列表中的项目保持自己的特征和状态</p>
<p><code>wx:key</code> 的值以两种形式提供</p>
<ol>
<li>字符串，代表在 for 循环的 array 中 item 的某个 property，该 property 的值需要是列表中唯一的字符串或数字，且不能动态改变。</li>
<li>保留关键字 <code>*this</code> 代表在 for 循环中的 item 本身，这种表示需要 item 本身是一个唯一的字符串或者数字，如：</li>
</ol>
<p>当数据改变触发渲染层重新渲染的时候，会校正带有 key 的组件，框架会确保他们被重新排序，而不是重新创建，以确保使组件保持自身的状态，并且提高列表渲染时的效率</p>
<h4 id="视图层——条件渲染"><a href="#视图层——条件渲染" class="headerlink" title="视图层——条件渲染"></a>视图层——条件渲染</h4><h5 id="wx-if"><a href="#wx-if" class="headerlink" title="wx:if"></a>wx:if</h5><p>在框架中，使用 <code>wx:if=&quot;&quot;</code> 来判断是否需要渲染该代码块，也可以用 <code>wx:elif</code> 和 <code>wx:else</code> 来添加一个 else 块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view wx:if=&quot;&#123;&#123;length &gt; 5&#125;&#125;&quot;&gt; 1 &lt;/view&gt;</span><br><span class="line">&lt;view wx:elif=&quot;&#123;&#123;length &gt; 2&#125;&#125;&quot;&gt; 2 &lt;/view&gt;</span><br><span class="line">&lt;view wx:else&gt; 3 &lt;/view&gt;</span><br></pre></td></tr></table></figure>
<h5 id="block-wx-if"><a href="#block-wx-if" class="headerlink" title="block wx:if"></a>block wx:if</h5><p>因为 <code>wx:if</code> 是一个控制属性，需要将它添加到一个标签上。如果要一次性判断多个组件标签，可以使用一个 <code>&lt;block/&gt;</code> 标签将多个组件包装起来，并在上边使用 <code>wx:if</code> 控制属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;block wx:if=&quot;&#123;&#123;true&#125;&#125;&quot;&gt;</span><br><span class="line">  &lt;view&gt; view1 &lt;/view&gt;</span><br><span class="line">  &lt;view&gt; view2 &lt;/view&gt;</span><br><span class="line">&lt;/block&gt;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> <code>&lt;block/&gt;</code> 并不是一个组件，它仅仅是一个包装元素，不会在页面中做任何渲染，只接受控制属性。</p>
<h5 id="wx-if-vs-hidden"><a href="#wx-if-vs-hidden" class="headerlink" title="wx:if vs hidden"></a><code>wx:if</code> vs <code>hidden</code></h5><p>因为 <code>wx:if</code> 之中的模板也可能包含数据绑定，所以当 <code>wx:if</code> 的条件值切换时，框架有一个局部渲染的过程，因为它会确保条件块在切换时销毁或重新渲染。</p>
<p>同时 <code>wx:if</code> 也是<strong>惰性的</strong>，如果在初始渲染条件为 <code>false</code>，框架什么也不做，在条件第一次变成真的时候才开始局部渲染</p>
<p>相比之下，<code>hidden</code> 就简单的多，组件始终会被渲染，只是简单的控制显示与隐藏</p>
<p>一般来说，<code>wx:if</code> 有更高的切换消耗而 <code>hidden</code> 有更高的初始渲染消耗。因此，如果需要频繁切换的情景下，用 <code>hidden</code> 更好，如果在运行时条件不大可能改变则 <code>wx:if</code> 较好</p>
<hr>
<h4 id="通用模板的使用"><a href="#通用模板的使用" class="headerlink" title="通用模板的使用"></a>通用模板的使用</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义模板</span></span><br><span class="line"><span class="comment">使用 name 属性，作为模板的名字。然后在&lt;template/&gt;内定义代码片段--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"mytemp"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>姓名：&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>年龄：&#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>地址：&#123;&#123;address&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>备注：&#123;&#123;remark&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 使用模板</span></span><br><span class="line"><span class="comment">is 属性，声明需要的使用的模板，然后将模板所需要的 data 传入</span></span><br><span class="line"><span class="comment">is 属性可以使用 Mustache 语法，来动态决定具体需要渲染哪个模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'container'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"mytemp"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;...person,msg,name:'rex',age:'18'&#125;&#125;"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">is</span>=<span class="string">"mytemp"</span> <span class="attr">data</span>=<span class="string">"&#123;&#123;...person,msg,name:'rex',age:'18'&#125;&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--temp.js--&gt;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    person:&#123;</span><br><span class="line">      address:"BEIJING",</span><br><span class="line">      remark:"This is a Template"</span><br><span class="line">    &#125;,</span><br><span class="line">    msg:"This is a Msg"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="wxs模块——页面引用-模块调用模块"><a href="#wxs模块——页面引用-模块调用模块" class="headerlink" title="wxs模块——页面引用/模块调用模块"></a>wxs模块——页面引用/模块调用模块</h4><p>WXS（WeiXin Script）是小程序的一套脚本语言，结合 WXML，可以构建出页面的结构；</p>
<p>wxs 不依赖于运行时的基础库版本，可以在所有版本的小程序中运行；<br>wxs 与 javascript 是不同的语言，有自己的语法，并不和 javascript 一致；<br>wxs 的运行环境和其他 javascript 代码是隔离的，wxs 中不能调用其他 javascript 文件中定义的函数，也不能调用小程序提供的API；<br>wxs 函数不能作为组件的事件回调；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module.wxs</span></span><br><span class="line"><span class="keyword">var</span> num2 = <span class="built_in">require</span>(<span class="string">"../wxs/num2.wxs"</span>);</span><br><span class="line"><span class="keyword">var</span> name = <span class="string">'imooc'</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">var</span> method = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(num2.name);</span><br><span class="line">  <span class="built_in">console</span>.log(num2.age);</span><br><span class="line">  <span class="built_in">console</span>.log(num2.method(<span class="string">"num2"</span>));</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  name: name,</span><br><span class="line">  age: age,</span><br><span class="line">  method: method</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// num2.wxs</span></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">'imooc2'</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> method = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  name: name,</span><br><span class="line">  age: age,</span><br><span class="line">  method: method</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// wxs.wxml</span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 页面级别的引用 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">wxs</span> <span class="attr">src</span>=<span class="string">"../wxs/module.wxs"</span> <span class="attr">module</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">wxs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;item.age&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span>&gt;</span>&#123;&#123;item.method("这是一个参数")&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="模版的外部引用"><a href="#模版的外部引用" class="headerlink" title="模版的外部引用"></a>模版的外部引用</h4><p>模版在某个wxml中定义完毕后，可以被其他页面引用；</p>
<p>关键字import；</p>
<p>import 有作用域的概念，即只会 import 目标文件中定义的 template，而不会 import 目标文件 import 的 template，即不支持间接传递引用（A引用B，B引用C，A不能引用C）； </p>
<p>WXML 提供两种文件引用方式<code>import</code>和<code>include</code>；</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;view <span class="class"><span class="keyword">class</span></span>=<span class="string">"container"</span>&gt;</span><br><span class="line">&lt;!-- 模版的外部引用 --&gt;</span><br><span class="line">  &lt;<span class="keyword">import</span> src=<span class="string">"../temp/temp.wxml"</span>/&gt;</span><br><span class="line">  &lt;template is=<span class="string">"mytemp"</span> data=<span class="string">"&#123;&#123;name:'imooc',age:'18',...person,msg&#125;&#125;"</span>/&gt;</span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="页面引用外部wxml通用页面"><a href="#页面引用外部wxml通用页面" class="headerlink" title="页面引用外部wxml通用页面"></a>页面引用外部wxml通用页面</h4><p>HTML页面常分为Header，Body，Footer；</p>
<p>定义通用的Header和Footer；</p>
<p>关键字include；</p>
<p><code>include</code> 可以将目标文件<strong>除了</strong> <code>&lt;template/&gt;</code> <code>&lt;wxs/&gt;</code> 外的整个代码引入，相当于是拷贝到 <code>include</code> 位置；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">src</span>=<span class="string">"header.wxml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span> body <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">src</span>=<span class="string">"footer.wxml"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- header.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span> header <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- footer.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span> footer <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>@ 2018年8月15日 20:41:52</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">REX CHEN</p>
              <p class="site-description motion-element" itemprop="description">日常记录</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">REX CHEN</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
