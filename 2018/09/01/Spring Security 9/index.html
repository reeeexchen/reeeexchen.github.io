<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="JAVA,Spring Security,QQ," />










<meta name="description" content="Spring Security Note-9 开发QQ登录所有的Api都继承AbstractOAuth2ApiBinding； 在AbstractOAuth2ApiBinding抽象类中有两个属性 12private final String accessToken;private RestTemplate restTemplate; 现在写的整个Api在整个流程当中，是负责执行第六步（获取用户信">
<meta name="keywords" content="JAVA,Spring Security,QQ">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security | Note-9">
<meta property="og:url" content="http://yoursite.com/2018/09/01/Spring Security 9/index.html">
<meta property="og:site_name" content="REEEEX">
<meta property="og:description" content="Spring Security Note-9 开发QQ登录所有的Api都继承AbstractOAuth2ApiBinding； 在AbstractOAuth2ApiBinding抽象类中有两个属性 12private final String accessToken;private RestTemplate restTemplate; 现在写的整个Api在整个流程当中，是负责执行第六步（获取用户信">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/675bae34gy1fuu58ds5lhj20eg06l0sv.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/675bae34gy1fuu58xrpnij20j908e755.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/675bae34gy1fuv4t0sxroj21540kvk46.jpg">
<meta property="og:updated_time" content="2018-09-02T06:40:10.288Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Security | Note-9">
<meta name="twitter:description" content="Spring Security Note-9 开发QQ登录所有的Api都继承AbstractOAuth2ApiBinding； 在AbstractOAuth2ApiBinding抽象类中有两个属性 12private final String accessToken;private RestTemplate restTemplate; 现在写的整个Api在整个流程当中，是负责执行第六步（获取用户信">
<meta name="twitter:image" content="https://ws1.sinaimg.cn/large/675bae34gy1fuu58ds5lhj20eg06l0sv.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/09/01/Spring Security 9/"/>





  <title>Spring Security | Note-9 | REEEEX</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">REEEEX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">KEEP GOING</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/01/Spring Security 9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring Security | Note-9</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-01T00:00:00+08:00">
                2018-09-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Spring-Security-Note-9"><a href="#Spring-Security-Note-9" class="headerlink" title="Spring Security Note-9"></a>Spring Security Note-9</h3><hr>
<h4 id="开发QQ登录"><a href="#开发QQ登录" class="headerlink" title="开发QQ登录"></a>开发QQ登录</h4><p>所有的Api都继承<code>AbstractOAuth2ApiBinding</code>；</p>
<p>在<code>AbstractOAuth2ApiBinding</code>抽象类中有两个属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String accessToken;</span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br></pre></td></tr></table></figure>
<p>现在写的整个Api在整个流程当中，是负责执行第六步（获取用户信息），要执行第六步，需要第五步最后收到的令牌（Token），拿着令牌才能获取用户信息；</p>
<p><code>accessToken</code>:存取前五步完成后，获取到的令牌信息，这是一个类级别的全局对象，在整个我们需要完成的QQImpl中，不是一个单例对象，对每个用户都会有个QQImpl的单独的实现，然后存取用户自己独有的accessToken，这是一个多实例的对象；</p>
<p><code>restTemplate</code>：在第六步获取用户信息，要往服务器提供商发往一个HTTP请求，restTemplate就是帮助发送HTTP请求的；</p>
<p>获取用户信息之前，我们需要前查看QQ开发的文档<a href="http://wiki.connect.qq.com/api%E5%88%97%E8%A1%A8" target="_blank" rel="noopener">QQ互联</a>；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuu58ds5lhj20eg06l0sv.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuu58xrpnij20j908e755.jpg" alt=""></p>
<p>获取用户信息接口的实现</p>
<p>继承，AbstractOAuth2ApiBinding中accessToken是存放前面5步获取的用户信息的；</p>
<p>每个用户的用户信息都不相同，因此QQImpl是个多实例的；</p>
<p>因此不能将此类申明成为Spring的一个组件，需要的时候new就可以了；</p>
<p>需要的参数：</p>
<p>appId：注册qq互联分配的appid</p>
<p>openId：qq用户的Id</p>
<p>accessToken：父类提供</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQImpl</span> <span class="keyword">extends</span> <span class="title">AbstractOAuth2ApiBinding</span> <span class="keyword">implements</span> <span class="title">QQ</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_OPENID = <span class="string">"https://graph.qq.com/oauth2.0/me?access_token=%s"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_GET_USERINFO = <span class="string">"https://graph.qq.com/user/get_user_info?oauth_consumer_key=%s&amp;openid=%s"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String openId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QQImpl</span><span class="params">(String accessToken,String appId)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用父类构造方法时，将accessToken需要作为查询参数</span></span><br><span class="line">        <span class="keyword">super</span>(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line">        <span class="keyword">this</span>.appId = appId;</span><br><span class="line">        String url = String.format(URL_GET_OPENID,accessToken);</span><br><span class="line">        <span class="comment">// getRestTemplate父类提供</span></span><br><span class="line">        String result = getRestTemplate().getForObject(url,String.class);</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.openId = StringUtils.substringBetween(result,<span class="string">"\"openid\":"</span>, <span class="string">"&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> QQUserInfo <span class="title">getUserInfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String url = String.format(URL_GET_USERINFO,appId,openId);</span><br><span class="line">        String result = getRestTemplate().getForObject(url,String.class);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="keyword">return</span> objectMapper.readValue(result,QQUserInfo.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQServiceProvider</span> <span class="keyword">extends</span> <span class="title">AbstractOAuth2ServiceProvider</span>&lt;<span class="title">QQ</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将用户导向的认证服务器的地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_AUTHORIZE = <span class="string">"https://graph.qq.com/oauth2.0/authorize"</span>;</span><br><span class="line">    <span class="comment">// 第三方拿着授权码获取Token的地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_ACCESS_TOKEN = <span class="string">"https://graph.qq.com/oauth2.0/token"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提供OAuth2Operations</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QQServiceProvider</span><span class="params">(String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> OAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> QQ <span class="title">getApi</span><span class="params">(String accessToken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QQImpl(accessToken, appId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="创建ConnectionFactory"><a href="#创建ConnectionFactory" class="headerlink" title="创建ConnectionFactory"></a>创建ConnectionFactory</h4><p>Service Provider上部已完成，接下来开发另一部分ApiAdapter；</p>
<p>ApiAdapter将服务提供商用户基本信息进行统一的适配作用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQAdapter</span> <span class="keyword">implements</span> <span class="title">ApiAdapter</span>&lt;<span class="title">QQ</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(QQ qq)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置创建Connection 需要的一些配置项ConnectionValues</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> api</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> values</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionValues</span><span class="params">(QQ api, ConnectionValues values)</span> </span>&#123;</span><br><span class="line">        QQUserInfo userInfo = api.getUserInfo();</span><br><span class="line">        values.setDisplayName(userInfo.getNickname());</span><br><span class="line">        values.setImageUrl(userInfo.getFigureurl_qq_1());</span><br><span class="line">        <span class="comment">// QQ无个人主页</span></span><br><span class="line">        values.setProfileUrl(<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 用户所在服务提供商的唯一标识</span></span><br><span class="line">        values.setProviderUserId(userInfo.getOpenId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 绑定用户和解绑用户</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> qq</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserProfile <span class="title">fetchUserProfile</span><span class="params">(QQ qq)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatus</span><span class="params">(QQ qq, String s)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调回自建Connection"><a href="#调回自建Connection" class="headerlink" title="调回自建Connection"></a>调回自建Connection</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将之前完成的QQServiceProvider和QQAdapter传递进来并创建</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: REX</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQConectionFactory</span> <span class="keyword">extends</span> <span class="title">OAuth2ConnectionFactory</span>&lt;<span class="title">QQ</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">QQConectionFactory</span><span class="params">(String providerId,String appId,String appSecret)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(providerId, <span class="keyword">new</span> QQServiceProvider(appId,appSecret), <span class="keyword">new</span> QQAdapter());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建SocialConfig配置类"><a href="#创建SocialConfig配置类" class="headerlink" title="创建SocialConfig配置类"></a>创建SocialConfig配置类</h4><p>配置UserConnection表相关设置，注入SpringSocialConfigure；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> UserConnection (userId <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">                             providerId <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">                             providerUserId <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">                             <span class="keyword">rank</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">                             displayName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">                             profileUrl <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">                             imageUrl <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">                             accessToken <span class="built_in">varchar</span>(<span class="number">512</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">                             secret <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">                             refreshToken <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">                             expireTime <span class="built_in">bigint</span>,</span><br><span class="line">                             primary <span class="keyword">key</span> (userId, providerId, providerUserId));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> <span class="keyword">index</span> UserConnectionRank <span class="keyword">on</span> UserConnection(userId, providerId, <span class="keyword">rank</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSocial</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialConfig</span> <span class="keyword">extends</span> <span class="title">SocialConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 操作UserConnection表的配置类</span></span><br><span class="line"><span class="comment">	 * 配置getUsersConnectionRepository操作Connection数据库的表</span></span><br><span class="line"><span class="comment">	 * 在这里面可以定义创建表的前缀信息和存入数据库数据的加解密的方法</span></span><br><span class="line"><span class="comment">	 * JdbcUsersConnectionRepository.sql中有建表的语句：</span></span><br><span class="line"><span class="comment">	* */</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">		JdbcUsersConnectionRepository repository = <span class="keyword">new</span> JdbcUsersConnectionRepository(dataSource,connectionFactoryLocator, Encryptors.noOpText());</span><br><span class="line">		<span class="comment">// 前缀</span></span><br><span class="line">		repository.setTablePrefix(<span class="string">"t_"</span>);</span><br><span class="line">		<span class="keyword">return</span> repository;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 将SpringSocialFilter添加到安全配置的Bean</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> SpringSocialConfigurer <span class="title">imoocSocialSecurityConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SpringSocialConfigurer();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQProperties</span> <span class="keyword">extends</span> <span class="title">SocialProperties</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String providerId = <span class="string">"qq"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialProperties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> QQProperties qq = <span class="keyword">new</span> QQProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"security"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityProperties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> BrowserProperties browser = <span class="keyword">new</span> BrowserProperties();</span><br><span class="line">	<span class="keyword">private</span> ValidateCodeProperties code = <span class="keyword">new</span> ValidateCodeProperties();</span><br><span class="line">	<span class="keyword">private</span> SocialProperties social = <span class="keyword">new</span> SocialProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 当配置了imooc.security.social.qq.app-id时才生效</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"security.social.qq"</span>,name = <span class="string">"app-id"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQAutoConfig</span> <span class="keyword">extends</span> <span class="title">SocialAutoConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 将配置文件中的ProviderId，AppId，AppSecret读取出来，给QQConnectionFactory</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">        QQProperties qqConfig = securityProperties.getSocial().getQq();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QQConectionFactory(qqConfig.getProviderId(), qqConfig.getAppId(),qqConfig.getAppSecret());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security.social.qq.app-id=xxx</span><br><span class="line">security.social.qq.app-secret=xxx</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="完善"><a href="#完善" class="headerlink" title="完善"></a>完善</h4><p>在上部分完成所有组件的配置之后，测试QQ登录，会发现报错：</p>
<blockquote>
<p>redirect uri is illegal(100010)</p>
</blockquote>
<p>在我们进行QQ登录的时候引导用户到认证服务器并授权后跳转回引导的地址；</p>
<p>所以要求我们发起QQ登录的请求和我们在QQ互联系统上配置的请求QQ要保持一致；</p>
<p>否则跳转回来的时候，携带授权码的请求就不会被第三方应用处理,这就导致了发生错误redirect uri is illegal：</p>
<p>方法就是设置server.port=80,这样也能访问成功，引导用户到认证服务器也能成功；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.port=80</span><br></pre></td></tr></table></figure>
<p>要想社交登录成功，我们最后还需要将spring social的过滤器配到我们的过滤器链中；</p>
<p>这个过滤器配置的Bean我们写在SocialConfig类中的ImoocSocialSecurityConfig方法中；</p>
<p>这个方法最终返回一个ImoocSpringSocialConfigurer对象；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocSpringSocialConfigurer</span> <span class="keyword">extends</span> <span class="title">SpringSocialConfigurer</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String filterProcessesUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImoocSpringSocialConfigurer</span><span class="params">(String filterProcessesUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filterProcessesUrl = filterProcessesUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">postProcess</span><span class="params">(T object)</span> </span>&#123;</span><br><span class="line">        SocialAuthenticationFilter filter = (SocialAuthenticationFilter)<span class="keyword">super</span>.postProcess(object);</span><br><span class="line">        filter.setFilterProcessesUrl(filterProcessesUrl);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.postProcess(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个继承的父类SpringSocialConfigurer类中进行了过滤器的配置，在SpringSocialConfigurer类的源码中发现,在configure方法中先实例化了一个过滤器，然后将SocialAuthenticationFilter 过滤器加到了过滤器链中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialProperties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> QQProperties qq = <span class="keyword">new</span> QQProperties();</span><br><span class="line">	<span class="keyword">private</span> String filterProcessesUrl = <span class="string">"/auth"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将SpringSocialFilter添加到安全配置的Bean</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SpringSocialConfigurer <span class="title">imoocSocialSecurityConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String filterProcessesUrl = securityProperties.getSocial().getFilterProcessesUrl();</span><br><span class="line">    ImoocSpringSocialConfigurer configurer = <span class="keyword">new</span> ImoocSpringSocialConfigurer(filterProcessesUrl);</span><br><span class="line">    <span class="keyword">return</span> configurer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuv4t0sxroj21540kvk46.jpg" alt=""></p>
<p>第一步请求授权的过滤器SocialAuthenticationFilter类开始；</p>
<p>这个方法用户处理请求；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth = attemptAuthService(authService, request, response);</span><br></pre></td></tr></table></figure>
<p>对应流程图中SocialAuthenticationService类如何创建出Authentication认证信息；</p>
<p>传入的SocialAuthenticationService对象通过调用getAuthToken方法，直接就获取了通过授权码来获取到的token，由于SocialAuthenticationService是一个接口，具体的实现在SocialAuthenticationService接口的实现类OAuth2AuthenticationService的getAuthToken方法中；</p>
<p>实际上过滤器拦截的请求“\login\qq”既是第一步将用户导向认证服务器的请求，也是认证服务器返回授权码给第三方用户的返回请求，所以这个方法第一句就对这两种请求进行区分：</p>
<h5 id="如果授权码code为空"><a href="#如果授权码code为空" class="headerlink" title="如果授权码code为空"></a>如果授权码code为空</h5><p>则说明是第一次登陆，则抛出一个重定向的异常SocialAuthenticationRedirectException，参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getConnectionFactory().getOAuthOperations().buildAuthenticateUrl(params)</span><br></pre></td></tr></table></figure>
<p>发现这个地址就是我们之前在QQConnectionFactory中的QQServiceProvider参数中配置的地址拼凑起来的，通过这个地址将用户导向到QQ的用户登录页面；</p>
<h5 id="如果授权码不为空"><a href="#如果授权码不为空" class="headerlink" title="如果授权码不为空"></a>如果授权码不为空</h5><p>说明是QQ携带授权码返回给第三方应用的请求，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AccessGrant accessGrant = getConnectionFactory().getOAuthOperations().exchangeForAccess(code, returnToUrl, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>就是通过ConnectionFactory中的QQServiceProvider中的OAuth2Operations实现类来做拿着授权码去获取access_token的操作。OAuth2Operations接口的实现是我们之前配的OAuth2Template类；</p>
<p>在这个类中发起获取token的请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getRestTemplate().postForObject(accessTokenUrl, parameters, Map.class)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQOAuth2Template</span> <span class="keyword">extends</span> <span class="title">OAuth2Template</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">QQOAuth2Template</span><span class="params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">		<span class="comment">// useParametersForClientAuthentication为true时exchangeForAccess方法</span></span><br><span class="line">		setUseParametersForClientAuthentication(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// QQ互联获取accessToke的响应返回的是&amp;拼接的字符串</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AccessGrant <span class="title">postForAccessGrant</span><span class="params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">		String responseStr = getRestTemplate().postForObject(accessTokenUrl, parameters, String.class);</span><br><span class="line"></span><br><span class="line">		logger.info(<span class="string">"获取accessToke的响应："</span> + responseStr);</span><br><span class="line"></span><br><span class="line">		String[] items = StringUtils.splitByWholeSeparatorPreserveAllTokens(responseStr, <span class="string">"&amp;"</span>);</span><br><span class="line"></span><br><span class="line">		String accessToken = StringUtils.substringAfterLast(items[<span class="number">0</span>], <span class="string">"="</span>);</span><br><span class="line">		Long expiresIn = <span class="keyword">new</span> Long(StringUtils.substringAfterLast(items[<span class="number">1</span>], <span class="string">"="</span>));</span><br><span class="line">		String refreshToken = StringUtils.substringAfterLast(items[<span class="number">2</span>], <span class="string">"="</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> AccessGrant(accessToken, <span class="keyword">null</span>, refreshToken, expiresIn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重写createRestTemplate，解决不能处理text/html</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RestTemplate <span class="title">createRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		RestTemplate restTemplate = <span class="keyword">super</span>.createRestTemplate();</span><br><span class="line">		restTemplate.getMessageConverters().add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">		<span class="keyword">return</span> restTemplate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过获取token的请求accessTokenUrl来获取token等信息后封装在AccessGrant实例中，而且要求返回格式为map，为此我们复写的这个方法要求返回的格式为String.class,即返回字符串responseStr；</p>
<p>并截取出accessToken，expireIn ，refreshToken 这三个参数，最后保存到AccessGrant对象中；</p>
<p>此外复写的createRestTemplate方法也是为了RestTemplate 实例可以接受返回的UTF-8格式的字符串；</p>
<hr>
<p>上部分时，成功封装了用户信息到了SocialAuthenticationProvider中出现了问题，页面重新引发跳转到signup；</p>
<p>在SocialAuthenticationProvider类中，有一个authenticate的方法，它接收一个Authentication；</p>
<p>接收它首先要判断进来的是一个SocialAuthenticationToken的信息；</p>
<p>拿到之后，会调用一个叫toUserId（connection）的方法；</p>
<p>在传入的connection当中，有服务提供商返回的用户信息，在key里面，有两个主要的属性：</p>
<blockquote>
<p>providerId &amp; providerUserId</p>
</blockquote>
<p>SpringSocial拿到这两个值以后，在toUserId（）方法里面，它会使用usersConnectionRepository去数据库中查询刚刚这个Key有没有对应的用户ID；</p>
<p>由于是第一次登录，肯定是不存在数据的，拿不到用户ID，将会抛出一个BadCredentialsException；</p>
<p>将会交由Social AuthenticationFilter处理，做出一个判断，判断这个过滤器中，singupUrl是否为空，否则会认为有一个注册的页面，在此我们应该去定义一个注册的页面；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SpringSocialConfigurer <span class="title">imoocSocialSecurityConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String filterProcessesUrl = securityProperties.getSocial().getFilterProcessesUrl();</span><br><span class="line">    ImoocSpringSocialConfigurer configurer = <span class="keyword">new</span> ImoocSpringSocialConfigurer(filterProcessesUrl);</span><br><span class="line">    configurer.signupUrl(securityProperties.getBrowser().getSignUpUrl());</span><br><span class="line">    <span class="keyword">return</span> configurer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/regist"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">regist</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">		<span class="comment">//注册用户</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了使跳转到注册页面时携带QQ的相关信息和注册完成后，将第三方的唯一标示传递给Social插入userConnections数据库中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 解决两个问题，跳转到注册页时返回的用户信息</span></span><br><span class="line"><span class="comment">	 * 并且在注册成功时将用户唯一标识放入social中，存到数据库</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectionFactoryLocator</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ProviderSignInUtils <span class="title">providerSignInUtils</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ProviderSignInUtils(connectionFactoryLocator,getUsersConnectionRepository(connectionFactoryLocator);)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="在BrowserSecurityController中添加获取QQ用户信息"><a href="#在BrowserSecurityController中添加获取QQ用户信息" class="headerlink" title="在BrowserSecurityController中添加获取QQ用户信息"></a>在BrowserSecurityController中添加获取QQ用户信息</h5> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ProviderSignInUtils providerSignInUtils;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回SocialUserInfo</span></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/social/user"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> SocialUserInfo <span class="title">getSocialUserInfo</span><span class="params">(HttpServletRequest request)</span></span>&#123;</span><br><span class="line">		SocialUserInfo userInfo = <span class="keyword">new</span> SocialUserInfo();</span><br><span class="line">		Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(<span class="keyword">new</span> ServletWebRequest(request));</span><br><span class="line">		userInfo.setProviderId(connection.getKey().getProviderId());</span><br><span class="line">		userInfo.setProviderUserId(connection.getKey().getProviderUserId());</span><br><span class="line">		userInfo.setNickname(connection.getDisplayName());</span><br><span class="line">		userInfo.setHeadimg(connection.getImageUrl());</span><br><span class="line">		<span class="keyword">return</span> userInfo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="封装SocialUserInfo"><a href="#封装SocialUserInfo" class="headerlink" title="封装SocialUserInfo"></a>封装SocialUserInfo</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialUserInfo</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String providerId;</span><br><span class="line">	<span class="keyword">private</span> String providerUserId;</span><br><span class="line">	<span class="keyword">private</span> String nickname;</span><br><span class="line">	<span class="keyword">private</span> String headimg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在用户进行第三方用户和QQ用户进行注册绑定时将用户唯一标示给Social，并插入UsersConnection；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProviderSignInUtils providerSignInUtils;</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/regist"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">regist</span><span class="params">(User user, HttpServletRequest request)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 注册用户</span></span><br><span class="line">        <span class="comment">// 不管是注册还是绑定用户，都拿到一个用户唯一标识</span></span><br><span class="line">        String userId = user.getUsername();</span><br><span class="line">        providerSignInUtils.doPostSignUp(userId,<span class="keyword">new</span> ServletWebRequest(request));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有一种情况，就是将QQ的用户信息默认注册为一个在第三方中的用户：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConnectionSignUp</span> <span class="keyword">implements</span> <span class="title">ConnectionSignUp</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(Connection&lt;?&gt; connection)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 根据社交用户信息默认创建用户并且返回用户唯一标识</span></span><br><span class="line">		<span class="keyword">return</span> connection.getDisplayName();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="修改SocialConfig"><a href="#修改SocialConfig" class="headerlink" title="修改SocialConfig"></a>修改SocialConfig</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSocial</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialConfig</span> <span class="keyword">extends</span> <span class="title">SocialConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> ConnectionSignUp connectionSignUp;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UsersConnectionRepository <span class="title">getUsersConnectionRepository</span><span class="params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;</span><br><span class="line">        JdbcUsersConnectionRepository repository = <span class="keyword">new</span> JdbcUsersConnectionRepository(dataSource,connectionFactoryLocator, Encryptors.noOpText());</span><br><span class="line">        <span class="comment">// 前缀</span></span><br><span class="line">        repository.setTablePrefix(<span class="string">"t_"</span>);</span><br><span class="line">        <span class="keyword">if</span>(connectionSignUp != <span class="keyword">null</span>)&#123;</span><br><span class="line">            repository.setConnectionSignUp(connectionSignUp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> repository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JAVA/" rel="tag"># JAVA</a>
          
            <a href="/tags/Spring-Security/" rel="tag"># Spring Security</a>
          
            <a href="/tags/QQ/" rel="tag"># QQ</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/31/Spring Security 8/" rel="next" title="Spring Security | Note-8">
                <i class="fa fa-chevron-left"></i> Spring Security | Note-8
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/02/Spring Security 10/" rel="prev" title="Spring Security | Note-10">
                Spring Security | Note-10 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">REX CHEN</p>
              <p class="site-description motion-element" itemprop="description">日常记录</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Security-Note-9"><span class="nav-number">1.</span> <span class="nav-text">Spring Security Note-9</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#开发QQ登录"><span class="nav-number">1.1.</span> <span class="nav-text">开发QQ登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建ConnectionFactory"><span class="nav-number">1.2.</span> <span class="nav-text">创建ConnectionFactory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调回自建Connection"><span class="nav-number">1.3.</span> <span class="nav-text">调回自建Connection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建SocialConfig配置类"><span class="nav-number">1.4.</span> <span class="nav-text">创建SocialConfig配置类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加配置"><span class="nav-number">1.5.</span> <span class="nav-text">添加配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完善"><span class="nav-number">1.6.</span> <span class="nav-text">完善</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#如果授权码code为空"><span class="nav-number">1.6.1.</span> <span class="nav-text">如果授权码code为空</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如果授权码不为空"><span class="nav-number">1.6.2.</span> <span class="nav-text">如果授权码不为空</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在BrowserSecurityController中添加获取QQ用户信息"><span class="nav-number">1.6.3.</span> <span class="nav-text">在BrowserSecurityController中添加获取QQ用户信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#封装SocialUserInfo"><span class="nav-number">1.6.4.</span> <span class="nav-text">封装SocialUserInfo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改SocialConfig"><span class="nav-number">1.6.5.</span> <span class="nav-text">修改SocialConfig</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">REX CHEN</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
