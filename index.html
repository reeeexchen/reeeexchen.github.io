<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="日常记录">
<meta property="og:type" content="website">
<meta property="og:title" content="REEEEX">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="REEEEX">
<meta property="og:description" content="日常记录">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="REEEEX">
<meta name="twitter:description" content="日常记录">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>REEEEX</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">REEEEX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">KEEP GOING</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/27/Spring Security 4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/27/Spring Security 4/" itemprop="url">Spring Security | Note-4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-27T00:00:00+08:00">
                2018-08-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-4"><a href="#Spring-Security-Note-4" class="headerlink" title="Spring Security Note-4"></a>Spring Security Note-4</h3><hr>
<h4 id="使用多线程提高REST服务性能"><a href="#使用多线程提高REST服务性能" class="headerlink" title="使用多线程提高REST服务性能"></a>使用多线程提高REST服务性能</h4><p>Q：为什么需要异步处理服务？</p>
<p>A：当HTTP请求服务之后，中间件的主线程调用一个副线程，当副线程处理完成之后，再由主线程返回结果；</p>
<p>在此过程中，主线程是可以空闲出来，去处理其它请求；</p>
<p>服务器的吞吐量可以达到优于同步处理的效果；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步处理</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">order</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"MAIN THREAD START"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        logger.info(<span class="string">"MAIN THREAD END"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用Runnable异步处理REST服务"><a href="#使用Runnable异步处理REST服务" class="headerlink" title="使用Runnable异步处理REST服务"></a>使用Runnable异步处理REST服务</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">order</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">      logger.info(<span class="string">"MAIN THREAD START"</span>);</span><br><span class="line">      Callable&lt;String&gt; result = <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            logger.info(<span class="string">"VICE THREAD START"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            logger.info(<span class="string">"VICE THREAD END"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      logger.info(<span class="string">"MAIN THREAD END"</span>);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制器返回：</p>
<blockquote>
<p>2018-08-31 10:34:47.285 Controller      : MAIN THREAD START<br>2018-08-31 10:34:47.285 Controller      : MAIN THREAD END<br>2018-08-31 10:34:47.292 Controller      : VICE THREAD START<br>2018-08-31 10:34:48.292 Controller      : VICE THREAD END</p>
</blockquote>
<p>从时间可以看出，主线程和副线程是几乎同时开始，没有停顿，不等待副线程的一秒钟；</p>
<p>副线程处理的一秒钟，主线程可以继续处理其他的HTTP请求；</p>
<blockquote>
<p>为什么我通过Runnable已经可以异步处理服务请求，还需要DeferredResult的处理方式？</p>
<p>因为Runnable不能处理所有的情况，它的副线程是必须通过主线程来调用的；</p>
</blockquote>
<h5 id="使用DeferredResult异步处理REST服务"><a href="#使用DeferredResult异步处理REST服务" class="headerlink" title="使用DeferredResult异步处理REST服务"></a>使用DeferredResult异步处理REST服务</h5><p>在模拟场景下，接受HTTP请求的服务器与处理服务的应用，并不是同一台服务器的情况下；</p>
<p>则需要由</p>
<p>1.HTTP请求，由应用1接收请求；</p>
<p>2.应用1将 请求发送消息到消息队列中；</p>
<p>3.应用2则实时监听消息队列，并且处理发送的消息；</p>
<p>4.在应用2处理完成的请求，发送处理的结果返回到消息队列中；</p>
<p>5.应用1也将实时监听消息队列，监听应用2返回的处理结果；</p>
<p>6.应用1收到处理结果后，再返回HTTP相应；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fusoqv6bqjj212j0gqdlz.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟应用1接收请求并且监听，返回</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MockQueue mockQueue;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DeferredResultHolder deferredResultHolder;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">order</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		logger.info(<span class="string">"MAIN THREAD START"</span>);</span><br><span class="line">		String orderNumber = RandomStringUtils.randomNumeric(<span class="number">8</span>);</span><br><span class="line">		mockQueue.setPlaceOrder(orderNumber);</span><br><span class="line"></span><br><span class="line">		DeferredResult&lt;String&gt; result = <span class="keyword">new</span> DeferredResult&lt;&gt;();</span><br><span class="line">		deferredResultHolder.getMap().put(orderNumber,result);</span><br><span class="line"></span><br><span class="line">		logger.info(<span class="string">"MAIN THREAD END"</span>);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟监听器</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockQueue mockQueue;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeferredResultHolder deferredResultHolder;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent contextRefreshedEvent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 监听模拟消息队列</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotBlank(mockQueue.getCompleteOrder())) &#123;</span><br><span class="line">                    String orderNumber = mockQueue.getCompleteOrder();</span><br><span class="line">                    logger.info(<span class="string">"返回订单处理结果，"</span> + orderNumber);</span><br><span class="line">                    deferredResultHolder.getMap().get(orderNumber).setResult(<span class="string">"place order success"</span>);</span><br><span class="line">                    mockQueue.setCompleteOrder(<span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟消息队列处理请求</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockQueue</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 订单消息</span></span><br><span class="line">	<span class="keyword">private</span> String placeOrder;</span><br><span class="line">	<span class="comment">// 完成订单消息</span></span><br><span class="line">	<span class="keyword">private</span> String completeOrder;</span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPlaceOrder</span><span class="params">(String placeOrder)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">			logger.info(<span class="string">"接到下单请求，"</span> + placeOrder);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.completeOrder = placeOrder;</span><br><span class="line">			logger.info(<span class="string">"下单请求处理完毕，"</span> + placeOrder);</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredResultHolder</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String,DeferredResult&lt;String&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>控制器返回结果:</p>
<p>2018-08-31 10:58:33.234  INFO 15020 — [nio-8081-exec-1] Controller : MAIN THREAD START<br>2018-08-31 10:58:33.236  INFO 15020 — [nio-8081-exec-1] Controller : MAIN THREAD END<br>2018-08-31 10:58:33.236  INFO 15020 — [      Thread-34] MockQueue : 接到下单请求，51722757<br>2018-08-31 10:58:34.236  INFO 15020 — [      Thread-34] MockQueue : 下单请求处理完毕，51722757<br>2018-08-31 10:58:34.344  INFO 15020 — [      Thread-23] QueueListener : 返回订单处理结果，51722757</p>
</blockquote>
<p>通过控制器返回的结果发现，几乎在主线程完成返回的同时，副线程（Thread-34）同时接收到请求，并且在一秒后完成服务的请求，并且返回处理结果，由模拟应用1的线程2接收返回结果（Thread-23）；</p>
<h5 id="异步处理配置"><a href="#异步处理配置" class="headerlink" title="异步处理配置"></a>异步处理配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TimeInterceptor timeInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAsyncSupport</span><span class="params">(AsyncSupportConfigurer configurer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 需要通过以下两个注册异步请求的拦截器</span></span><br><span class="line">        configurer.registerCallableInterceptors();</span><br><span class="line">        configurer.registerDeferredResultInterceptors();</span><br><span class="line">        <span class="comment">// 设置异步请求的超时时间</span></span><br><span class="line">        configurer.setDefaultTimeout(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 设置自定义的线程池</span></span><br><span class="line">        configurer.setTaskExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="与前端开发并行工作工具"><a href="#与前端开发并行工作工具" class="headerlink" title="与前端开发并行工作工具"></a>与前端开发并行工作工具</h4><h5 id="使用Swagger自动生成API文档"><a href="#使用Swagger自动生成API文档" class="headerlink" title="使用Swagger自动生成API文档"></a>使用Swagger自动生成API文档</h5><p>首先需要在pom中加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 在主应用中开启Swagger服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello Spring Security"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常用注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Swagger注解</span></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"用户列表查询服务"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">(UserQueryCondition condition, @PageableDefault(size = <span class="number">17</span>, page = <span class="number">2</span>, sort = <span class="string">"username,asc"</span>)</span> Pageable pageable) </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@ApiParam(value = <span class="string">"用户ID"</span>)</span> @<span class="title">PathVariable</span><span class="params">(name = <span class="string">"id"</span>, required = <span class="keyword">false</span>)</span> String id) </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuspyqjm07j20qq01nt8q.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuspz0ph7xj20m905x3yo.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserQueryCondition</span> </span>&#123;</span><br><span class="line">	<span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户年龄起始值"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">	<span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户年龄终止值"</span>)</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> ageTo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuspz90rfgj20mj02o0sn.jpg" alt=""></p>
<h5 id="使用WireMock伪造REST服务"><a href="#使用WireMock伪造REST服务" class="headerlink" title="使用WireMock伪造REST服务"></a>使用WireMock伪造REST服务</h5><p>前后端分离的情况下，不止于HTML的请求，还有IOS，ANDROID的请求服务；</p>
<p>自我编写假数据是不现实，并且效率很低；</p>
<p>提供一个统一的伪造REST服务是有必要的；</p>
<p>WireMock是一个独立的服务器，收到怎么样的请求，返回怎么样的相应；</p>
<p>WireMock不需要重启，不需要模拟数据，只需要去连接WireMock服务器即可；</p>
<p><a href="http://wiremock.org/docs/running-standalone/" target="_blank" rel="noopener">WireMock独立运行</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar wiremock-standalone-2.18.0.jar --port 8082</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 添加WireMock的依赖</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.tomakehurst<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wiremock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpmime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 指定连接</span></span><br><span class="line">        WireMock.configureFor(<span class="number">8082</span>);</span><br><span class="line">        <span class="comment">// 清空所有配置</span></span><br><span class="line">        WireMock.removeAllMappings();</span><br><span class="line">        <span class="comment">// 处理请求</span></span><br><span class="line">        mock(<span class="string">"/order/1"</span>, <span class="string">"01"</span>);</span><br><span class="line">        mock(<span class="string">"/order/2"</span>, <span class="string">"02"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mock</span><span class="params">(String url, String file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"mock/response/"</span> + file + <span class="string">".txt"</span>);</span><br><span class="line">        String content = StringUtils.join(FileUtils.readLines(resource.getFile(), <span class="string">"UTF-8"</span>).toArray(), <span class="string">"\n"</span>);</span><br><span class="line">        WireMock.stubFor(WireMock.get(urlPathEqualTo(url)).willReturn(aResponse().withBody(content).withStatus(<span class="number">200</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/26/Spring Security 3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/26/Spring Security 3/" itemprop="url">Spring Security | Note-3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-26T00:00:00+08:00">
                2018-08-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-3"><a href="#Spring-Security-Note-3" class="headerlink" title="Spring Security Note-3"></a>Spring Security Note-3</h3><hr>
<h4 id="服务异常处理"><a href="#服务异常处理" class="headerlink" title="服务异常处理"></a>服务异常处理</h4><h5 id="Spring-Boot-中默认的错误处理机制"><a href="#Spring-Boot-中默认的错误处理机制" class="headerlink" title="Spring Boot 中默认的错误处理机制"></a>Spring Boot 中默认的错误处理机制</h5><p>例如：</p>
<p>访问不存在的URL时，返回一个空白的错误页（状态码404）；</p>
<p>访问页面<a href="http://127.0.0.1:8080/xxx" target="_blank" rel="noopener">http://127.0.0.1:8080/xxx</a></p>
<p>当浏览器访问时，返回的是一个HTML页面；(Accept: text/html)</p>
<p>当客户端(Restlet Client模拟)访问时，返回的是一个JSON；(Accept: */*)</p>
<p>这是Spring Boot默认的错误返回机制；</p>
<blockquote>
<p>public class BasicErrorController extends AbstractErrorController {…}</p>
<p>根据请求头(header)中的信息不同，进行不同的处理；</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(produces = &#123;<span class="string">"text/html"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在默认的错误返回机制下，已经可以解决大部分的错误和异常；</p>
<h5 id="自定义异常处理"><a href="#自定义异常处理" class="headerlink" title="自定义异常处理"></a>自定义异常处理</h5><p>我们在main/resources文件夹目录下，新建一个目录结构 main/resources/resources/error</p>
<p>在error文件夹目录下，新建一个404.html的页面；</p>
<p>此时，浏览器再次访问<a href="http://127.0.0.1:8080/xxx页面，404错误时，不再是返回空白的错误页面；" target="_blank" rel="noopener">http://127.0.0.1:8080/xxx页面，404错误时，不再是返回空白的错误页面；</a></p>
<p>而是返回自定义的404.html页面的内容；</p>
<p>对于客户端的错误信息如何自定义？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="meta">@JsonView</span>(User.UserDetailView.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@PathVariable(name = <span class="string">"id"</span>,required = <span class="keyword">false</span>)</span> String id)</span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UserNotExistException(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过自定义异常类（extends RuntimeException）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserNotExistException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserNotExistException</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"user not exist"</span>);</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且在Controller中，定义一个新的类ControllerExceptionHandler，用于处理其他Controller所抛出的所有异常信息；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(UserNotExistException.class)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">handleUserNotExistException</span><span class="params">(UserNotExistException ex)</span></span>&#123;</span><br><span class="line">        Map&lt;String ,Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">"id"</span>,ex.getId());</span><br><span class="line">        result.put(<span class="string">"message"</span>,ex.getMessage());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SpringBoot默认异常返回机制</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"timestamp"</span>: <span class="number">1535356164785</span>,</span><br><span class="line"><span class="attr">"status"</span>: <span class="number">500</span>,</span><br><span class="line"><span class="attr">"error"</span>: <span class="string">"Internal Server Error"</span>,</span><br><span class="line"><span class="attr">"exception"</span>: <span class="string">"java.lang.RuntimeException"</span>,</span><br><span class="line"><span class="attr">"message"</span>: <span class="string">"user not exist"</span>,</span><br><span class="line"><span class="attr">"path"</span>: <span class="string">"/user/1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>自定义异常返回机制</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"id"</span>: <span class="string">"1"</span>,</span><br><span class="line"><span class="attr">"message"</span>: <span class="string">"user not exist"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="使用Filter和Interceptor拦截REST服务"><a href="#使用Filter和Interceptor拦截REST服务" class="headerlink" title="使用Filter和Interceptor拦截REST服务"></a>使用Filter和Interceptor拦截REST服务</h4><p>需求：记录所有服务的处理时间</p>
<h5 id="过滤器-Filter"><a href="#过滤器-Filter" class="headerlink" title="过滤器 Filter"></a>过滤器 Filter</h5><p>无法获得具体调用的参数，具体的Controller，具体的方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Time Filter Init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Time Filter Start"</span>);</span><br><span class="line">        <span class="keyword">long</span> start = <span class="keyword">new</span> Date().getTime();</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">        System.out.println(<span class="string">"Time Filter Time Used : "</span> + (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">        System.out.println(<span class="string">"Time Filter End"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Time Filter Destroy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Q：若第三方过滤器的框架，无法进行Spring @Component的注解怎么办？</p>
<p>A：在传统的项目中，有一个web.xml的配置文件，将第三方的过滤器，配置到web.xml文件即可；</p>
<p>A：但是Spring项目不存在web.xml文件，如何配置进去？通过自定义WebConfig的方式；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">timeFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        FilterRegistrationBean registrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        TimeFilter timeFilter = <span class="keyword">new</span> TimeFilter();</span><br><span class="line">        registrationBean.setFilter(timeFilter);</span><br><span class="line">        List&lt;String&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        urls.add(<span class="string">"/*"</span>);</span><br><span class="line">        registrationBean.setUrlPatterns(urls);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="拦截器-Interceptor"><a href="#拦截器-Interceptor" class="headerlink" title="拦截器 Interceptor"></a>拦截器 Interceptor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"preHandle"</span>);</span><br><span class="line">        <span class="comment">// 获取Controller名字</span></span><br><span class="line">        System.out.println(((HandlerMethod) handler).getBean().getClass().getName());</span><br><span class="line">        <span class="comment">// 获取方法名字</span></span><br><span class="line">        System.out.println(((HandlerMethod) handler).getMethod().getName());</span><br><span class="line">        request.setAttribute(<span class="string">"startTime"</span>, <span class="keyword">new</span> Date().getTime());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"postHandle"</span>);</span><br><span class="line">        Long start = (Long) request.getAttribute(<span class="string">"startTime"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Time Interceptor Time Used : "</span> + (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterCompletion"</span>);</span><br><span class="line">        Long start = (Long) request.getAttribute(<span class="string">"startTime"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Time Interceptor Time Used : "</span> + (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">        System.out.println(<span class="string">"ex is : "</span> + ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TimeInterceptor timeInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(timeInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="使用切片拦截REST服务"><a href="#使用切片拦截REST服务" class="headerlink" title="使用切片拦截REST服务"></a>使用切片拦截REST服务</h4><h5 id="切片（AOP）-Aspect"><a href="#切片（AOP）-Aspect" class="headerlink" title="切片（AOP） Aspect"></a>切片（AOP） Aspect</h5><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuoccxei77j20uv0i0100.jpg" alt="AOP"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Around 包含了其余三个@Before @After @AfterThrowing</span></span><br><span class="line">    <span class="comment">// execution执行 拦截的类 所有的方法 任何的返回值 任何的参数</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"execution(* com.imooc.web.controller.UserController.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">handleControllerMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Time Aspect Start"</span>);</span><br><span class="line">        Object[] args = pjp.getArgs();</span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            System.out.println(<span class="string">"arg is : "</span> + arg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> start = <span class="keyword">new</span> Date().getTime();</span><br><span class="line">        Object object = pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">"Time Aspect Time Used : "</span> + (<span class="keyword">new</span> Date().getTime() - start));</span><br><span class="line">        System.out.println(<span class="string">"Time Aspect End"</span>);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>过滤器：可以拿到原始的HTTP请求和相应的信息，但是拿不到处理请求信息方法的信息；</p>
<p>拦截器：即可以拿到原始的HTTP请求和相应的信息，也能拿到处理请求的方法的信息，但是拿不到被调用的参数的值；</p>
<p>切片：可以拿到处理请求的方法的信息，以及真正调用方法的参数的值，但是拿不到原始的HTTp请求和相应的对象；</p>
<p>三个对象各有各特点，根据具体的业务需要，选择具体的拦截机制；</p>
<p>拦截机制的拦截顺序：Filter -&gt; Interceptor -&gt; ControllerAdvice -&gt; Aspect -&gt; Controller</p>
<hr>
<h4 id="使用REST方式处理文件服务"><a href="#使用REST方式处理文件服务" class="headerlink" title="使用REST方式处理文件服务"></a>使用REST方式处理文件服务</h4><h5 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟上传到本地</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenUploadSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String result = mockMvc.perform(fileUpload(<span class="string">"/file"</span>)</span><br><span class="line">                                    .file(<span class="keyword">new</span> MockMultipartFile(<span class="string">"file"</span>,<span class="string">"test.txt"</span>,<span class="string">"multipart/form-data"</span>,<span class="string">"hello upload"</span>.getBytes(<span class="string">"UTF-8"</span>))))</span><br><span class="line">        .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">        .andReturn().getResponse().getContentAsString();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/file"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FileInfo <span class="title">update</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(file.getName());</span><br><span class="line">        System.out.println(file.getOriginalFilename());</span><br><span class="line">        System.out.println(file.getSize());</span><br><span class="line"></span><br><span class="line">        String folder = <span class="string">"xxx"</span>;</span><br><span class="line">        File localFile = <span class="keyword">new</span> File(folder,<span class="keyword">new</span> Date().getTime() + <span class="string">".txt"</span>);</span><br><span class="line">        file.transferTo(localFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileInfo(localFile.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过API下载</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(@PathVariable String id, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(folder, id + <span class="string">".txt"</span>));</span><br><span class="line">        OutputStream outputStream = response.getOutputStream();</span><br><span class="line">    )&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/x-download"</span>);</span><br><span class="line">        response.addHeader(<span class="string">"Content-Disposition"</span>,<span class="string">"attachment;filename=test.txt"</span>);</span><br><span class="line">        IOUtils.copy(inputStream,outputStream);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/25/Spring Security 2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/25/Spring Security 2/" itemprop="url">Spring Security | Note-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-25T00:00:00+08:00">
                2018-08-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-2"><a href="#Spring-Security-Note-2" class="headerlink" title="Spring Security Note-2"></a>Spring Security Note-2</h3><hr>
<h3 id="Spring-MVC开发RESTful-API"><a href="#Spring-MVC开发RESTful-API" class="headerlink" title="Spring MVC开发RESTful API"></a>Spring MVC开发RESTful API</h3><p>在这一篇笔记中，将开发REST风格的API服务接口，并且在后面的笔记中的认证和授权中，对这些API进行安全保护；</p>
<p>并且会有学习到，如何拦截服务接口来提供一些统一的功能；</p>
<p>如何通过多线程提高服务的性能；</p>
<p>如何自动生成API文档；</p>
<p>伪造服务；</p>
<hr>
<h4 id="RESTful简介"><a href="#RESTful简介" class="headerlink" title="RESTful简介"></a>RESTful简介</h4><h5 id="传统API-VS-RESTful-API"><a href="#传统API-VS-RESTful-API" class="headerlink" title="传统API VS RESTful API"></a>传统API VS RESTful API</h5><table>
<thead>
<tr>
<th>NAME</th>
<th>API</th>
<th>METHOD</th>
<th>RESTful API</th>
<th>METHOD</th>
</tr>
</thead>
<tbody>
<tr>
<td>查询</td>
<td>/user/query?name=tom</td>
<td>GET</td>
<td>/user?name=tom</td>
<td>GET</td>
</tr>
<tr>
<td>详情</td>
<td>/user/getInfo?id=1</td>
<td>GET</td>
<td>/user/1</td>
<td>GET</td>
</tr>
<tr>
<td>创建</td>
<td>/user/create?name=tom</td>
<td>POST</td>
<td>/user</td>
<td>POST</td>
</tr>
<tr>
<td>修改</td>
<td>/user/update?id=1&amp;name=tom</td>
<td>POST</td>
<td>/user/1</td>
<td>PUT</td>
</tr>
<tr>
<td>删除</td>
<td>/user/delete?id=1</td>
<td>GET</td>
<td>/user/1</td>
<td>DELETE</td>
</tr>
</tbody>
</table>
<h5 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h5><pre><code>1.用URL描述资源，而不是描述行为；

2.使用HTTP方法描述行为，使用HTTP状态码来表示不同的结果；

3.使用JSON交互数据；

4.RESTful只是一种风格，不是强制的标准；
</code></pre><h5 id="REST成熟度模型"><a href="#REST成熟度模型" class="headerlink" title="REST成熟度模型"></a>REST成熟度模型</h5><p>Level0：使用HTTP作为传输方式；</p>
<p>Level1：引入资源概念；每个资源都有对应的URL；</p>
<p>Level2（RESTful）：使用HTTP方法进行不同的操作；使用HTTP状态码来表示不同的结果；</p>
<p>Level3：使用超媒体；在资源的表达中包含了链接信息；</p>
<hr>
<h4 id="用户查询请求"><a href="#用户查询请求" class="headerlink" title="用户查询请求"></a>用户查询请求</h4><h5 id="编写针对RESTful-API的测试用例"><a href="#编写针对RESTful-API的测试用例" class="headerlink" title="编写针对RESTful API的测试用例"></a>编写针对RESTful API的测试用例</h5><p>首先引入针对Spring Boot的测试框架；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 伪造一个MVC环境</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext wac;</span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenQuerySuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// perform 执行请求，根据请求的结果判断返回的内容是否符合期望</span></span><br><span class="line">        <span class="comment">// MockMvcRequestBuilders.get() 模拟发出get请求</span></span><br><span class="line">        <span class="comment">// contentType发出内容的请求是UTF-8 JSON格式</span></span><br><span class="line">        <span class="comment">// andExpect(),编写返回的期望</span></span><br><span class="line">        <span class="comment">// 期望返回的状态是MockMvcResultMatchers.status().isOk() 即200</span></span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/user"</span>).contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">            .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.length()"</span>).value(<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用注解声明RESTful-API"><a href="#使用注解声明RESTful-API" class="headerlink" title="使用注解声明RESTful API"></a>使用注解声明RESTful API</h5><p>@RestController 标明这个Controller提供REST API</p>
<p>@RequestMapping 及其变体（映射HTTP请求URL到JAVA方法）</p>
<p>@RequestParam 映射请求参数到JAVA方法的参数</p>
<p>@PageableDefault 指定分页参数默认值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        users.add(<span class="keyword">new</span> User());</span><br><span class="line">        users.add(<span class="keyword">new</span> User());</span><br><span class="line">        users.add(<span class="keyword">new</span> User());</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="在RESTful-API中传递参数"><a href="#在RESTful-API中传递参数" class="headerlink" title="在RESTful API中传递参数"></a>在RESTful API中传递参数</h5><p>此时我们在请求中，加入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">(@RequestParam String username)</span></span>&#123;&#125;</span><br><span class="line"><span class="meta">@RequestParam</span>(required = <span class="keyword">false</span>,name = <span class="string">"username"</span>,defaultValue = <span class="string">"rex"</span>)</span><br></pre></td></tr></table></figure>
<p>required ：指明参数是否必传；</p>
<p>name ：指明参数在URL传递的名称；</p>
<p>defaultValue：当参数为空时的默认值；</p>
<p>那么在测试用例中，我们对于的需要加上参数，不然将报出400的错误；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.param(<span class="string">"username"</span>,<span class="string">"rex"</span>)</span><br></pre></td></tr></table></figure>
<p>将查询的条件，封装成一个对象，直接传入查询的对象；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserQueryCondition</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ageTo;</span><br><span class="line">    <span class="keyword">private</span> String xxx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">query</span><span class="params">(UserQueryCondition condition, @PageableDefault(size = <span class="number">17</span>,page = <span class="number">2</span>,sort = <span class="string">"username,asc"</span>)</span> Pageable pageable)</span>&#123;</span><br><span class="line">    System.out.println(ReflectionToStringBuilder.toString(condition, ToStringStyle.MULTI_LINE_STYLE));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.param(<span class="string">"username"</span>,<span class="string">"rex"</span>)</span><br><span class="line">.param(<span class="string">"age"</span>,<span class="string">"18"</span>)</span><br><span class="line">.param(<span class="string">"ageTo"</span>,<span class="string">"60"</span>)</span><br><span class="line">.param(<span class="string">"xxx"</span>,<span class="string">"yyy"</span>)</span><br><span class="line">.param(<span class="string">"size"</span>,<span class="string">"15"</span>)</span><br><span class="line">.param(<span class="string">"page"</span>,<span class="string">"3"</span>)</span><br><span class="line">.param(<span class="string">"sort"</span>,<span class="string">"age,desc"</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户详情请求"><a href="#用户详情请求" class="headerlink" title="用户详情请求"></a>用户详情请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenGetInfoSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/user/1"</span>)</span><br><span class="line">                    .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">        .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">        .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.username"</span>).value(<span class="string">"tom"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PathVaribale-映射URL片段到JAVA方法的参数"><a href="#PathVaribale-映射URL片段到JAVA方法的参数" class="headerlink" title="@PathVaribale 映射URL片段到JAVA方法的参数"></a>@PathVaribale 映射URL片段到JAVA方法的参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getInfo</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setUsername(<span class="string">"tom"</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="在URL声明中使用正则表达式"><a href="#在URL声明中使用正则表达式" class="headerlink" title="在URL声明中使用正则表达式"></a>在URL声明中使用正则表达式</h5><p>希望传入的id必须是数字，使用正则表达式规范传入的参数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id:\\d+&#125;"</span>,method = RequestMethod.GET)</span><br></pre></td></tr></table></figure>
<h5 id="JsonView控制JSON输出方式"><a href="#JsonView控制JSON输出方式" class="headerlink" title="@JsonView控制JSON输出方式"></a>@JsonView控制JSON输出方式</h5><p>场景：假设在query（）中，不希望返回用户的password，但是在getinfo（）中可返回用户的password，在这两个服务中，返回不同的字段；</p>
<h5 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h5><pre><code>1.使用接口来声明多个视图

2.在值对象的get方法上指定视图
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserSimpleView</span></span>&#123;&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailView</span> <span class="keyword">extends</span> <span class="title">UserSimpleView</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView</span>(UserSimpleView.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView</span>(UserDetailView.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>3.在Controller方法上指定视图
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@JsonView</span>(User.UserSimpleView.class)</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id:\\d+&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@JsonView</span>(User.UserDetailView.class)</span><br></pre></td></tr></table></figure>
<h5 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>,method = RequestMethod.GET)</span><br><span class="line">--&gt; <span class="meta">@GetMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id:\\d+&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line">--&gt; <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;id:\\d+&#125;"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户创建请求"><a href="#用户创建请求" class="headerlink" title="用户创建请求"></a>用户创建请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenCreateSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String content = <span class="string">"&#123;\"username\":\"tom\",\"password\":null&#125;"</span>;</span><br><span class="line">    mockMvc.perform(MockMvcRequestBuilders.post(<span class="string">"/user"</span>)</span><br><span class="line">                    .contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">                    .content(content))</span><br><span class="line">        .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">        .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.id"</span>).value(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RequestBody-映射请求体到-JAVA方法的参数"><a href="#RequestBody-映射请求体到-JAVA方法的参数" class="headerlink" title="@RequestBody 映射请求体到 JAVA方法的参数"></a>@RequestBody 映射请求体到 JAVA方法的参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">create</span><span class="params">(@RequestBody User user)</span></span>&#123;</span><br><span class="line">    user.setId(<span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="日期类型参数的处理"><a href="#日期类型参数的处理" class="headerlink" title="日期类型参数的处理"></a>日期类型参数的处理</h5><p>为了解决每一个服务端所使用的时间展示方法不一样，有一些使用年月日，有一些使用时分秒；</p>
<p>后台采取时间戳的方式，传递时间数据；</p>
<p>最终的展示格式，由前端（服务端）进行自我定义；</p>
<h5 id="Valid注解和BindingResult验证请求参数的合法性并处理校验结果"><a href="#Valid注解和BindingResult验证请求参数的合法性并处理校验结果" class="headerlink" title="@Valid注解和BindingResult验证请求参数的合法性并处理校验结果"></a>@Valid注解和BindingResult验证请求参数的合法性并处理校验结果</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank</span></span><br><span class="line"><span class="keyword">private</span> String password;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">create</span><span class="params">(@Valid @RequestBody User user)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了对请求既能返回错误，又能对请求做出响应，则需要用上BindingResult；</p>
<p>带着错误信息进入到方法体中，继续执行；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">create</span><span class="params">(@Valid @RequestBody User user, BindingResult errors)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        errors.getAllErrors().stream().forEach(error -&gt; System.out.println(error.getDefaultMessage()));</span><br><span class="line">    &#125;</span><br><span class="line">    user.setId(<span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台返回：may not be empty</p>
<hr>
<h4 id="用户修改请求"><a href="#用户修改请求" class="headerlink" title="用户修改请求"></a>用户修改请求</h4><h5 id="常用的验证注解"><a href="#常用的验证注解" class="headerlink" title="常用的验证注解"></a>常用的验证注解</h5><table>
<thead>
<tr>
<th>注解</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>@NotNull</td>
<td>值不能为空</td>
</tr>
<tr>
<td>@Null</td>
<td>值必须为空</td>
</tr>
<tr>
<td>@Pattern(regex=)</td>
<td>字符串必须匹配正则表达式</td>
</tr>
<tr>
<td>@Size(min=,max=)</td>
<td>集合的元素数量在范围内</td>
</tr>
<tr>
<td>@CreditCardNumber(ignoreNonDigitCharacters=)</td>
<td>字符串必须是信用卡号</td>
</tr>
<tr>
<td>@Email</td>
<td>字符串必须是Email地址</td>
</tr>
<tr>
<td>@Length(min=,max=)</td>
<td>检查字符串的长度</td>
</tr>
<tr>
<td>@NotBlank</td>
<td>字符串必须有字符</td>
</tr>
<tr>
<td>@NotEmpty</td>
<td>字符串不为NULL，集合有元素</td>
</tr>
<tr>
<td>@Range(min=,max=)</td>
<td>数字必须在范围内</td>
</tr>
<tr>
<td>@SafeHtml</td>
<td>字符串是安全的HTML</td>
</tr>
<tr>
<td>@URL</td>
<td>字符串是合法的URL</td>
</tr>
<tr>
<td>@Past</td>
<td>被注释的元素必须是一个过去的日期</td>
</tr>
<tr>
<td>@Future</td>
<td>被注释的元素必须是一个将来的日期</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenUpdateSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Date date = <span class="keyword">new</span> Date(LocalDateTime.now().plusYears(<span class="number">1</span>).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());</span><br><span class="line">    System.out.println(date.getTime());</span><br><span class="line">    String content = <span class="string">"&#123;\"id\":\"1\", \"username\":\"tom\",\"password\":null,\"birthday\":"</span> + date.getTime() + <span class="string">"&#125;"</span>;</span><br><span class="line">    String result = mockMvc.perform(MockMvcRequestBuilders.put(<span class="string">"/user/1"</span>)</span><br><span class="line">                                    .contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">                                    .content(content))</span><br><span class="line">        .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">        .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">"$.id"</span>).value(<span class="string">"1"</span>))</span><br><span class="line">        .andReturn().getResponse().getContentAsString();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">update</span><span class="params">(@Valid @RequestBody User user, BindingResult errors)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        errors.getAllErrors().stream().forEach(error -&gt; &#123;</span><br><span class="line">            FieldError fieldError = (FieldError)error;</span><br><span class="line">            String message = fieldError.getField() +<span class="string">" "</span>+ error.getDefaultMessage();</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    user.setId(<span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台返回：</p>
<blockquote>
<p>password may not be empty<br>birthday must be in the past</p>
</blockquote>
<h5 id="自定义错误消息"><a href="#自定义错误消息" class="headerlink" title="自定义错误消息"></a>自定义错误消息</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank</span>(message = <span class="string">"密码不能为空"</span>)</span><br><span class="line"><span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Past</span>(message = <span class="string">"生日必须是过去的时间"</span>)</span><br><span class="line"><span class="keyword">private</span> Date birthday;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">    errors.getAllErrors().stream().forEach(error -&gt; &#123;</span><br><span class="line">        System.out.println(error.getDefaultMessage());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台返回：</p>
<blockquote>
<p>密码不能为空<br>生日必须是过去的时间</p>
</blockquote>
<h5 id="自定义校验注解"><a href="#自定义校验注解" class="headerlink" title="自定义校验注解"></a>自定义校验注解</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注解可标注在方法和字段上</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD,ElementType.FIELD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="comment">// 执行注解时，检验的类</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = MyConstraintValidator.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyConstraint &#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span></span>;</span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">MyConstraint</span>,<span class="title">Object</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloService helloService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(MyConstraint myConstraint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"My Constraint Validator Init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        helloService.greeting(<span class="string">"tom"</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyConstraint</span>(message = <span class="string">"测试"</span>)</span><br><span class="line"><span class="keyword">private</span> String username;</span><br></pre></td></tr></table></figure>
<p>控制台返回：</p>
<blockquote>
<p>My Constraint Validator Init<br>greeting<br>tom<br>测试</p>
</blockquote>
<hr>
<h4 id="用户删除请求"><a href="#用户删除请求" class="headerlink" title="用户删除请求"></a>用户删除请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenDeleteSuccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    mockMvc.perform(MockMvcRequestBuilders.delete(<span class="string">"/user/1"</span>)</span><br><span class="line">                    .contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">        .andExpect(MockMvcResultMatchers.status().isOk());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping</span>(<span class="string">"/&#123;id:\\d+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">    System.out.println(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/24/MicWechat Note-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/24/MicWechat Note-10/" itemprop="url">Wechat Mini | Note-10</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-24T00:00:00+08:00">
                2018-08-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-10"><a href="#微信小程序开发-Note-10" class="headerlink" title="微信小程序开发 Note-10"></a>微信小程序开发 Note-10</h3><hr>
<h4 id="保存留言功能"><a href="#保存留言功能" class="headerlink" title="保存留言功能"></a>保存留言功能</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveComment</span><span class="params">(Comments comment)</span> </span>&#123;</span><br><span class="line">    comment.setId(sid.nextShort());</span><br><span class="line">    comment.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">    commentsMapper.insert(comment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"SAVE COMMENT"</span>, notes = <span class="string">"SAVE COMMENT API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/saveComment"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">saveComment</span><span class="params">(@RequestBody Comments comment)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存留言</span></span><br><span class="line">    videoService.saveComment(comment);</span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JS</span></span><br><span class="line"><span class="comment">// 留言按钮触发的事件</span></span><br><span class="line">leaveComment: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">        commentFocus: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JS</span></span><br><span class="line"><span class="comment">// 发表留言</span></span><br><span class="line">saveComment: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> content = e.detail.value;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(me.data.videoInfo);</span><br><span class="line">    <span class="keyword">var</span> realUrl = <span class="string">'../videoinfo/videoinfo#videoInfo@'</span> + videoInfo;</span><br><span class="line">    <span class="comment">// 用户判断</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">''</span>) &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            url: <span class="string">'../userLogin/login?redirectUrl='</span> + realUrl,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wx.showLoading(&#123;</span><br><span class="line">            title: <span class="string">'提交中'</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        wx.request(&#123;</span><br><span class="line">            url: app.serverUrl + <span class="string">'/video/saveComment'</span>,</span><br><span class="line">            method: <span class="string">'POST'</span>,</span><br><span class="line">            header: &#123;</span><br><span class="line">                <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">                <span class="string">'userId'</span>: user.id,</span><br><span class="line">                <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">            &#125;,</span><br><span class="line">            data: &#123;</span><br><span class="line">                fromUserId: user.id,</span><br><span class="line">                videoId: me.data.videoInfo.id,</span><br><span class="line">                comment:content</span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">                wx.hideLoading();</span><br><span class="line">                <span class="built_in">console</span>.log(res.data);</span><br><span class="line">                me.setData(&#123;</span><br><span class="line">                    <span class="comment">// 清空留言文字</span></span><br><span class="line">                    contentValue:<span class="string">""</span>,</span><br><span class="line">                    commentsList:[]</span><br><span class="line">                &#125;);</span><br><span class="line">                me.getCommentsList(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="留言列表（分页）-amp-联调"><a href="#留言列表（分页）-amp-联调" class="headerlink" title="留言列表（分页） &amp; 联调"></a>留言列表（分页） &amp; 联调</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PagedResult <span class="title">getAllComments</span><span class="params">(String videoId, Integer page, Integer pageSize)</span> </span>&#123;</span><br><span class="line">    PageHelper.startPage(page, pageSize);</span><br><span class="line">    List&lt;CommentsVO&gt; list = commentsMapperCustom.queryComments(videoId);</span><br><span class="line">    <span class="keyword">for</span>(CommentsVO c:list)&#123;</span><br><span class="line">        String timeAgo = TimeAgoUtils.format(c.getCreateTime());</span><br><span class="line">        c.setTimeAgoStr(timeAgo);</span><br><span class="line">    &#125;</span><br><span class="line">    PageInfo&lt;CommentsVO&gt; pageList = <span class="keyword">new</span> PageInfo&lt;&gt;(list);</span><br><span class="line">    PagedResult grid = <span class="keyword">new</span> PagedResult();</span><br><span class="line">    grid.setTotal(pageList.getPages());</span><br><span class="line">    grid.setRows(list);</span><br><span class="line">    grid.setPage(page);</span><br><span class="line">    grid.setRecords(pageList.getTotal());</span><br><span class="line">    <span class="keyword">return</span> grid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryComments"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    c.*,</span><br><span class="line">    u.face_image AS face_image,</span><br><span class="line">    u.nickname</span><br><span class="line">    FROM comments c LEFT JOIN users u ON c.from_user_id = u.id</span><br><span class="line">    WHERE c.video_id = #&#123;videoId&#125;</span><br><span class="line">    ORDER BY c.create_time DESC</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"GET COMMENT LIST"</span>, notes = <span class="string">"GET COMMENT LIST API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/getVideoComments"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">getVideoComments</span><span class="params">(String videoId,Integer page,Integer pageSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取视频留言列表</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(videoId))&#123;</span><br><span class="line">        <span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分页查询，时间倒序</span></span><br><span class="line">    <span class="keyword">if</span> (page == <span class="keyword">null</span>) &#123;</span><br><span class="line">        page = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pageSize == <span class="keyword">null</span>)&#123;</span><br><span class="line">        pageSize = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PagedResult list = videoService.getAllComments(videoId, page, pageSize);</span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.ok(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JS</span></span><br><span class="line"><span class="comment">// 获取留言列表</span></span><br><span class="line">getCommentsList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoId = me.data.videoInfo.id;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'留言列表加载中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">        url: app.serverUrl + <span class="string">'/video/getVideoComments?videoId='</span> + videoId + <span class="string">'&amp;page='</span> + page + <span class="string">'&amp;pageSize=5'</span>,</span><br><span class="line">        method: <span class="string">'POST'</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            wx.hideLoading();</span><br><span class="line">            <span class="built_in">console</span>.log(res.data);</span><br><span class="line">            <span class="comment">// 返回的数据库留言列表</span></span><br><span class="line">            <span class="keyword">var</span> commentsList = res.data.data.rows;</span><br><span class="line">            <span class="comment">// 当前分页列表</span></span><br><span class="line">            <span class="keyword">var</span> newCommentsList = me.data.commentsList;</span><br><span class="line">            me.setData(&#123;</span><br><span class="line">                commentsList: newCommentsList.concat(commentsList),</span><br><span class="line">                commentsPage: page,</span><br><span class="line">                commentsTotalPage: res.data.data.total</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JS</span></span><br><span class="line"><span class="comment">// 留言列表触底，刷新</span></span><br><span class="line">onReachBottom: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> currentPage = me.data.commentsPage;</span><br><span class="line">    <span class="keyword">var</span> totalPage = me.data.commentsTotalPage;</span><br><span class="line">    <span class="keyword">if</span> (currentPage === totalPage) &#123;</span><br><span class="line">        wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'没有更多留言'</span>,</span><br><span class="line">            icon: <span class="string">'loading'</span>,</span><br><span class="line">            duration:<span class="number">2000</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> page = currentPage + <span class="number">1</span>;</span><br><span class="line">    me.getCommentsList(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="评论回复（SQL设计与查询）"><a href="#评论回复（SQL设计与查询）" class="headerlink" title="评论回复（SQL设计与查询）"></a>评论回复（SQL设计与查询）</h4><p>对于回复评论的评论，需要在数据库comments表中添加多一个新的字段<code>father_comment_id</code>，以表示评论之间的关系，评论的关系则使用新的字段<code>to_user_id</code>；</p>
<p>并且修改XML中的SQL查询；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryComments"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    c.*,</span><br><span class="line">    u.face_image AS face_image,</span><br><span class="line">    u.nickname,</span><br><span class="line">    tu.nickname  AS toNickname</span><br><span class="line">    FROM comments c</span><br><span class="line">    LEFT JOIN users u ON c.from_user_id = u.id</span><br><span class="line">    LEFT JOIN users tu ON c.to_user_id = tu.id</span><br><span class="line">    WHERE c.video_id = #&#123;videoId&#125;</span><br><span class="line">    ORDER BY c.create_time DESC</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="评论回复功能"><a href="#评论回复功能" class="headerlink" title="评论回复功能"></a>评论回复功能</h4><p>修改部分JS；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发表留言</span></span><br><span class="line">saveComment: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 获取评论回复的fatherid和touseri</span></span><br><span class="line">    <span class="keyword">var</span> fatherCommentId = e.currentTarget.dataset.replyfathercommentid;</span><br><span class="line">    <span class="keyword">var</span> toUserId = e.currentTarget.dataset.replytouserid;</span><br><span class="line">    ...</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">        url: app.serverUrl + <span class="string">'/video/saveComment?fatherCommentId='</span> + fatherCommentId + <span class="string">'&amp;toUserId='</span> + toUserId,</span><br><span class="line">        ...</span><br><span class="line">        )&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改Controller；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"SAVE COMMENT"</span>, notes = <span class="string">"SAVE COMMENT API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/saveComment"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">saveComment</span><span class="params">(@RequestBody Comments comment, String fatherCommentId, String toUserId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存留言</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(fatherCommentId) || StringUtils.isBlank(toUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    comment.setFatherCommentId(fatherCommentId);</span><br><span class="line">    comment.setToUserId(toUserId);</span><br><span class="line">    videoService.saveComment(comment);</span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回复评论的评论绑定JS；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回复评论的评论事件</span></span><br><span class="line">replyFocus: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> fatherCommentId = e.currentTarget.dataset.fathercommentid;</span><br><span class="line">    <span class="keyword">var</span> toUserId = e.currentTarget.dataset.touserid;</span><br><span class="line">    <span class="keyword">var</span> toNickname = e.currentTarget.dataset.tonickname;</span><br><span class="line"></span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        placeholder: <span class="string">'回复 - '</span> + toNickname,</span><br><span class="line">        replyFatherCommentId: fatherCommentId,</span><br><span class="line">        replyToUserId: toUserId,</span><br><span class="line">        commentFocus: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/24/Spring Security 1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/24/Spring Security 1/" itemprop="url">Spring Security | Note-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-24T00:00:00+08:00">
                2018-08-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-1"><a href="#Spring-Security-Note-1" class="headerlink" title="Spring Security Note-1"></a>Spring Security Note-1</h3><hr>
<h4 id="认证和授权"><a href="#认证和授权" class="headerlink" title="认证和授权"></a>认证和授权</h4><p>对于服务的安全考虑，认证和授权是一个非常重要，并且有难度的点；</p>
<p>它的最终表现形式之一是登录；</p>
<h5 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h5><p>同时支持多种认证方式（传统，手机短信，微信，QQ等）；</p>
<p>同时支持多种前端渠道（浏览器，APP）；</p>
<p>支持集群环境，跨应用工作，SESSION控制，控制用户权限，防护与身份认证相关的攻击；</p>
<h5 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h5><p>打造可重用的，企业级的，认证和授权模块；</p>
<h5 id="涉及技术"><a href="#涉及技术" class="headerlink" title="涉及技术"></a>涉及技术</h5><p>Spring Security，Spring Social，Spring Security OAuth；</p>
<h5 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h5><p>理解Spring Security以及相关框架的原理、功能；</p>
<p>基于Spring Security以及相关框架独立开发认证授权相关功能；</p>
<p>掌握抽象和封装的常用技巧，编写可重用的模块；</p>
<hr>
<h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><p>security：主模块（统一执行命令）</p>
<p>security-core：核心业务逻辑（实现基本安全的方式）</p>
<p>security-browser：浏览器安全逻辑</p>
<p>security-app：app安全逻辑</p>
<p>security-demo：样例程序</p>
<hr>
<h4 id="工程搭建"><a href="#工程搭建" class="headerlink" title="工程搭建"></a>工程搭建</h4><p>在创建完所有的过程后；</p>
<p>首先对security的pom进行配置，引入dependencyManagement管理Maven项目的版本（自动管理其他依赖的版本，只需要告诉项目什么依赖即可，不需要指定版本，保证互相兼容）；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.spring.platform<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>platform-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Brussels-SR12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--引入插件，maven的编译工具，指定JDK和编译的版本为1.8--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-complier-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../security-app<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../security-browser<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../security-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>../security-demo<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来，在core项目中，添加pom依赖，依赖过多，不与展示；</p>
<p>添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--不需要添加version，由主项目的dependencyManagement控制版本，保证互相兼容--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Spring Security &amp; OAuth2认证--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Redis缓存--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--JDBC数据库--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--MYSQL驱动--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Spring Social--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--commons工具包--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来，在app和browser项目中，添加core依赖即可；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.imooc.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>imooc-security-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;imooc.security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>browser项目与app有略微不同，是一个web项目，所以需要添加spring-session依赖；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>demo项目则引用browser依赖；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.imooc.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>imooc-security-browser<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;imooc.security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Hello项目"><a href="#Hello项目" class="headerlink" title="Hello项目"></a>Hello项目</h4><p>首先依赖的有关数据库的包，需要先对数据库连接进行配置；</p>
<p>暂时先对spring-session的配置，暂时关闭；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># datasource</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxx?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=xxxx</span><br><span class="line"># session</span><br><span class="line">spring.session.store-type=none</span><br><span class="line"># spring-security</span><br><span class="line">security.basic.enabled=false</span><br></pre></td></tr></table></figure>
<p>此时访问<a href="http://localhost:8081/hello" target="_blank" rel="noopener">http://localhost:8081/hello</a> 需要帐号密码才能访问；</p>
<p>这是由于spring-security的默认配置，这里我们先暂时关闭；</p>
<p>如果我们需要将项目打包成可上线的包的形式，则需要在demo的pom文件中，添加一个插件；</p>
<p>用作打包的插件，按照Spring Boot的特有方式，进行打包；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此时maven进行 clean package的命令；</p>
<p>在demo文件下的target的目录下，有两个人jar包；</p>
<p>一个叫demo.jar（可执行jar包），一个demo.jar.original（原始文件）；</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/23/MicWechat Note-9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/23/MicWechat Note-9/" itemprop="url">Wechat Mini | Note-9</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-23T00:00:00+08:00">
                2018-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-9"><a href="#微信小程序开发-Note-9" class="headerlink" title="微信小程序开发 Note-9"></a>微信小程序开发 Note-9</h3><hr>
<h4 id="关注接口"><a href="#关注接口" class="headerlink" title="关注接口"></a>关注接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersLikeVideosMapper usersLikeVideosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersFansMapper usersFansMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUserFanRelation</span><span class="params">(String userId, String fanId)</span> </span>&#123;</span><br><span class="line">		UsersFans usersFan = <span class="keyword">new</span> UsersFans();</span><br><span class="line">		usersFan.setId(sid.nextShort());</span><br><span class="line">		usersFan.setUserId(userId);</span><br><span class="line">		usersFan.setFanId(fanId);</span><br><span class="line">		usersFansMapper.insert(usersFan);</span><br><span class="line"></span><br><span class="line">		userMapper.addFansCount(userId);</span><br><span class="line">		userMapper.addFollersCount(fanId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUserFanRelation</span><span class="params">(String userId, String fanId)</span> </span>&#123;</span><br><span class="line">		Example example = <span class="keyword">new</span> Example(UsersFans.class);</span><br><span class="line">		Example.Criteria criteria = example.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"userId"</span>,userId);</span><br><span class="line">		criteria.andEqualTo(<span class="string">"fanId"</span>,fanId);</span><br><span class="line">		usersFansMapper.deleteByExample(example);</span><br><span class="line"></span><br><span class="line">		userMapper.reduceFansCount(userId);</span><br><span class="line">		userMapper.reduceFollersCount(fanId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"FOLLOW USER"</span>, notes = <span class="string">"FOLLOW USER API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/beyourfans"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">beyourfans</span><span class="params">(String userId,String fanId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId) || StringUtils.isBlank(fanId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		userService.saveUserFanRelation(userId,fanId);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(<span class="string">"关注成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UNFOLLOW USER"</span>, notes = <span class="string">"UNFOLLOW USER API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/dontbeyourfans"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">dontbeyourfans</span><span class="params">(String userId,String fanId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId) || StringUtils.isBlank(fanId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		userService.deleteUserFanRelation(userId,fanId);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(<span class="string">"取消关注成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="关注联调"><a href="#关注联调" class="headerlink" title="关注联调"></a>关注联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mine.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    isMe:<span class="literal">true</span>,</span><br><span class="line">    isFollow:<span class="literal">false</span>,</span><br><span class="line">    publisherId:<span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// var user = app.userInfo;</span></span><br><span class="line">    <span class="comment">// 修改原有的全局对象为本地缓存</span></span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> userId = user.id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> publisherId = params.publisherId;</span><br><span class="line">    <span class="keyword">if</span> (publisherId != <span class="literal">null</span> &amp;&amp; publisherId != <span class="string">""</span> &amp;&amp; publisherId != <span class="literal">undefined</span>)&#123;</span><br><span class="line">      <span class="comment">// 进入发布者的页面</span></span><br><span class="line">      userId = publisherId;</span><br><span class="line">      me.setData(&#123;</span><br><span class="line">        isMe:<span class="literal">false</span>,</span><br><span class="line">        publisherId: publisherId</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 关注事件</span></span><br><span class="line">  followMe:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> publisherId = me.data.publisherId;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> userId = user.id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> followType = e.currentTarget.dataset.followtype;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span>(followType == <span class="string">'1'</span>)&#123;</span><br><span class="line">      <span class="comment">// 关注</span></span><br><span class="line">      url = <span class="string">'/user/beyourfans?userId='</span> + publisherId + <span class="string">"&amp;fanId="</span> + userId;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// 取消关注</span></span><br><span class="line">      url = <span class="string">'/user/dontbeyourfans?userId='</span> + publisherId + <span class="string">"&amp;fanId="</span> + userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'提交中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: app.serverUrl + url,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="string">'userId'</span>: user.id,</span><br><span class="line">        <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">      &#125;,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (followType == <span class="string">'1'</span>) &#123;</span><br><span class="line">          <span class="comment">// 关注</span></span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            isFollow:<span class="literal">true</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 取消关注</span></span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            isFollow: <span class="literal">false</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="关注功能完善"><a href="#关注功能完善" class="headerlink" title="关注功能完善"></a>关注功能完善</h4><p>关注与已关注的实时刷新；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (followType == <span class="string">'1'</span>) &#123;</span><br><span class="line">    <span class="comment">// 关注</span></span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        isFollow:<span class="literal">true</span>,</span><br><span class="line">        fansCounts: ++me.data.fansCounts</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 取消关注</span></span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        isFollow: <span class="literal">false</span>,</span><br><span class="line">        fansCounts: --me.data.fansCounts</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户头像的事件触发修改；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;isMe&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;faceUrl&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"face"</span> <span class="attr">bindtap</span>=<span class="string">'changeFace'</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;!isMe&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;faceUrl&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"face"</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">'nickname'</span>&gt;</span>&#123;&#123;nickname&#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="作品-收藏-关注-tab动态切换"><a href="#作品-收藏-关注-tab动态切换" class="headerlink" title="作品 收藏 关注 tab动态切换"></a>作品 收藏 关注 tab动态切换</h4><p>通过三个不同的List和不同的Flag的值，进行不同List的获取；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">    isMe: <span class="literal">true</span>,</span><br><span class="line">    isFollow: <span class="literal">false</span>,</span><br><span class="line">    publisherId: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    videoSelClass: <span class="string">"video-info"</span>,</span><br><span class="line">    isSelectedWork: <span class="string">"video-info-selected"</span>,</span><br><span class="line">    isSelectedLike: <span class="string">""</span>,</span><br><span class="line">    isSelectedFollow: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    myVideoList: [],</span><br><span class="line">    myVideoPage: <span class="number">1</span>,</span><br><span class="line">    myVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    likeVideoList: [],</span><br><span class="line">    likeVideoPage: <span class="number">1</span>,</span><br><span class="line">    likeVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    followVideoList: [],</span><br><span class="line">    followVideoPage: <span class="number">1</span>,</span><br><span class="line">    followVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    myWorkFlag: <span class="literal">false</span>,</span><br><span class="line">    myLikesFlag: <span class="literal">true</span>,</span><br><span class="line">    myFollowFlag: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 选择作品tab</span></span><br><span class="line">  doSelectWork: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setData(&#123;</span><br><span class="line">      isSelectedWork: <span class="string">"video-info-selected"</span>,</span><br><span class="line">      isSelectedLike: <span class="string">""</span>,</span><br><span class="line">      isSelectedFollow: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">      myWorkFlag: <span class="literal">false</span>,</span><br><span class="line">      myLikesFlag: <span class="literal">true</span>,</span><br><span class="line">      myFollowFlag: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      myVideoList: [],</span><br><span class="line">      myVideoPage: <span class="number">1</span>,</span><br><span class="line">      myVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      likeVideoList: [],</span><br><span class="line">      likeVideoPage: <span class="number">1</span>,</span><br><span class="line">      likeVideoTotal: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">      followVideoList: [],</span><br><span class="line">      followVideoPage: <span class="number">1</span>,</span><br><span class="line">      followVideoTotal: <span class="number">1</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.getMyVideoList(<span class="number">1</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 选择收藏tab</span></span><br><span class="line">  doSelectLike: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 选择关注tab</span></span><br><span class="line">  doSelectFollow: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">  &#125;,</span><br><span class="line">  getMyVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询视频信息</span></span><br><span class="line">    wx.showLoading();</span><br><span class="line">    <span class="comment">// 调用后端</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll/?page='</span> + page + <span class="string">'&amp;pageSize=6'</span>,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        userId: me.data.userId</span><br><span class="line">      &#125;,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span> <span class="comment">// 默认值</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="keyword">var</span> myVideoList = res.data.data.rows;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.myVideoList;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          myVideoPage: page,</span><br><span class="line">          myVideoList: newVideoList.concat(myVideoList),</span><br><span class="line">          myVideoTotal: res.data.data.total,</span><br><span class="line">          serverUrl: app.serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 我的作品视频列表</span></span><br><span class="line">  getMyVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询视频信息</span></span><br><span class="line">    wx.showLoading();</span><br><span class="line">    <span class="comment">// 调用后端</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll/?page='</span> + page + <span class="string">'&amp;pageSize=6'</span>,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        userId: me.data.userId</span><br><span class="line">      &#125;,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span> <span class="comment">// 默认值</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="keyword">var</span> myVideoList = res.data.data.rows;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.myVideoList;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          myVideoPage: page,</span><br><span class="line">          myVideoList: newVideoList.concat(myVideoList),</span><br><span class="line">          myVideoTotal: res.data.data.total,</span><br><span class="line">          serverUrl: app.serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="微信API菜单操作"><a href="#微信API菜单操作" class="headerlink" title="微信API菜单操作"></a>微信API菜单操作</h4><h5 id="wx-showActionSheet-OBJECT-显示操作菜单"><a href="#wx-showActionSheet-OBJECT-显示操作菜单" class="headerlink" title="wx.showActionSheet(OBJECT) 显示操作菜单"></a>wx.showActionSheet(OBJECT) 显示操作菜单</h5><p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>itemList</td>
<td>String Array</td>
<td>是</td>
<td>按钮的文字数组，数组长度最大为6个</td>
</tr>
<tr>
<td>itemColor</td>
<td>HexColor</td>
<td>否</td>
<td>按钮的文字颜色，默认为”#000000”</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功的回调函数，详见返回参数说明</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">shareMe:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.showActionSheet(&#123;</span><br><span class="line">        itemList: [<span class="string">'下载到本地'</span>, <span class="string">'举报用户'</span>, <span class="string">'分享到朋友圈'</span>,<span class="string">'分享到QQ空间'</span>,<span class="string">'分享到微博'</span>],</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(res.tapIndex);</span><br><span class="line">            <span class="keyword">if</span>(res.tapIndex == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">// 下载</span></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(res.tapIndex == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="comment">// 举报用户</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 未开放</span></span><br><span class="line">                wx.showToast(&#123;</span><br><span class="line">                    title: <span class="string">'功能暂未开发'</span>,</span><br><span class="line">                    icon:<span class="string">'loading'</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="保存举报信息接口"><a href="#保存举报信息接口" class="headerlink" title="保存举报信息接口"></a>保存举报信息接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Service</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportUser</span><span class="params">(UsersReport usersReport)</span> </span>&#123;</span><br><span class="line">    usersReport.setId(sid.nextShort());</span><br><span class="line">    usersReport.setCreateDate(<span class="keyword">new</span> Date());</span><br><span class="line">    usersReportMapper.insert(usersReport);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"REPORT USER"</span>, notes = <span class="string">"REPORT USER API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/reportUser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">reportUser</span><span class="params">(@RequestBody UsersReport usersReport)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存举报信息</span></span><br><span class="line">    userService.reportUser(usersReport);</span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"举报成功，相关人员会及时处理"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="举报联调"><a href="#举报联调" class="headerlink" title="举报联调"></a>举报联调</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (res.tapIndex == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 举报用户</span></span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(me.data.videoInfo);</span><br><span class="line">    <span class="keyword">var</span> realUrl = <span class="string">'../videoinfo/videoinfo#videoInfo@'</span> + videoInfo;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">''</span>) &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            url: <span class="string">'../userLogin/login?redirectUrl='</span> + realUrl,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> publishUserId = me.data.videoInfo.userId;</span><br><span class="line">        <span class="keyword">var</span> videoId = me.data.videoInfo.id;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            url: <span class="string">'../report/report?videoId='</span> + videoId + <span class="string">"&amp;publishUserId="</span> + publishUserId</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="分享好友或微信群"><a href="#分享好友或微信群" class="headerlink" title="分享好友或微信群"></a>分享好友或微信群</h4><h5 id="onShareAppMessage-Object"><a href="#onShareAppMessage-Object" class="headerlink" title="onShareAppMessage(Object)"></a>onShareAppMessage(Object)</h5><p>监听用户点击页面内转发按钮（<code>&lt;button&gt;</code> 组件 <code>open-type=&quot;share&quot;</code>）或右上角菜单“转发”按钮的行为，并自定义转发内容。</p>
<p><strong>注意：只有定义了此事件处理函数，右上角菜单才会显示“转发”按钮</strong></p>
<p><strong>Object 参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>from</td>
<td>String</td>
<td>转发事件来源。 <code>button</code>：页面内转发按钮； <code>menu</code>：右上角转发菜单</td>
</tr>
<tr>
<td>target</td>
<td>Object</td>
<td>如果 <code>from</code> 值是 <code>button</code>，则 <code>target</code> 是触发这次转发事件的 <code>button</code>，否则为 <code>undefined</code></td>
</tr>
<tr>
<td>webViewUrl</td>
<td>String</td>
<td>页面中包含<code>&lt;web-view&gt;</code>组件时，返回当前<code>&lt;web-view&gt;</code>的url</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分享</span></span><br><span class="line">onShareAppMessage: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoInfo = me.data.videoInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        title: <span class="string">'短视频内容分享'</span>,</span><br><span class="line">        path: <span class="string">'pages/videoinfo/videoinfo?videoInfo='</span> + <span class="built_in">JSON</span>.stringify(videoInfo)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="下载视频到本地"><a href="#下载视频到本地" class="headerlink" title="下载视频到本地"></a>下载视频到本地</h4><h5 id="wx-downloadFile-OBJECT"><a href="#wx-downloadFile-OBJECT" class="headerlink" title="wx.downloadFile(OBJECT)"></a>wx.downloadFile(OBJECT)</h5><p>下载文件资源到本地，客户端直接发起一个 HTTP GET 请求，返回文件的本地临时路径；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>必填</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>String</td>
<td>是</td>
<td>下载资源的 url</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>否</td>
<td>HTTP 请求 Header，header 中不能设置 Referer</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>下载成功后以 tempFilePath 的形式传给页面，res = {tempFilePath: ‘文件的临时路径’}</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<p>注：文件的临时路径，在小程序本次启动期间可以正常使用，如需持久保存，需在主动调用 wx.saveFile，才能在小程序下次启动时访问得到；</p>
<p>注：请在 header 中指定合理的 Content-Type 字段，以保证客户端正确处理文件类型；</p>
<h5 id="wx-saveVideoToPhotosAlbum-OBJECT"><a href="#wx-saveVideoToPhotosAlbum-OBJECT" class="headerlink" title="wx.saveVideoToPhotosAlbum(OBJECT)"></a>wx.saveVideoToPhotosAlbum(OBJECT)</h5><p>保存视频到系统相册</p>
<p>需要<a href="https://developers.weixin.qq.com/miniprogram/dev/api/authorize-index.html" target="_blank" rel="noopener">用户授权</a> scope.writePhotosAlbum</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>filePath</td>
<td>String</td>
<td>是</td>
<td>视频文件路径，可以是临时文件路径也可以是永久文件路径</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (res.tapIndex == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 下载</span></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'下载中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.downloadFile(&#123;</span><br><span class="line">        url: app.serverUrl + me.data.videoInfo.videoPath,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 只要服务器有响应数据，就会把响应内容写入文件并进入 success 回调，业务需要自行判断是否下载到了想要的内容</span></span><br><span class="line">            <span class="keyword">if</span> (res.statusCode === <span class="number">200</span>) &#123;</span><br><span class="line">                wx.saveVideoToPhotosAlbum(&#123;</span><br><span class="line">                    filePath: res.tempFilePath,</span><br><span class="line">                    success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(res.errMsg)</span><br><span class="line">                        wx.hideLoading();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/MicWechat Note-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/22/MicWechat Note-8/" itemprop="url">Wechat Mini | Note-8</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T00:00:00+08:00">
                2018-08-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-8"><a href="#微信小程序开发-Note-8" class="headerlink" title="微信小程序开发 Note-8"></a>微信小程序开发 Note-8</h3><hr>
<h4 id="搜索功能整合-amp-首页联调"><a href="#搜索功能整合-amp-首页联调" class="headerlink" title="搜索功能整合 &amp; 首页联调"></a>搜索功能整合 &amp; 首页联调</h4><p>通过修改index.js中对于<code>getAllVideoList</code>，加入对应的参数，搜索内容和分页记录；</p>
<p>以达到搜索返回视频列表的目标；（上拉刷新和下拉刷新不进行刷新）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 共用方法</span></span><br><span class="line">getAllVideoList: <span class="function"><span class="keyword">function</span> (<span class="params">page, isSaveRecord</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'视频加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> searchContent = me.data.searchContent;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page + <span class="string">"&amp;isSaveRecord="</span> + isSaveRecord,</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      data:&#123;</span><br><span class="line">        videoDesc:searchContent</span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        wx.hideNavigationBarLoading();</span><br><span class="line">        wx.stopPullDownRefresh();</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="comment">// 判断当前页page是否为第一页，第一页则清空videoList</span></span><br><span class="line">        <span class="keyword">if</span> (page === <span class="number">1</span>) &#123;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            videoList: []</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> videoList = res.data.data.rows;</span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.videoList;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          videoList: newVideoList.concat(videoList),</span><br><span class="line">          page: page,</span><br><span class="line">          totalPage: res.data.data.total,</span><br><span class="line">          serverUrl: serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="热搜查询联调-amp-视频对象播放与暂停"><a href="#热搜查询联调-amp-视频对象播放与暂停" class="headerlink" title="热搜查询联调 &amp; 视频对象播放与暂停"></a>热搜查询联调 &amp; 视频对象播放与暂停</h4><p><strong>Q:对视频对象进行mute设置时，跳转到搜索页面和主页时，视频依然播放音乐；</strong></p>
<p>A:在JS中进行相应的修改；</p>
<p>步骤：    在生命周期的onLoad（），获取videoContext，onShow（）对视频进行播放，</p>
<p>​        在跳转时，onHide（）进行视频暂停；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    cover:<span class="string">"cover"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  videoCtx:&#123;&#125;,</span><br><span class="line">  onLoad:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx = wx.createVideoContext(<span class="string">"myVideo"</span>, me);</span><br><span class="line">  &#125;,</span><br><span class="line">  onShow:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx.play();</span><br><span class="line">  &#125;,</span><br><span class="line">  onHide:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx.pause();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 搜索</span></span><br><span class="line">  showSearch:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.navigateTo(&#123;</span><br><span class="line">      url: <span class="string">'../searchVideo/searchVideo'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="上传视频功能复用-amp-测试"><a href="#上传视频功能复用-amp-测试" class="headerlink" title="上传视频功能复用 &amp; 测试"></a>上传视频功能复用 &amp; 测试</h4><p>在pages同级目录下，创建一个utils，videoUtil.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// videoUtil.js</span></span><br><span class="line"><span class="comment">// 视频上传-跳转至BGM选择页面</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadVideo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">  wx.chooseVideo(&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// videoUtil.js 导出</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  uploadVideo: uploadVideo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> videoUtil = <span class="built_in">require</span>(<span class="string">'../../utils/videoUtil.js'</span>) <span class="comment">// 引用</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 上传视频</span></span><br><span class="line">  upload:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    videoUtil.uploadVideo();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页进入视频展示页"><a href="#首页进入视频展示页" class="headerlink" title="首页进入视频展示页"></a>首页进入视频展示页</h4><p>从首页中的对象，获取到JSON数据，然后通过转换的形式，转换成字符串，传到videoinfo，在videoinfo中，再转换回JSON对象，进行数据的获取和赋值；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// 具体的视频信息-跳转</span></span><br><span class="line">showVideoInfo: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoList = me.data.videoList;</span><br><span class="line">    <span class="keyword">var</span> arrindex = e.target.dataset.arrindex;</span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(videoList[arrindex]);</span><br><span class="line">    wx.redirectTo(&#123;</span><br><span class="line">      url: <span class="string">'../videoinfo/videoinfo?videoInfo='</span> + videoInfo</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// videoinfo.js</span></span><br><span class="line">onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.videoCtx = wx.createVideoContext(<span class="string">"myVideo"</span>, me);</span><br><span class="line">    <span class="comment">// 获取上一页面传入的参数</span></span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.parse(params.videoInfo);</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">      videoId: videoInfo.id,</span><br><span class="line">      src: app.serverUrl + videoInfo.videoPath,</span><br><span class="line">      videoInfo: videoInfo</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="页面重定向"><a href="#页面重定向" class="headerlink" title="页面重定向"></a>页面重定向</h4><p>对于没有登录的用户，可以搜索，但是不能进行个人信息页面的跳转和视频的上传；</p>
<p>所以需要对于没有登录的用户，进行页面的拦截和重定向；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">showMine: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">""</span>) &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../mine/mine'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在从视频详细页面跳转到登录页面之后，我们希望登录后，再次跳转回到之前的视频详细页面；</p>
<p>那么我们需要将原视频详细页面的信息传到登录页面，再进行页面的重定向跳转；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// videoInfo.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 上传视频</span></span><br><span class="line">  upload: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="comment">// 重定向数据定义</span></span><br><span class="line">    <span class="keyword">var</span> videoInfo = <span class="built_in">JSON</span>.stringify(me.data.videoInfo);</span><br><span class="line">    <span class="keyword">var</span> realUrl = <span class="string">'../videoinfo/videoinfo#videoInfo@'</span> + videoInfo;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">""</span>) &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../userLogin/login?redirectUrl='</span> + realUrl,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      videoUtil.uploadVideo();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.js</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 视频页面重定向跳转到登录页面，做参数的处理（接收与反传）</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> redirectUrl = params.redirectUrl;</span><br><span class="line">    redirectUrl = redirectUrl.replace(<span class="regexp">/#/g</span>, <span class="string">"?"</span>);</span><br><span class="line">    redirectUrl = redirectUrl.replace(<span class="regexp">/@/g</span>, <span class="string">"="</span>);</span><br><span class="line">    me.redirectUrl = redirectUrl;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 登录</span></span><br><span class="line">  doLogin: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (username.length == <span class="number">0</span> || password.length == <span class="number">0</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// BackEnd</span></span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        ...</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">          ...</span><br><span class="line">            <span class="comment">// app.userInfo = res.data.data;</span></span><br><span class="line">            <span class="comment">// fixme 修改原有全局对象为本地缓存</span></span><br><span class="line">            app.setGlobalUserInfo(res.data.data);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 页面跳转</span></span><br><span class="line">            <span class="keyword">var</span> redirectUrl = me.redirectUrl;</span><br><span class="line">            <span class="keyword">if</span> (redirectUrl != <span class="literal">null</span> &amp;&amp; redirectUrl != <span class="literal">undefined</span> &amp;&amp; redirectUrl != <span class="string">""</span>) &#123;</span><br><span class="line">              wx.redirectTo(&#123;</span><br><span class="line">                url: redirectUrl,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              wx.redirectTo(&#123;</span><br><span class="line">                url: <span class="string">'../mine/mine'</span>,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == <span class="number">500</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="拦截器配置与注册"><a href="#拦截器配置与注册" class="headerlink" title="拦截器配置与注册"></a>拦截器配置与注册</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟拦截器配置（对所有请求进行拦截）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 拦截请求判断，预处理（Controller之前）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">"请求拦截"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 返回false：请求被拦截，返回</span></span><br><span class="line">		<span class="comment">// 返回true:请求允许,继续执行</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求Controller之后，渲染视图之前</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求和视图渲染之后</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拦截器注册</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MiniInterceptor <span class="title">miniInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MiniInterceptor();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册中心</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对UserController进行拦截注册</span></span><br><span class="line">        registry.addInterceptor(miniInterceptor()).addPathPatterns(<span class="string">"/user/**"</span>);</span><br><span class="line">        <span class="keyword">super</span>.addInterceptors(registry);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="完善登录拦截-amp-限制单台手机登录"><a href="#完善登录拦截-amp-限制单台手机登录" class="headerlink" title="完善登录拦截 &amp; 限制单台手机登录"></a>完善登录拦截 &amp; 限制单台手机登录</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RedisOperator redis;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_REDIS_SESSION = <span class="string">"user-redis-session"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 拦截请求判断，预处理（Controller之前）</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String userId = request.getHeader(<span class="string">"userId"</span>);</span><br><span class="line">		String userToken = request.getHeader(<span class="string">"userToken"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isNotBlank(userId) &amp;&amp; StringUtils.isNotBlank(userToken)) &#123;</span><br><span class="line">			String uniqueToken = redis.get(USER_REDIS_SESSION + <span class="string">":"</span> + userId);</span><br><span class="line">			<span class="comment">// Token超时限制的判断 重新登录</span></span><br><span class="line">			<span class="keyword">if</span> (StringUtils.isEmpty(uniqueToken) &amp;&amp; StringUtils.isBlank(uniqueToken)) &#123;</span><br><span class="line">				System.out.println(<span class="string">"请登录"</span>);</span><br><span class="line">				returnErrorResponse(response, IMoocJSONResult.errorTokenMsg(<span class="string">"请登录"</span>));</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 限制一台手机登录</span></span><br><span class="line">				<span class="keyword">if</span> (!uniqueToken.equals(userToken)) &#123;</span><br><span class="line">					System.out.println(<span class="string">"帐号异点登录"</span>);</span><br><span class="line">					returnErrorResponse(response, IMoocJSONResult.errorTokenMsg(<span class="string">"帐号异点登录"</span>));</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			returnErrorResponse(response, IMoocJSONResult.errorTokenMsg(<span class="string">"请登录"</span>));</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 公用返回JSON格式</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnErrorResponse</span><span class="params">(HttpServletResponse response, IMoocJSONResult result)</span> <span class="keyword">throws</span> IOException, UnsupportedEncodingException </span>&#123;</span><br><span class="line">		OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">			response.setContentType(<span class="string">"text/json"</span>);</span><br><span class="line">			out = response.getOutputStream();</span><br><span class="line">			out.write(JsonUtils.objectToJson(result).getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			out.flush();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">				out.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="拦截器联调"><a href="#拦截器联调" class="headerlink" title="拦截器联调"></a>拦截器联调</h4><p>对于拦截器方法中，需要获取用户的USERID以及USERTOKEN，所以在用户请求时，在header中加入相应数据，以实现拦截器的功能；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      ...</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="string">'userId'</span>: user.id,</span><br><span class="line">        <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.data.status == <span class="number">502</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: res.data.msg,</span><br><span class="line">            icon: <span class="string">'none'</span>,</span><br><span class="line">            duration: <span class="number">2000</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">              wx.redirectTo(&#123;</span><br><span class="line">                url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="点赞接口"><a href="#点赞接口" class="headerlink" title="点赞接口"></a>点赞接口</h4><p>非常简单的接口，不加以展示；</p>
<p>首先对Mapper进行方法的编写，然后修改对于的XML的语句；</p>
<p>在VideoServiceImpl进行对于方法的实现即可<code>userLikeVideo</code> &amp; <code>userUnLikeVideo</code>；</p>
<p>以及Controller的修改；</p>
<h4 id="点赞联调"><a href="#点赞联调" class="headerlink" title="点赞联调"></a>点赞联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> videoUtil = <span class="built_in">require</span>(<span class="string">'../../utils/videoUtil.js'</span>)</span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    cover: <span class="string">"cover"</span>,</span><br><span class="line">    videoId: <span class="string">""</span>,</span><br><span class="line">    src: <span class="string">""</span>,</span><br><span class="line">    videoInfo: &#123;&#125;,</span><br><span class="line">    userLikeVideo: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 点赞与取消点赞</span></span><br><span class="line">  likeVideoOrNot: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> videoInfo = me.data.videoInfo;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="comment">// 判断登录</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user == <span class="literal">undefined</span> || user == <span class="string">""</span>) &#123;</span><br><span class="line">      wx.navigateTo(&#123;</span><br><span class="line">        url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 点赞与取消点赞的request</span></span><br><span class="line">      <span class="keyword">var</span> userLikeVideo = me.data.userLikeVideo;</span><br><span class="line">      <span class="keyword">var</span> url = <span class="string">'/video/userLike?userId='</span> + user.id + <span class="string">"&amp;videoId="</span> + videoInfo.id + <span class="string">"&amp;videoCreaterId="</span> + videoInfo.userId;</span><br><span class="line">      <span class="keyword">if</span> (userLikeVideo) &#123;</span><br><span class="line">        <span class="comment">// 取消点赞</span></span><br><span class="line">        url = <span class="string">'/video/userUnLike?userId='</span> + user.id + <span class="string">"&amp;videoId="</span> + videoInfo.id + <span class="string">"&amp;videoCreaterId="</span> + videoInfo.userId;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// request</span></span><br><span class="line">      <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">      wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'提交中'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        url: serverUrl + url,</span><br><span class="line">        method: <span class="string">'POST'</span>,</span><br><span class="line">        header: &#123;</span><br><span class="line">          <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">          <span class="string">'userId'</span>: user.id,</span><br><span class="line">          <span class="string">'userToken'</span>: user.userToken</span><br><span class="line">        &#125;,</span><br><span class="line">        success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">          wx.hideLoading();</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            userLikeVideo: !userLikeVideo</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视频展示页"><a href="#视频展示页" class="headerlink" title="视频展示页"></a>视频展示页</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> videoUtil = <span class="built_in">require</span>(<span class="string">'../../utils/videoUtil.js'</span>)</span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    cover: <span class="string">"cover"</span>,</span><br><span class="line">    videoId: <span class="string">""</span>,</span><br><span class="line">    src: <span class="string">""</span>,</span><br><span class="line">    videoInfo: &#123;&#125;,</span><br><span class="line">    userLikeVideo: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取视频发布者信息，点赞关系</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    <span class="keyword">var</span> user = app.getGlobalUserInfo();</span><br><span class="line">    <span class="keyword">var</span> loginUserId = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span> &amp;&amp; user != <span class="literal">undefined</span> &amp;&amp; user != <span class="string">""</span>) &#123;</span><br><span class="line">      loginUserId = user.id;</span><br><span class="line">    &#125;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/user/queryPublisher?loginUserId='</span> + loginUserId + <span class="string">"&amp;videoId="</span> + videoInfo.id + <span class="string">"&amp;publishUserId="</span> + videoInfo.userId,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="keyword">var</span> publisher = res.data.data.publisher;</span><br><span class="line">        <span class="keyword">var</span> userLikeVideo = res.data.data.userLikeVideo;</span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          serverUrl: serverUrl,</span><br><span class="line">          publisher: publisher,</span><br><span class="line">          userLikeVideo: userLikeVideo</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"QUERY VIDEO PUBLISHER INFORMATION"</span>, notes = <span class="string">"QUERY VIDEO PUBLISHER INFORMATION API"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/queryPublisher"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">queryPublisher</span><span class="params">(String loginUserId,String videoId,String publishUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(publishUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"信息不存在(无ID)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查询发布者用户个人信息</span></span><br><span class="line">    Users userInfo = userService.queryUserInfo(publishUserId);</span><br><span class="line">    UsersVO publisher = <span class="keyword">new</span> UsersVO();</span><br><span class="line">    BeanUtils.copyProperties(userInfo, publisher);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查询登录用户与点赞关系</span></span><br><span class="line">    <span class="keyword">boolean</span> userLikeVideo = userService.isUserLikeVideo(loginUserId,videoId);</span><br><span class="line">    PublisherVideo bean = <span class="keyword">new</span> PublisherVideo();</span><br><span class="line">    bean.setPublisher(publisher);</span><br><span class="line">    bean.setUserLikeVideo(userLikeVideo);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> IMoocJSONResult.ok(bean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/21/MicWechat Note-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/21/MicWechat Note-7/" itemprop="url">Wechat Mini | Note-7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-21T00:00:00+08:00">
                2018-08-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-7"><a href="#微信小程序开发-Note-7" class="headerlink" title="微信小程序开发 Note-7"></a>微信小程序开发 Note-7</h3><hr>
<h4 id="小程序首页视频列表"><a href="#小程序首页视频列表" class="headerlink" title="小程序首页视频列表"></a>小程序首页视频列表</h4><p>首页是底色加封面图，并不是可播放的视频；</p>
<h4 id="自定义mapper"><a href="#自定义mapper" class="headerlink" title="自定义mapper"></a>自定义mapper</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAllVideos"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    select v.*,u.face_image as face_image,u.nickname as nickname from videos v</span><br><span class="line">    left join users u on u.id = v.user_id</span><br><span class="line">    where</span><br><span class="line">    1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" videoDesc != null and videoDesc != '' "</span>&gt;</span></span><br><span class="line">        and v.video_desc like '%$&#123;videoDesc&#125;%'</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" userId != null and userId != '' "</span>&gt;</span></span><br><span class="line">        and v.user_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    and v.status = 1</span><br><span class="line">    order by v.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="视频列表分页查询接口"><a href="#视频列表分页查询接口" class="headerlink" title="视频列表分页查询接口"></a>视频列表分页查询接口</h4><p>Pagehelper原理：</p>
<p>从数据库中select数据，在查询之前做一层拦截；</p>
<p>拦截后的select语句，将会由Ph做一个拼接，拼接成复合分页要求的select（limit）语句；</p>
<p>拼接出来的新select语句将替代原select，获取数据；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询第几页，每页显示几条数据</span></span><br><span class="line">PageHelper.startPage(page,pageSize);</span><br><span class="line">List&lt;User&gt; list = userMapper.find();</span><br><span class="line">PageInfo page = <span class="keyword">new</span> PageInfo&lt;list&gt;;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapperCustom videosMapperCustom;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> PagedResult <span class="title">getAllVideos</span><span class="params">(Integer page, Integer pageSize)</span> </span>&#123;</span><br><span class="line">		PageHelper.startPage(page,pageSize);</span><br><span class="line">		List&lt;VideosVO&gt; list = videosMapperCustom.queryAllVideos();</span><br><span class="line"></span><br><span class="line">		PageInfo&lt;VideosVO&gt; pageList = <span class="keyword">new</span> PageInfo&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">		PagedResult pagedResult = <span class="keyword">new</span> PagedResult();</span><br><span class="line">		pagedResult.setPage(page);</span><br><span class="line">		pagedResult.setTotal(pageList.getPages());</span><br><span class="line">		pagedResult.setRows(list);</span><br><span class="line">		pagedResult.setRecords(pageList.getTotal());</span><br><span class="line">		<span class="keyword">return</span> pagedResult;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/showAll"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">showAll</span><span class="params">(Integer page)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(page == <span class="keyword">null</span>)&#123;</span><br><span class="line">			page = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		PagedResult pagedResult = videoService.getAllVideos(page,PAGE_SIZE);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(pagedResult);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页分页联调"><a href="#首页分页联调" class="headerlink" title="首页分页联调"></a>首页分页联调</h4><h5 id="wx-getSystemInfoSync-获取系统信息同步接口"><a href="#wx-getSystemInfoSync-获取系统信息同步接口" class="headerlink" title="wx.getSystemInfoSync() - 获取系统信息同步接口"></a>wx.getSystemInfoSync() - 获取系统信息同步接口</h5><p>同步返回参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>screenWidth</td>
<td>屏幕宽度</td>
</tr>
<tr>
<td>screenHeight</td>
<td>屏幕高度</td>
</tr>
<tr>
<td>windowWidth</td>
<td>可使用窗口宽度</td>
</tr>
<tr>
<td>windowHeight</td>
<td>可使用窗口高度</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    <span class="comment">// 总页数</span></span><br><span class="line">    totalPage: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 当前页数</span></span><br><span class="line">    page: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 视频列表</span></span><br><span class="line">    videoList: [],</span><br><span class="line">    screenWidth: <span class="number">350</span>,</span><br><span class="line">    serverUrl: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> screenWidth = wx.getSystemInfoSync().screenWidth;</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">      screenWidth: screenWidth</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前的分页数</span></span><br><span class="line">    <span class="keyword">var</span> page = me.data.page;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="comment">// 判断当前页page是否为第一页，第一页则清空videoList</span></span><br><span class="line">        <span class="keyword">if</span>(page === <span class="number">1</span>)&#123;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            videoList: []</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> videoList = res.data.data.rows;</span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.videoList;</span><br><span class="line"></span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          videoList: newVideoList.concat(videoList),</span><br><span class="line">          page:page,</span><br><span class="line">          totalPage: res.data.data.total,</span><br><span class="line">          serverUrl:serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页——上拉分页"><a href="#首页——上拉分页" class="headerlink" title="首页——上拉分页"></a>首页——上拉分页</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"><span class="comment">// 并且修改共用方法</span></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    <span class="comment">// 总页数</span></span><br><span class="line">    totalPage: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 当前页数</span></span><br><span class="line">    page: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 视频列表</span></span><br><span class="line">    videoList: [],</span><br><span class="line">    screenWidth: <span class="number">350</span>,</span><br><span class="line">    serverUrl: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 共用方法</span></span><br><span class="line">  getAllVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page,</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="comment">// 判断当前页page是否为第一页，第一页则清空videoList</span></span><br><span class="line">        <span class="keyword">if</span> (page === <span class="number">1</span>) &#123;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            videoList: []</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> videoList = res.data.data.rows;</span><br><span class="line">        <span class="keyword">var</span> newVideoList = me.data.videoList;</span><br><span class="line"></span><br><span class="line">        me.setData(&#123;</span><br><span class="line">          videoList: newVideoList.concat(videoList),</span><br><span class="line">          page: page,</span><br><span class="line">          totalPage: res.data.data.total,</span><br><span class="line">          serverUrl: serverUrl</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 上拉刷新</span></span><br><span class="line">  onReachBottom: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> currentPage = me.data.page;</span><br><span class="line">    <span class="keyword">var</span> totalPage = me.data.totalPage;</span><br><span class="line">    <span class="comment">// 如果是最后一页，无须查询</span></span><br><span class="line">    <span class="keyword">if</span> (currentPage === totalPage) &#123;</span><br><span class="line">      wx.showToast(&#123;</span><br><span class="line">        title: <span class="string">'没有更多视频，请积极投稿'</span>,</span><br><span class="line">        icon: <span class="string">'none'</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续翻页</span></span><br><span class="line">    <span class="keyword">var</span> page = currentPage + <span class="number">1</span>;</span><br><span class="line">    me.getAllVideoList(page);</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 具体的视频信息</span></span><br><span class="line">  showVideoInfo: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="首页——下拉刷新"><a href="#首页——下拉刷新" class="headerlink" title="首页——下拉刷新"></a>首页——下拉刷新</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 共用方法</span></span><br><span class="line">  getAllVideoList: <span class="function"><span class="keyword">function</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/video/showAll?page='</span> + page,</span><br><span class="line">      method: <span class="string">'POST'</span>,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 隐藏刷新</span></span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        wx.hideNavigationBarLoading();</span><br><span class="line">        wx.stopPullDownRefresh();</span><br><span class="line">        ...</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 下拉刷新(需要在index.json启动事件)</span></span><br><span class="line">  onPullDownRefresh:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    wx.showNavigationBarLoading();</span><br><span class="line">    <span class="keyword">this</span>.getAllVideoList(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视频组件与API"><a href="#视频组件与API" class="headerlink" title="视频组件与API"></a>视频组件与API</h4><p><a href="https://developers.weixin.qq.com/miniprogram/dev/component/video.html" target="_blank" rel="noopener">video 视频</a></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>src</td>
<td>String</td>
<td></td>
<td>要播放视频的资源地址，支持云文件ID（2.2.3）</td>
</tr>
<tr>
<td>initial-time</td>
<td>Number</td>
<td></td>
<td>指定视频初始播放位置</td>
</tr>
<tr>
<td>duration</td>
<td>Number</td>
<td></td>
<td>指定视频时长</td>
</tr>
<tr>
<td>controls</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示默认播放控件（播放/暂停按钮、播放进度、时间）</td>
</tr>
<tr>
<td>danmu-list</td>
<td>Object Array</td>
<td></td>
<td>弹幕列表</td>
</tr>
<tr>
<td>danmu-btn</td>
<td>Boolean</td>
<td>false</td>
<td>是否显示弹幕按钮，只在初始化时有效，不能动态变更</td>
</tr>
<tr>
<td>enable-danmu</td>
<td>Boolean</td>
<td>false</td>
<td>是否展示弹幕，只在初始化时有效，不能动态变更</td>
</tr>
<tr>
<td>autoplay</td>
<td>Boolean</td>
<td>false</td>
<td>是否自动播放</td>
</tr>
<tr>
<td>loop</td>
<td>Boolean</td>
<td>false</td>
<td>是否循环播放</td>
</tr>
<tr>
<td>muted</td>
<td>Boolean</td>
<td>false</td>
<td>是否静音播放</td>
</tr>
<tr>
<td>page-gesture</td>
<td>Boolean</td>
<td>false</td>
<td>在非全屏模式下，是否开启亮度与音量调节手势</td>
</tr>
<tr>
<td>direction</td>
<td>Number</td>
<td></td>
<td>设置全屏时视频的方向，不指定则根据宽高比自动判断。有效值为 0（正常竖向）, 90（屏幕逆时针90度）, -90（屏幕顺时针90度）</td>
</tr>
<tr>
<td>show-progress</td>
<td>Boolean</td>
<td>true</td>
<td>若不设置，宽度大于240时才会显示</td>
</tr>
<tr>
<td>show-fullscreen-btn</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示全屏按钮</td>
</tr>
<tr>
<td>show-play-btn</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示视频底部控制栏的播放按钮</td>
</tr>
<tr>
<td>show-center-play-btn</td>
<td>Boolean</td>
<td>true</td>
<td>是否显示视频中间的播放按钮</td>
</tr>
<tr>
<td>enable-progress-gesture</td>
<td>Boolean</td>
<td>true</td>
<td>是否开启控制进度的手势</td>
</tr>
</tbody>
</table>
<h5 id="wx-createVideoContext-videoId-this"><a href="#wx-createVideoContext-videoId-this" class="headerlink" title="wx.createVideoContext(videoId, this)"></a>wx.createVideoContext(videoId, this)</h5><p>创建并返回 video 上下文 <code>videoContext</code> 对象。在自定义组件下，第二个参数传入组件实例this，以操作组件内 <code>&lt;video/&gt;</code>组件</p>
<h5 id="videoContext"><a href="#videoContext" class="headerlink" title="videoContext"></a>videoContext</h5><p><code>videoContext</code> 通过 videoId 跟一个 video 组件绑定，通过它可以操作一个 video 组件</p>
<hr>
<h4 id="开源搜索视频组件"><a href="#开源搜索视频组件" class="headerlink" title="开源搜索视频组件"></a>开源搜索视频组件</h4><h5 id="wsSearchView"><a href="#wsSearchView" class="headerlink" title="wsSearchView"></a><a href="https://github.com/mindawei/wsSearchView" target="_blank" rel="noopener">wsSearchView</a></h5><p>该搜索框组件基于开源项目<a href="https://github.com/icindy/wxSearch" target="_blank" rel="noopener">wxSearch</a> 进行了改进，主要有以下几个修改点：</p>
<ul>
<li>增加了注释，修改了一些bug，项目可以跑起来。</li>
<li>为了解决搜索框和输入法界面重叠的问题，将搜索组件作为一个独立的页面。</li>
<li>修改了界面样式，更加美观。</li>
<li>减少了暴露接口，复杂性更低。</li>
</ul>
<h4 id="搜索插件缓存"><a href="#搜索插件缓存" class="headerlink" title="搜索插件缓存"></a>搜索插件缓存</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params">inputValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (inputValue &amp;&amp; inputValue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 添加历史记录</span></span><br><span class="line">    wxSearchAddHisKey(inputValue);</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    <span class="keyword">var</span> temData = __that.data.wxSearchData;</span><br><span class="line">    temData.value = inputValue;</span><br><span class="line">    __that.setData(&#123;</span><br><span class="line">      wxSearchData: temData</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 回调搜索</span></span><br><span class="line">    __searchFunction(inputValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加本地缓存</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wxSearchAddHisKey</span>(<span class="params">inputValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!inputValue || inputValue.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> value = wx.getStorageSync(<span class="string">'wxSearchHisKeys'</span>);</span><br><span class="line">  <span class="keyword">if</span> (value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value.indexOf(inputValue) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      value.unshift(inputValue);</span><br><span class="line">    &#125;</span><br><span class="line">    wx.setStorage(&#123;</span><br><span class="line">      key: <span class="string">"wxSearchHisKeys"</span>,</span><br><span class="line">      data: value,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        getHisKeys(__that);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    value = [];</span><br><span class="line">    value.push(inputValue);</span><br><span class="line">    wx.setStorage(&#123;</span><br><span class="line">      key: <span class="string">"wxSearchHisKeys"</span>,</span><br><span class="line">      data: value,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        getHisKeys(__that);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="修改全局用户对象（使用缓存）"><a href="#修改全局用户对象（使用缓存）" class="headerlink" title="修改全局用户对象（使用缓存）"></a>修改全局用户对象（使用缓存）</h4><p>为了使用户每次打开小程序不需要重复的登录，根据官方文档的同步&amp;异步方法的说明；</p>
<p>需要通过设置全局的用户对象，使用本地缓存的方式，解决这样的问题；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line">App(&#123;</span><br><span class="line">  serverUrl: <span class="string">"ip"</span>,</span><br><span class="line">  userInfo: <span class="literal">null</span>,</span><br><span class="line">  setGlobalUserInfo:<span class="function"><span class="keyword">function</span>(<span class="params">user</span>)</span>&#123;</span><br><span class="line">    wx.setStorageSync(<span class="string">"userInfo"</span>, user);</span><br><span class="line">  &#125;,</span><br><span class="line">  getGlobalUserInfo: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> wx.getStorageSync(<span class="string">"userInfo"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.userInfo = res.data.data;</span></span><br><span class="line"><span class="comment">// fixme 修改原有全局对象为本地缓存</span></span><br><span class="line">app.setGlobalUserInfo(res.data.data);</span><br><span class="line"><span class="comment">// fixme 修改原有全局对象为本地缓存</span></span><br><span class="line"><span class="keyword">var</span> userInfo = app.getGlobalUserInfo();</span><br><span class="line"><span class="comment">// 注销后，清空缓存</span></span><br><span class="line">          wx.removeStorageSync(<span class="string">"userInfo"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="查询接口完善-amp-热搜词保存"><a href="#查询接口完善-amp-热搜词保存" class="headerlink" title="查询接口完善 &amp; 热搜词保存"></a>查询接口完善 &amp; 热搜词保存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="keyword">package</span> com.imooc.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageInfo;</span><br><span class="line"><span class="keyword">import</span> com.imooc.mapper.SearchRecordsMapper;</span><br><span class="line"><span class="keyword">import</span> com.imooc.mapper.VideosMapper;</span><br><span class="line"><span class="keyword">import</span> com.imooc.mapper.VideosMapperCustom;</span><br><span class="line"><span class="keyword">import</span> com.imooc.pojo.SearchRecords;</span><br><span class="line"><span class="keyword">import</span> com.imooc.pojo.Videos;</span><br><span class="line"><span class="keyword">import</span> com.imooc.pojo.vo.VideosVO;</span><br><span class="line"><span class="keyword">import</span> com.imooc.service.VideoService;</span><br><span class="line"><span class="keyword">import</span> com.imooc.utils.PagedResult;</span><br><span class="line"><span class="keyword">import</span> org.n3r.idworker.Sid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapperCustom videosMapperCustom;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SearchRecordsMapper searchRecordsMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> PagedResult <span class="title">getAllVideos</span><span class="params">(Videos video, Integer isSaveRecord, Integer page, Integer pageSize)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 保存热搜词记录</span></span><br><span class="line">		String desc = video.getVideoDesc();</span><br><span class="line">		<span class="keyword">if</span>(isSaveRecord != <span class="keyword">null</span> &amp;&amp; isSaveRecord == <span class="number">1</span>)&#123;</span><br><span class="line">			SearchRecords record = <span class="keyword">new</span> SearchRecords();</span><br><span class="line">			record.setId(sid.nextShort());</span><br><span class="line">			record.setContent(desc);</span><br><span class="line">			searchRecordsMapper.insert(record);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 视频分页查询</span></span><br><span class="line">		PageHelper.startPage(page, pageSize);</span><br><span class="line">		List&lt;VideosVO&gt; list = videosMapperCustom.queryAllVideos(desc);</span><br><span class="line"></span><br><span class="line">		PageInfo&lt;VideosVO&gt; pageList = <span class="keyword">new</span> PageInfo&lt;&gt;(list);</span><br><span class="line"></span><br><span class="line">		PagedResult pagedResult = <span class="keyword">new</span> PagedResult();</span><br><span class="line">		pagedResult.setPage(page);</span><br><span class="line">		pagedResult.setTotal(pageList.getPages());</span><br><span class="line">		pagedResult.setRows(list);</span><br><span class="line">		pagedResult.setRecords(pageList.getTotal());</span><br><span class="line">		<span class="keyword">return</span> pagedResult;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// VideosMapperCustom.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAllVideos"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    select v.*,u.face_image as face_image,u.nickname as nickname from videos v</span><br><span class="line">    left join users u on u.id = v.user_id</span><br><span class="line">    where</span><br><span class="line">    1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" videoDesc != null and videoDesc != '' "</span>&gt;</span></span><br><span class="line">        and v.video_desc like '%$&#123;videoDesc&#125;%'</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    and v.status = 1</span><br><span class="line">    order by v.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="热搜词查询接口"><a href="#热搜词查询接口" class="headerlink" title="热搜词查询接口"></a>热搜词查询接口</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// SearchRecordsMapper.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getHotwords"</span> <span class="attr">resultType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">    SELECT content</span><br><span class="line">    FROM search_records</span><br><span class="line">    GROUP BY content</span><br><span class="line">    ORDER BY count(content) DESC</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SearchRecordsMapper searchRecordsMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHotwords</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> searchRecordsMapper.getHotwords();;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideoService videoService;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/hot"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">hot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(videoService.getHotwords());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="热搜词联调"><a href="#热搜词联调" class="headerlink" title="热搜词联调"></a>热搜词联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...  </span><br><span class="line"><span class="comment">// 2 搜索栏初始化（热搜词）</span></span><br><span class="line">onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 查询热搜词</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl+<span class="string">'/video/hot'</span>,</span><br><span class="line">      method:<span class="string">'POST'</span>,</span><br><span class="line">      success:<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res);</span><br><span class="line">        <span class="keyword">var</span> hotList = res.data.data;</span><br><span class="line">        <span class="comment">// 搜索栏初始化</span></span><br><span class="line">        WxSearch.init(</span><br><span class="line">          that, <span class="comment">// 本页面一个引用</span></span><br><span class="line">          <span class="comment">// ['慕课网', "小程序", 'SpringBoot', 'linux'], 热点搜索推荐，[]表示不使用</span></span><br><span class="line">          hotList,</span><br><span class="line">          hotList, <span class="comment">// 搜索匹配，[]表示不使用</span></span><br><span class="line">          that.mySearchFunction, <span class="comment">// 提供一个搜索回调函数</span></span><br><span class="line">          that.myGobackFunction <span class="comment">//提供一个返回回调函数</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/20/MicWechat Note-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/20/MicWechat Note-6/" itemprop="url">Wechat Mini | Note-6</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-20T00:00:00+08:00">
                2018-08-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-6"><a href="#微信小程序开发-Note-6" class="headerlink" title="微信小程序开发 Note-6"></a>微信小程序开发 Note-6</h3><p>@ 2018年8月17日 22:51:33</p>
<h4 id="上传短视频业务流程"><a href="#上传短视频业务流程" class="headerlink" title="上传短视频业务流程"></a>上传短视频业务流程</h4><p>用户选择视频（10s限制或即时拍摄）；</p>
<p>BGM选择页面；</p>
<p>选择/不选择，并且输入描述（可为空）；</p>
<p>上传（Controller）；</p>
<p>保存视频截图（封面）；</p>
<p>用户是否选择BGM；</p>
<p>​    -否——直接保存视频；</p>
<p>​    -是——合并视频和BGM成新视频，并保存；</p>
<h4 id="用户选择视频"><a href="#用户选择视频" class="headerlink" title="用户选择视频"></a>用户选择视频</h4><h6 id="wx-chooseVideo-OBJECT"><a href="#wx-chooseVideo-OBJECT" class="headerlink" title="wx.chooseVideo(OBJECT)"></a>wx.chooseVideo(OBJECT)</h6><p>拍摄视频或从手机相册中选视频，返回视频的临时文件路径。</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>sourceType</td>
<td>StringArray</td>
<td>否</td>
<td>album 从相册选视频，camera 使用相机拍摄，默认为：[‘album’, ‘camera’]</td>
</tr>
<tr>
<td>compressed</td>
<td>Boolead</td>
<td>否</td>
<td>是否压缩所选的视频源文件，默认值为true，需要压缩</td>
</tr>
<tr>
<td>maxDuration</td>
<td>Number</td>
<td>否</td>
<td>拍摄视频最长拍摄时间，单位秒。最长支持 60 秒</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功，返回视频文件的临时文件路径，详见返回参数说明</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 视频上传</span></span><br><span class="line">  uploadVideo: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    wx.chooseVideo(&#123;</span><br><span class="line">      sourceType: [<span class="string">'album'</span>],</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res);</span><br><span class="line">        <span class="keyword">var</span> duration = res.duration;</span><br><span class="line">        <span class="keyword">var</span> tempheight = res.height;</span><br><span class="line">        <span class="keyword">var</span> tempwidth = res.width;</span><br><span class="line">        <span class="keyword">var</span> tempVideoUrl = res.tempFilePath;</span><br><span class="line">        <span class="keyword">var</span> tempCoverUrl = res.thumbTempFilePath;</span><br><span class="line">        <span class="keyword">if</span> (duration &gt; <span class="number">11</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'视频长度不能超过10秒'</span>,</span><br><span class="line">            icon: <span class="string">"none"</span>,</span><br><span class="line">            duration: <span class="number">2500</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (duration &lt; <span class="number">3</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'视频长度过短，请上传超过3秒以上的视频'</span>,</span><br><span class="line">            icon: <span class="string">"none"</span>,</span><br><span class="line">            duration: <span class="number">2500</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// TODO 打开BGM选择页面</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="后台BGM列表接口"><a href="#后台BGM列表接口" class="headerlink" title="后台BGM列表接口"></a>后台BGM列表接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BgmServiceImpl</span> <span class="keyword">implements</span> <span class="title">BgmService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> BgmMapper bgmMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Bgm&gt; <span class="title">queryBgmList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> bgmMapper.selectAll();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"BGM API"</span>, tags = &#123;<span class="string">"BGM CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/bgm"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BgmController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> BgmService bgmService;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"GET BGM LIST"</span>, notes = <span class="string">"GET BGM LIST API"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(bgmService.queryBgmList());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="BGM页面联调-amp-获取背景音乐列表"><a href="#BGM页面联调-amp-获取背景音乐列表" class="headerlink" title="BGM页面联调 &amp; 获取背景音乐列表"></a>BGM页面联调 &amp; 获取背景音乐列表</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    bgmList: [],</span><br><span class="line">    serverUrl: <span class="string">""</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'加载背景音乐中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/bgm/list'</span>,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> bgmList = res.data.data;</span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            bgmList: bgmList,</span><br><span class="line">            serverUrl: serverUrl</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">'upload'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">radio-group</span> <span class="attr">name</span>=<span class="string">"bgmId"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:for</span>=<span class="string">"&#123;&#123;bgmList&#125;&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">'container'</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">audio</span> <span class="attr">name</span>=<span class="string">"&#123;&#123;item.name&#125;&#125;"</span> <span class="attr">author</span>=<span class="string">"&#123;&#123;item.author&#125;&#125;"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;serverUrl&#125;&#125;&#123;&#123;item.path&#125;&#125;"</span> <span class="attr">style</span>=<span class="string">"width:300px"</span> <span class="attr">id</span>=<span class="string">"&#123;&#123;item.id&#125;&#125;"</span> <span class="attr">controls</span> <span class="attr">loop</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">radio</span> <span class="attr">style</span>=<span class="string">'margin-top:20px;'</span> <span class="attr">value</span>=<span class="string">''</span>&gt;</span><span class="tag">&lt;/<span class="name">radio</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">radio-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="开发上传短视频接口-amp-Swagger测试上传"><a href="#开发上传短视频接口-amp-Swagger测试上传" class="headerlink" title="开发上传短视频接口 &amp; Swagger测试上传"></a>开发上传短视频接口 &amp; Swagger测试上传</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UPLOAD VIDEO"</span>, notes = <span class="string">"UPLOAD VIDEO API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"bgmId"</span>, value = <span class="string">"背景音乐ID"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoSeconds"</span>, value = <span class="string">"视频长度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"double"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoWidth"</span>, value = <span class="string">"视频宽度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"int"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoHeight"</span>, value = <span class="string">"视频高度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"int"</span>, paramType = <span class="string">"query"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"desc"</span>, value = <span class="string">"视频描述"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/upload"</span>,headers = <span class="string">"content-type=multipart/form-data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">upload</span><span class="params">(String userId, String bgmId,</span></span></span><br><span class="line"><span class="function"><span class="params">								  <span class="keyword">double</span> videoSeconds, <span class="keyword">int</span> videoWidth, <span class="keyword">int</span> videoHeight, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">								  @ApiParam(value = <span class="string">"短视频"</span>,required = <span class="keyword">true</span>)</span> MultipartFile file) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 文件保存的命名空间</span></span><br><span class="line">		String fileSpace = <span class="string">"D:/xxx"</span>;</span><br><span class="line">		<span class="comment">// 保存到数据库中的相对路径</span></span><br><span class="line">		String uploadPathDB = <span class="string">"/"</span> + userId + <span class="string">"/video"</span>;</span><br><span class="line"></span><br><span class="line">		FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">				String fileName = file.getOriginalFilename();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(fileName)) &#123;</span><br><span class="line">					<span class="comment">// 文件上传的最终保存绝对路径</span></span><br><span class="line">					String finalVideoPath = fileSpace + uploadPathDB + <span class="string">"/"</span> + fileName;</span><br><span class="line">					<span class="comment">// 设置数据库保存的路径</span></span><br><span class="line">					uploadPathDB += (<span class="string">"/"</span> + fileName);</span><br><span class="line"></span><br><span class="line">					File outFile = <span class="keyword">new</span> File(finalVideoPath);</span><br><span class="line">					<span class="keyword">if</span> (outFile.getParentFile() != <span class="keyword">null</span> || !outFile.getParentFile().isDirectory()) &#123;</span><br><span class="line">						<span class="comment">// 创建父文件夹</span></span><br><span class="line">						outFile.getParentFile().mkdirs();</span><br><span class="line">					&#125;</span><br><span class="line">					fileOutputStream = <span class="keyword">new</span> FileOutputStream(outFile);</span><br><span class="line">					inputStream = file.getInputStream();</span><br><span class="line">					IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fileOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">				fileOutputStream.flush();</span><br><span class="line">				fileOutputStream.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="视频临时参数传入下一个页面"><a href="#视频临时参数传入下一个页面" class="headerlink" title="视频临时参数传入下一个页面"></a>视频临时参数传入下一个页面</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开BGM选择页面</span></span><br><span class="line">wx.navigateTo(&#123;</span><br><span class="line">    url: <span class="string">'../chooseBgm/chooseBgm?duration='</span> + duration </span><br><span class="line">    + <span class="string">"&amp;tempHeight="</span> + tempHeight</span><br><span class="line">    + <span class="string">"&amp;tempWidth="</span> + tempWidth</span><br><span class="line">    + <span class="string">"&amp;tempVideoUrl="</span> + tempVideoUrl</span><br><span class="line">    + <span class="string">"&amp;tempCoverUrl="</span> + tempCoverUrl</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    videoParams:&#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(params);</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">      videoParams:params</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在BGM选择页面，选择BGM后，上传视频</span></span><br><span class="line">  upload:<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> bgmId = e.detail.value.bgmId;</span><br><span class="line">    <span class="keyword">var</span> desc = e.detail.value.desc;</span><br><span class="line">    <span class="built_in">console</span>.log(bgmId + <span class="string">"---"</span> + desc);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="小程序上传短视频联调"><a href="#小程序上传短视频联调" class="headerlink" title="小程序上传短视频联调"></a>小程序上传短视频联调</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controler</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UPLOAD VIDEO"</span>, notes = <span class="string">"UPLOAD VIDEO API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"bgmId"</span>, value = <span class="string">"背景音乐ID"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoSeconds"</span>, value = <span class="string">"视频长度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoWidth"</span>, value = <span class="string">"视频宽度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoHeight"</span>, value = <span class="string">"视频高度"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"desc"</span>, value = <span class="string">"视频描述"</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/upload"</span>,headers = <span class="string">"content-type=multipart/form-data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">upload</span><span class="params">(String userId, String bgmId,</span></span></span><br><span class="line"><span class="function"><span class="params">								  <span class="keyword">double</span> videoSeconds, <span class="keyword">int</span> videoWidth, <span class="keyword">int</span> videoHeight, String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">								  @ApiParam(value = <span class="string">"短视频"</span>,required = <span class="keyword">true</span>)</span> MultipartFile file) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 文件保存的命名空间</span></span><br><span class="line">		String fileSpace = <span class="string">"D:/videos_dev_face"</span>;</span><br><span class="line">		<span class="comment">// 保存到数据库中的相对路径</span></span><br><span class="line">		String uploadPathDB = <span class="string">"/"</span> + userId + <span class="string">"/video"</span>;</span><br><span class="line"></span><br><span class="line">		FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">				String fileName = file.getOriginalFilename();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(fileName)) &#123;</span><br><span class="line">					<span class="comment">// 文件上传的最终保存绝对路径</span></span><br><span class="line">					String finalVideoPath = fileSpace + uploadPathDB + <span class="string">"/"</span> + fileName;</span><br><span class="line">					<span class="comment">// 设置数据库保存的路径</span></span><br><span class="line">					uploadPathDB += (<span class="string">"/"</span> + fileName);</span><br><span class="line"></span><br><span class="line">					File outFile = <span class="keyword">new</span> File(finalVideoPath);</span><br><span class="line">					<span class="keyword">if</span> (outFile.getParentFile() != <span class="keyword">null</span> || !outFile.getParentFile().isDirectory()) &#123;</span><br><span class="line">						<span class="comment">// 创建父文件夹</span></span><br><span class="line">						outFile.getParentFile().mkdirs();</span><br><span class="line">					&#125;</span><br><span class="line">					fileOutputStream = <span class="keyword">new</span> FileOutputStream(outFile);</span><br><span class="line">					inputStream = file.getInputStream();</span><br><span class="line">					IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"视频上传错误"</span>);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fileOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">				fileOutputStream.flush();</span><br><span class="line">				fileOutputStream.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line"></span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    bgmList: [],</span><br><span class="line">    serverUrl: <span class="string">""</span>,</span><br><span class="line">    videoParams: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在BGM选择页面，选择BGM后，上传视频</span></span><br><span class="line">  upload: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> bgmId = e.detail.value.bgmId;</span><br><span class="line">    <span class="keyword">var</span> desc = e.detail.value.desc;</span><br><span class="line">    <span class="built_in">console</span>.log(bgmId + <span class="string">"---"</span> + desc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> duration = me.data.videoParams.duration;</span><br><span class="line">    <span class="keyword">var</span> tmpHeight = me.data.videoParams.tmpHeight;</span><br><span class="line">    <span class="keyword">var</span> tmpWidth = me.data.videoParams.tmpWidth;</span><br><span class="line">    <span class="keyword">var</span> tmpVideoUrl = me.data.videoParams.tmpVideoUrl;</span><br><span class="line">    <span class="keyword">var</span> tmpCoverUrl = me.data.videoParams.tmpCoverUrl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(tmpHeight + <span class="string">","</span> + tmpWidth);</span><br><span class="line">    <span class="built_in">console</span>.log(tmpVideoUrl);</span><br><span class="line">    <span class="built_in">console</span>.log(tmpCoverUrl);</span><br><span class="line"></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频上传中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 上传短视频</span></span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.uploadFile(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">"/video/upload"</span>,</span><br><span class="line">      formData: &#123;</span><br><span class="line">        userId: app.userInfo.id,</span><br><span class="line">        bgmId: bgmId,</span><br><span class="line">        videoSeconds: duration,</span><br><span class="line">        videoWidth: tmpHeight,</span><br><span class="line">        videoHeight: tmpWidth,</span><br><span class="line">        desc: desc</span><br><span class="line">      &#125;,</span><br><span class="line">      filePath: tmpVideoUrl,</span><br><span class="line">      name: <span class="string">'file'</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// var data = JSON.parse(res.data);</span></span><br><span class="line">        <span class="built_in">console</span>.log(res);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.status == <span class="number">200</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'视频上传成功'</span>,</span><br><span class="line">            icon: <span class="string">'success'</span>,</span><br><span class="line">            duration: <span class="number">3000</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="FFMPEG"><a href="#FFMPEG" class="headerlink" title="FFMPEG"></a>FFMPEG</h4><p>视音频处理工具；跨平台的视音频处理解决方案；</p>
<p>播放器（暴风）；转码工具（格式工厂）；直播、视频加码、滤镜、水印、特效；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 output.avi</span><br></pre></td></tr></table></figure>
<h4 id="JAVA-amp-FFMPEG"><a href="#JAVA-amp-FFMPEG" class="headerlink" title="JAVA &amp; FFMPEG"></a>JAVA &amp; FFMPEG</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FFMPEGTest</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String ffmpegEXE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FFMPEGTest</span><span class="params">(String ffmpegEXE)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ffmpegEXE = ffmpegEXE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">convertor</span><span class="params">(String videoInputPath, String videoOutputPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">// cmd执行命令</span></span><br><span class="line">		List&lt;String&gt; command = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		command.add(ffmpegEXE);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(videoInputPath);</span><br><span class="line">		command.add(videoOutputPath);</span><br><span class="line">		<span class="comment">// 建立进程cmd</span></span><br><span class="line">		ProcessBuilder builder = <span class="keyword">new</span> ProcessBuilder(command);</span><br><span class="line">		Process process = builder.start();</span><br><span class="line">		<span class="comment">// 关闭流，避免资源浪费</span></span><br><span class="line">		InputStream errorStream = process.getErrorStream();</span><br><span class="line">		InputStreamReader inputStreamReader = <span class="keyword">new</span> InputStreamReader(errorStream);</span><br><span class="line">		BufferedReader br = <span class="keyword">new</span> BufferedReader(inputStreamReader);</span><br><span class="line">		String line = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(br != <span class="keyword">null</span>)&#123;</span><br><span class="line">			br.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(inputStreamReader != <span class="keyword">null</span>)&#123;</span><br><span class="line">			inputStreamReader.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(errorStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">			errorStream.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 执行.exe的路径</span></span><br><span class="line">		FFMPEGTest ffmpeg = <span class="keyword">new</span> FFMPEGTest(<span class="string">"D:\\FFMEPG\\bin\\ffmpeg.exe"</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ffmpeg.convertor(<span class="string">"D:\\test.mp4"</span>, <span class="string">"D:\\done.avi"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FFMPEG操作视频-amp-BGM"><a href="#FFMPEG操作视频-amp-BGM" class="headerlink" title="FFMPEG操作视频 &amp; BGM"></a>FFMPEG操作视频 &amp; BGM</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg.exe -i test.mp4 -i bgm.mp3 -t <span class="number">10</span> -y done.mp4</span><br></pre></td></tr></table></figure>
<h4 id="JAVA合并音视频"><a href="#JAVA合并音视频" class="headerlink" title="JAVA合并音视频"></a>JAVA合并音视频</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在JAVA &amp; FFMPEG的基础上，进行修改即可</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeVideoMp3</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String ffmpegEXE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MergeVideoMp3</span><span class="params">(String ffmpegEXE)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.ffmpegEXE = ffmpegEXE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">convertor</span><span class="params">(String videoInputPath, String mp3InputPath, <span class="keyword">double</span> seconds, String videoOutputPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">// cmd执行命令 ffmpeg.exe -i test.mp4 -i bgm.mp3 -t 10 -y done.mp4</span></span><br><span class="line">		List&lt;String&gt; command = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		command.add(ffmpegEXE);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(videoInputPath);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(mp3InputPath);</span><br><span class="line">		command.add(<span class="string">"-t"</span>);</span><br><span class="line">		command.add(String.valueOf(seconds));</span><br><span class="line">		command.add(<span class="string">"-y"</span>);</span><br><span class="line">		command.add(videoOutputPath);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 执行.exe的路径</span></span><br><span class="line">		MergeVideoMp3 ffmpeg = <span class="keyword">new</span> MergeVideoMp3(<span class="string">"D:\\FFMEPG\\bin\\ffmpeg.exe"</span>);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ffmpeg.convertor(<span class="string">"D:\\test.mp4"</span>, <span class="string">"D:\\bgm.mp3"</span>, <span class="number">10</span>, <span class="string">"D:\\done.mp4"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="保存视频信息-amp-数据库"><a href="#保存视频信息-amp-数据库" class="headerlink" title="保存视频信息 &amp; 数据库"></a>保存视频信息 &amp; 数据库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Sid sid;</span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">saveVideo</span><span class="params">(Videos video)</span> </span>&#123;</span><br><span class="line">        video.setId(sid.nextShort());</span><br><span class="line">        videosMapper.insertSelective(video);</span><br><span class="line">        <span class="keyword">return</span> video.getId();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="comment">// 具体代码与头像上传和保存到数据库基本类似；</span></span><br><span class="line"><span class="comment">// 代码过长，不进行发表；</span></span><br><span class="line"><span class="comment">// 详情看github；</span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="上传封面图-amp-数据库"><a href="#上传封面图-amp-数据库" class="headerlink" title="上传封面图 &amp; 数据库"></a>上传封面图 &amp; 数据库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceImpl</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideosMapper videosMapper;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateVideo</span><span class="params">(String videoId, String coverPath)</span> </span>&#123;</span><br><span class="line">		Videos video = <span class="keyword">new</span> Videos();</span><br><span class="line">		video.setId(videoId);</span><br><span class="line">		video.setCoverPath(coverPath);</span><br><span class="line">		videosMapper.updateByPrimaryKeySelective(video);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="comment">// 具体代码与头像上传和保存到数据库基本类似；</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"VIDEO API"</span>, tags = &#123;<span class="string">"VIDEO CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> VideoService videoService;</span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"UPLOAD COVER PIC"</span>, notes = <span class="string">"UPLOAD COVER PIC API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>),</span><br><span class="line">			<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"videoId"</span>, value = <span class="string">"视频ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"form"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/uploadCover"</span>, headers = <span class="string">"content-type=multipart/form-data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">uploadCover</span><span class="params">(String userId, String videoId, @ApiParam(value = <span class="string">"封面"</span>, required = <span class="keyword">true</span>)</span> MultipartFile file) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		...</span><br><span class="line">		videoService.updateVideo(videoId,uploadPathDB);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="小程序上传视频业务流程联调"><a href="#小程序上传视频业务流程联调" class="headerlink" title="小程序上传视频业务流程联调"></a>小程序上传视频业务流程联调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 封面图上传 补充</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    bgmList: [],</span><br><span class="line">    serverUrl: <span class="string">""</span>,</span><br><span class="line">    videoParams: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在BGM选择页面，选择BGM后，上传视频</span></span><br><span class="line">  upload: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'视频上传中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 上传短视频</span></span><br><span class="line">      ...</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> videoId = data.data;</span><br><span class="line">          <span class="comment">// 封面图上传</span></span><br><span class="line">          wx.showLoading(&#123;</span><br><span class="line">            title: <span class="string">'封面图上传中'</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          wx.uploadFile(&#123;</span><br><span class="line">            url: serverUrl + <span class="string">"/video/uploadCover"</span>,</span><br><span class="line">            formData: &#123;</span><br><span class="line">              userId: app.userInfo.id,</span><br><span class="line">              videoId: videoId</span><br><span class="line">            &#125;,</span><br><span class="line">            filePath: tmpCoverUrl,</span><br><span class="line">            name: <span class="string">'file'</span>,</span><br><span class="line">            header: &#123;</span><br><span class="line">              <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res.data);</span><br><span class="line">              wx.hideLoading();</span><br><span class="line">              <span class="keyword">if</span> (data.status == <span class="number">200</span>) &#123;</span><br><span class="line">                wx.showToast(&#123;</span><br><span class="line">                  title: <span class="string">'上传成功'</span>,</span><br><span class="line">                  icon: <span class="string">"success"</span></span><br><span class="line">                &#125;);</span><br><span class="line">                wx.navigateBack(&#123;</span><br><span class="line">                  delta: <span class="number">1</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                wx.showToast(&#123;</span><br><span class="line">                  title: <span class="string">'上传失败'</span>,</span><br><span class="line">                  icon: <span class="string">"none"</span></span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'上传失败'</span>,</span><br><span class="line">            icon: <span class="string">"none"</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="联调手机端-amp-坑"><a href="#联调手机端-amp-坑" class="headerlink" title="联调手机端 &amp; 坑"></a>联调手机端 &amp; 坑</h4><p>在使用手机端测试时，res所返回的数据与PC端返回的数据不同；</p>
<p>手机端所返回的数据中，不包含封面图的数据信息；</p>
<p>所以，才用FFMPEG生成截图的方式，生成封面图；</p>
<h4 id="使用FFMPEG生成截图"><a href="#使用FFMPEG生成截图" class="headerlink" title="使用FFMPEG生成截图"></a>使用FFMPEG生成截图</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FetchVideoCover</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 视频路径</span></span><br><span class="line">	<span class="keyword">private</span> String ffmpegEXE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCover</span><span class="params">(String videoInputPath, String coverOutputPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">//		ffmpeg.exe -ss 00:00:01 -i spring.mp4 -vframes 1 bb.jpg</span></span><br><span class="line">		List&lt;String&gt; command = <span class="keyword">new</span> java.util.ArrayList&lt;String&gt;();</span><br><span class="line">		command.add(ffmpegEXE);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 指定截取第1秒</span></span><br><span class="line">		command.add(<span class="string">"-ss"</span>);</span><br><span class="line">		command.add(<span class="string">"00:00:01"</span>);</span><br><span class="line"></span><br><span class="line">		command.add(<span class="string">"-y"</span>);</span><br><span class="line">		command.add(<span class="string">"-i"</span>);</span><br><span class="line">		command.add(videoInputPath);</span><br><span class="line"></span><br><span class="line">		command.add(<span class="string">"-vframes"</span>);</span><br><span class="line">		command.add(<span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">		command.add(coverOutputPath);</span><br><span class="line"></span><br><span class="line">		ProcessBuilder builder = <span class="keyword">new</span> ProcessBuilder(command);</span><br><span class="line">		Process process = builder.start();</span><br><span class="line"></span><br><span class="line">		InputStream errorStream = process.getErrorStream();</span><br><span class="line">		InputStreamReader inputStreamReader = <span class="keyword">new</span> InputStreamReader(errorStream);</span><br><span class="line">		BufferedReader br = <span class="keyword">new</span> BufferedReader(inputStreamReader);</span><br><span class="line"></span><br><span class="line">		String line = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">			br.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (inputStreamReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">			inputStreamReader.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (errorStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">			errorStream.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上传视频流程-amp-整合视频截图功能"><a href="#上传视频流程-amp-整合视频截图功能" class="headerlink" title="上传视频流程 &amp; 整合视频截图功能"></a>上传视频流程 &amp; 整合视频截图功能</h4><h4 id="上传流程联调"><a href="#上传流程联调" class="headerlink" title="上传流程联调"></a>上传流程联调</h4><p>在上传视频的同时，制作封面图，并且将封面图的CoverPath存储到数据库即可；</p>
<p>就解决了PC和手机传回数据不同的问题，不再需要二次request的过程；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 产生视频封面</span></span><br><span class="line">FetchVideoCover videoInfo = <span class="keyword">new</span> FetchVideoCover(FFMPEG_EXE);</span><br><span class="line">videoInfo.getCover(finalVideoPath, FILE_SPACE + coverPathDB);</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月19日 19:47:47</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/19/MicWechat Note-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/MicWechat Note-5/" itemprop="url">Wechat Mini | Note-5</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T00:00:00+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="微信小程序开发-Note-5"><a href="#微信小程序开发-Note-5" class="headerlink" title="微信小程序开发 Note-5"></a>微信小程序开发 Note-5</h3><p>@ 2018年8月17日 15:15:32</p>
<h4 id="注销接口"><a href="#注销接口" class="headerlink" title="注销接口"></a>注销接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"LOGIN &amp; REGISTER API"</span>, tags = &#123;<span class="string">"LOGIN &amp; REGISTER CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistLoginController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"LOGOUT"</span>, notes = <span class="string">"LOGOUT API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">logout</span><span class="params">(String userId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		redis.del(USER_REDIS_SESSION + <span class="string">":"</span> + userId);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"注销成功"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="注销联调"><a href="#注销联调" class="headerlink" title="注销联调"></a>注销联调</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 注销</span></span><br><span class="line">  logout: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user = app.userInfo;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'注销中'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/logout?userId='</span> + user.id,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          wx.showToast(&#123;</span><br><span class="line">            title: <span class="string">'注销成功'</span>,</span><br><span class="line">            icon: <span class="string">'success'</span>,</span><br><span class="line">            duration: <span class="number">2000</span></span><br><span class="line">          &#125;);</span><br><span class="line">          app.userInfo = <span class="literal">null</span>;</span><br><span class="line">          <span class="comment">// 页面跳转Login</span></span><br><span class="line">          wx.redirectTo(&#123;</span><br><span class="line">            url: <span class="string">'../userLogin/login'</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户头像接口"><a href="#用户头像接口" class="headerlink" title="用户头像接口"></a>用户头像接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;	</span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"USER UPLOAD FACE IMG"</span>, notes = <span class="string">"USER UPLOAD FACE IMG API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/uploadFace"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">uploadFace</span><span class="params">(String userId, @RequestParam(<span class="string">"file"</span>)</span> MultipartFile[] files) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 文件保存的命名空间</span></span><br><span class="line">		String fileSpace = <span class="string">"D:/videos_dev_face"</span>;</span><br><span class="line">		<span class="comment">// 保存到数据库中的相对路径</span></span><br><span class="line">		String uploadPathDB = <span class="string">"/"</span> + userId + <span class="string">"/face"</span>;</span><br><span class="line"></span><br><span class="line">		FileOutputStream fileOutputStream = <span class="keyword">null</span>;</span><br><span class="line">		InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (files != <span class="keyword">null</span> &amp;&amp; files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				String fileName = files[<span class="number">0</span>].getOriginalFilename();</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.isNotBlank(fileName)) &#123;</span><br><span class="line">					<span class="comment">// 文件上传的最终保存绝对路径</span></span><br><span class="line">					String finalFacePath = fileSpace + uploadPathDB + <span class="string">"/"</span> + fileName;</span><br><span class="line">					<span class="comment">// 设置数据库保存的路径</span></span><br><span class="line">					uploadPathDB += (<span class="string">"/"</span> + fileName);</span><br><span class="line"></span><br><span class="line">					File outFile = <span class="keyword">new</span> File(finalFacePath);</span><br><span class="line">					<span class="keyword">if</span> (outFile.getParentFile() != <span class="keyword">null</span> || !outFile.getParentFile().isDirectory()) &#123;</span><br><span class="line">						<span class="comment">// 创建父文件夹</span></span><br><span class="line">						outFile.getParentFile().mkdirs();</span><br><span class="line">					&#125;</span><br><span class="line">					fileOutputStream = <span class="keyword">new</span> FileOutputStream(outFile);</span><br><span class="line">					inputStream = files[<span class="number">0</span>].getInputStream();</span><br><span class="line">					IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(fileOutputStream != <span class="keyword">null</span>)&#123;</span><br><span class="line">				fileOutputStream.flush();</span><br><span class="line">				fileOutputStream.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户头像联调"><a href="#用户头像联调" class="headerlink" title="用户头像联调"></a>用户头像联调</h4><h5 id="wx-chooseImage-OBJECT"><a href="#wx-chooseImage-OBJECT" class="headerlink" title="wx.chooseImage(OBJECT)"></a>wx.chooseImage(OBJECT)</h5><p>从本地相册选择图片或使用相机拍照；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>count</td>
<td>Number</td>
<td>否</td>
<td>最多可以选择的图片张数，默认9</td>
</tr>
<tr>
<td>sizeType</td>
<td>StringArray</td>
<td>否</td>
<td>original 原图，compressed 压缩图，默认二者都有</td>
</tr>
<tr>
<td>sourceType</td>
<td>StringArray</td>
<td>否</td>
<td>album 从相册选图，camera 使用相机，默认二者都有</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>是</td>
<td>成功则返回图片的本地文件路径列表 tempFilePaths</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<h5 id="wx-uploadFile-OBJECT"><a href="#wx-uploadFile-OBJECT" class="headerlink" title="wx.uploadFile(OBJECT)"></a>wx.uploadFile(OBJECT)</h5><p>将本地资源上传到开发者服务器，客户端发起一个 HTTPS POST 请求，其中 <code>content-type</code> 为 <code>multipart/form-data</code> ；</p>
<p><strong>OBJECT参数说明：</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>String</td>
<td>是</td>
<td>开发者服务器 url</td>
</tr>
<tr>
<td>filePath</td>
<td>String</td>
<td>是</td>
<td>要上传文件资源的路径</td>
</tr>
<tr>
<td>name</td>
<td>String</td>
<td>是</td>
<td>文件对应的 key , 开发者在服务器端通过这个 key 可以获取到文件二进制内容</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td>否</td>
<td>HTTP 请求 Header, header 中不能设置 Referer</td>
</tr>
<tr>
<td>formData</td>
<td>Object</td>
<td>否</td>
<td>HTTP 请求中其他额外的 form data</td>
</tr>
<tr>
<td>success</td>
<td>Function</td>
<td>否</td>
<td>接口调用成功的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>Function</td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>Function</td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  <span class="comment">// 头像上传</span></span><br><span class="line">  changeFace: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    wx.chooseImage(&#123;</span><br><span class="line">      count: <span class="number">1</span>,</span><br><span class="line">      sizeType: [<span class="string">'compressed'</span>],</span><br><span class="line">      sourceType: [<span class="string">'album'</span>],</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> tempFilePaths = res.tempFilePaths;</span><br><span class="line">        <span class="built_in">console</span>.log(tempFilePaths);</span><br><span class="line"></span><br><span class="line">        wx.showLoading(&#123;</span><br><span class="line">          title: <span class="string">'上传中...'</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上传</span></span><br><span class="line">        <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">        wx.uploadFile(&#123;</span><br><span class="line">          url: serverUrl + <span class="string">"/user/uploadFace?userId="</span> + app.userInfo.id,</span><br><span class="line">          filePath: tempFilePaths[<span class="number">0</span>],</span><br><span class="line">          name: <span class="string">'file'</span>,</span><br><span class="line">          header: &#123;</span><br><span class="line">            <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> data = res.data</span><br><span class="line">            <span class="built_in">console</span>.log(data);</span><br><span class="line">            wx.hideLoading();</span><br><span class="line">            wx.showToast(&#123;</span><br><span class="line">              title: <span class="string">'头像上传成功'</span>,</span><br><span class="line">              icon:<span class="string">'success'</span>,</span><br><span class="line">              duration:<span class="number">3000</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户头像更新到数据库"><a href="#用户头像更新到数据库" class="headerlink" title="用户头像更新到数据库"></a>用户头像更新到数据库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUserInfo</span><span class="params">(Users user)</span> </span>&#123;</span><br><span class="line">		Example userExample = <span class="keyword">new</span> Example(Users.class);</span><br><span class="line">		Example.Criteria criteria = userExample.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"id"</span>,user.getId());</span><br><span class="line">		userMapper.updateByExampleSelective(user,userExample);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"USER UPLOAD FACE IMG"</span>, notes = <span class="string">"USER UPLOAD FACE IMG API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/uploadFace"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">uploadFace</span><span class="params">(String userId, @RequestParam(<span class="string">"file"</span>)</span> MultipartFile[] files) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isBlank(userId))&#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">// 上传成功,更新数据库头像信息</span></span><br><span class="line">		Users user = <span class="keyword">new</span> Users();</span><br><span class="line">		user.setId(userId);</span><br><span class="line">		user.setFaceImage(uploadPathDB);</span><br><span class="line">		userService.updateUserInfo(user);</span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="SpringBoot静态资源配置，显示图片"><a href="#SpringBoot静态资源配置，显示图片" class="headerlink" title="SpringBoot静态资源配置，显示图片"></a>SpringBoot静态资源配置，显示图片</h4><p>通过虚拟目录的功能，创建一个配置类，继承<code>WebMvcConfigurerAdapter</code>，重写方法<code>addResourceHandlers</code>；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">      registry.addResourceHandler(<span class="string">"/**"</span>)</span><br><span class="line">      .addResourceLocations(<span class="string">"file:D:/xxx/"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动项目后，即可通过访问<a href="http://localhost:8081/123/face/imooc.jpg的方式，获取到静态资源文件；" target="_blank" rel="noopener">http://localhost:8081/123/face/imooc.jpg的方式，获取到静态资源文件；</a></p>
<p>@问题，配置后，<a href="http://localhost:8081/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8081/swagger-ui.html</a> 无法访问，报404；</p>
<p>需要重新配置；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">		registry.addResourceHandler(<span class="string">"/**"</span>)</span><br><span class="line">				.addResourceLocations(<span class="string">"classpath:/META-INF/resources/"</span>)</span><br><span class="line">				.addResourceLocations(<span class="string">"file:D:/xxx/"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="小程序展示头像以及手机端调试"><a href="#小程序展示头像以及手机端调试" class="headerlink" title="小程序展示头像以及手机端调试"></a>小程序展示头像以及手机端调试</h4><p>现在完成页面访问静态资源文件的功能，既可以完成小程序中展示头像的功能；</p>
<p>在上传完成文件后，并且更新数据库信息，需要给小程序返回相对路径的地址；</p>
<p>@success返回的data并不是JSON格式，而是String类型；</p>
<p>需要将data转换成JSON格式，在小程序前端实现格式化；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(res.data);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 获取返回的头像相对路径</span></span><br><span class="line">    <span class="keyword">var</span> imageUrl = data.data;</span><br><span class="line">    me.setData(&#123;</span><br><span class="line">        faceUrl: serverUrl + imageUrl</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用预览模式，并且打开调试模式，即可完成效果；</p>
<hr>
<h4 id="查询用户信息接口"><a href="#查询用户信息接口" class="headerlink" title="查询用户信息接口"></a>查询用户信息接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersMapper userMapper;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.SUPPORTS)</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Users <span class="title">queryUserInfo</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">		Example userExample = <span class="keyword">new</span> Example(Users.class);</span><br><span class="line">		Example.Criteria criteria = userExample.createCriteria();</span><br><span class="line">		criteria.andEqualTo(<span class="string">"id"</span>,userId);</span><br><span class="line">		Users user = userMapper.selectOneByExample(userExample);</span><br><span class="line">		<span class="keyword">return</span> user;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"USER FUNCTION API"</span>, tags = &#123;<span class="string">"USER FUNCTION CONTROLLER"</span>&#125;)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BasicController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ApiOperation</span>(value = <span class="string">"QUERY USER INFORMATION"</span>, notes = <span class="string">"QUERY USER INFORMATION API"</span>)</span><br><span class="line">	<span class="meta">@ApiImplicitParam</span>(name = <span class="string">"userId"</span>, value = <span class="string">"用户ID"</span>, required = <span class="keyword">true</span>, dataType = <span class="string">"String"</span>, paramType = <span class="string">"query"</span>)</span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/query"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> IMoocJSONResult <span class="title">query</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(userId)) &#123;</span><br><span class="line">			<span class="keyword">return</span> IMoocJSONResult.errorMsg(<span class="string">"用户不存在(无ID)"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Users userInfo = userService.queryUserInfo(userId);</span><br><span class="line">		UsersVO usersVO = <span class="keyword">new</span> UsersVO();</span><br><span class="line">		BeanUtils.copyProperties(userInfo, usersVO);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> IMoocJSONResult.ok(usersVO);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="用户信息展示联调"><a href="#用户信息展示联调" class="headerlink" title="用户信息展示联调"></a>用户信息展示联调</h4><p>实现了后台的API后，对小程序进行数据的读取和设置；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    faceUrl: <span class="string">"../resource/images/noneface.png"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 加载</span></span><br><span class="line">  onLoad: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> user = app.userInfo;</span><br><span class="line">    <span class="keyword">var</span> serverUrl = app.serverUrl;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">      title: <span class="string">'加载中...'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// BackEnd</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: serverUrl + <span class="string">'/user/query?userId='</span> + user.id,</span><br><span class="line">      method: <span class="string">"POST"</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.data);</span><br><span class="line">        wx.hideLoading();</span><br><span class="line">        <span class="keyword">if</span> (res.data.status == <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> userInfo = res.data.data;</span><br><span class="line">          <span class="keyword">var</span> faceUrl = <span class="string">"../resource/images/noneface.png"</span>;</span><br><span class="line">          <span class="comment">// 头像判空</span></span><br><span class="line">          <span class="keyword">if</span> (userInfo.faceImage != <span class="literal">null</span> &amp;&amp; userInfo.faceImage != <span class="string">""</span> &amp;&amp; userInfo.faceImage != <span class="literal">undefined</span>) &#123;</span><br><span class="line">            faceUrl = serverUrl + userInfo.faceImage;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 个人信息设置</span></span><br><span class="line">          me.setData(&#123;</span><br><span class="line">            faceUrl: faceUrl,</span><br><span class="line">            fansCounts: userInfo.fansCounts,</span><br><span class="line">            followCounts: userInfo.followCounts,</span><br><span class="line">            receiveLikeCounts: userInfo.receiveLikeCounts,</span><br><span class="line">            nickname: userInfo.nickname</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>@ 2018年8月17日 22:34:27</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">REX CHEN</p>
              <p class="site-description motion-element" itemprop="description">日常记录</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">REX CHEN</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
