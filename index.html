<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="日常记录">
<meta property="og:type" content="website">
<meta property="og:title" content="REEEEX">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="REEEEX">
<meta property="og:description" content="日常记录">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="REEEEX">
<meta name="twitter:description" content="日常记录">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>REEEEX</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">REEEEX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">KEEP GOING</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/04/INTERVIEW-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/INTERVIEW-1/" itemprop="url">Interview | Note-1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-04T00:00:00+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Interview-Note-1"><a href="#Interview-Note-1" class="headerlink" title="Interview | Note-1"></a>Interview | Note-1</h2><h3 id="网络基础知识"><a href="#网络基础知识" class="headerlink" title="网络基础知识"></a>网络基础知识</h3><h4 id="OSI开放式模型（七层协议、参考的国际模型）"><a href="#OSI开放式模型（七层协议、参考的国际模型）" class="headerlink" title="OSI开放式模型（七层协议、参考的国际模型）"></a>OSI开放式模型（七层协议、参考的国际模型）</h4><p>先自上而下，后自下而上的处理数据的头部</p>
<ul>
<li><p>物理层：解决物理介质的传输、原始比特流传输、模数转换、数模转换、网卡工作层</p>
</li>
<li><p>数据链路层：物理寻址、将比特流转变为逻辑传输线路、错误检测、确保数据传输的可靠性、交换机工作层</p>
</li>
<li>网络层：将网络地址翻译成对应的物理地址、并且决定数据从发送方路由到接收方、保证数据发送优先权、网络阻塞程度、路由器、数据包、TCP/IP协议、分组传输</li>
<li>传输层：必要时对数据进行分割，并且交由网络层，保证数据段有效到达对端、1500字节、TCP/UDP协议</li>
<li>会话层：自动收发包、自动寻址、建立及管理会话、解决不同系统的语法</li>
<li>应用层：固定消息头、消息体、信息的语法语义及其关联、HTTP协议</li>
</ul>
<hr>
<h4 id="TCP-IP（四层模型、OSI的实现）"><a href="#TCP-IP（四层模型、OSI的实现）" class="headerlink" title="TCP/IP（四层模型、OSI的实现）"></a>TCP/IP（四层模型、OSI的实现）</h4><p>先自上而下，后自下而上的处理数据的头部</p>
<table>
<thead>
<tr>
<th>OSI七层</th>
<th>TCP/IP四层</th>
<th>功能</th>
<th>TCP/IP协议族</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层</td>
<td>应用层</td>
<td>文件传输、EMAIL、文件、虚拟终端</td>
<td>HTTP/FTP/SMTP/DNS/Telnet</td>
</tr>
<tr>
<td>表示层</td>
<td>\</td>
<td>数据格式化、代码转换、数据加密</td>
<td>\</td>
</tr>
<tr>
<td>会话层</td>
<td>\</td>
<td>建立以及管理会话</td>
<td>\</td>
</tr>
<tr>
<td>传输层</td>
<td>传输层</td>
<td>提供端对端的接口</td>
<td>TCP/UDP</td>
</tr>
<tr>
<td>网络层</td>
<td>网络层</td>
<td>为数据包选择路由</td>
<td>IP/ICMP/IGMP/RIP</td>
</tr>
<tr>
<td>数据链路层</td>
<td>链路层</td>
<td>传输有地址的帧、错误检测</td>
<td>PPP/MTU</td>
</tr>
<tr>
<td>物理层</td>
<td>\</td>
<td>二进制形式在物理媒体传输</td>
<td>ISO02110/IEEE802/IEEE802.2</td>
</tr>
</tbody>
</table>
<p>TCP/IP重点在于，实际应用中应该开发的应用和协议</p>
<hr>
<p>参考链接：<a href="https://blog.csdn.net/qq_38950316/article/details/81087809" target="_blank" rel="noopener">https://blog.csdn.net/qq_38950316/article/details/81087809</a></p>
<h4 id="TCP三次握手"><a href="#TCP三次握手" class="headerlink" title="TCP三次握手"></a>TCP三次握手</h4><p>TCP 传输控制协议</p>
<ul>
<li>面向连接的、可靠的、基于字节流的传输层通信协议</li>
<li>将应用层的数据分割成适当长度的报文段（MTU）并且发送给目标节点的TCP层</li>
<li>数据包有序号Sequence Number，对象收到则发送ACK确认，未收到则重传</li>
<li>使用奇偶校验和检验数据在传输过程中是否有误</li>
</ul>
<p><img src="https://images0.cnblogs.com/blog/88420/201401/291246111727359.png" alt=""></p>
<ol>
<li>URG：紧急指针 1-有效 0-忽略</li>
<li>ACK：确认序号 1-有效 0-不包含确认信息<ol>
<li>确认号：其数值等于发送方的发送序号 +1(即接收方期望接收的下一个序列号)</li>
</ol>
</li>
<li>PSH：push标志 尽快提交到应用层，而不是在缓存中</li>
<li>RST：重置连接 重置崩溃</li>
<li>SYN：同步序号，用于建立连接过程</li>
<li>FIN：finish，用于释放连接</li>
</ol>
<h5 id="三次握手流程"><a href="#三次握手流程" class="headerlink" title="三次握手流程"></a>三次握手流程</h5><ul>
<li>第一次握手：建立连接时，客户端发送SYN包（SYN=J）到服务器，并且进入SYN_SEND状态，等待服务器Query</li>
<li>第二次握手：服务器收到SYN包，必须确认客户的SYN（ACK=J+1），同时自己也发送一个SYN包（SYN=K），即SYN+ACK包，此时服务器进入SYN_RECV状态</li>
<li>第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认ACK（ACK=K+1），此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成</li>
</ul>
<h5 id="为什么需要三次握手"><a href="#为什么需要三次握手" class="headerlink" title="为什么需要三次握手"></a>为什么需要三次握手</h5><ul>
<li>为了初始化Sequence Number的初始值，作为往后的通讯序号</li>
</ul>
<h5 id="首次握手的隐患——SYN超时"><a href="#首次握手的隐患——SYN超时" class="headerlink" title="首次握手的隐患——SYN超时"></a>首次握手的隐患——SYN超时</h5><ul>
<li>Server收到Client的SYN，回复SYN+ACK的时候，Server未收到ACK确认</li>
<li>Server不断重试至超时（Linux默认等待63秒断开）</li>
<li>可能导致服务器遭受SYN Flood的风险<ul>
<li>针对SYN Flood的防护措施<ul>
<li>SYN队列满后，通过tcp_syncookies参数回发SYN Cookie</li>
<li>若为正常连接，则Client会回发SYN Cookie，直接建立连接</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="建立连接后，Client出现故障"><a href="#建立连接后，Client出现故障" class="headerlink" title="建立连接后，Client出现故障"></a>建立连接后，Client出现故障</h5><ul>
<li>保活机制<ul>
<li>向对方发送保活检测报文，如果未收到响应则继续发送</li>
<li>尝试次数达到保活检测数仍未收到响应则中断连接</li>
</ul>
</li>
</ul>
<hr>
<h4 id="TCP四次挥手"><a href="#TCP四次挥手" class="headerlink" title="TCP四次挥手"></a>TCP四次挥手</h4><p>用于TCP连接是全双工，每个方向都必须单独进行关闭，发送方和接收方都需要FIN报文和ACK报文，首先进行关闭的一方主动关闭，另一方则被动关闭。</p>
<p>任何一方执行close()操作即可产生挥手（经过时间2MSL才真正释放）</p>
<p><img src="https://img-blog.csdn.net/20180717204202563?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4OTUwMzE2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
<h5 id="为什么有TIME-WAIT"><a href="#为什么有TIME-WAIT" class="headerlink" title="为什么有TIME_WAIT"></a>为什么有TIME_WAIT</h5><ul>
<li>确保有足够时间让对端收到ACK包</li>
<li>避免新旧连接混淆</li>
</ul>
<h5 id="服务器出现大量CLOSE-WAIT状态"><a href="#服务器出现大量CLOSE-WAIT状态" class="headerlink" title="服务器出现大量CLOSE_WAIT状态"></a>服务器出现大量CLOSE_WAIT状态</h5><p>CLOSE_WAIT：被动关闭的一端收到FIN后，但未发出ACK的TCP状态</p>
<ul>
<li>对方关闭socket连接，我方忙于读或写，没有及时关闭连接<ul>
<li>检查代码：被动关闭一端的代码，尤其是释放资源的</li>
<li>检查配置：处理请求的线程配置</li>
</ul>
</li>
</ul>
<hr>
<h4 id="TCP-amp-UDP区别"><a href="#TCP-amp-UDP区别" class="headerlink" title="TCP &amp; UDP区别"></a>TCP &amp; UDP区别</h4><h5 id="UDP特点"><a href="#UDP特点" class="headerlink" title="UDP特点"></a>UDP特点</h5><ul>
<li>面向非连接</li>
<li>不维护连接状态，支持同时向多个客户端传输相同的消息</li>
<li>数据包报头只有8个字节，额外开销较小</li>
<li>吞吐量只受限于数据生成速率、传输速率以及机器性能</li>
<li>尽最大努力交付，不保证可靠交付，不需要维持复杂的链接状态表</li>
<li>面向报文，不对应用程序提交的报文信息进行拆分或合并</li>
</ul>
<h5 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h5><ul>
<li>面向连接 &amp; 无连接</li>
<li>可靠性（TCP）</li>
<li>有序性（TCP-序列号，到达无序）</li>
<li>速度（UDP更快）</li>
<li>量级（TCP-重量级、UDP-轻量级）</li>
</ul>
<hr>
<h4 id="TCP滑动窗口"><a href="#TCP滑动窗口" class="headerlink" title="TCP滑动窗口"></a>TCP滑动窗口</h4><p>RTT：发送一个数据包到收到对应ACK所花费的时间</p>
<p>RTO：重传时间间隔</p>
<p>TCP使用滑动窗口做流量控制与乱序重排</p>
<ul>
<li>保证TCP可靠性和流控特性</li>
</ul>
<p><strong>AdvertisedWindow = MaxRcvBuffer - (LastByteRcvd - LastByteRead)</strong></p>
<p><strong>EffectiveWindow = AdvertisedWindow - (LastByteSent - LastByteAcked)</strong></p>
<p><img src="https://s2.ax1x.com/2019/03/04/kO1AoV.png" alt="kO1AoV.png"></p>
<h5 id="TCP会话的发送方"><a href="#TCP会话的发送方" class="headerlink" title="TCP会话的发送方"></a>TCP会话的发送方</h5><p><img src="https://s2.ax1x.com/2019/03/04/kO1jmR.png" alt="kO1jmR.png"></p>
<h5 id="TCP会话的接收方"><a href="#TCP会话的接收方" class="headerlink" title="TCP会话的接收方"></a>TCP会话的接收方</h5><p><img src="https://s2.ax1x.com/2019/03/04/kO3ptK.png" alt="kO3ptK.png"></p>
<hr>
<h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><h5 id="HTTP特点"><a href="#HTTP特点" class="headerlink" title="HTTP特点"></a>HTTP特点</h5><ul>
<li>支持C(Client)/S(Server)模式</li>
<li>简单快速</li>
<li>灵活（任意类型数据对象）</li>
<li>无连接（限制每次只处理一个请求）</li>
<li>无状态（处理事务没有记忆）</li>
</ul>
<p><strong>HTTP请求结构</strong></p>
<p><img src="https://s2.ax1x.com/2019/03/04/kO30c4.png" alt="kO30c4.png"></p>
<p><strong>HTTP响应结构</strong></p>
<p><img src="https://s2.ax1x.com/2019/03/04/kO3gN6.png" alt="kO3gN6.png"></p>
<h5 id="请求-响应的步骤"><a href="#请求-响应的步骤" class="headerlink" title="请求/响应的步骤"></a>请求/响应的步骤</h5><ul>
<li>客户端连接到Web服务器</li>
<li>发送HTTP请求</li>
<li>服务器接受请求并且返回HTTP响应</li>
<li>释放TCP连接</li>
<li>客户端解析HTML内容</li>
</ul>
<h5 id="在浏览器输入URL，键入回车的流程"><a href="#在浏览器输入URL，键入回车的流程" class="headerlink" title="在浏览器输入URL，键入回车的流程"></a>在浏览器输入URL，键入回车的流程</h5><ul>
<li>DNS解析</li>
<li>根据IP地址和Port建立TCP连接</li>
<li>发送HTTP请求</li>
<li>服务器处理请求并且返回HTTP报文</li>
<li>浏览器解析HTML</li>
<li>连接接受</li>
</ul>
<h5 id="HTTP常见状态码"><a href="#HTTP常见状态码" class="headerlink" title="HTTP常见状态码"></a>HTTP常见状态码</h5><ul>
<li>1xx 指示信息 - 请求已接收，继续处理</li>
<li>2xx 成功 - 请求已被成功接收、理解、接受</li>
<li>3xx 重定向 - 要完成请求必须进行更进一步的操作</li>
<li>4xx 客户端错误 - 请求有语法错误或请求无法实现</li>
<li>5xx 服务端错误 - 服务器未能实现合法的请求 </li>
</ul>
<h4 id="GET-POST"><a href="#GET-POST" class="headerlink" title="GET / POST"></a>GET / POST</h4><h5 id="区别-1"><a href="#区别-1" class="headerlink" title="区别"></a>区别</h5><ul>
<li>HTTP报文：GET将请求信息放在URL，POST放在报文体中</li>
<li>数据库：GET符合幂等性和安全性，POST不符合（每次请求都不同）</li>
<li>GET可以被缓存，POST不行</li>
</ul>
<h4 id="Cookie-Session"><a href="#Cookie-Session" class="headerlink" title="Cookie / Session"></a>Cookie / Session</h4><h5 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h5><ul>
<li>Cookie由服务器发给客户端的特殊信息，以文本的形式存放在客户端</li>
<li>客户端再次请求时，会把Cookie回发</li>
<li>服务器接收到Cookie，会解析与客户端相对应的内容</li>
</ul>
<h5 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h5><ul>
<li>服务器端的机制，在服务器上保存的信息</li>
<li>解析客户端请求并操作session id，按需保存状态信息</li>
<li>实现方式<ul>
<li>Cookie - JSESSIONID = xxx</li>
<li>URL回写</li>
</ul>
</li>
</ul>
<h5 id="区别-2"><a href="#区别-2" class="headerlink" title="区别"></a>区别</h5><ul>
<li>Cookie数据存放在客户端的浏览器，Session数据存放在服务器</li>
<li>Session相对于Cookie更安全</li>
<li>考虑减少服务器负担，应使用Cookie</li>
</ul>
<hr>
<h4 id="HTTP-HTTPS"><a href="#HTTP-HTTPS" class="headerlink" title="HTTP / HTTPS"></a>HTTP / HTTPS</h4><p><img src="https://s2.ax1x.com/2019/03/04/kOGkdI.png" alt="kOGkdI.png"></p>
<h5 id="SSL（Security-Sockets-Layer）"><a href="#SSL（Security-Sockets-Layer）" class="headerlink" title="SSL（Security Sockets Layer）"></a>SSL（Security Sockets Layer）</h5><ul>
<li>为网络通信提供安全及数据完整性的一种安全协议</li>
<li>操作系统对外的API(SSL3.0更名TLS)</li>
<li>采用身份验证和数据加密，保证网络通信的安全和数据的完整性</li>
</ul>
<h5 id="加密的方式"><a href="#加密的方式" class="headerlink" title="加密的方式"></a>加密的方式</h5><ul>
<li>对称加密、非对称加密、哈希算法（算法不可逆-MD5）、数字签名</li>
</ul>
<h5 id="HTTPS数据传输流程"><a href="#HTTPS数据传输流程" class="headerlink" title="HTTPS数据传输流程"></a>HTTPS数据传输流程</h5><ul>
<li>浏览器将支持的加密算法信息发送给服务器</li>
<li>服务器选择支持的加密算法，以证书的形式回发浏览器</li>
<li>浏览器校验证书合法性，并且结合证书公钥加密信息发送给服务器</li>
<li>服务器使用私钥解密信息，验证哈希，加密响应消息回发浏览器</li>
<li>浏览器解密响应消息，并对消息进行验真，进行加密交互数据</li>
</ul>
<h5 id="区别-3"><a href="#区别-3" class="headerlink" title="区别"></a>区别</h5><ul>
<li>HTTPS需要CA申请证书</li>
<li>HTTPS密文传输，HTTP明文传输</li>
<li>连接方式不同，HTTPS默认443，HTTP默认80</li>
<li>HTTPS = HTTP + 加密 + 认证 + 完整性保护</li>
</ul>
<hr>
<h4 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h4><ul>
<li>Socket是对TCP/IP协议的抽象，是操作系统对外开放的接口</li>
<li>IP + PID</li>
</ul>
<h5 id="Socket通信流程"><a href="#Socket通信流程" class="headerlink" title="Socket通信流程"></a>Socket通信流程</h5><p><img src="https://s2.ax1x.com/2019/03/04/kXCjMD.png" alt="kXCjMD.png"></p>
<h5 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h5><ul>
<li>客户端向服务器发送一个字符串，服务器收到该字符串后将其打印到命令行上，然后向客户端返回该字符串的长度，最后，客户端输出服务器端返回的该字符串的长度，分别用TCP和UDP实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LengthCalculator</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LengthCalculator</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取socket的输出流</span></span><br><span class="line">            OutputStream os = socket.getOutputStream();</span><br><span class="line">            <span class="comment">// 获取socket的输入流</span></span><br><span class="line">            InputStream is = socket.getInputStream();</span><br><span class="line">            <span class="keyword">int</span> ch = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            ch = is.read(buff);</span><br><span class="line">            String content = <span class="keyword">new</span> String(buff, <span class="number">0</span>, ch);</span><br><span class="line">            System.out.println(content);</span><br><span class="line">            <span class="comment">// 往输出流写入获得的字符串，回发客户端</span></span><br><span class="line">            os.write(String.valueOf(content.length()).getBytes());</span><br><span class="line">            <span class="comment">// 关闭流</span></span><br><span class="line">            is.close();</span><br><span class="line">            os.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建socket，绑定端口</span></span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">65000</span>);</span><br><span class="line">        <span class="comment">// 死循环，一直等待并且处理Client发送的请求</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 监听端口，知道客户端返回连接信息才返回</span></span><br><span class="line">            Socket socket = serverSocket.accept();</span><br><span class="line">            <span class="comment">// 获取客户端的请求信息后，执行相关业务逻辑</span></span><br><span class="line">            <span class="keyword">new</span> LengthCalculator(socket).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建socket，指定连接65000端口的服务器socket</span></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>,<span class="number">65000</span>);</span><br><span class="line">        <span class="comment">// 获取输出流</span></span><br><span class="line">        OutputStream os = socket.getOutputStream();</span><br><span class="line">        <span class="comment">// 获取输入流</span></span><br><span class="line">        InputStream is = socket.getInputStream();</span><br><span class="line">        <span class="comment">// 字符串转换byte,并且写入到输出流中</span></span><br><span class="line">        os.write(<span class="string">"hello world"</span>.getBytes());</span><br><span class="line">        <span class="keyword">int</span> ch = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        ch = is.read(buff);</span><br><span class="line">        <span class="comment">// 将接收流的byte数组转换为字符串(从服务器端发回的字符串长度数据)</span></span><br><span class="line">        String content = <span class="keyword">new</span> String(buff,<span class="number">0</span>,ch);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">// 关闭流</span></span><br><span class="line">        is.close();</span><br><span class="line">        os.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 服务端接受客户端发送的数据报</span></span><br><span class="line">        DatagramSocket socket = <span class="keyword">new</span> DatagramSocket(<span class="number">65001</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">128</span>];</span><br><span class="line">        DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buff, buff.length);</span><br><span class="line">        <span class="comment">// 接受客户端发送过来的内容,并且将内容封装到DatagramPacket中</span></span><br><span class="line">        socket.receive(packet);</span><br><span class="line">        <span class="comment">// 从DatagramPacket对象中获取真正存储的数据</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = packet.getData();</span><br><span class="line">        <span class="comment">// 将数据从二进制转换成字符串</span></span><br><span class="line">        String content = <span class="keyword">new</span> String(data,<span class="number">0</span>,packet.getLength());</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">// 将要发送给客户端的数据转换成二进制</span></span><br><span class="line">        <span class="keyword">byte</span>[] sendedContent = String.valueOf(content.length()).getBytes();</span><br><span class="line">        <span class="comment">// 服务端给客户端发送数据报</span></span><br><span class="line">        DatagramPacket packetToClient = <span class="keyword">new</span> DatagramPacket(sendedContent,sendedContent.length,packet.getAddress(),packet.getPort());</span><br><span class="line">        <span class="comment">// 发送数据给客户端</span></span><br><span class="line">        socket.send(packetToClient);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 客户端发送数据给服务端</span></span><br><span class="line">        DatagramSocket socket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">        <span class="comment">// 要发送给服务端的数据</span></span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="string">"hello world"</span>.getBytes();</span><br><span class="line">        <span class="comment">// 将IP地址封装</span></span><br><span class="line">        InetAddress address = InetAddress.getByName(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">        <span class="comment">// 将要发送的数据封装</span></span><br><span class="line">        DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buff, buff.length, address, <span class="number">65001</span>);</span><br><span class="line">        <span class="comment">// 发送</span></span><br><span class="line">        socket.send(packet);</span><br><span class="line">        <span class="comment">// 客户端接收服务端发来的数据报</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">128</span>];</span><br><span class="line">        <span class="comment">// 创建DatagramPacket对象存储服务端发送的数据</span></span><br><span class="line">        DatagramPacket receivedPacket = <span class="keyword">new</span> DatagramPacket(data, data.length);</span><br><span class="line">        <span class="comment">// 将接收到的数据存储到DatagramPacket对象中</span></span><br><span class="line">        socket.receive(receivedPacket);</span><br><span class="line">        <span class="comment">// 将服务端发送的数据打印</span></span><br><span class="line">        String content = <span class="keyword">new</span> String(receivedPacket.getData(), <span class="number">0</span>, receivedPacket.getLength());</span><br><span class="line">        System.out.println(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/09/Spring Security 18/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/09/Spring Security 18/" itemprop="url">Spring Security | Note-18</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-09T00:00:00+08:00">
                2018-09-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Security-Note-18"><a href="#Spring-Security-Note-18" class="headerlink" title="Spring Security Note-18"></a>Spring Security Note-18</h1><hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1.引入依赖(pom.xml)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.imooc.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>imooc-security-browser<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.imooc.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>imooc-security-authorize<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.配置系统(参见 application-example.properties)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application.properties</span><br></pre></td></tr></table></figure>
<p>3.增加UserDetailsService接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username,passwordEncoder.encode(<span class="string">"123456"</span>),</span><br><span class="line">                        AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"ROLE_USER"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.如果需要记住我功能，需要创建数据库表(参见 db.sql)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 记住我功能用的表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> persistent_logins (</span><br><span class="line">    username <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    series <span class="built_in">varchar</span>(<span class="number">64</span>) primary <span class="keyword">key</span>,</span><br><span class="line">    token <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    last_used <span class="keyword">timestamp</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>5.如果需要社交登录功能，需要以下额外的步骤<br>1).配置appId和appSecret(qq &amp; weixin)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 微信登录配置，参见WeixinProperties</span><br><span class="line">imooc.security.social.weixin.app-id = wxd99431bbff8305a0</span><br><span class="line">imooc.security.social.weixin.app-secret = 60f78681d063590a469f1b297feff3c4</span><br><span class="line">#imooc.security.social.weixin.providerId = weixin</span><br></pre></td></tr></table></figure>
<p>2).创建并配置用户注册页面，并实现注册服务(需要配置访问权限)，注意在服务中要调用ProviderSignInUtils的doPostSignUp方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestAuthorizeConfigProvider</span> <span class="keyword">implements</span> <span class="title">AuthorizeConfigProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">config</span><span class="params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;</span><br><span class="line">        config.antMatchers(HttpMethod.POST,<span class="string">"/user/regist"</span>).permitAll();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3).添加SocialUserDetailsService接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span>,<span class="title">SocialUserDetailsService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username,passwordEncoder.encode(<span class="string">"123456"</span>),</span><br><span class="line">                        AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"ROLE_USER"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocialUserDetails <span class="title">loadUserByUserId</span><span class="params">(String userId)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SocialUser(userId,passwordEncoder.encode(<span class="string">"123456"</span>),</span><br><span class="line">                              AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"ROLE_USER"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4).创建社交登录用的表 (参见 db.sql)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 社交登录用的表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> imooc_UserConnection (</span><br><span class="line">    userId <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    providerId <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    providerUserId <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    <span class="keyword">rank</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    displayName <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    profileUrl <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    imageUrl <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    accessToken <span class="built_in">varchar</span>(<span class="number">512</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    secret <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    refreshToken <span class="built_in">varchar</span>(<span class="number">512</span>),</span><br><span class="line">    expireTime <span class="built_in">bigint</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (userId, providerId, providerUserId));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> <span class="keyword">index</span> UserConnectionRank <span class="keyword">on</span> imooc_UserConnection(userId, providerId, <span class="keyword">rank</span></span><br><span class="line">                                                              );</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/08/Spring Security 17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/08/Spring Security 17/" itemprop="url">Spring Security | Note-17</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-08T00:00:00+08:00">
                2018-09-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Security-Note-17"><a href="#Spring-Security-Note-17" class="headerlink" title="Spring Security Note-17"></a>Spring Security Note-17</h1><hr>
<h3 id="Spring-Security授权简介"><a href="#Spring-Security授权简介" class="headerlink" title="Spring Security授权简介"></a>Spring Security授权简介</h3><h4 id="Spring-Security授权定义"><a href="#Spring-Security授权定义" class="headerlink" title="Spring Security授权定义"></a>Spring Security授权定义</h4><p>我们所谓的菜单，按钮触发的对应的一个后台的URL，授权并不是看见与否，而是能否访问；</p>
<p>安全问题，涉及的是访问与否的问题；</p>
<p>在用户体验的情况下，会给出所谓的按钮和菜单，但是在没有权限访问的前提下，最终依然没有访问的能力，给出的是提示；</p>
<p>涉及的用户体验和安全，要求不同，给出的解决方案是不同，最终我们只需要将自定义开发权限模块和Spring Security对接即可；</p>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p>业务系统（普通用户）、内管系统（公司运营人员），对于这两个系统来说，授权是不同的；</p>
<p>在业务系统当中，只区分是否登录（浏览、操作）或区分简单的角色（普通、VIP），权限规则基本不变；</p>
<p>在内管系统当中，角色众多，权限复杂，权限规则随着体系和业务的发展不断变化；</p>
<p>在应用系统内部，需要两份数据，一份是系统配置信息（每个URL需要的权限），一份是用户权限信息（用户1有ABC权限），对于请求，将会对两份数据进行比对以获取访问请求；</p>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>在BrowserSecurityConfig的authorizeRequests()已经进行URL的配置；</p>
<p>接下去对于角色的验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定URL的角色</span></span><br><span class="line">.antMatchers(<span class="string">"/user"</span>).hasRole(<span class="string">"ADMIN"</span>)</span><br><span class="line"><span class="comment">// 指定请求方法</span></span><br><span class="line">.antMatchers(HttpMethod.GET,<span class="string">"/user/*"</span>).hasRole(<span class="string">"ADMIN"</span>)</span><br></pre></td></tr></table></figure>
<p>在<code>MyUserDetailService</code>，可以指定返回用户的权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SocialUserDetails <span class="title">buildUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO 根据用户名（数据库）查找用户信息</span></span><br><span class="line">		<span class="comment">// 根据查找到的用户信息，判断用户是否被冻结</span></span><br><span class="line">		String password = passwordEncoder.encode(<span class="string">"123456"</span>);</span><br><span class="line">		logger.info(<span class="string">"PASSWORD FROM DB : "</span> + password);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SocialUser(username, password,</span><br><span class="line">				<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>,</span><br><span class="line">				AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admin,ROLE_USER,ROLE_ADMIN"</span>));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Spring-Security源码解析"><a href="#Spring-Security源码解析" class="headerlink" title="Spring Security源码解析"></a>Spring Security源码解析</h3><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuyfwgmi09j21740b2gv0.jpg" alt=""></p>
<p>在这里的学习中，我们重点关注橙色的部分<code>Filter Security Interceptor</code>，它最终决定你的请求是否能够通过，访问到REST API ；</p>
<p>如果不能访问，它会抛出异常，并且说明原因，由蓝色部分<code>Exception Translation Filter</code>来处理；</p>
<p><code>Anonymous Authentication Filter</code>匿名认证过滤器，位于绿色过滤器链段最后一端；</p>
<h4 id="Anonymous-Authentication-Filter"><a href="#Anonymous-Authentication-Filter" class="headerlink" title="Anonymous Authentication Filter"></a>Anonymous Authentication Filter</h4><p>这个类十分简单，它主要关注你当前的<code>SecurityContextHolder</code>是否有<code>Authentication</code>，判断是否为空，实际上就是在判断，前面绿色过滤器链是否完成身份认证，如果为空，那么就会创建一个<code>Authentication</code>；</p>
<p>这个由匿名认证过滤器创建的<code>Authentication</code>，是匿名的<code>principal</code>；</p>
<p>通过<code>Anonymous Authentication Filter</code>，最终都会带有你的身份，去到<code>Filter Security Interceptor</code>，由它来判断你的身份是否有对API的访问权限；</p>
<p><img src="C:\Users\lenovo\AppData\Local\Temp\1536113901081.png" alt="1536113901081"></p>
<p>上面此图，是与Spring Security授权相关的类和接口；</p>
<p>最核心的三个类<code>FilterSecurityInterceptor</code> &amp; <code>AccessDecisionManager</code> &amp; <code>AccessDecisionVoter</code>；</p>
<h4 id="Filter-Security-Interceptor"><a href="#Filter-Security-Interceptor" class="headerlink" title="Filter Security Interceptor"></a>Filter Security Interceptor</h4><p>整个控制授权的主入口；</p>
<h4 id="Access-Decision-Manager"><a href="#Access-Decision-Manager" class="headerlink" title="Access Decision Manager"></a>Access Decision Manager</h4><p>访问决定的管理者，它由一个抽象类<code>Abstract Access Decision Manager</code>，和三个具体实现<code>AffirmativeBased</code> &amp; <code>ConsensusBased</code> &amp; <code>UnanimouosBased</code>；</p>
<p>它在抽象类中，管理一组<code>AccessDecisionVoter</code>；</p>
<p><code>Abstract Access Decision Manager</code>则会综合所有投票者的决定，给出一个最终的结果；</p>
<p>最终的结果，是有三套具体实现的逻辑；</p>
<p><code>AffirmativeBased</code> 只要有一个通过就通过；</p>
<p><code>ConsensusBased</code> 多数通过逻辑；</p>
<p><code>UnanimouosBased</code>只要有一个不通过就不通过；</p>
<p>默认Spring Security使用的是第一个逻辑，只要有一个通过就通过的逻辑；</p>
<h4 id="Access-Decision-Voter"><a href="#Access-Decision-Voter" class="headerlink" title="Access Decision Voter"></a>Access Decision Voter</h4><p>Voter是投票者，有一组投票者，每个投票者有不同的处理逻辑；</p>
<p>判断Authentication是否有某种角色，是否经过完全的身份认证；</p>
<p>每个投票者根据自己的逻辑，投出自己的一票，投出过还是不过；</p>
<h4 id="Security-Config"><a href="#Security-Config" class="headerlink" title="Security Config"></a>Security Config</h4><p>判断你的授权是否通过，需要两块数据的配置信息；</p>
<p><code>Security Config</code>会将系统配置信息读取出来，封装成一组<code>Config Attribute</code>的对象；</p>
<p>这一组对象中，每一个<code>Config Attribute</code>都会带有每一个URL所需要的权限；</p>
<h4 id="Security-Context-Holder"><a href="#Security-Context-Holder" class="headerlink" title="Security Context Holder"></a>Security Context Holder</h4><p>当前用户的权限信息，会封装在<code>Authentication</code>当中；</p>
<p>-</p>
<p>在进入到<code>Access Decision Manager之前</code>，会封装三部分的信息<code>Config Attribute</code>，<code>Authentication</code>，<code>请求信息</code>，成一个对象，进行授权认证的判断；</p>
<p>在Spring Security3.x以后，新产生的<code>Wen Expression Voter</code>包办了所有的Voter的工作，在WEB的环境下，所有的Voter的工作由它承担；</p>
<hr>
<h3 id="权限表达式"><a href="#权限表达式" class="headerlink" title="权限表达式"></a>权限表达式</h3><p>Spring Security允许我们在定义URL访问或方法访问所应有的权限时使用Spring EL表达式，在定义所需的访问权限时如果对应的表达式返回结果为true则表示拥有对应的权限，反之则无；</p>
<table>
<thead>
<tr>
<th><strong>表达式</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>hasRole([role])</td>
<td>当前用户是否拥有指定角色。</td>
</tr>
<tr>
<td>hasAnyRole([role1,role2])</td>
<td>多个角色是一个以逗号进行分隔的字符串。如果当前用户拥有指定角色中的任意一个则返回true。</td>
</tr>
<tr>
<td>hasAuthority([auth])</td>
<td>等同于hasRole</td>
</tr>
<tr>
<td>hasAnyAuthority([auth1,auth2])</td>
<td>等同于hasAnyRole</td>
</tr>
<tr>
<td>Principle</td>
<td>代表当前用户的principle对象</td>
</tr>
<tr>
<td>authentication</td>
<td>直接从SecurityContext获取的当前Authentication对象</td>
</tr>
<tr>
<td>permitAll</td>
<td>总是返回true，表示允许所有的</td>
</tr>
<tr>
<td>denyAll</td>
<td>总是返回false，表示拒绝所有的</td>
</tr>
<tr>
<td>isAnonymous()</td>
<td>当前用户是否是一个匿名用户</td>
</tr>
<tr>
<td>isRememberMe()</td>
<td>表示当前用户是否是通过Remember-Me自动登录的</td>
</tr>
<tr>
<td>isAuthenticated()</td>
<td>表示当前用户是否已经登录认证成功了。</td>
</tr>
<tr>
<td>isFullyAuthenticated()</td>
<td>如果当前用户既不是一个匿名用户，同时又不是通过Remember-Me自动登录的，则返回true。</td>
</tr>
</tbody>
</table>
<p>-</p>
<h4 id="多权限表达式"><a href="#多权限表达式" class="headerlink" title="多权限表达式"></a>多权限表达式</h4><p><img src="https://images2018.cnblogs.com/blog/702434/201803/702434-20180320160102243-1707373872.png" alt="img"></p>
<p>-</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuyhmqnvxrj211q0j6dmr.jpg" alt=""></p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><h5 id="配置提供者"><a href="#配置提供者" class="headerlink" title="配置提供者"></a>配置提供者</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthorizeConfigProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">config</span><span class="params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="具体实现配置提供者"><a href="#具体实现配置提供者" class="headerlink" title="具体实现配置提供者"></a>具体实现配置提供者</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthorizeConfigProvider</span> <span class="keyword">implements</span> <span class="title">AuthorizeConfigProvider</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">config</span><span class="params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;</span><br><span class="line">        config.antMatchers(</span><br><span class="line">            SecurityConstants.DEFAULT_UNAUTHENTICATION_URL,</span><br><span class="line">            SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE,</span><br><span class="line">            SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX+<span class="string">"/*"</span>,</span><br><span class="line">            securityProperties.getBrowser().getLoginPage(),</span><br><span class="line">            securityProperties.getBrowser().getSignUpUrl(),</span><br><span class="line">            securityProperties.getBrowser().getSession().getSessionInvalidUrl(),</span><br><span class="line">            securityProperties.getBrowser().getSignOutUrl()</span><br><span class="line">        ).permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="配置管理器"><a href="#配置管理器" class="headerlink" title="配置管理器"></a>配置管理器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthorizeConfigManager</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">config</span><span class="params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="具体实现配置管理器"><a href="#具体实现配置管理器" class="headerlink" title="具体实现配置管理器"></a>具体实现配置管理器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthorizeConfigManager</span> <span class="keyword">implements</span> <span class="title">AuthorizeConfigManager</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Set&lt;AuthorizeConfigProvider&gt; authorizeConfigProviders;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">config</span><span class="params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (AuthorizeConfigProvider authorizeConfigProvider : authorizeConfigProviders) &#123;</span><br><span class="line">			authorizeConfigProvider.config(config);</span><br><span class="line">		&#125;</span><br><span class="line">        config.anyRequest().authenticated();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="修改浏览器安全配置"><a href="#修改浏览器安全配置" class="headerlink" title="修改浏览器安全配置"></a>修改浏览器安全配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">AbstractChannelSecurityConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizeConfigManager authorizeConfigManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        applyPasswordAuthenticationConfig(http);</span><br><span class="line">        http.apply(validateCodeSecurityConfig)</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 删除Cookies</span></span><br><span class="line">            .deleteCookies(<span class="string">"JSESSIONID"</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().disable();</span><br><span class="line">        authorizeConfigManager.config(http.authorizeRequests());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="修改APP资源管理器安全配置"><a href="#修改APP资源管理器安全配置" class="headerlink" title="修改APP资源管理器安全配置"></a>修改APP资源管理器安全配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizeConfigManager authorizeConfigManager;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line">            .loginPage(SecurityConstants.DEFAULT_UNAUTHENTICATION_URL)</span><br><span class="line">            .loginProcessingUrl(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_FORM)</span><br><span class="line">            .successHandler(imoocAuthenticationSuccessHandler)</span><br><span class="line">            .failureHandler(imoocAuthenticationFailureHandler);</span><br><span class="line">        http</span><br><span class="line">            .apply(validateCodeSecurityConfig)</span><br><span class="line">            .and()</span><br><span class="line">            .apply(smsCodeAuthenticationSecurityConfig)</span><br><span class="line">            .and()</span><br><span class="line">            .apply(imoocSocialSecurityConfig)</span><br><span class="line">            .and()</span><br><span class="line">            .apply(openIdAuthenticationSecurityConfig)</span><br><span class="line">            .and().csrf().disable();</span><br><span class="line">        authorizeConfigManager.config(http.authorizeRequests());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="基于数据库RBAC数据模型控制权限"><a href="#基于数据库RBAC数据模型控制权限" class="headerlink" title="基于数据库RBAC数据模型控制权限"></a>基于数据库RBAC数据模型控制权限</h3><p>在内管系统中，以满足角色众多，权限复杂，权限规则随着业务的发展不断变化的问题，我们需要将权限放入到数据库当中，以添加，修改，删除数据的方式满足需要；</p>
<h4 id="通用RBAC数据模型"><a href="#通用RBAC数据模型" class="headerlink" title="通用RBAC数据模型"></a>通用RBAC数据模型</h4><p>RBAC（Role-Based Access Control）：有大约5张表组成，3张实体表，2张关系表，分别是：</p>
<p>用户表：存储用户信息，由业务人员维护；</p>
<p>角色表：存储角色信息，由业务人员维护；</p>
<p>资源表：存储资源信息，菜单，按钮及其URL等，由开发人员维护；</p>
<p>用户-角色关系表（n-n）：存储用户和角色的对应关系，由业务人员维护；</p>
<p>角色-资源关系表（n-n）：存储角色和资源的对应关系，由业务人员维护；</p>
<h4 id="声明权限服务"><a href="#声明权限服务" class="headerlink" title="声明权限服务"></a>声明权限服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RbacServiceImpl</span> <span class="keyword">implements</span> <span class="title">RbacService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(HttpServletRequest request, Authentication authentication)</span> </span>&#123;</span><br><span class="line">        Object principal = authentication.getPrincipal();</span><br><span class="line">        <span class="keyword">boolean</span> hasPermission = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails) &#123;</span><br><span class="line">            String username = ((UserDetails) principal).getUsername();</span><br><span class="line">            <span class="comment">// 读取用户所拥有权限的所有URL</span></span><br><span class="line">            Set&lt;String&gt; urls = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">                <span class="keyword">if</span> (antPathMatcher.match(url, request.getRequestURI())) &#123;</span><br><span class="line">                    hasPermission = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hasPermission;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order</span>(Integer.MAX_VALUE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoAuthorizeConfigProvider</span> <span class="keyword">implements</span> <span class="title">AuthorizeConfigProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">config</span><span class="params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;</span><br><span class="line">        config.anyRequest().access(<span class="string">"@rbacService.hasPermission(request,authentication)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/07/Spring Security 16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/07/Spring Security 16/" itemprop="url">Spring Security | Note-16</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-07T00:00:00+08:00">
                2018-09-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Spring-Security-Note-16"><a href="#Spring-Security-Note-16" class="headerlink" title="Spring Security Note-16"></a>Spring Security Note-16</h2><hr>
<h3 id="基于JWT实现SSO单点登录"><a href="#基于JWT实现SSO单点登录" class="headerlink" title="基于JWT实现SSO单点登录"></a>基于JWT实现SSO单点登录</h3><hr>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>在实际生活的应用中，我们举个例子而言，对于淘宝和天猫这两个完全不同的域名，是两个完全不同的服务器上；</p>
<p>我们在淘宝进行登录的时候，跳转到了一个域名为</p>
<blockquote>
<p>login.taobao.com</p>
</blockquote>
<p>意味着，服务器又换了一个，到此已经出现了三个服务器；</p>
<p>登录后，页面又跳转回到了淘宝，此时我们重新刷新天猫，天猫也以直接完成了登录状态；</p>
<p>虽然这两个网站是独立的域名，独立的服务器，但是在其中一个网站登录，在另一个网站上实现了登录；</p>
<hr>
<h4 id="步骤流程"><a href="#步骤流程" class="headerlink" title="步骤流程"></a>步骤流程</h4><p>应用A（淘宝） 应用B（天猫） 和认证服务器（登录服务器）；</p>
<p>0.用户访问请求登录应用A；</p>
<p>1.应用A将会向认证服务器发起请求授权的请求；</p>
<p>2.此时在认证服务器中获取认证并授权（登录）之后；</p>
<p>3.认证服务区将会返回一个授权码给应用A；</p>
<p>4.获得授权码后，应用A会再次请求认证服务器请求令牌；</p>
<p>5.认证服务器接受请求，返回JWT配置下的令牌，返回给应用A；</p>
<p>6.应用A获得JWT令牌后，进行解析，并且完成登录；</p>
<p>7.当用户访问另一个系统（应用B）；</p>
<p>8.应用B也会去认证服务器请求授权；</p>
<p>9.但是在认证服务器中，已存在授权记录，那么认证服务器是知道用户是谁；</p>
<p>10.完成整个OAuth流程，并且返回应用B一个JWT令牌（不同于应用A）；</p>
<p>11.应用B获取到认证服务器返回给应用B的JWT进行解析并登录；</p>
<p>12.真正的业务是部署在一个独立的资源服务器，我们只需要使用JWT访问资源服务器即可；</p>
<p>PS：尽管应用A和应用B的JWT不同，但是解析出来的用户信息是一致的；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxhgyr3g5j214w0j1118.jpg" alt=""></p>
<hr>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>我们需要重新新建项目sso-demo，在sso这个项目中，我们需要对认证服务器进行一个重新的构造，这个认证服务器是基于浏览器，session的技术；</p>
<p>创建四个项目；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxhvelpnij203o02zt8j.jpg" alt=""></p>
<h5 id="认证服务器配置SSOAuthorizationServerConfig"><a href="#认证服务器配置SSOAuthorizationServerConfig" class="headerlink" title="认证服务器配置SSOAuthorizationServerConfig"></a>认证服务器配置SSOAuthorizationServerConfig</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证服务器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: REX</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: Create in 14:34 2018/9/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSOAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 配置两个应用</span></span><br><span class="line">        clients.inMemory()</span><br><span class="line">            .withClient(<span class="string">"app1"</span>).secret(<span class="string">"appsecret1"</span>)</span><br><span class="line">            .authorizedGrantTypes(<span class="string">"authorization_code"</span>, <span class="string">"refresh_token"</span>).scopes(<span class="string">"all"</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .withClient(<span class="string">"app2"</span>).secret(<span class="string">"appsecret2"</span>)</span><br><span class="line">            .authorizedGrantTypes(<span class="string">"authorization_code"</span>, <span class="string">"refresh_token"</span>).scopes(<span class="string">"all"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 安全配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 授权表达式</span></span><br><span class="line">        security.tokenKeyAccess(<span class="string">"isAuthenticated()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置入口</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints.tokenStore(jwtTokenStore()).accessTokenConverter(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置JWT</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        <span class="comment">// 指定密签</span></span><br><span class="line">        converter.setSigningKey(<span class="string">"REX"</span>);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.port=9999</span><br><span class="line">server.context-path=/server</span><br><span class="line">security.user.password=123123</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="应用A"><a href="#应用A" class="headerlink" title="应用A"></a>应用A</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableOAuth</span>2Sso</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSOClient1Application</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SSOClient1Application.class,args);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">user</span><span class="params">(Authentication user)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> user;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># OAuth认证（与服务器配置要一致）</span><br><span class="line">security.oauth2.client.client-id=app1</span><br><span class="line">security.oauth2.client.client-secret=appsecret1</span><br><span class="line"># 认证服务器</span><br><span class="line">security.oauth2.client.user-authorization-uri=http://127.0.0.1:9999/server/oauth/authorize</span><br><span class="line"># 返回授权码</span><br><span class="line">security.oauth2.client.access-token-uri=http://127.0.0.1:9999/server/oauth/token</span><br><span class="line"># 解析的密钥URL</span><br><span class="line">security.oauth2.resource.jwt.key-uri=http://127.0.0.1:9999/server/oauth/token_key</span><br><span class="line"># SERVER</span><br><span class="line">server.port=8080</span><br><span class="line">server.context-path=/client1</span><br></pre></td></tr></table></figure>
<h4 id="应用B"><a href="#应用B" class="headerlink" title="应用B"></a>应用B</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># OAuth认证（与服务器配置要一致）</span><br><span class="line">security.oauth2.client.client-id=app2</span><br><span class="line">security.oauth2.client.client-secret=appsecret2</span><br><span class="line"># 认证服务器</span><br><span class="line">security.oauth2.client.user-authorization-uri=http://127.0.0.1:9999/server/oauth/authorize</span><br><span class="line"># 返回授权码</span><br><span class="line">security.oauth2.client.access-token-uri=http://127.0.0.1:9999/server/oauth/token</span><br><span class="line"># 解析的密钥URL</span><br><span class="line">security.oauth2.resource.jwt.key-uri=http://127.0.0.1:9999/server/oauth/token_key</span><br><span class="line"># SERVER</span><br><span class="line">server.port=8060</span><br><span class="line">server.context-path=/client2</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>1.首先访问127.0.0.1:8080/client1/index.html</p>
<p>2.跳转登录认证（9999）</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxj5s7ydcj20r100taa0.jpg" alt=""></p>
<blockquote>
<p>username:user</p>
<p>password:123123</p>
</blockquote>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxj564bvlj20ci0630so.jpg" alt=""></p>
<p>3.是否授权给APP1访问受保护的资源？</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxj6qtie6j20df04j3yk.jpg" alt=""></p>
<p>4.得到授权后返回，此时已获得认证服务器的授权</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxj9resfpj20a904z0ts.jpg" alt=""></p>
<p>5.访问<code>/user</code>，获取用户信息</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxjao8gw6j20ji0puwfu.jpg" alt=""></p>
<p>6.访问Client2，这时候，认证服务器已经知道我的用户信息，不需要重新登录，只需要授权即可</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxjbiaii1j20dg04tdfw.jpg" alt=""></p>
<p>7.此时即可完成Client1和Client2页面之间任意的跳转</p>
<p>8.这时候我们会发现Client1和Client2访问<code>/user</code>所获得的<code>tokenValue</code>是不同的，但是用户信息是一样的；</p>
<hr>
<h3 id="改善"><a href="#改善" class="headerlink" title="改善"></a>改善</h3><p>登录页面和A跳转B的隐藏授权；</p>
<h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><p>在Server项目中，重新configure为表单登录的方式；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSOSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin().and().authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不将用户名和密码写死，通过重新实现UserDetailsService的方式，从数据库中读写用户名和密码；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSOUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username,<span class="string">""</span>, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"ROLE_USER"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>覆盖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSOSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-</p>
<h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><p>找到授权的表单的页面在<code>WhitelabelApprovalEndpoint</code>类，在进入时直接跳转授权，不需要点击；</p>
<p>重新写一个<code>WhitelabelApprovalEndpoint</code>，将@FrameworkEndpoint改为@RestController进行处理；</p>
<p>并且复制一份<code>SpelView</code>为<code>SsoSpelView</code>；</p>
<p>我们直接将confirmationForm提交，并且隐藏<code>&lt;body&gt;&lt;/body&gt;</code>；</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">'display:none;'</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>OAuth Approval<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Do you authorize '$&#123;authorizationRequest.clientId&#125;' to access your protected resources?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">'confirmationForm'</span> <span class="attr">name</span>=<span class="string">'confirmationForm'</span> <span class="attr">action</span>=<span class="string">'$&#123;path&#125;/oauth/authorize'</span> <span class="attr">method</span>=<span class="string">'post'</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">'user_oauth_approval'</span> <span class="attr">value</span>=<span class="string">'true'</span> <span class="attr">type</span>=<span class="string">'hidden'</span>/&gt;</span>%csrf%%scopes%<span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">'authorize'</span> <span class="attr">value</span>=<span class="string">'Authorize'</span> <span class="attr">type</span>=<span class="string">'submit'</span>/&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            %denial%</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'confirmationForm'</span>).submit()</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span>"</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/06/Spring Security 15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/06/Spring Security 15/" itemprop="url">Spring Security | Note-15</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-06T00:00:00+08:00">
                2018-09-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Security-Note-15"><a href="#Spring-Security-Note-15" class="headerlink" title="Spring Security Note-15"></a>Spring Security Note-15</h1><hr>
<h3 id="重构注册逻辑"><a href="#重构注册逻辑" class="headerlink" title="重构注册逻辑"></a>重构注册逻辑</h3><p>在之前浏览器的社交账号登录注册操作逻辑时，发现用户是第一次用社交帐号登录时，它会跳转至配置的注册页上，跳转到注册页之前，会将第三方用户信息放到SESSION当中；</p>
<p>跳转到注册页之后，可以访问<code>/social/user</code>服务，然后将用户信息从SESSION中提出来，并且提供了providerSignInUtils的根据，从SESSION中拿出用户数据来，一旦用户注册（绑定）完成之后，拿到一个唯一的用户标识，providerSignInUtils再把之前的第三方用户信息拿出来，做一个绑定，存到数据库中；</p>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>在APP当中，之前的逻辑是想不通的，因为浏览器是基于SESSION的；</p>
<p>APP是一种属于无SESSION的环境，我们需要对注册逻辑进行改造；</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>基本的操作思路与验证码的重构一致，我们不将信息存到SESSION当中，而是在传输信息时，先将用户信息存到一个外部存储（REDIS）当中，携带一个deviceId；</p>
<h5 id="存放社交信息工具类AppSignUpUtils"><a href="#存放社交信息工具类AppSignUpUtils" class="headerlink" title="存放社交信息工具类AppSignUpUtils"></a>存放社交信息工具类AppSignUpUtils</h5> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSignUpUtils</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UsersConnectionRepository usersConnectionRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionFactoryLocator connectionFactoryLocator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveConnectionData</span><span class="params">(WebRequest request, ConnectionData connectionData)</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(getKey(request), connectionData, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPostSignUp</span><span class="params">(WebRequest request, String userId)</span> </span>&#123;</span><br><span class="line">        String key = getKey(request);</span><br><span class="line">        <span class="keyword">if</span> (!redisTemplate.hasKey(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppSecretException(<span class="string">"无法找到缓存的用户社交账号信息"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ConnectionData connectionData = (ConnectionData) redisTemplate.opsForValue().get(key);</span><br><span class="line">        Connection&lt;?&gt; connection = connectionFactoryLocator.getConnectionFactory(connectionData.getProviderId()).createConnection(connectionData);</span><br><span class="line"></span><br><span class="line">        usersConnectionRepository.createConnectionRepository(userId).addConnection(connection);</span><br><span class="line">        redisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getKey</span><span class="params">(WebRequest request)</span> </span>&#123;</span><br><span class="line">        String deviceId = request.getHeader(<span class="string">"deviceId"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(deviceId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AppSecretException(<span class="string">"设备ID参数不能为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"imooc:security:social.connect."</span> + deviceId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="SpringSocialConfigurerPostProcessor"><a href="#SpringSocialConfigurerPostProcessor" class="headerlink" title="SpringSocialConfigurerPostProcessor"></a>SpringSocialConfigurerPostProcessor</h5><p>SpringSocialConfigurerPostProcessor ，在所有的Bean初始化之前，如果是配置了imoocSocialSecurityConfig，就重行定义注册的处理器；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSocialConfigurerPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.equals(beanName,<span class="string">"imoocSocialSecurityConfig"</span>))&#123;</span><br><span class="line">			ImoocSpringSocialConfigurer configurer = (ImoocSpringSocialConfigurer)bean;</span><br><span class="line">			configurer.signupUrl(<span class="string">"/social/signUp"</span>);</span><br><span class="line">			<span class="keyword">return</span> configurer;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="处理注册处理器AppSecurityController"><a href="#处理注册处理器AppSecurityController" class="headerlink" title="处理注册处理器AppSecurityController"></a>处理注册处理器AppSecurityController</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSecurityController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProviderSignInUtils providerSignInUtils;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AppSignUpUtils appSignUpUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/social/signUp"</span>)</span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.UNAUTHORIZED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocialUserInfo <span class="title">getSocialUserInfo</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        SocialUserInfo userInfo = <span class="keyword">new</span> SocialUserInfo();</span><br><span class="line">        Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(<span class="keyword">new</span> ServletWebRequest(request));</span><br><span class="line">        userInfo.setProviderId(connection.getKey().getProviderId());</span><br><span class="line">        userInfo.setProviderUserId(connection.getKey().getProviderUserId());</span><br><span class="line">        userInfo.setNickname(connection.getDisplayName());</span><br><span class="line">        userInfo.setHeadimg(connection.getImageUrl());</span><br><span class="line"></span><br><span class="line">        appSignUpUtils.saveConnectionData(<span class="keyword">new</span> ServletWebRequest(request), connection.createData());</span><br><span class="line">        <span class="keyword">return</span> userInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样如果在使用社交帐号进行登录时，如果在数据库中没有对应的用户信息，就会引导进行注册，而且不是之前配置的注册页面的逻辑；</p>
<p>此时用户信息已经封装在UserInfo中，并存放在redis中了，在执行注册的请求；</p>
<hr>
<h3 id="Token处理"><a href="#Token处理" class="headerlink" title="Token处理"></a>Token处理</h3><h4 id="基本的Token参数配置"><a href="#基本的Token参数配置" class="headerlink" title="基本的Token参数配置"></a>基本的Token参数配置</h4><p>Token的处理都在认证服务器内完成，对<code>ImoocAuthorizationServerConfig</code>进行配置；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints.authenticationManager(authenticationManager).userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory() <span class="comment">// Token存储信息的位置</span></span><br><span class="line">            .withClient(<span class="string">"imooc"</span>) <span class="comment">// 指定client-id 配置文件就不会起作用</span></span><br><span class="line">            .secret(<span class="string">"imoocsecret"</span>) <span class="comment">// 指定client-secret 配置文件就不会起作用</span></span><br><span class="line">            .accessTokenValiditySeconds(<span class="number">7200</span>) <span class="comment">// 令牌有效期</span></span><br><span class="line">            .authorizedGrantTypes(<span class="string">"password"</span>, <span class="string">"refresh_token"</span>) <span class="comment">// 所支持的授权模式</span></span><br><span class="line">            .scopes(<span class="string">"all"</span>); <span class="comment">// 发出的权限</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的结果当中，最明显的就是expires_in；</p>
<p>如果发送时，不带有scope的参数，则会返回所有的scope类型；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxc06bya7j20cu02xq31.jpg" alt=""></p>
<p>-</p>
<h5 id="通用配置类代替"><a href="#通用配置类代替" class="headerlink" title="通用配置类代替"></a>通用配置类代替</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2ClientProperties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String clientId;</span><br><span class="line">	<span class="keyword">private</span> String clientSecret;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> accessTokenValidateSeconds = <span class="number">7200</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Properties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> OAuth2ClientProperties[] clients = &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints.authenticationManager(authenticationManager).userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InMemoryClientDetailsServiceBuilder builder = clients.inMemory();</span><br><span class="line">        <span class="keyword">if</span>(ArrayUtils.isNotEmpty(securityProperties.getOauth2().getClients()))&#123;</span><br><span class="line">            <span class="keyword">for</span>(OAuth2ClientProperties config:securityProperties.getOauth2().getClients())&#123;</span><br><span class="line">                builder.withClient(config.getClientId()) <span class="comment">// 指定client-id 配置文件就不会起作用</span></span><br><span class="line">                    .secret(config.getClientSecret()) <span class="comment">// 指定client-secret 配置文件就不会起作用</span></span><br><span class="line">                    .accessTokenValiditySeconds(config.getAccessTokenValidateSeconds()) <span class="comment">// 令牌有效期</span></span><br><span class="line">                    .authorizedGrantTypes(<span class="string">"password"</span>, <span class="string">"refresh_token"</span>) <span class="comment">// 所支持的授权模式</span></span><br><span class="line">                    .scopes(<span class="string">"all"</span>,<span class="string">"read"</span>,<span class="string">"write"</span>); <span class="comment">// 发出的权限</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-</p>
<h5 id="配置存储方式TokenStoreConfig"><a href="#配置存储方式TokenStoreConfig" class="headerlink" title="配置存储方式TokenStoreConfig"></a>配置存储方式TokenStoreConfig</h5><p>现在的存储方式是存储在内存当中的，当服务重启时，就会清除；</p>
<p>此时我们需要将它存储在独立的容器中，例如数据库或Redis；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">redisTokenStore</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisTokenStore(redisConnectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    endpoints.tokenStore(tokenStore).authenticationManager(authenticationManager).userDetailsService(userDetailsService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-</p>
<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxcsl59sxj20bg02yaa2.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxcssmowaj208708hwek.jpg" alt=""></p>
<hr>
<h4 id="JWT替换默认令牌"><a href="#JWT替换默认令牌" class="headerlink" title="JWT替换默认令牌"></a>JWT替换默认令牌</h4><p>JWT(Json Web Token)：是JSON开放的Token标准，与默认的区别在于：</p>
<p>自包含：里面包含有意义的信息。Spring默认的Token是UUID生成的Token，本身无任何意义，本身不包含任何信息，信息是单独保存的。JWT的Token的是包含有意义信息的，如果存放Token的依赖储存器（Redis）奔溃或不可测情况，Token进行解读即可；</p>
<p>密签：为了自包含中的信息不可被随意的修改，并且不包含相关的业务信息，可用指定的密钥进行签名，防止篡改，修改即可知道；</p>
<p>可拓展：所包含的信息可用根据业务需求进行自定义；</p>
<p>-</p>
<h5 id="配置TokenStoreConfig"><a href="#配置TokenStoreConfig" class="headerlink" title="配置TokenStoreConfig"></a>配置TokenStoreConfig</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Properties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> OAuth2ClientProperties[] clients = &#123;&#125;;</span><br><span class="line">	<span class="keyword">private</span> String jwtSigningKey = <span class="string">"imooc"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"imooc.security.oauth2"</span>, name = <span class="string">"storeType"</span>, havingValue = <span class="string">"redis"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">redisTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisTokenStore(redisConnectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"imooc.security.oauth2"</span>, name = <span class="string">"storeType"</span>, havingValue = <span class="string">"jwt"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenConfig</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span></span>&#123;</span><br><span class="line">            JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">            <span class="comment">// 指定密签</span></span><br><span class="line">            converter.setSigningKey(securityProperties.getOauth2().getJwtSigningKey());</span><br><span class="line">            <span class="keyword">return</span> converter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="修改ImoocAuthorizationServerConfig"><a href="#修改ImoocAuthorizationServerConfig" class="headerlink" title="修改ImoocAuthorizationServerConfig"></a>修改ImoocAuthorizationServerConfig</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		endpoints.tokenStore(tokenStore).authenticationManager(authenticationManager).userDetailsService(userDetailsService);</span><br><span class="line">		<span class="keyword">if</span>(jwtAccessTokenConverter != <span class="keyword">null</span>)&#123;</span><br><span class="line">			endpoints.accessTokenConverter(jwtAccessTokenConverter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="返回结果-JWT"><a href="#返回结果-JWT" class="headerlink" title="返回结果(JWT)"></a>返回结果(JWT)</h5><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxd9xofisj20os05kt9l.jpg" alt=""></p>
<h6 id="自包含解码结果"><a href="#自包含解码结果" class="headerlink" title="自包含解码结果"></a>自包含解码结果</h6><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxdbguyrwj20sz0g1jti.jpg" alt=""></p>
<p>-</p>
<p>此时再通过access_token去获取用户信息，发现无返回内容；</p>
<p>实际，我们在用户信息<code>/user/me</code>中的参数UserDetails，实际我们传入的参数并不是UserDetails，而是一个字符串，所以无法获取到对应的用户信息；</p>
<h6 id="参数修改为Authentication"><a href="#参数修改为Authentication" class="headerlink" title="参数修改为Authentication"></a>参数修改为Authentication</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/me"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getCurrentUser</span><span class="params">(Authentication user)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxdguqp9ij20940g1dgp.jpg" alt=""></p>
<p>-</p>
<h5 id="自拓展ImoocJwtTokenEnhancer"><a href="#自拓展ImoocJwtTokenEnhancer" class="headerlink" title="自拓展ImoocJwtTokenEnhancer"></a>自拓展ImoocJwtTokenEnhancer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocJwtTokenEnhancer</span> <span class="keyword">implements</span> <span class="title">TokenEnhancer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">enhance</span><span class="params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; info = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        info.put(<span class="string">"company"</span>, <span class="string">"imooc"</span>);</span><br><span class="line">        ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(info);</span><br><span class="line">        <span class="keyword">return</span> accessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="添加配置TokenStoreConfig"><a href="#添加配置TokenStoreConfig" class="headerlink" title="添加配置TokenStoreConfig"></a>添加配置TokenStoreConfig</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"jwtTokenEnhancer"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> TokenEnhancer <span class="title">jwtTokenEnhancer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ImoocJwtTokenEnhancer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="修改认证服务器"><a href="#修改认证服务器" class="headerlink" title="修改认证服务器"></a>修改认证服务器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">private</span> TokenEnhancer jwtTokenEnhancer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    endpoints.tokenStore(tokenStore).authenticationManager(authenticationManager).userDetailsService(userDetailsService);</span><br><span class="line">    <span class="keyword">if</span> (jwtAccessTokenConverter != <span class="keyword">null</span> &amp;&amp; jwtTokenEnhancer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        TokenEnhancerChain enhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">        List&lt;TokenEnhancer&gt; enhancers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        enhancers.add(jwtTokenEnhancer);</span><br><span class="line">        enhancers.add(jwtAccessTokenConverter);</span><br><span class="line">        enhancerChain.setTokenEnhancers(enhancers);</span><br><span class="line">        endpoints.tokenEnhancer(enhancerChain).accessTokenConverter(jwtAccessTokenConverter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h6><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxds80neqj20a0062gm1.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxdsmxwgdj206k055mx2.jpg" alt=""></p>
<p>再次访问用户信息，实际上不存在我们自拓展的信息，只包含规范内的信息；</p>
<p>如果需要解析自拓展的信息，则需要以下操作；</p>
<h5 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h5><h6 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/me"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getCurrentUser</span><span class="params">(Authentication user, HttpServletRequest request)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">    String header = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">    String token = StringUtils.substringAfter(header,<span class="string">"bearer "</span>);</span><br><span class="line">    Claims claims = Jwts.parser().setSigningKey(securityProperties.getOauth2().getJwtSigningKey().getBytes(<span class="string">"UTF-8"</span>)).parseClaimsJws(token).getBody();</span><br><span class="line">    String company = (String)claims.get(<span class="string">"company"</span>);</span><br><span class="line">    logger.info(company);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="令牌刷新"><a href="#令牌刷新" class="headerlink" title="令牌刷新"></a>令牌刷新</h3><p>令牌无效后，不能反复登录去重新获取令牌，因为用户会用户体验极差；</p>
<p>在返回refresh_token，在无感知的情况下，获取一个新的access_token；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuxe6cjxl7j20gx0b1ab4.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/05/Spring Security 14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/05/Spring Security 14/" itemprop="url">Spring Security | Note-14</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-05T00:00:00+08:00">
                2018-09-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Security-Note-14"><a href="#Spring-Security-Note-14" class="headerlink" title="Spring Security Note-14"></a>Spring Security Note-14</h1><hr>
<h3 id="Spring-Security-OAuth核心源码"><a href="#Spring-Security-OAuth核心源码" class="headerlink" title="Spring Security OAuth核心源码"></a>Spring Security OAuth核心源码</h3><p>接下来，通过源码解析的方式，我们去了解如何将之前开发的</p>
<blockquote>
<p>用户名密码登录方式</p>
<p>手机短信登录方式</p>
<p>社交帐号登录方式</p>
</blockquote>
<p>以上三种自定义的认证方式，嫁接到Spring Security OAuth认证服务器中，并且实现Token的生成存储；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw8pkwnlpj215r0j0akt.jpg" alt=""></p>
<p>-</p>
<p>步骤略解</p>
<p>/oauth/token的请求会被<code>TokenEndpoint</code>拦截，通过<code>ClientDetailsService</code>获取<code>ClientDetails</code>（第三方相信），并一起封装在<code>TokenRequest</code>（请求的信息）中；</p>
<p>用这个<code>TokenRequest</code>会去调用一个<code>TokenGranter</code>的接口，在这后面，封装的是四种授权方式不同的实现，在这个接口里面，会根据你传入的grant_type具体选择一个Token的生成逻辑；</p>
<p>生成的逻辑，都会产生两个东西<code>OAuth2Request</code>（是之前两个信息<code>ClientDetails</code>和<code>TokenRequest</code>的整合）和<code>Authentication</code>；</p>
<p>这两个对象组合起来会生成一个叫<code>OAuth2Authentication</code>的对象，最终产生的<code>OAuth2Authentication</code>对象这个包含哪个第三方应用，请求哪个用户授权，授权模式，授权参数等所有的信息；</p>
<p>这个<code>OAuth2Authentication</code>对象会传入<code>AuthorizationServerTokenServices</code>接口的实现，最终生成一个<code>OAuth2AccessToken</code>令牌；</p>
<p>TokenStore实现令牌的存取；</p>
<p>TokenEnhancer实现令牌的增强；</p>
<p>-</p>
<h4 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h4><p>首先进入到TokenEndpoint中，处理/oauth/token的POST请求，拿到的第三方信息，根据第三方信息去创建一个TokenRequest；</p>
<p>拿到TokenRequest之后，去进行一系列的判断，最终会传到TokenGranter的grant当中产生最终的Token；</p>
<h5 id="CompositeTokenGranter"><a href="#CompositeTokenGranter" class="headerlink" title="CompositeTokenGranter"></a>CompositeTokenGranter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 四种授权模式 &amp; 刷新令牌的模式根据grant_type判断</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (TokenGranter granter : tokenGranters) &#123;</span><br><span class="line">        OAuth2AccessToken grant = granter.grant(grantType, tokenRequest);</span><br><span class="line">        <span class="keyword">if</span> (grant!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> grant;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="AbstractTokenGranter"><a href="#AbstractTokenGranter" class="headerlink" title="AbstractTokenGranter"></a>AbstractTokenGranter</h5><p><code>getAccessToken</code>产生最终的Token；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> OAuth2AccessToken <span class="title">getAccessToken</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="DefaultTokenServices"><a href="#DefaultTokenServices" class="headerlink" title="DefaultTokenServices"></a>DefaultTokenServices</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">createAccessToken</span><span class="params">(OAuth2Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="comment">// 从tokenStore获取OAuth2AccessToken（如果令牌存在，不同的授权模式下将返回同一个令牌）</span></span><br><span class="line">    OAuth2AccessToken existingAccessToken = tokenStore.getAccessToken(authentication);</span><br><span class="line">    OAuth2RefreshToken refreshToken = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 判断是否过期</span></span><br><span class="line">    <span class="keyword">if</span> (existingAccessToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (existingAccessToken.isExpired()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 删除过期的令牌</span></span><br><span class="line">                refreshToken = existingAccessToken.getRefreshToken();</span><br><span class="line">                tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">            &#125;</span><br><span class="line">            tokenStore.removeAccessToken(existingAccessToken);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果令牌存在则重新存储</span></span><br><span class="line">            tokenStore.storeAccessToken(existingAccessToken, authentication);</span><br><span class="line">            <span class="comment">// 存储后直接返回</span></span><br><span class="line">            <span class="keyword">return</span> existingAccessToken;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断刷新令牌不存在</span></span><br><span class="line">    <span class="keyword">if</span> (refreshToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建刷新令牌</span></span><br><span class="line">        refreshToken = createRefreshToken(authentication);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (refreshToken <span class="keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">        <span class="comment">// 过期</span></span><br><span class="line">        ExpiringOAuth2RefreshToken expiring = (ExpiringOAuth2RefreshToken) refreshToken;</span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;</span><br><span class="line">            refreshToken = createRefreshToken(authentication);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据刷新令牌创建OAuth2AccessToken</span></span><br><span class="line">    OAuth2AccessToken accessToken = createAccessToken(authentication, refreshToken);</span><br><span class="line">    tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">    refreshToken = accessToken.getRefreshToken();</span><br><span class="line">    <span class="keyword">if</span> (refreshToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">        tokenStore.storeRefreshToken(refreshToken, authentication);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返 回OAuth2AccessToken</span></span><br><span class="line">    <span class="keyword">return</span> accessToken;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="重构用户名密码登录"><a href="#重构用户名密码登录" class="headerlink" title="重构用户名密码登录"></a>重构用户名密码登录</h3><p>我们通过登录请求，到自定义的Filter重新到登录逻辑进行处理，在自定义的AuthenticationSuccessHandler处理之后，再获得OAuth2Request和Authentication，再达到最后的Token的获取；</p>
<p>通过请求参数，获取CilentId，根据ClientId通过ClientDetailsService获取ClientDetails，让ClientDetails和TokenRequest一同封装成OAuth2Request；</p>
<p>最终目标是得到OAuth2Request对象；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwavmc3l8j216t0nlk5o.jpg" alt=""></p>
<p>-</p>
<h4 id="改造Token的生成"><a href="#改造Token的生成" class="headerlink" title="改造Token的生成"></a>改造Token的生成</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"imoocAuthenticationSuccessHandler"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthenticationSuccessHandler</span> <span class="keyword">extends</span> <span class="title">SavedRequestAwareAuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ClientDetailsService clientDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationServerTokenServices authorizationServerTokenServices;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"登录成功"</span>);</span><br><span class="line">        String header = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">if</span> (header == <span class="keyword">null</span> || !header.startsWith(<span class="string">"Basic "</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">"请求头中无CLIENT信息"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解码获取ClientId</span></span><br><span class="line">        String[] tokens = extractAndDecodeHeader(header, request);</span><br><span class="line">        <span class="keyword">assert</span> tokens.length == <span class="number">2</span>;</span><br><span class="line">        String clientId = tokens[<span class="number">0</span>];</span><br><span class="line">        String clientSecret = tokens[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 获取ClientDetails</span></span><br><span class="line">        ClientDetails clientDetails = clientDetailsService.loadClientByClientId(clientId);</span><br><span class="line">        <span class="keyword">if</span> (clientDetails == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">"CLIENT_ID对应配置信息不存在:"</span> + clientId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!StringUtils.equals(clientDetails.getClientSecret(), clientSecret)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">"CLIENT_SECRET信息不匹配:"</span> + clientSecret);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// TokenRequest</span></span><br><span class="line">        TokenRequest tokenRequest = <span class="keyword">new</span> TokenRequest(MapUtils.EMPTY_MAP, clientId, clientDetails.getScope(), <span class="string">"custom"</span>);</span><br><span class="line">        <span class="comment">// OAuth2Request</span></span><br><span class="line">        OAuth2Request oAuth2Request = tokenRequest.createOAuth2Request(clientDetails);</span><br><span class="line">        <span class="comment">// 用OAuth2Request和Authentication封装成OAuth2Authentication</span></span><br><span class="line">        OAuth2Authentication oAuth2Authentication = <span class="keyword">new</span> OAuth2Authentication(oAuth2Request, authentication);</span><br><span class="line">        <span class="comment">// 传给AuthorizationServerTokenServices</span></span><br><span class="line">        OAuth2AccessToken token = authorizationServerTokenServices.createAccessToken(oAuth2Authentication);</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] extractAndDecodeHeader(String header, HttpServletRequest request) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] base64Token = header.substring(<span class="number">6</span>).getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] decoded;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            decoded = Base64.decode(base64Token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"Failed to decode basic authentication token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String token = <span class="keyword">new</span> String(decoded, <span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="keyword">int</span> delim = token.indexOf(<span class="string">":"</span>);</span><br><span class="line">        <span class="keyword">if</span> (delim == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"Invalid basic authentication token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;token.substring(<span class="number">0</span>, delim), token.substring(delim + <span class="number">1</span>)&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改造完成，我们还需要在安全配置类中去配置，保护我们的资源安全；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler imoocAuthenticationSuccessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler imoocAuthenticationFailureHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsCodeAuthenticationSecurityConfig smsCodeAuthenticationSecurityConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SpringSocialConfigurer imoocSocialSecurityConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line">            .loginPage(SecurityConstants.DEFAULT_UNAUTHENTICATION_URL)</span><br><span class="line">            .loginProcessingUrl(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_FORM)</span><br><span class="line">            .successHandler(imoocAuthenticationSuccessHandler)</span><br><span class="line">            .failureHandler(imoocAuthenticationFailureHandler);</span><br><span class="line">        http</span><br><span class="line">            <span class="comment">//				.apply(validateCodeSecurityConfig)</span></span><br><span class="line">            <span class="comment">//				.and()</span></span><br><span class="line">            .apply(smsCodeAuthenticationSecurityConfig)</span><br><span class="line">            .and()</span><br><span class="line">            .apply(imoocSocialSecurityConfig)</span><br><span class="line">            .and()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// 当访问以下URL，不需要身份认证</span></span><br><span class="line">            .antMatchers(</span><br><span class="line">            SecurityConstants.DEFAULT_UNAUTHENTICATION_URL,</span><br><span class="line">            SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE,</span><br><span class="line">            SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX+<span class="string">"/*"</span>,</span><br><span class="line">            securityProperties.getBrowser().getLoginPage(),</span><br><span class="line">            securityProperties.getBrowser().getSignUpUrl(),</span><br><span class="line">            securityProperties.getBrowser().getSession().getSessionInvalidUrl(),</span><br><span class="line">            securityProperties.getBrowser().getSignOutUrl(),</span><br><span class="line">            <span class="string">"/user/regist"</span></span><br><span class="line">        ).permitAll()</span><br><span class="line">            <span class="comment">// 任何请求</span></span><br><span class="line">            .anyRequest()</span><br><span class="line">            <span class="comment">// 认证后才能访问</span></span><br><span class="line">            .authenticated().and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动项目测试，做一个登陆的请求，携带用户名和密码并携带：authentication（封装clientId和clientSecret）的信息，因为项目的用户名密码的登录请求路径是authentication/form；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwbo8b7r5j20s007nwf7.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwbotbmuoj20ty09hmxx.jpg" alt=""></p>
<hr>
<h3 id="重构短信登录"><a href="#重构短信登录" class="headerlink" title="重构短信登录"></a>重构短信登录</h3><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>上部分在用户名密码的登录方式中，我们用Token的方式已经重新实现了，但是依然有许多的问题；</p>
<p>短信验证码登录的逻辑，设计到验证码存储的逻辑，</p>
<p>在这之前，我们是通过浏览器去发起请求，然后在服务器中生成，存储在SESSION当中的；</p>
<p>在之后的请求当中，再对验证码进行校验；</p>
<p>-</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>在APP的架构下，服务器是不存在SESSION的，那么验证码是无处可放的；</p>
<p>解决的思路，我们是在APP发起请求时，在生成和校验验证码逻辑的过程中，加上deviceId（设备ID），根据你的deviceId放到外部存储当中，进行生成和校验；</p>
<p>我们需要重构验证码的相关代码；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidateCodeProcessor</span> </span>&#123;</span><br><span class="line">	String SESSION_KEY_PREFIX = <span class="string">"SESSION_KEY_FOR_CODE_"</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(ServletWebRequest request)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(ServletWebRequest servletWebRequest)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidateCodeRepository</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存验证码</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request,ValidateCode code,ValidateCodeType validateCodeType)</span></span>;</span><br><span class="line">    <span class="comment">// 获取验证码</span></span><br><span class="line">    <span class="function">ValidateCode <span class="title">get</span><span class="params">(ServletWebRequest request,ValidateCodeType validateCodeType)</span></span>;</span><br><span class="line">    <span class="comment">// 删除验证码</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(ServletWebRequest request,ValidateCodeType validateCodeType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在APP项目中的验证码逻辑；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisValidateCodeRepository</span> <span class="keyword">implements</span> <span class="title">ValidateCodeRepository</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request, ValidateCode code, ValidateCodeType type)</span> </span>&#123;</span><br><span class="line">		redisTemplate.opsForValue().set(buildKey(request, type), code, <span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ValidateCode <span class="title">get</span><span class="params">(ServletWebRequest request, ValidateCodeType type)</span> </span>&#123;</span><br><span class="line">		Object value = redisTemplate.opsForValue().get(buildKey(request, type));</span><br><span class="line">		<span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (ValidateCode) value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ServletWebRequest request, ValidateCodeType type)</span> </span>&#123;</span><br><span class="line">		redisTemplate.delete(buildKey(request, type));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">buildKey</span><span class="params">(ServletWebRequest request, ValidateCodeType type)</span> </span>&#123;</span><br><span class="line">		String deviceId = request.getHeader(<span class="string">"deviceId"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isBlank(deviceId)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(<span class="string">"请在请求头中携带deviceId参数"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"code:"</span> + type.toString().toLowerCase() + <span class="string">":"</span> + deviceId;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Browser项目中的验证码逻辑；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionValidateCodeRepository</span> <span class="keyword">implements</span> <span class="title">ValidateCodeRepository</span> </span>&#123;</span><br><span class="line">    String SESSION_KEY_PREFIX = <span class="string">"SESSION_KEY_FOR_CODE_"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 操作session的工具类</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">private</span> SessionStrategy sessionStrategy = <span class="keyword">new</span> HttpSessionSessionStrategy();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request, ValidateCode code, ValidateCodeType validateCodeType)</span> </span>&#123;</span><br><span class="line">        sessionStrategy.setAttribute(request, getSessionKey(request, validateCodeType), code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建验证码放入session时的key</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getSessionKey</span><span class="params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SESSION_KEY_PREFIX + validateCodeType.toString().toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValidateCode <span class="title">get</span><span class="params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ValidateCode) sessionStrategy.getAttribute(request, getSessionKey(request, validateCodeType));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ServletWebRequest request, ValidateCodeType codeType)</span> </span>&#123;</span><br><span class="line">        sessionStrategy.removeAttribute(request, getSessionKey(request, codeType));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractValidateCodeProcessor</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">ValidateCode</span>&gt; <span class="keyword">implements</span> <span class="title">ValidateCodeProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 收集系统中所有的 &#123;<span class="doctag">@link</span> ValidateCodeGenerator&#125; 接口的实现</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, ValidateCodeGenerator&gt; validateCodeGenerators;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ValidateCodeRepository validateCodeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(ServletWebRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        C validateCode = generate(request);</span><br><span class="line">        save(request, validateCode);</span><br><span class="line">        send(request, validateCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 生成校验码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> C <span class="title">generate</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">        String type = getValidateCodeType(request).toString().toLowerCase();</span><br><span class="line">        String generatorName = type + ValidateCodeGenerator.class.getSimpleName();</span><br><span class="line">        ValidateCodeGenerator validateCodeGenerator = validateCodeGenerators.get(generatorName);</span><br><span class="line">        <span class="keyword">if</span> (validateCodeGenerator == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(<span class="string">"验证码生成器"</span> + generatorName + <span class="string">"不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (C) validateCodeGenerator.generate(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 保存校验码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request, C validateCode)</span> </span>&#123;</span><br><span class="line">        ValidateCode code = <span class="keyword">new</span> ValidateCode(validateCode.getCode(), validateCode.getExpireTime());</span><br><span class="line">        validateCodeRepository.save(request, code, getValidateCodeType(request));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送校验码，由子类实现</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(ServletWebRequest request, C validateCode)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据请求的url获取校验码的类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ValidateCodeType <span class="title">getValidateCodeType</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">        String type = StringUtils.substringBefore(getClass().getSimpleName(), <span class="string">"CodeProcessor"</span>);</span><br><span class="line">        <span class="keyword">return</span> ValidateCodeType.valueOf(type.toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(ServletWebRequest request)</span> </span>&#123;</span><br><span class="line">        ValidateCodeType codeType = getValidateCodeType(request);</span><br><span class="line">        C codeInSession = (C) validateCodeRepository.get(request, codeType);</span><br><span class="line"></span><br><span class="line">        String codeInRequest;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), codeType.getParamNameOnValidate());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServletRequestBindingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(<span class="string">"获取验证码失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(codeInRequest)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(codeType + <span class="string">"验证码不能为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (codeInSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(codeType + <span class="string">"验证码不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (codeInSession.isExpired()) &#123;</span><br><span class="line">            validateCodeRepository.remove(request, codeType);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(codeType + <span class="string">"验证码已过期"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidateCodeException(codeType + <span class="string">"验证码不匹配"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        validateCodeRepository.remove(request, codeType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwclwavqjj20gz0b93z2.jpg" alt=""></p>
<blockquote>
<p>向手机:13012345678. 发送短信验证码801409</p>
</blockquote>
<p>-</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwdeos7vnj20h206q74l.jpg" alt=""></p>
<p>-</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwdhm6rqjj20e8075mxf.jpg" alt=""></p>
<p>-</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwdefgjzrj20tw04vmxm.jpg" alt=""></p>
<p>在工具里发送的验证码登录请求，实际上以上是带上Cookies的HTTP请求，所以我们需要通过一段CMD代码，转化为APP的请求；</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http://127.0.0.1:8060/authentication/mobile \</span><br><span class="line">  -H 'authorization: Basic aW1vb2M6aW1vb2NzZWNyZXQ=' \</span><br><span class="line">  -H 'cache-control: no-cache' \</span><br><span class="line">  -H 'content-type: application/x-www-form-urlencoded' \</span><br><span class="line">  -H 'deviceid: 007' \</span><br><span class="line">  -H 'postman-token: 3646c210-6b71-316d-f1a2-f7cf91a242a6'</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="重构社交登录"><a href="#重构社交登录" class="headerlink" title="重构社交登录"></a>重构社交登录</h3><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwdqevj8oj211n0jhwrb.jpg" alt=""></p>
<h4 id="简化模式"><a href="#简化模式" class="headerlink" title="简化模式"></a>简化模式</h4><p>用户直接访问app，在app里面点击QQ或微信的第三方登录，QQ或微信返回openId和accessToken，app用openId换取令牌，然后返回令牌；</p>
<h5 id="封装请求信息TokenOpenIdAuthenticationToken"><a href="#封装请求信息TokenOpenIdAuthenticationToken" class="headerlink" title="封装请求信息TokenOpenIdAuthenticationToken"></a>封装请求信息TokenOpenIdAuthenticationToken</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenIdAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line">    <span class="keyword">private</span> String providerId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OpenIdAuthenticationToken</span><span class="params">(String openId, String providerId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.principal = openId;</span><br><span class="line">        <span class="keyword">this</span>.providerId = providerId;</span><br><span class="line">        setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OpenIdAuthenticationToken</span><span class="params">(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>); <span class="comment">// must use super, as we override</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProviderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> providerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eraseCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.eraseCredentials();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要一个过滤器，拦截登录请求，然后把信息封装，交到OpenIdAuthenticationToken里面；</p>
<p>-</p>
<h5 id="拦截请求OpenIdAuthenticationFilter"><a href="#拦截请求OpenIdAuthenticationFilter" class="headerlink" title="拦截请求OpenIdAuthenticationFilter"></a>拦截请求OpenIdAuthenticationFilter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SecurityConstants</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * openid参数名</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String DEFAULT_PARAMETER_NAME_OPENID = <span class="string">"openId"</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * providerId参数名</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String DEFAULT_PARAMETER_NAME_PROVIDERID = <span class="string">"providerId"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 默认的OPENID登录请求处理url</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String DEFAULT_LOGIN_PROCESSING_URL_OPENID = <span class="string">"/authentication/openid"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenIdAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String openIdParameter = SecurityConstants.DEFAULT_PARAMETER_NAME_OPENID;</span><br><span class="line">	<span class="keyword">private</span> String providerIdParameter = SecurityConstants.DEFAULT_PARAMETER_NAME_PROVIDERID;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> postOnly = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OpenIdAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_OPENID, <span class="string">"POST"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">		&#125;</span><br><span class="line">		String openid = obtainOpenId(request);</span><br><span class="line">		String providerId = obtainProviderId(request);</span><br><span class="line">		<span class="keyword">if</span> (openid == <span class="keyword">null</span>) &#123;</span><br><span class="line">			openid = <span class="string">""</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (providerId == <span class="keyword">null</span>) &#123;</span><br><span class="line">			providerId = <span class="string">""</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		openid = openid.trim();</span><br><span class="line">		providerId = providerId.trim();</span><br><span class="line">		OpenIdAuthenticationToken authRequest = <span class="keyword">new</span> OpenIdAuthenticationToken(openid, providerId);</span><br><span class="line">		setDetails(request, authRequest);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取openId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">obtainOpenId</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> request.getParameter(openIdParameter);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取提供商id</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">obtainProviderId</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> request.getParameter(providerIdParameter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setDetails</span><span class="params">(HttpServletRequest request, OpenIdAuthenticationToken authRequest)</span> </span>&#123;</span><br><span class="line">		authRequest.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOpenIdParameter</span><span class="params">(String openIdParameter)</span> </span>&#123;</span><br><span class="line">		Assert.hasText(openIdParameter, <span class="string">"Username parameter must not be empty or null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.openIdParameter = openIdParameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPostOnly</span><span class="params">(<span class="keyword">boolean</span> postOnly)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.postOnly = postOnly;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getOpenIdParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> openIdParameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getProviderIdParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> providerIdParameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProviderIdParameter</span><span class="params">(String providerIdParameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.providerIdParameter = providerIdParameter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="验证服务器OpenIdAuthenticationProvider"><a href="#验证服务器OpenIdAuthenticationProvider" class="headerlink" title="验证服务器OpenIdAuthenticationProvider"></a>验证服务器OpenIdAuthenticationProvider</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenIdAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> SocialUserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> UsersConnectionRepository usersConnectionRepository;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">		OpenIdAuthenticationToken authenticationToken = (OpenIdAuthenticationToken) authentication;</span><br><span class="line"></span><br><span class="line">		Set&lt;String&gt; providerUserIds = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">		providerUserIds.add((String) authenticationToken.getPrincipal());</span><br><span class="line">		Set&lt;String&gt; userIds = usersConnectionRepository.findUserIdsConnectedTo(authenticationToken.getProviderId(), providerUserIds);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(CollectionUtils.isEmpty(userIds) || userIds.size() != <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">"无法获取用户信息"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String userId = userIds.iterator().next();</span><br><span class="line"></span><br><span class="line">		UserDetails user = userDetailsService.loadUserByUserId(userId);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">"无法获取用户信息"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		OpenIdAuthenticationToken authenticationResult = <span class="keyword">new</span> OpenIdAuthenticationToken(user, user.getAuthorities());</span><br><span class="line"></span><br><span class="line">		authenticationResult.setDetails(authenticationToken.getDetails());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> authenticationResult;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> OpenIdAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="安全配置类OpenIdAuthenticationSecurityConfig"><a href="#安全配置类OpenIdAuthenticationSecurityConfig" class="headerlink" title="安全配置类OpenIdAuthenticationSecurityConfig"></a>安全配置类OpenIdAuthenticationSecurityConfig</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenIdAuthenticationSecurityConfig</span> <span class="keyword">extends</span> <span class="title">SecurityConfigurerAdapter</span>&lt;<span class="title">DefaultSecurityFilterChain</span>, <span class="title">HttpSecurity</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationSuccessHandler imoocAuthenticationSuccessHandler;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthenticationFailureHandler imoocAuthenticationFailureHandler;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SocialUserDetailsService userDetailsService;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UsersConnectionRepository usersConnectionRepository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		OpenIdAuthenticationFilter OpenIdAuthenticationFilter = <span class="keyword">new</span> OpenIdAuthenticationFilter();</span><br><span class="line">		OpenIdAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));</span><br><span class="line">		OpenIdAuthenticationFilter.setAuthenticationSuccessHandler(imoocAuthenticationSuccessHandler);</span><br><span class="line">		OpenIdAuthenticationFilter.setAuthenticationFailureHandler(imoocAuthenticationFailureHandler);</span><br><span class="line"></span><br><span class="line">		OpenIdAuthenticationProvider OpenIdAuthenticationProvider = <span class="keyword">new</span> OpenIdAuthenticationProvider();</span><br><span class="line">		OpenIdAuthenticationProvider.setUserDetailsService(userDetailsService);</span><br><span class="line">		OpenIdAuthenticationProvider.setUsersConnectionRepository(usersConnectionRepository);</span><br><span class="line"></span><br><span class="line">		http.authenticationProvider(OpenIdAuthenticationProvider).addFilterAfter(OpenIdAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="资源服务器配置ImoocResourceServerConfig"><a href="#资源服务器配置ImoocResourceServerConfig" class="headerlink" title="资源服务器配置ImoocResourceServerConfig"></a>资源服务器配置ImoocResourceServerConfig</h5><p>将刚刚写好的OpenId安全配置类加入到配置当中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OpenIdAuthenticationSecurityConfig openIdAuthenticationSecurityConfig;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">            http.</span><br><span class="line">            ...</span><br><span class="line">            .apply(openIdAuthenticationSecurityConfig)</span><br><span class="line">            .and()</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送请求，通过OpenId获取信息，成功登录；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwep2vp2sj20gh0c4754.jpg" alt=""></p>
<hr>
<h4 id="标准授权码模式"><a href="#标准授权码模式" class="headerlink" title="标准授权码模式"></a>标准授权码模式</h4><p>标准的授权码模式，APP请求QQ或微信去获取授权码；</p>
<p>然后将授权码交给我们自己的第三方client，由第三方client带着授权码去QQ；</p>
<p>或微信申请令牌，然后发放令牌给第三方应用，然后读取用户数据；</p>
<p>然后第三方应用重新生成自己的令牌返回给APP；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuwevaq9x5j20rh04hq3e.jpg" alt=""></p>
<p>在此处换令牌之前获取授权码，停止服务；</p>
<blockquote>
<p><a href="http://xxx/qqLogin/weixin" target="_blank" rel="noopener">http://xxx/qqLogin/weixin</a></p>
<p>?code=061f8yj728JKBJ0DADl72sMEj72f8yjh</p>
<p>&amp;state=344fadca-77e7-47a4-a3cd-7cd988f1953d</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SocialAuthenticationFilterPostProcessor</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(SocialAuthenticationFilter socialAuthenticationFilter)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocSpringSocialConfigurer</span> <span class="keyword">extends</span> <span class="title">SpringSocialConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SocialAuthenticationFilterPostProcessor socialAuthenticationFilterPostProcessor;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">postProcess</span><span class="params">(T object)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="keyword">if</span>(socialAuthenticationFilterPostProcessor != <span class="keyword">null</span>)&#123;</span><br><span class="line">                socialAuthenticationFilterPostProcessor.process(filter);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) filter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSocial</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocialConfig</span> <span class="keyword">extends</span> <span class="title">SocialConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> SocialAuthenticationFilterPostProcessor socialAuthenticationFilterPostProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将SpringSocialFilter添加到安全配置的Bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringSocialConfigurer <span class="title">imoocSocialSecurityConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...            configurer.setSocialAuthenticationFilterPostProcessor(socialAuthenticationFilterPostProcessor);</span><br><span class="line">        <span class="keyword">return</span> configurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将成功处理器设置进来imoocAuthenticationSuccessHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSocialAuthenticationFilterPostProcessor</span> <span class="keyword">implements</span> <span class="title">SocialAuthenticationFilterPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler imoocAuthenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(SocialAuthenticationFilter socialAuthenticationFilter)</span> </span>&#123;</span><br><span class="line">        socialAuthenticationFilter.setAuthenticationSuccessHandler(imoocAuthenticationSuccessHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成返回第三方应用生成的Token给APP；</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/04/Spring Security 13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/04/Spring Security 13/" itemprop="url">Spring Security | Note-13</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-04T00:00:00+08:00">
                2018-09-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-13"><a href="#Spring-Security-Note-13" class="headerlink" title="Spring Security Note-13"></a>Spring Security Note-13</h3><hr>
<h4 id="开发APP认证框架"><a href="#开发APP认证框架" class="headerlink" title="开发APP认证框架"></a>开发APP认证框架</h4><h5 id="基于服务器"><a href="#基于服务器" class="headerlink" title="基于服务器"></a>基于服务器</h5><p>在之前的学习中，我们所保存的用户信息，Session等都是保存在服务器中的；</p>
<p>用户通过浏览器，每次访问服务的时候，服务器都会检查浏览器的Cookies中是否包含JSESSIONID；</p>
<p>如果不包含JSESSIONID，就会新建一个SESSION，新建的SESSION就会写到Cookies中，每次用户请求时，都会去检查SESSION，拿出用户的信息；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw5uy63h5j20zp0j0jw5.jpg" alt=""></p>
<h5 id="更新换代"><a href="#更新换代" class="headerlink" title="更新换代"></a>更新换代</h5><p>前后端分离的服务，将HTML服务与应用服务分离开，单独部署到Web Server上；</p>
<p>在这种部署模式下，用户通过浏览器直接访问的是Web Server而不是Application Server，然后针对HTML的渲染由Web Server完成，ajax请求发给Web Server之后，再向Application Server发送请求，拿到数据；</p>
<p>不管是APP还是前后端分离的部署，最根本的出现就是：</p>
<blockquote>
<p>用户不再是通过浏览器直接访问应用</p>
<p>而是通过第三方应用（APP，Web Server）</p>
</blockquote>
<p>在这种架构模式下，继续使用Cookies和Session就会出现问题：</p>
<p>1.开发繁琐（浏览器已经封装好）</p>
<p>2.安全性和客户体验差（认证工作由服务器完成，SESSION失效与登录）</p>
<p>3.有些前端技术不支持Cookies（微信小程序）</p>
<h5 id="Spring-Security-OAuth"><a href="#Spring-Security-OAuth" class="headerlink" title="Spring Security OAuth"></a>Spring Security OAuth</h5><p>解决这种架构下的方法，其中一种是通过令牌（Token）的方式解决；</p>
<p>令牌是一种类似SESSION的唯一标识，在SESSION模式下，是往Cookies中写入JSESSIONID，而令牌是直接发给用户一个唯一标识的Token，用户每次访问带着令牌，Application Server去认证自身发出的令牌；</p>
<p>-</p>
<p>在接下来的开发过程中，开发和认证的方式，就改变成了令牌的收发和认证，使用OAuth协议来解决开发问题；</p>
<p>在OAuth协议中，Spring Social封装了大部分的开发内容，直接使用就可以完成第三方应用Client基本功能；</p>
<p>接下来学习的Spring Security OAuth则是封装了服务提供商的绝大部分行为，可以实现发令牌，认证令牌；</p>
<p>-</p>
<p>为了完成服务提供商的功能，我们需要实现认证服务器和资源服务器的功能；</p>
<p>在认证服务器中，需要完成4种授权模式，确认用户的身份和权限，通过4种授权模式，根据这些信息生成Token和存储；</p>
<p>在资源服务器下，我们需要保护资源（REST服务），通过Spring Security的过滤器链进行保护，在Spring Security OAuth中，通过在过滤器链上加入<code>OAuth2AuthenticationProcessingFilter</code>的方式，对请求中拿出Token，在存储策略中进行认证；</p>
<p>在实际开发中，我们不希望用户通过4种标准的授权模式（手机短信），我们希望通过自定义的认证方式，在认证服务器中实现认证；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw6ax8nj8j20zc0hjajb.jpg" alt=""></p>
<hr>
<h4 id="实现标准的OAuth2服务提供商（Provider）"><a href="#实现标准的OAuth2服务提供商（Provider）" class="headerlink" title="实现标准的OAuth2服务提供商（Provider）"></a>实现标准的OAuth2服务提供商（Provider）</h4><p>1.首先我们将SimpleRespon移动到Core项目当中；</p>
<p>2.将BrowserSecurityConfig的PasswordEncoder移动到Core项目的SecurityCoreConfig；</p>
<h5 id="认证服务器"><a href="#认证服务器" class="headerlink" title="认证服务器"></a>认证服务器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocAuthorizationServerConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="资源服务器"><a href="#资源服务器" class="headerlink" title="资源服务器"></a>资源服务器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocResourceServerConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-</p>
<h5 id="访问四种授权模式"><a href="#访问四种授权模式" class="headerlink" title="访问四种授权模式"></a>访问四种授权模式</h5><p>访问/oauth/authorize 需要附带参数：</p>
<blockquote>
<p>response_type : code</p>
<p>client_id : xxx</p>
<p>redirect_uri : http://</p>
<p>scope : all</p>
</blockquote>
<p>启动时默认生成的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security.oauth2.client.client-id = 64f9b36e-d819-4526-8047-d6f80cf16123</span><br><span class="line">security.oauth2.client.client-secret = 1d5527b0-33f8-4a9d-8536-312ff78d69d0</span><br></pre></td></tr></table></figure>
<h6 id="在配置文件中配置"><a href="#在配置文件中配置" class="headerlink" title="在配置文件中配置"></a>在配置文件中配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security.oauth2.client.client-id=imooc</span><br><span class="line">security.oauth2.client.client-secret=imoocsecret</span><br></pre></td></tr></table></figure>
<h6 id="修改MyUserDetailService"><a href="#修改MyUserDetailService" class="headerlink" title="修改MyUserDetailService"></a>修改MyUserDetailService</h6><p>添加ROLE_USER的角色（默认必须有这个角色）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SocialUserDetails <span class="title">buildUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO 根据用户名（数据库）查找用户信息</span></span><br><span class="line">    <span class="comment">// 根据查找到的用户信息，判断用户是否被冻结</span></span><br><span class="line">    String password = passwordEncoder.encode(<span class="string">"123456"</span>);</span><br><span class="line">    logger.info(<span class="string">"PASSWORD FROM DB : "</span> + password);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SocialUser(username, password,</span><br><span class="line">                          <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>,</span><br><span class="line">                      AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admin,ROLE_USER"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-</p>
<h5 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h5><h6 id="获取授权码"><a href="#获取授权码" class="headerlink" title="获取授权码"></a>获取授权码</h6><blockquote>
<p><a href="http://localhost:8060/oauth/authorize?response_type=code&amp;client_id=imooc&amp;redirect_uri=http://example.com&amp;scope=all" target="_blank" rel="noopener">http://localhost:8060/oauth/authorize?response_type=code&amp;client_id=imooc&amp;redirect_uri=http://example.com&amp;scope=all</a></p>
</blockquote>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw7xl71oij206f00s3ya.jpg" alt=""></p>
<h6 id="在工具内验证授权码模式请求："><a href="#在工具内验证授权码模式请求：" class="headerlink" title="在工具内验证授权码模式请求："></a>在工具内验证授权码模式请求：</h6><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw7y6z3caj20rk0bjq45.jpg" alt=""></p>
<h6 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h6><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw7zetcrej20s509tdgo.jpg" alt=""></p>
<p>-</p>
<h5 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h5><h6 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h6><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw86r7xgrj20ri08e3zb.jpg" alt=""></p>
<h6 id="返回结果-1"><a href="#返回结果-1" class="headerlink" title="返回结果"></a>返回结果</h6><p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw877ngkjj20s00a0wfb.jpg" alt=""></p>
<p>-</p>
<h5 id="获取用户信息"><a href="#获取用户信息" class="headerlink" title="获取用户信息"></a>获取用户信息</h5><p>对比我们可以发现，在expires_in没过期的前提下，同一个用户在两种授权模式下的access_token是一样的；</p>
<h6 id="401"><a href="#401" class="headerlink" title="401"></a>401</h6><p>在不附带参数的情况下，获取用户数据的话，会报出401的错误；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw8cs72o0j20rc0dz75e.jpg" alt=""></p>
<p>-</p>
<h6 id="200"><a href="#200" class="headerlink" title="200"></a>200</h6><p>当我们获取到access_token之后，就可以通过access_token &amp; token_type获取用户信息；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw8ew5fsyj20nv085wf2.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuw8f9qwwej20ts0dt3zl.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/04/Spring Security 12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/04/Spring Security 12/" itemprop="url">Spring Security | Note-12</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-04T00:00:00+08:00">
                2018-09-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-12"><a href="#Spring-Security-Note-12" class="headerlink" title="Spring Security Note-12"></a>Spring Security Note-12</h3><hr>
<h4 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h4><h5 id="如何退出登录"><a href="#如何退出登录" class="headerlink" title="如何退出登录"></a>如何退出登录</h5><p>退出登录，需要访问一个特定的服务，默认情况下，服务的路径是/logout；</p>
<p>并且退出成功后跳转的URL是登录URL + ?logout的路径；</p>
<h5 id="Spring-Security默认的退出处理逻辑"><a href="#Spring-Security默认的退出处理逻辑" class="headerlink" title="Spring Security默认的退出处理逻辑"></a>Spring Security默认的退出处理逻辑</h5><p>使当前session失效；</p>
<p>清除与当前用户相关的remember-me记录；</p>
<p>清空当前的SecurityContext；</p>
<p>重定向到登录页；</p>
<h5 id="与退出登录相关的配置"><a href="#与退出登录相关的配置" class="headerlink" title="与退出登录相关的配置"></a>与退出登录相关的配置</h5><h6 id="自定义成功退出的逻辑处理"><a href="#自定义成功退出的逻辑处理" class="headerlink" title="自定义成功退出的逻辑处理"></a>自定义成功退出的逻辑处理</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title">LogoutSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="keyword">private</span> String signOutUrl;</span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImoocLogoutSuccessHandler</span><span class="params">(String signOutUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.signOutUrl = signOutUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"退出成功"</span>);</span><br><span class="line">        <span class="comment">// 自定义退出成功的逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(signOutUrl)) &#123;</span><br><span class="line">            <span class="comment">// 无页面，返回JSON</span></span><br><span class="line">            response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">            response.getWriter().write(objectMapper.writeValueAsString(<span class="keyword">new</span> SimpleResponse(<span class="string">"退出成功"</span>)));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.sendRedirect(signOutUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="注入Bean"><a href="#注入Bean" class="headerlink" title="注入Bean"></a>注入Bean</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityBeanConfig</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(LogoutSuccessHandler.class)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> LogoutSuccessHandler <span class="title">logoutSuccessHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImoocLogoutSuccessHandler(securityProperties.getBrowser().getSignOutUrl());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="BrowserProperties配置URL"><a href="#BrowserProperties配置URL" class="headerlink" title="BrowserProperties配置URL"></a>BrowserProperties配置URL</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserProperties</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String signOutUrl = <span class="string">"/logout.html"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    applyPasswordAuthenticationConfig(http);</span><br><span class="line">    http.</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 默认</span></span><br><span class="line">        .and()</span><br><span class="line">        .logout().logoutUrl(<span class="string">"/signOut"</span>)</span><br><span class="line">        <span class="comment">// 成功退出的自定义URL</span></span><br><span class="line">        <span class="comment">// .logoutSuccessUrl("/imooc-logout.html")</span></span><br><span class="line">        <span class="comment">// 成功退出的自定义逻辑（与URL冲突）</span></span><br><span class="line">        .logoutSuccessHandler(logoutSuccessHandler)</span><br><span class="line">        <span class="comment">// 删除Cookies</span></span><br><span class="line">        .deleteCookies(<span class="string">"JSESSIONID"</span>)</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// 都需要认证</span></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/03/Spring Security 11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/03/Spring Security 11/" itemprop="url">Spring Security | Note-11</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-03T00:00:00+08:00">
                2018-09-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-11"><a href="#Spring-Security-Note-11" class="headerlink" title="Spring Security Note-11"></a>Spring Security Note-11</h3><hr>
<h4 id="Session管理"><a href="#Session管理" class="headerlink" title="Session管理"></a>Session管理</h4><h5 id="Session超时管理"><a href="#Session超时管理" class="headerlink" title="Session超时管理"></a>Session超时管理</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.session.timeout=10</span><br></pre></td></tr></table></figure>
<p>在设置了超时时间之后，等待片刻，重新刷新页面；</p>
<p>实际上发现，我们依然能够获取到用户的信息，session并没有清除；</p>
<p>在SpringBoot的源码当中，我们可以发现，默认最少超时时间是一分钟，所以我们设置的时间，应该要大于60秒；</p>
<p>在某些情况下，我们需要提示用户session失效，让用户重新登录；</p>
<h6 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    applyPasswordAuthenticationConfig(http);</span><br><span class="line">    http.</span><br><span class="line">        ...</span><br><span class="line">        .and().sessionManagement().invalidSessionUrl(<span class="string">"/session/invalid"</span>)</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/session/invalid"</span>)</span><br><span class="line">	<span class="meta">@ResponseStatus</span>(code = HttpStatus.UNAUTHORIZED)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> SimpleResponse <span class="title">sessionInvalid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String message = <span class="string">"SESSION 失效"</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleResponse(message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Session并发控制"><a href="#Session并发控制" class="headerlink" title="Session并发控制"></a>Session并发控制</h5><h6 id="添加配置-1"><a href="#添加配置-1" class="headerlink" title="添加配置"></a>添加配置</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    applyPasswordAuthenticationConfig(http);</span><br><span class="line">    http.</span><br><span class="line">        ...</span><br><span class="line">        .and().sessionManagement()</span><br><span class="line">        <span class="comment">// session 过期返回URL</span></span><br><span class="line">        .invalidSessionUrl(<span class="string">"/session/invalid"</span>)</span><br><span class="line">        <span class="comment">// 最大session并发数量</span></span><br><span class="line">        .maximumSessions(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">// false之后登录将会踢下之前的登录，true则是不允许之后登录</span></span><br><span class="line">        .maxSessionsPreventsLogin(<span class="keyword">false</span>)</span><br><span class="line">        <span class="comment">// 登录被踢掉时的自定义操作</span></span><br><span class="line">        .expiredSessionStrategy(<span class="keyword">new</span> ImoocExpiredSessionStrategy())</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// 默认</span></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocExpiredSessionStrategy</span> <span class="keyword">implements</span> <span class="title">SessionInformationExpiredStrategy</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        event.getResponse().setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        event.getResponse().getWriter().write(<span class="string">"并发登录"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionProperties</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 最大session数 默认1</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> maximumSessions = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// 并发登录的默认阻止设置 默认false</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> maxSessionsPreventsLogin;</span><br><span class="line">	<span class="comment">// session失效的跳转地址</span></span><br><span class="line">	<span class="keyword">private</span> String sessionInvalidUrl = SecurityConstants.DEFAULT_SESSION_INVALID_URL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="session失效以及并发控制的自定义的策略"><a href="#session失效以及并发控制的自定义的策略" class="headerlink" title="session失效以及并发控制的自定义的策略"></a>session失效以及并发控制的自定义的策略</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSessionStrategy</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 跳转的url</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String destinationUrl;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 重定向策略</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> RedirectStrategy redirectStrategy = <span class="keyword">new</span> DefaultRedirectStrategy();</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 跳转前是否创建新的session</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> createNewSession = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractSessionStrategy</span><span class="params">(String invalidSessionUrl)</span> </span>&#123;</span><br><span class="line">		Assert.isTrue(UrlUtils.isValidRedirectUrl(invalidSessionUrl), <span class="string">"url must start with '/' or with 'http(s)'"</span>);</span><br><span class="line">		<span class="keyword">this</span>.destinationUrl = invalidSessionUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSessionInvalid</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (createNewSession) &#123;</span><br><span class="line">			request.getSession();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String sourceUrl = request.getRequestURI();</span><br><span class="line">		String targetUrl;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.endsWithIgnoreCase(sourceUrl, <span class="string">".html"</span>)) &#123;</span><br><span class="line">			targetUrl = destinationUrl + <span class="string">".html"</span>;</span><br><span class="line">			logger.info(<span class="string">"session失效,跳转到"</span> + targetUrl);</span><br><span class="line">			redirectStrategy.sendRedirect(request, response, targetUrl);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			String message = <span class="string">"session已失效"</span>;</span><br><span class="line">			<span class="keyword">if</span> (isConcurrency()) &#123;</span><br><span class="line">				message = message + <span class="string">"，有可能是并发登录导致的"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">			response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">			response.getWriter().write(objectMapper.writeValueAsString(<span class="keyword">new</span> SimpleResponse(message)));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isConcurrency</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateNewSession</span><span class="params">(<span class="keyword">boolean</span> createNewSession)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.createNewSession = createNewSession;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="session超时的配置处理类"><a href="#session超时的配置处理类" class="headerlink" title="session超时的配置处理类"></a>session超时的配置处理类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocExpiredSessionStrategy</span> <span class="keyword">extends</span> <span class="title">AbstractSessionStrategy</span> <span class="keyword">implements</span> <span class="title">SessionInformationExpiredStrategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImoocExpiredSessionStrategy</span><span class="params">(String invalidSessionUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(invalidSessionUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        onSessionInvalid(event.getRequest(), event.getResponse());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isConcurrency</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="session失效的配置处理类"><a href="#session失效的配置处理类" class="headerlink" title="session失效的配置处理类"></a>session失效的配置处理类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocInvalidSessionStrategy</span> <span class="keyword">extends</span> <span class="title">AbstractSessionStrategy</span> <span class="keyword">implements</span> <span class="title">InvalidSessionStrategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImoocInvalidSessionStrategy</span><span class="params">(String invalidSessionUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(invalidSessionUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidSessionDetected</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        onSessionInvalid(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    applyPasswordAuthenticationConfig(http);</span><br><span class="line">    http.</span><br><span class="line">        ...</span><br><span class="line">        .and().sessionManagement()</span><br><span class="line">        <span class="comment">// session 过期返回URL</span></span><br><span class="line">        .invalidSessionStrategy(invalidSessionStrategy)</span><br><span class="line">        <span class="comment">// 最大session并发数量</span></span><br><span class="line">      .maximumSessions(securityProperties.getBrowser().getSession().getMaximumSessions())</span><br><span class="line">        <span class="comment">// false之后登录将会踢下之前的登录，true则是不允许之后登录</span></span><br><span class="line">      .maxSessionsPreventsLogin(securityProperties.getBrowser().getSession().isMaxSessionsPreventsLogin())</span><br><span class="line">        <span class="comment">// 登录被踢掉时的自定义操作</span></span><br><span class="line">        .expiredSessionStrategy(expiredSessionStrategy)</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// 默认</span></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="配置注入Bean"><a href="#配置注入Bean" class="headerlink" title="配置注入Bean"></a>配置注入Bean</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityBeanConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityProperties securityProperties;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(InvalidSessionStrategy.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> InvalidSessionStrategy <span class="title">invalidSessionStrategy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImoocInvalidSessionStrategy(securityProperties.getBrowser().getSession().getSessionInvalidUrl());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(SessionInformationExpiredStrategy.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionInformationExpiredStrategy <span class="title">sessionInformationExpiredStrategy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImoocExpiredSessionStrategy(securityProperties.getBrowser().getSession().getSessionInvalidUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="集群Session管理"><a href="#集群Session管理" class="headerlink" title="集群Session管理"></a>集群Session管理</h5><h6 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h6><p>面对一个问题，任何一个软件在面向用户使用的时候，至少部署两台机器；</p>
<p>在集群环境下，基于Session的认证就会存在问题；</p>
<p>用户的登录请求发送到Server1时，登录成功后，所有的session等信息，存储在Server1中；</p>
<p>在后续用户发送的服务请求中， 如果在负载均衡上没有做出处理的话，请求可能会发送到Server2中；</p>
<p>那么当后面的请求发送到Server2上，在Server2中不存在用户的session等信息认证，那么Server2将会拒绝用户的服务请求，需要再次登录；</p>
<h6 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h6><p>将session抽取出来，放在一个独立的存取中，不放在服务器上；</p>
<p><img src="https://ws1.sinaimg.cn/large/675bae34gy1fuvcl2gz0aj213s0ergrz.jpg" alt=""></p>
<h6 id="在Browser添加依赖"><a href="#在Browser添加依赖" class="headerlink" title="在Browser添加依赖"></a>在Browser添加依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Spring Social提供的支持Session的类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> StoreType &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Redis backed sessions.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	REDIS,</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Mongo backed sessions.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	MONGO,</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * JDBC backed sessions.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	JDBC,</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Hazelcast backed sessions.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	HAZELCAST,</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Simple in-memory map of sessions.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	HASH_MAP,</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * No session data-store.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NONE;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># SESSION</span><br><span class="line">spring.session.store-type=redis</span><br></pre></td></tr></table></figure>
<p>这样就能做到将session存储在redis中；</p>
<h6 id="图形验证码"><a href="#图形验证码" class="headerlink" title="图形验证码"></a>图形验证码</h6><p>使ValidateCode实现Serializable接口，才能将图形验证码放入到session当中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCode</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>不将图片放入session当中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 保存校验码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(ServletWebRequest request, C validateCode)</span> </span>&#123;</span><br><span class="line">    ValidateCode code = <span class="keyword">new</span> ValidateCode(validateCode.getCode(),validateCode.getExpireTime());</span><br><span class="line">    sessionStrategy.setAttribute(request, getSessionKey(request), code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/02/Spring Security 10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="REX CHEN">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="REEEEX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/02/Spring Security 10/" itemprop="url">Spring Security | Note-10</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T00:00:00+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Security-Note-10"><a href="#Spring-Security-Note-10" class="headerlink" title="Spring Security Note-10"></a>Spring Security Note-10</h3><hr>
<h4 id="微信登录开发"><a href="#微信登录开发" class="headerlink" title="微信登录开发"></a>微信登录开发</h4><p>微信开发的整个流程，原理和QQ是几乎一致；</p>
<p><code>api</code> 定义api绑定的公共接口</p>
<p><code>config</code> 微信的一些配置信息</p>
<p><code>connect</code>与服务提供商建立连接所需的一些类</p>
<p>代码过多且雷同，详见GITHUB；</p>
<hr>
<h4 id="社交帐号绑定与解绑"><a href="#社交帐号绑定与解绑" class="headerlink" title="社交帐号绑定与解绑"></a>社交帐号绑定与解绑</h4><p>实现绑定与解绑，需要知道社交账号的绑定状态，绑定就是重新经历<code>OAuth2</code>流程,关联当前登录用户；</p>
<p>解绑就是删除<code>UserConnection</code>表中的数据；</p>
<p><code>Spring Social</code>默认在<code>ConnectController</code>类上已经实现了以上需求；</p>
<h5 id="获取状态"><a href="#获取状态" class="headerlink" title="获取状态"></a>获取状态</h5><p><code>/connect</code>获取状态</p>
<p>ConnectController中的方法只提供了数据并没有提供视图；</p>
<p>实现<code>connect/status</code>视图即可获得社交账号的绑定状态；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">connectionStatus</span><span class="params">(NativeWebRequest request, Model model)</span> </span>&#123;</span><br><span class="line">    setNoCache(request);</span><br><span class="line">    processFlash(request, model);</span><br><span class="line">    <span class="comment">// 根据userId查询UserConnection表</span></span><br><span class="line">    Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = connectionRepository.findAllConnections();</span><br><span class="line">    <span class="comment">// 系统中已经注册的服务提供商</span></span><br><span class="line">    model.addAttribute(<span class="string">"providerIds"</span>, connectionFactoryLocator.registeredProviderIds());     </span><br><span class="line">    model.addAttribute(<span class="string">"connectionMap"</span>, connections);</span><br><span class="line">    <span class="comment">// 返回connectView()</span></span><br><span class="line">    <span class="keyword">return</span> connectView();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">connectView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// connect/status </span></span><br><span class="line">    <span class="keyword">return</span> getViewPath() + <span class="string">"status"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实现connect-status"><a href="#实现connect-status" class="headerlink" title="实现connect/status"></a>实现connect/status</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"connect/status"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocConnectionStatusView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = (Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt;) model.get(<span class="string">"connectionMap"</span>);</span><br><span class="line">        Map&lt;String, Boolean&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String key : connections.keySet()) &#123;</span><br><span class="line">            result.put(key, CollectionUtils.isNotEmpty(connections.get(key)));</span><br><span class="line">        &#125;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="绑定的实现"><a href="#绑定的实现" class="headerlink" title="绑定的实现"></a>绑定的实现</h4><p>ConnectController中的方法 /connect/{providerId} 绑定社交帐号</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////跳转到授权的页面</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;providerId&#125;"</span>, method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedirectView <span class="title">connect</span><span class="params">(@PathVariable String providerId, NativeWebRequest request)</span> </span>&#123;</span><br><span class="line">    ConnectionFactory&lt;?&gt; connectionFactory = connectionFactoryLocator.getConnectionFactory(providerId);</span><br><span class="line">    MultiValueMap&lt;String, String&gt; parameters = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;(); </span><br><span class="line">    preConnect(connectionFactory, parameters, request);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedirectView(connectSupport.buildOAuthUrl(connectionFactory, request, parameters));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        sessionStrategy.setAttribute(request, PROVIDER_ERROR_ATTRIBUTE, e);</span><br><span class="line">        <span class="keyword">return</span> connectionStatusRedirect(providerId, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="授权成功的回调地址"><a href="#授权成功的回调地址" class="headerlink" title="授权成功的回调地址"></a>授权成功的回调地址</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将当前的登录账户与社交账号绑定（写入到UserConnection表）</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;providerId&#125;"</span>, method=RequestMethod.GET, params=<span class="string">"code"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedirectView <span class="title">oauth2Callback</span><span class="params">(@PathVariable String providerId, NativeWebRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        OAuth2ConnectionFactory&lt;?&gt; connectionFactory = (OAuth2ConnectionFactory&lt;?&gt;) connectionFactoryLocator.getConnectionFactory(providerId);</span><br><span class="line">        Connection&lt;?&gt; connection = connectSupport.completeConnection(connectionFactory, request);</span><br><span class="line">        addConnection(connection, connectionFactory, request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        sessionStrategy.setAttribute(request, PROVIDER_ERROR_ATTRIBUTE, e);</span><br><span class="line">        logger.warn(<span class="string">"Exception while handling OAuth2 callback ("</span> + e.getMessage() + <span class="string">"). Redirecting to "</span> + providerId +<span class="string">" connection status page."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> connectionStatusRedirect(providerId, request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回/connext/qqed视图</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> RedirectView <span class="title">connectionStatusRedirect</span><span class="params">(String providerId, NativeWebRequest request)</span> </span>&#123;</span><br><span class="line">    HttpServletRequest servletRequest = request.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">    String path = <span class="string">"/connect/"</span> + providerId + getPathExtension(servletRequest);</span><br><span class="line">    <span class="keyword">if</span> (prependServletPath(servletRequest)) &#123;</span><br><span class="line">        path = servletRequest.getServletPath() + path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RedirectView(path, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="绑定结果的视图"><a href="#绑定结果的视图" class="headerlink" title="绑定结果的视图"></a>绑定结果的视图</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImoocConnectView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">        <span class="keyword">if</span> (model.get(<span class="string">"connections"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.getWriter().write(<span class="string">"&lt;h3&gt;解绑成功&lt;/h3&gt;"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.getWriter().write(<span class="string">"&lt;h3&gt;绑定成功&lt;/h3&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="注入绑定结果的视图"><a href="#注入绑定结果的视图" class="headerlink" title="注入绑定结果的视图"></a>注入绑定结果的视图</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"imooc.security.social.weixin"</span>, name = <span class="string">"app-id"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinAutoConfiguration</span> <span class="keyword">extends</span> <span class="title">SocialAutoConfigurerAdapter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span>(<span class="string">"connect/weixinConnected"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"weixinConnectedView"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">weixinConnectedView</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImoocConnectView();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="解除绑定的实现"><a href="#解除绑定的实现" class="headerlink" title="解除绑定的实现"></a>解除绑定的实现</h4><p>解除绑定的操作其实与绑定是一样的，只是发出请求的方式是DELETE，而不是POST；</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://localhost/connect/weixin</span></span><br><span class="line"><span class="attribute">Method:DELETE</span></span><br></pre></td></tr></table></figure>
<p>发送请求后，虽然返回的响应结果是302，但是实际上在数据库中，已经完成了记录的删除；</p>
<p>补充一下解绑的视图；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(&#123;<span class="string">"connect/weixinConnect"</span>,<span class="string">"connect/weixinConnected"</span>&#125;)</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"weixinConnectedView"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">weixinConnectedView</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ImoocConnectView();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">REX CHEN</p>
              <p class="site-description motion-element" itemprop="description">日常记录</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">REX CHEN</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
